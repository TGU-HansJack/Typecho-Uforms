## ğŸ¤– Assistant

æ ¹æ®ä½ çš„æè¿°å’Œä»£ç åˆ†æï¼Œé—®é¢˜å‡ºç°åœ¨å‡ ä¸ªå…³é”®åœ°æ–¹ã€‚ä¸»è¦é—®é¢˜æ˜¯ï¼š

1. **æ•°æ®åº“è¿æ¥é—®é¢˜** - `front.php` ä¸­ä½¿ç”¨äº† `global $db, $request` ä½†æ²¡æœ‰æ­£ç¡®åˆå§‹åŒ–
2. **è·¯ç”±å¤„ç†é—®é¢˜** - Action.php çš„è·¯ç”±å¤„ç†å¯èƒ½æœ‰é—®é¢˜
3. **POST-REDIRECT-GETæ¨¡å¼ç¼ºå¤±** - å¯¼è‡´åˆ·æ–°æ—¶é‡å¤æäº¤

## è§£å†³æ–¹æ¡ˆ

### 1. ä¿®å¤ `frontend/front.php`

```php
<?php
if (!defined('__TYPECHO_ROOT_DIR__')) exit;

class UformsFront {
    
    public static function renderForm($form_name, $template = 'default') {
        $db = Typecho_Db::get();
        $request = Typecho_Request::getInstance();
        
        try {
            // è·å–è¡¨å•
            $form = $db->fetchRow(
                $db->select('*')->from('table.uforms_forms')
                   ->where('name = ? AND status = ?', $form_name, 'published')
            );
            
            if (!$form) {
                return '<div class="uform-error">è¡¨å•ä¸å­˜åœ¨æˆ–æœªå‘å¸ƒ</div>';
            }
            
            // è·å–è¡¨å•å­—æ®µ
            $fields = $db->fetchAll(
                $db->select('*')->from('table.uforms_fields')
                   ->where('form_id = ?', $form['id'])
                   ->order('sort_order ASC')
            );
            
            $form_config = json_decode($form['config'], true) ?: array();
            $form_settings = json_decode($form['settings'], true) ?: array();
            
            // å¤„ç†è¡¨å•æäº¤
            if ($request->isPost() && $request->get('uform_name') === $form_name) {
                return self::handleFormSubmission($form, $fields, $form_settings);
            }
            
            // æ¸²æŸ“è¡¨å•
            return self::renderFormHTML($form, $fields, $form_config, $form_settings, $template);
            
        } catch (Exception $e) {
            error_log('Uforms renderForm error: ' . $e->getMessage());
            return '<div class="uform-error">è¡¨å•åŠ è½½å¤±è´¥: ' . htmlspecialchars($e->getMessage()) . '</div>';
        }
    }
    
    public static function handleFormSubmission($form, $fields, $settings) {
        $db = Typecho_Db::get();
        $request = Typecho_Request::getInstance();
        
        error_log('Uforms: Starting handleFormSubmission for form ID: ' . $form['id']);
        error_log('Uforms: POST data: ' . print_r($_POST, true));
        
        $errors = array();
        $form_data = array();
        $uploaded_files = array();
        
        try {
            // éªŒè¯å®‰å…¨ä»¤ç‰Œ
            $security = Helper::security();
            $token = $request->get('_token');
            
            error_log('Uforms: Checking security token: ' . $token);
            
            if (!$security->checkToken($token)) {
                error_log('Uforms: Security token validation failed');
                return '<div class="uform-error">å®‰å…¨éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
            
            // æ£€æŸ¥é¢‘ç‡é™åˆ¶
            if (!self::checkRateLimit($form['id'])) {
                error_log('Uforms: Rate limit exceeded');
                return '<div class="uform-error">æäº¤è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•</div>';
            }
            
            // éªŒè¯å­—æ®µ
            foreach ($fields as $field) {
                $field_name = $field['field_name'];
                $field_value = $request->get($field_name);
                $field_config = json_decode($field['field_config'], true) ?: array();
                
                error_log('Uforms: Processing field: ' . $field_name . ' = ' . print_r($field_value, true));
                
                // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
                if ($field['field_type'] === 'file' && isset($_FILES[$field_name])) {
                    $file_result = self::handleFileUpload($_FILES[$field_name], $field, $form['id']);
                    if ($file_result['success']) {
                        $form_data[$field_name] = $file_result['file_info'];
                        $uploaded_files[] = $file_result['file_info'];
                    } else {
                        $errors[$field_name] = $file_result['error'];
                    }
                    continue;
                }
                
                // éªŒè¯å¿…å¡«å­—æ®µ
                if ($field['is_required'] && (empty($field_value) || (is_array($field_value) && count($field_value) === 0))) {
                    $errors[$field_name] = 'æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹';
                    continue;
                }
                
                // æ ¹æ®å­—æ®µç±»å‹éªŒè¯
                if (!empty($field_value)) {
                    $validation_errors = UformsHelper::validateField($field['field_type'], $field_value, $field_config);
                    if (!empty($validation_errors)) {
                        $errors[$field_name] = implode(', ', $validation_errors);
                    }
                }
                
                $form_data[$field_name] = $field_value;
            }
            
            error_log('Uforms: Validation errors: ' . print_r($errors, true));
            error_log('Uforms: Form data collected: ' . print_r($form_data, true));
            
            // å¦‚æœæœ‰é”™è¯¯ï¼Œè¿”å›è¡¨å•
            if (!empty($errors)) {
                $error_html = '<div class="uform-errors"><ul>';
                foreach ($errors as $field => $error) {
                    $error_html .= '<li>' . htmlspecialchars($error) . '</li>';
                }
                $error_html .= '</ul></div>';
                return $error_html . self::renderFormHTML($form, $fields, array(), $settings, 'default', $errors, $form_data);
            }
            
            // æ£€æŸ¥åƒåœ¾å†…å®¹
            if (UformsHelper::isSpam($form_data)) {
                UformsHelper::logSpam($form['id'], UformsHelper::getClientIP(), 'spam_keywords', $form_data);
                error_log('Uforms: Spam detected and logged');
                return '<div class="uform-error">æäº¤å¤±è´¥ï¼Œå†…å®¹è¢«è¯†åˆ«ä¸ºåƒåœ¾ä¿¡æ¯</div>';
            }
            
            error_log('Uforms: Starting database operations');
            
            // ä¿å­˜æäº¤æ•°æ®åˆ°æ•°æ®åº“
            $submission_data = array(
                'form_id' => intval($form['id']),
                'data' => json_encode($form_data, JSON_UNESCAPED_UNICODE),
                'ip' => UformsHelper::getClientIP(),
                'user_agent' => isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : '',
                'status' => 'new',
                'source' => 'web',
                'created_time' => time(),
                'modified_time' => time()
            );
            
            error_log('Uforms: Preparing to insert submission data: ' . print_r($submission_data, true));
            
            // æ’å…¥æäº¤æ•°æ®
            $insert_query = $db->insert('table.uforms_submissions')->rows($submission_data);
            error_log('Uforms: Insert query: ' . $insert_query);
            
            $submission_id = $db->query($insert_query);
            
            if (!$submission_id || $submission_id <= 0) {
                throw new Exception('Failed to insert submission data. Submission ID: ' . $submission_id);
            }
            
            error_log('Uforms: Successfully inserted submission with ID: ' . $submission_id);
            
            // ä¿å­˜æ–‡ä»¶è®°å½•
            foreach ($uploaded_files as $file_info) {
                $file_data = array(
                    'submission_id' => $submission_id,
                    'form_id' => $form['id'],
                    'field_name' => $file_info['field_name'],
                    'original_name' => $file_info['original_name'],
                    'filename' => $file_info['filename'],
                    'file_path' => $file_info['file_path'],
                    'file_size' => $file_info['file_size'],
                    'file_type' => $file_info['file_type'],
                    'created_time' => time()
                );
                $db->query($db->insert('table.uforms_files')->rows($file_data));
                error_log('Uforms: Saved file record for: ' . $file_info['original_name']);
            }
            
            // æ›´æ–°è¡¨å•æäº¤è®¡æ•°
            $update_query = $db->update('table.uforms_forms')
                              ->expression('submit_count', 'submit_count + 1')
                              ->where('id = ?', $form['id']);
            $db->query($update_query);
            
            error_log('Uforms: Updated form submit count');
            
            // å‘é€é€šçŸ¥
            self::sendNotifications($form, $form_data, $settings);
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            $success_message = !empty($settings['success_message']) ? 
                              $settings['success_message'] : 
                              'è¡¨å•æäº¤æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„å‚ä¸ã€‚';
            
            error_log('Uforms: Submission completed successfully');
            
            return '<div class="uform-success">' . htmlspecialchars($success_message) . '</div>';
            
        } catch (Exception $e) {
            // è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—
            error_log('Uforms submission error: ' . $e->getMessage());
            error_log('Uforms submission error file: ' . $e->getFile());
            error_log('Uforms submission error line: ' . $e->getLine());
            error_log('Uforms submission error trace: ' . $e->getTraceAsString());
            
            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            return '<div class="uform-error">è¡¨å•æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚é”™è¯¯ï¼š' . htmlspecialchars($e->getMessage()) . '</div>';
        }
    }
    
    public static function renderFormHTML($form, $fields, $config, $settings, $template = 'default', $errors = array(), $form_data = array()) {
        $html = '';
        
        // æ·»åŠ æ ·å¼å¼•ç”¨
        $pluginUrl = Helper::options()->pluginUrl . '/Uforms';
        $html .= '<link rel="stylesheet" href="' . $pluginUrl . '/assets/css/uforms.css">';
        
        // è¡¨å•å®¹å™¨å¼€å§‹
        $html .= '<div class="uform uform-' . htmlspecialchars($form['name']) . '" data-form-name="' . htmlspecialchars($form['name']) . '">';
        
        // è¡¨å•å¤´éƒ¨
        if (!empty($form['title']) || !empty($form['description'])) {
            $html .= '<div class="uform-header">';
            if (!empty($form['title'])) {
                $html .= '<h2 class="uform-title">' . htmlspecialchars($form['title']) . '</h2>';
            }
            if (!empty($form['description'])) {
                $html .= '<div class="uform-description">' . nl2br(htmlspecialchars($form['description'])) . '</div>';
            }
            $html .= '</div>';
        }
        
        // è¡¨å•ä¸»ä½“
        $html .= '<form class="uform-form" method="post" enctype="multipart/form-data" action="">';
        $html .= '<input type="hidden" name="uform_name" value="' . htmlspecialchars($form['name']) . '">';
        
        // CSRFä¿æŠ¤
        $security = Helper::security();
        $html .= $security->getTokenInput();
        
        // æ¸²æŸ“å­—æ®µ
        foreach ($fields as $field) {
            $field_config = json_decode($field['field_config'], true) ?: array();
            $field_errors = isset($errors[$field['field_name']]) ? array($errors[$field['field_name']]) : array();
            $field_value = isset($form_data[$field['field_name']]) ? $form_data[$field['field_name']] : '';
            
            $html .= self::renderField($field, $field_config, $field_errors, $field_value);
        }
        
        // æäº¤æŒ‰é’®
        $submit_text = !empty($settings['submit_text']) ? $settings['submit_text'] : 'æäº¤';
        $html .= '<div class="uform-actions">';
        $html .= '<button type="submit" class="uform-submit btn btn-primary">' . htmlspecialchars($submit_text) . '</button>';
        $html .= '</div>';
        
        $html .= '</form>';
        $html .= '</div>';
        
        // æ·»åŠ JavaScriptå¼•ç”¨
        $html .= '<script src="' . $pluginUrl . '/assets/js/uforms.js"></script>';
        
        return $html;
    }
    
    private static function renderField($field, $config, $errors = array(), $value = '') {
        $type = $field['field_type'];
        $name = $field['field_name'];
        $label = $field['field_label'];
        $required = $field['is_required'];
        
        $html = '<div class="uform-field uform-field-' . $type . '">';
        
        // å­—æ®µæ ‡ç­¾
        if (!in_array($type, array('heading', 'paragraph', 'divider', 'hidden'))) {
            $html .= '<label class="uform-label" for="' . htmlspecialchars($name) . '">';
            $html .= htmlspecialchars($label);
            if ($required) {
                $html .= ' <span class="required-mark">*</span>';
            }
            $html .= '</label>';
        }
        
        // å­—æ®µè¾“å…¥æ§ä»¶
        switch ($type) {
            case 'text':
            case 'email':
            case 'url':
            case 'tel':
                $html .= '<input type="' . $type . '" id="' . htmlspecialchars($name) . '" name="' . htmlspecialchars($name) . '" ';
                $html .= 'value="' . htmlspecialchars($value) . '" ';
                $html .= 'class="uform-input' . (!empty($errors) ? ' error' : '') . '" ';
                if ($required) $html .= 'required ';
                if (isset($config['placeholder'])) {
                    $html .= 'placeholder="' . htmlspecialchars($config['placeholder']) . '" ';
                }
                $html .= '>';
                break;
                
            case 'textarea':
                $html .= '<textarea id="' . htmlspecialchars($name) . '" name="' . htmlspecialchars($name) . '" ';
                $html .= 'class="uform-textarea' . (!empty($errors) ? ' error' : '') . '" ';
                if ($required) $html .= 'required ';
                $html .= 'rows="' . (isset($config['rows']) ? intval($config['rows']) : 4) . '" ';
                if (isset($config['placeholder'])) {
                    $html .= 'placeholder="' . htmlspecialchars($config['placeholder']) . '" ';
                }
                $html .= '>' . htmlspecialchars($value) . '</textarea>';
                break;
                
            case 'select':
                $html .= '<select id="' . htmlspecialchars($name) . '" name="' . htmlspecialchars($name) . '" ';
                $html .= 'class="uform-select' . (!empty($errors) ? ' error' : '') . '" ';
                if ($required) $html .= 'required ';
                $html .= '>';
                
                if (!$required) {
                    $html .= '<option value="">' . (isset($config['placeholder']) ? htmlspecialchars($config['placeholder']) : 'è¯·é€‰æ‹©') . '</option>';
                }
                
                if (isset($config['options']) && is_array($config['options'])) {
                    foreach ($config['options'] as $option) {
                        $selected = $value == $option['value'] ? ' selected' : '';
                        $html .= '<option value="' . htmlspecialchars($option['value']) . '"' . $selected . '>' . htmlspecialchars($option['label']) . '</option>';
                    }
                }
                $html .= '</select>';
                break;
                
            case 'radio':
                $html .= '<div class="uform-radio-group">';
                if (isset($config['options']) && is_array($config['options'])) {
                    foreach ($config['options'] as $option) {
                        $checked = $value == $option['value'] ? ' checked' : '';
                        $html .= '<label class="uform-radio-label">';
                        $html .= '<input type="radio" name="' . htmlspecialchars($name) . '" value="' . htmlspecialchars($option['value']) . '"' . $checked;
                        if ($required) $html .= ' required';
                        $html .= '>';
                        $html .= '<span class="radio-text">' . htmlspecialchars($option['label']) . '</span>';
                        $html .= '</label>';
                    }
                }
                $html .= '</div>';
                break;
                
            case 'checkbox':
                $html .= '<div class="uform-checkbox-group">';
                if (isset($config['options']) && is_array($config['options'])) {
                    $values = is_array($value) ? $value : array($value);
                    foreach ($config['options'] as $option) {
                        $checked = in_array($option['value'], $values) ? ' checked' : '';
                        $html .= '<label class="uform-checkbox-label">';
                        $html .= '<input type="checkbox" name="' . htmlspecialchars($name) . '[]" value="' . htmlspecialchars($option['value']) . '"' . $checked . '>';
                        $html .= '<span class="checkbox-text">' . htmlspecialchars($option['label']) . '</span>';
                        $html .= '</label>';
                    }
                }
                $html .= '</div>';
                break;
                
            case 'hidden':
                $html .= '<input type="hidden" name="' . htmlspecialchars($name) . '" value="' . htmlspecialchars($value) . '">';
                break;
                
            default:
                $html .= '<input type="text" name="' . htmlspecialchars($name) . '" value="' . htmlspecialchars($value) . '" class="uform-input">';
        }
        
        // é”™è¯¯ä¿¡æ¯
        if (!empty($errors)) {
            foreach ($errors as $error) {
                $html .= '<div class="uform-error">' . htmlspecialchars($error) . '</div>';
            }
        }
        
        $html .= '</div>';
        
        return $html;
    }
    
    // æ£€æŸ¥é¢‘ç‡é™åˆ¶
    private static function checkRateLimit($form_id) {
        $db = Typecho_Db::get();
        $ip = UformsHelper::getClientIP();
        $time_limit = time() - 300; // 5åˆ†é’Ÿå†…é™åˆ¶
        
        try {
            $count = $db->fetchObject(
                $db->select('COUNT(*) as count')->from('table.uforms_submissions')
                   ->where('form_id = ? AND ip = ? AND created_time > ?', $form_id, $ip, $time_limit)
            )->count;
            
            return $count < 5; // æ¯5åˆ†é’Ÿæœ€å¤š5æ¬¡æäº¤
        } catch (Exception $e) {
            error_log('Uforms: Rate limit check failed: ' . $e->getMessage());
            return true; // å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œå…è®¸æäº¤
        }
    }
    
    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    public static function handleFileUpload($file, $field, $form_id) {
        if ($file['error'] !== UPLOAD_ERR_OK) {
            return array('success' => false, 'error' => 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼šé”™è¯¯ä»£ç  ' . $file['error']);
        }
        
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!UformsHelper::isAllowedFileType($file['name'])) {
            return array('success' => false, 'error' => 'ä¸å…è®¸çš„æ–‡ä»¶ç±»å‹');
        }
        
        // åˆ›å»ºä¸Šä¼ ç›®å½•
        $upload_dir = __TYPECHO_ROOT_DIR__ . '/usr/uploads/uforms/' . $form_id . '/';
        if (!is_dir($upload_dir)) {
            if (!mkdir($upload_dir, 0755, true)) {
                return array('success' => false, 'error' => 'æ— æ³•åˆ›å»ºä¸Šä¼ ç›®å½•');
            }
        }
        
        // ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å
        $filename = UformsHelper::sanitizeFilename($file['name']);
        $filename = time() . '_' . $filename;
        $file_path = $upload_dir . $filename;
        
        // ç§»åŠ¨ä¸Šä¼ æ–‡ä»¶
        if (move_uploaded_file($file['tmp_name'], $file_path)) {
            return array(
                'success' => true,
                'file_info' => array(
                    'field_name' => $field['field_name'],
                    'original_name' => $file['name'],
                    'filename' => $filename,
                    'file_path' => $file_path,
                    'file_size' => $file['size'],
                    'file_type' => $file['type']
                )
            );
        } else {
            return array('success' => false, 'error' => 'æ–‡ä»¶ä¿å­˜å¤±è´¥');
        }
    }
    
    // å‘é€é€šçŸ¥
    private static function sendNotifications($form, $form_data, $settings) {
        // å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if (!empty($settings['enable_email_notification']) && !empty($settings['notification_email'])) {
            $subject = 'æ–°è¡¨å•æäº¤ï¼š' . $form['title'];
            $message = "è¡¨å•ã€{$form['title']}ã€‘æ”¶åˆ°æ–°çš„æäº¤ï¼š\n\n";
            
            foreach ($form_data as $key => $value) {
                if (is_array($value)) {
                    $value = implode(', ', $value);
                }
                $message .= "$key: $value\n";
            }
            
            $message .= "\næäº¤æ—¶é—´ï¼š" . date('Y-m-d H:i:s');
            $message .= "\nIPåœ°å€ï¼š" . UformsHelper::getClientIP();
            
            UformsHelper::sendEmailNotification($settings['notification_email'], $subject, $message, $form_data);
        }
    }
}
```

### 2. ä¿®å¤ `Action.php` ä¸­çš„å¤„ç†é€»è¾‘

```php
/**
 * æ˜¾ç¤ºè¡¨å•
 */
public function showForm()
{
    $request = $this->request;
    $name = $request->get('name');
    
    if (empty($name)) {
        throw new Typecho_Widget_Exception('è¡¨å•åç§°ä¸èƒ½ä¸ºç©º', 404);
    }
    
    $form = UformsHelper::getFormByName($name);
    if (!$form || $form['status'] !== 'published') {
        throw new Typecho_Widget_Exception('è¡¨å•ä¸å­˜åœ¨æˆ–æœªå‘å¸ƒ', 404);
    }
    
    // å¢åŠ è®¿é—®ç»Ÿè®¡
    $this->trackFormView($form['id']);
    
    // è·å–è¡¨å•å­—æ®µ
    $fields = UformsHelper::getFormFields($form['id']);
    $config = json_decode($form['config'], true) ?: array();
    $settings = json_decode($form['settings'], true) ?: array();
    
    // å¤„ç†è¡¨å•æäº¤
    if ($request->isPost() && $request->get('uform_name') === $name) {
        error_log('Uforms: Form submission detected for form: ' . $name);
        
        // å¤„ç†æäº¤
        $result = UformsFront::handleFormSubmission($form, $fields, $settings);
        
        // æ£€æŸ¥ç»“æœç±»å‹
        if (is_string($result)) {
            if (strpos($result, 'uform-success') !== false) {
                // æäº¤æˆåŠŸï¼Œè¿›è¡Œé‡å®šå‘é¿å…é‡å¤æäº¤
                if (!empty($settings['redirect_url'])) {
                    $this->response->redirect($settings['redirect_url']);
                } else {
                    // é‡å®šå‘åˆ°å½“å‰é¡µé¢å¹¶æ·»åŠ æˆåŠŸæ ‡è®°
                    $redirect_url = Helper::options()->siteUrl . 'uforms/form/' . $name . '?success=1';
                    $this->response->redirect($redirect_url);
                }
                return;
            } else {
                // æœ‰é”™è¯¯ï¼Œæ˜¾ç¤ºè¡¨å•å’Œé”™è¯¯ä¿¡æ¯
                $this->renderFormPage($form, $fields, $config, $settings, $result);
                return;
            }
        }
    }
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    if ($request->get('success') === '1') {
        $success_message = !empty($settings['success_message']) ? 
                          $settings['success_message'] : 
                          'è¡¨å•æäº¤æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„å‚ä¸ã€‚';
        $success_content = '<div class="uform-success">' . htmlspecialchars($success_message) . '</div>';
        $this->renderFormPage($form, $fields, $config, $settings, $success_content);
        return;
    }
    
    // æ¸²æŸ“è¡¨å•é¡µé¢
    $this->renderFormPage($form, $fields, $config, $settings);
}
```

### 3. åˆ›å»ºä¸€ä¸ªæµ‹è¯•é¡µé¢éªŒè¯æ•°æ®åº“

åœ¨ç½‘ç«™æ ¹ç›®å½•åˆ›å»º `debug_uforms.php`ï¼š

```php
<?php
define('__TYPECHO_ROOT_DIR__', dirname(__FILE__));
require_once __TYPECHO_ROOT_DIR__ . '/config.inc.php';

echo "<h2>Uforms è°ƒè¯•ä¿¡æ¯</h2>";

try {
    $db = Typecho_Db::get();
    echo "<p>âœ“ æ•°æ®åº“è¿æ¥æˆåŠŸ</p>";
    
    // æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    $tables = array('uforms_forms', 'uforms_fields', 'uforms_submissions');
    foreach ($tables as $table) {
        try {
            $count = $db->fetchObject($db->select('COUNT(*) as count')->from('table.' . $table))->count;
            echo "<p>âœ“ è¡¨ {$table} å­˜åœ¨ï¼Œè®°å½•æ•°ï¼š{$count}</p>";
        } catch (Exception $e) {
            echo "<p>âœ— è¡¨ {$table} ä¸å­˜åœ¨æˆ–æœ‰é”™è¯¯ï¼š{$e->getMessage()}</p>";
        }
    }
    
    // æµ‹è¯•æ’å…¥æ•°æ®
    echo "<h3>æµ‹è¯•æ•°æ®æ’å…¥</h3>";
    
    $test_data = array(
        'form_id' => 999,
        'data' => json_encode(array('test' => 'value')),
        'ip' => '127.0.0.1',
        'user_agent' => 'Test',
        'status' => 'new',
        'source' => 'test',
        'created_time' => time(),
        'modified_time' => time()
    );
    
    $insert_id = $db->query($db->insert('table.uforms_submissions')->rows($test_data));
    if ($insert_id) {
        echo "<p>âœ“ æµ‹è¯•æ•°æ®æ’å…¥æˆåŠŸï¼ŒIDï¼š{$insert_id}</p>";
        
        // åˆ é™¤æµ‹è¯•æ•°æ®
        $db->query($db->delete('table.uforms_submissions')->where('id = ?', $insert_id));
        echo "<p>âœ“ æµ‹è¯•æ•°æ®å·²æ¸…ç†</p>";
    } else {
        echo "<p>âœ— æµ‹è¯•æ•°æ®æ’å…¥å¤±è´¥</p>";
    }
    
} catch (Exception $e) {
    echo "<p>âœ— æ•°æ®åº“é”™è¯¯ï¼š{$e->getMessage()}</p>";
    echo "<p>é”™è¯¯è·Ÿè¸ªï¼š{$e->getTraceAsString()}</p>";
}

echo "<h3>ç³»ç»Ÿä¿¡æ¯</h3>";
echo "<p>PHPç‰ˆæœ¬ï¼š" . PHP_VERSION . "</p>";
echo "<p>Typechoç‰ˆæœ¬ï¼š" . Typecho_Common::VERSION . "</p>";
echo "<p>é”™è¯¯æ—¥å¿—ä½ç½®ï¼š" . ini_get('error_log') . "</p>";

// æ£€æŸ¥é”™è¯¯æ—¥å¿—
$log_file = __TYPECHO_ROOT_DIR__ . '/error.log';
if (file_exists($log_file)) {
    echo "<h3>æœ€è¿‘çš„é”™è¯¯æ—¥å¿—</h3>";
    $logs = file_get_contents($log_file);
    $recent_logs = substr($logs, -2000); // æœ€å2000ä¸ªå­—ç¬¦
    echo "<pre style='background:#f5f5f5;padding:10px;overflow:auto;max-height:300px;'>" . htmlspecialchars($recent_logs) . "</pre>";
}
?>
```

è®¿é—®è¿™ä¸ªæ–‡ä»¶æ¥æ£€æŸ¥æ•°æ®åº“çŠ¶æ€å’Œæ’ä»¶é…ç½®ã€‚

### 4. æ›´æ–°è·¯ç”±æ³¨å†Œ

åœ¨ `Plugin.php` ä¸­ï¼Œç¡®ä¿è·¯ç”±æ­£ç¡®æ³¨å†Œï¼š

```php
// æ³¨å†Œè·¯ç”± - ä½¿ç”¨æ­£ç¡®çš„å‚æ•°å
Helper::addRoute('uforms_form', '/uforms/form/[name]', 'Uforms_Action', 'showForm');
Helper::addRoute('uforms_form_id', '/uforms/form/id/[id:digital]', 'Uforms_Action', 'showFormById'); 
Helper::addRoute('uforms_submit', '/uforms/submit', 'Uforms_Action', 'submit');
```

ç°åœ¨è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

1. **æ›´æ–°ä»£ç **ï¼šç”¨ä¸Šé¢ä¿®å¤çš„ä»£ç æ›¿æ¢å¯¹åº”æ–‡ä»¶
2. **è®¿é—®è°ƒè¯•é¡µé¢**ï¼šè¿è¡Œ `debug_uforms.php` æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
3. **æŸ¥çœ‹é”™è¯¯æ—¥å¿—**ï¼šæ£€æŸ¥ `/error.log` æ–‡ä»¶ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
4. **æµ‹è¯•è¡¨å•æäº¤**ï¼šé‡æ–°æµ‹è¯•è¡¨å•æäº¤åŠŸèƒ½

è¿™äº›ä¿®æ”¹åº”è¯¥èƒ½è§£å†³è¡¨å•æäº¤ä½†æ•°æ®ä¸ä¿å­˜çš„é—®é¢˜ã€‚å…³é”®ä¿®å¤åŒ…æ‹¬ï¼š

- æ­£ç¡®çš„æ•°æ®åº“è¿æ¥å’Œé”™è¯¯å¤„ç†
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- POST-REDIRECT-GETæ¨¡å¼é¿å…é‡å¤æäº¤
- æ•°æ®åº“æ’å…¥çš„é”™è¯¯æ£€æŸ¥
