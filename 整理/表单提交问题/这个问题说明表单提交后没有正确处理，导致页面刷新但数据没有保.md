## 🤖 Assistant

这个问题说明表单提交后没有正确处理，导致页面刷新但数据没有保存到数据库。让我们来排查和修复这个问题。

## 问题分析

1. "Firefox 必须发送将重复此前操作" 提示说明表单是通过 POST 提交的，但没有正确的重定向
2. 数据没有保存到数据库，说明 `handleFormSubmission` 方法可能有问题
3. 控制台没有报错，可能是服务器端的问题

## 解决方案

### 1. 首先检查 `front.php` 文件中的 `handleFormSubmission` 方法

修改你的 `front.php` 文件：

```php
<?php
if (!defined('__TYPECHO_ROOT_DIR__')) exit;

require_once dirname(__FILE__) . '/frontend-functions.php';

class UformsFront {
    
    public static function renderForm($form_name, $template = 'default') {
        $db = Typecho_Db::get();
        $request = Typecho_Request::getInstance();
        
        try {
            // 获取表单
            $form = $db->fetchRow(
                $db->select('*')->from('table.uforms_forms')
                   ->where('name = ? AND status = ?', $form_name, 'published')
            );
            
            if (!$form) {
                return '<div class="uform-error">表单不存在或未发布</div>';
            }
            
            // 获取表单字段
            $fields = $db->fetchAll(
                $db->select('*')->from('table.uforms_fields')
                   ->where('form_id = ?', $form['id'])
                   ->order('sort_order ASC')
            );
            
            $form_config = json_decode($form['config'], true) ?: array();
            $form_settings = json_decode($form['settings'], true) ?: array();
            
            // 处理表单提交
            if ($request->isPost() && $request->get('uform_name') === $form_name) {
                return self::handleFormSubmission($form, $fields, $form_settings);
            }
            
            // 渲染表单
            return self::renderFormHTML($form, $fields, $form_config, $form_settings, $template);
            
        } catch (Exception $e) {
            return '<div class="uform-error">表单加载失败: ' . htmlspecialchars($e->getMessage()) . '</div>';
        }
    }
    
    public static function handleFormSubmission($form, $fields, $settings) {
        $db = Typecho_Db::get();
        $request = Typecho_Request::getInstance();
        
        error_log('Uforms: handleFormSubmission called for form ID: ' . $form['id']);
        
        $errors = array();
        $form_data = array();
        $uploaded_files = array();
        
        // 验证安全令牌
        $security = Helper::security();
        if (!$security->checkToken($request->get('_token'))) {
            error_log('Uforms: Security token validation failed');
            return '<div class="uform-error">安全验证失败，请重试</div>';
        }
        
        // 检查是否启用表单
        if (isset($settings['enable_forms']) && !$settings['enable_forms']) {
            error_log('Uforms: Form submissions disabled');
            return '<div class="uform-error">表单已禁用</div>';
        }
        
        // 检查频率限制
        if (!self::checkRateLimit($form['id'])) {
            error_log('Uforms: Rate limit exceeded');
            return '<div class="uform-error">提交过于频繁，请稍后再试</div>';
        }
        
        // 验证字段
        foreach ($fields as $field) {
            $field_name = $field['field_name'];
            $field_value = $request->get($field_name);
            $field_config = json_decode($field['field_config'], true) ?: array();
            
            error_log('Uforms: Processing field: ' . $field_name . ' = ' . print_r($field_value, true));
            
            // 处理文件上传
            if ($field['field_type'] === 'file' && isset($_FILES[$field_name])) {
                $file_result = self::handleFileUpload($_FILES[$field_name], $field, $form['id']);
                if ($file_result['success']) {
                    $form_data[$field_name] = $file_result['file_info'];
                    $uploaded_files[] = $file_result['file_info'];
                } else {
                    $errors[$field_name] = $file_result['error'];
                }
                continue;
            }
            
            // 验证必填字段
            if ($field['is_required'] && (empty($field_value) || (is_array($field_value) && count($field_value) === 0))) {
                $errors[$field_name] = '此字段为必填项';
                continue;
            }
            
            // 根据字段类型验证
            if (!empty($field_value)) {
                $validation_errors = UformsHelper::validateField($field['field_type'], $field_value, $field_config);
                if (!empty($validation_errors)) {
                    $errors[$field_name] = implode(', ', $validation_errors);
                }
            }
            
            $form_data[$field_name] = $field_value;
        }
        
        error_log('Uforms: Validation errors: ' . print_r($errors, true));
        error_log('Uforms: Form data: ' . print_r($form_data, true));
        
        // 如果有错误，返回表单
        if (!empty($errors)) {
            $error_html = '<div class="uform-errors"><ul>';
            foreach ($errors as $field => $error) {
                $error_html .= '<li>' . htmlspecialchars($error) . '</li>';
            }
            $error_html .= '</ul></div>';
            return $error_html . self::renderFormHTML($form, $fields, array(), $settings, 'default', $errors, $form_data);
        }
        
        try {
            // 检查垃圾内容
            if (UformsHelper::isSpam($form_data)) {
                UformsHelper::logSpam($form['id'], UformsHelper::getClientIP(), 'spam_keywords', $form_data);
                error_log('Uforms: Spam detected and logged');
                return '<div class="uform-error">提交失败，内容被识别为垃圾信息</div>';
            }
            
            // 开始数据库事务
            $db->query('START TRANSACTION');
            error_log('Uforms: Starting database transaction');
            
            // 保存提交数据
            $submission_data = array(
                'form_id' => $form['id'],
                'data' => json_encode($form_data, JSON_UNESCAPED_UNICODE),
                'ip' => UformsHelper::getClientIP(),
                'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',
                'status' => 'new',
                'source' => 'web',
                'created_time' => time(),
                'modified_time' => time()
            );
            
            error_log('Uforms: Inserting submission data: ' . print_r($submission_data, true));
            
            $submission_id = $db->query($db->insert('table.uforms_submissions')->rows($submission_data));
            
            if (!$submission_id) {
                throw new Exception('Failed to insert submission data');
            }
            
            error_log('Uforms: Submission ID: ' . $submission_id);
            
            // 保存文件记录
            foreach ($uploaded_files as $file_info) {
                $file_data = array(
                    'submission_id' => $submission_id,
                    'form_id' => $form['id'],
                    'field_name' => $file_info['field_name'],
                    'original_name' => $file_info['original_name'],
                    'filename' => $file_info['filename'],
                    'file_path' => $file_info['file_path'],
                    'file_size' => $file_info['file_size'],
                    'file_type' => $file_info['file_type'],
                    'created_time' => time()
                );
                $db->query($db->insert('table.uforms_files')->rows($file_data));
            }
            
            // 更新表单提交计数
            $db->query($db->update('table.uforms_forms')
                          ->expression('submit_count', 'submit_count + 1')
                          ->where('id = ?', $form['id']));
            
            // 提交事务
            $db->query('COMMIT');
            error_log('Uforms: Transaction committed successfully');
            
            // 发送通知
            self::sendNotifications($form, $form_data, $settings);
            
            // 显示成功消息
            $success_message = !empty($settings['success_message']) ? 
                              $settings['success_message'] : 
                              '表单提交成功！感谢您的参与。';
            
            error_log('Uforms: Submission successful');
            
            return '<div class="uform-success">' . htmlspecialchars($success_message) . '</div>';
            
        } catch (Exception $e) {
            // 回滚事务
            $db->query('ROLLBACK');
            
            // 记录错误日志
            error_log('Uforms submission error: ' . $e->getMessage());
            error_log('Uforms submission error trace: ' . $e->getTraceAsString());
            
            // 显示错误消息
            return '<div class="uform-error">表单提交失败，请稍后重试。错误信息：' . htmlspecialchars($e->getMessage()) . '</div>';
        }
    }
    
    public static function renderFormHTML($form, $fields, $config, $settings, $template = 'default', $errors = array(), $form_data = array()) {
        $html = '';
        
        // 添加样式引用
        $pluginUrl = Helper::options()->pluginUrl . '/Uforms';
        $html .= '<link rel="stylesheet" href="' . $pluginUrl . '/assets/css/uforms.css">';
        
        // 表单容器开始
        $html .= '<div class="uform uform-' . htmlspecialchars($form['name']) . '" data-form-name="' . htmlspecialchars($form['name']) . '">';
        
        // 表单头部
        if (!empty($form['title']) || !empty($form['description'])) {
            $html .= '<div class="uform-header">';
            if (!empty($form['title'])) {
                $html .= '<h2 class="uform-title">' . htmlspecialchars($form['title']) . '</h2>';
            }
            if (!empty($form['description'])) {
                $html .= '<div class="uform-description">' . nl2br(htmlspecialchars($form['description'])) . '</div>';
            }
            $html .= '</div>';
        }
        
        // 表单主体
        $html .= '<form class="uform-form" method="post" enctype="multipart/form-data" action="">';
        $html .= '<input type="hidden" name="uform_name" value="' . htmlspecialchars($form['name']) . '">';
        
        // CSRF保护
        $security = Helper::security();
        $html .= $security->getTokenInput();
        
        // 渲染字段
        foreach ($fields as $field) {
            $field_config = json_decode($field['field_config'], true) ?: array();
            $field_errors = isset($errors[$field['field_name']]) ? array($errors[$field['field_name']]) : array();
            $field_value = isset($form_data[$field['field_name']]) ? $form_data[$field['field_name']] : '';
            
            $html .= self::renderField($field, $field_config, $field_errors, $field_value);
        }
        
        // 提交按钮
        $submit_text = !empty($settings['submit_text']) ? $settings['submit_text'] : '提交';
        $html .= '<div class="uform-actions">';
        $html .= '<button type="submit" class="uform-submit btn btn-primary">' . htmlspecialchars($submit_text) . '</button>';
        $html .= '</div>';
        
        $html .= '</form>';
        $html .= '</div>';
        
        // 添加JavaScript引用
        $html .= '<script src="' . $pluginUrl . '/assets/js/uforms.js"></script>';
        
        return $html;
    }
    
    private static function renderField($field, $config, $errors = array(), $value = '') {
        $type = $field['field_type'];
        $name = $field['field_name'];
        $label = $field['field_label'];
        $required = $field['is_required'];
        
        $html = '<div class="uform-field uform-field-' . $type . '">';
        
        // 字段标签
        if (!in_array($type, array('heading', 'paragraph', 'divider', 'hidden'))) {
            $html .= '<label class="uform-label" for="' . htmlspecialchars($name) . '">';
            $html .= htmlspecialchars($label);
            if ($required) {
                $html .= ' <span class="required-mark">*</span>';
            }
            $html .= '</label>';
        }
        
        // 字段输入控件
        switch ($type) {
            case 'text':
            case 'email':
            case 'url':
            case 'tel':
                $html .= '<input type="' . $type . '" id="' . htmlspecialchars($name) . '" name="' . htmlspecialchars($name) . '" ';
                $html .= 'value="' . htmlspecialchars($value) . '" ';
                $html .= 'class="uform-input' . (!empty($errors) ? ' error' : '') . '" ';
                if ($required) $html .= 'required ';
                if (isset($config['placeholder'])) {
                    $html .= 'placeholder="' . htmlspecialchars($config['placeholder']) . '" ';
                }
                $html .= '>';
                break;
                
            case 'textarea':
                $html .= '<textarea id="' . htmlspecialchars($name) . '" name="' . htmlspecialchars($name) . '" ';
                $html .= 'class="uform-textarea' . (!empty($errors) ? ' error' : '') . '" ';
                if ($required) $html .= 'required ';
                $html .= 'rows="' . (isset($config['rows']) ? intval($config['rows']) : 4) . '" ';
                if (isset($config['placeholder'])) {
                    $html .= 'placeholder="' . htmlspecialchars($config['placeholder']) . '" ';
                }
                $html .= '>' . htmlspecialchars($value) . '</textarea>';
                break;
                
            case 'select':
                $html .= '<select id="' . htmlspecialchars($name) . '" name="' . htmlspecialchars($name) . '" ';
                $html .= 'class="uform-select' . (!empty($errors) ? ' error' : '') . '" ';
                if ($required) $html .= 'required ';
                $html .= '>';
                
                if (!$required) {
                    $html .= '<option value="">' . (isset($config['placeholder']) ? htmlspecialchars($config['placeholder']) : '请选择') . '</option>';
                }
                
                if (isset($config['options']) && is_array($config['options'])) {
                    foreach ($config['options'] as $option) {
                        $selected = $value == $option['value'] ? ' selected' : '';
                        $html .= '<option value="' . htmlspecialchars($option['value']) . '"' . $selected . '>' . htmlspecialchars($option['label']) . '</option>';
                    }
                }
                $html .= '</select>';
                break;
                
            case 'radio':
                $html .= '<div class="uform-radio-group">';
                if (isset($config['options']) && is_array($config['options'])) {
                    foreach ($config['options'] as $option) {
                        $checked = $value == $option['value'] ? ' checked' : '';
                        $html .= '<label class="uform-radio-label">';
                        $html .= '<input type="radio" name="' . htmlspecialchars($name) . '" value="' . htmlspecialchars($option['value']) . '"' . $checked;
                        if ($required) $html .= ' required';
                        $html .= '>';
                        $html .= '<span class="radio-text">' . htmlspecialchars($option['label']) . '</span>';
                        $html .= '</label>';
                    }
                }
                $html .= '</div>';
                break;
                
            case 'checkbox':
                $html .= '<div class="uform-checkbox-group">';
                if (isset($config['options']) && is_array($config['options'])) {
                    $values = is_array($value) ? $value : array($value);
                    foreach ($config['options'] as $option) {
                        $checked = in_array($option['value'], $values) ? ' checked' : '';
                        $html .= '<label class="uform-checkbox-label">';
                        $html .= '<input type="checkbox" name="' . htmlspecialchars($name) . '[]" value="' . htmlspecialchars($option['value']) . '"' . $checked . '>';
                        $html .= '<span class="checkbox-text">' . htmlspecialchars($option['label']) . '</span>';
                        $html .= '</label>';
                    }
                }
                $html .= '</div>';
                break;
                
            case 'hidden':
                $html .= '<input type="hidden" name="' . htmlspecialchars($name) . '" value="' . htmlspecialchars($value) . '">';
                break;
                
            default:
                $html .= '<input type="text" name="' . htmlspecialchars($name) . '" value="' . htmlspecialchars($value) . '" class="uform-input">';
        }
        
        // 错误信息
        if (!empty($errors)) {
            foreach ($errors as $error) {
                $html .= '<div class="uform-error">' . htmlspecialchars($error) . '</div>';
            }
        }
        
        $html .= '</div>';
        
        return $html;
    }
    
    // 检查频率限制
    private static function checkRateLimit($form_id) {
        $db = Typecho_Db::get();
        $ip = UformsHelper::getClientIP();
        $time_limit = time() - 60; // 1分钟内限制
        
        $count = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_submissions')
               ->where('form_id = ? AND ip = ? AND created_time > ?', $form_id, $ip, $time_limit)
        )->count;
        
        return $count < 3; // 每分钟最多3次提交
    }
    
    // 处理文件上传
    public static function handleFileUpload($file, $field, $form_id) {
        if ($file['error'] !== UPLOAD_ERR_OK) {
            return array('success' => false, 'error' => '文件上传失败');
        }
        
        // 检查文件类型
        if (!UformsHelper::isAllowedFileType($file['name'])) {
            return array('success' => false, 'error' => '不允许的文件类型');
        }
        
        // 创建上传目录
        $upload_dir = __TYPECHO_ROOT_DIR__ . '/usr/uploads/uforms/' . $form_id . '/';
        if (!is_dir($upload_dir)) {
            if (!mkdir($upload_dir, 0755, true)) {
                return array('success' => false, 'error' => '无法创建上传目录');
            }
        }
        
        // 生成安全的文件名
        $filename = UformsHelper::sanitizeFilename($file['name']);
        $filename = time() . '_' . $filename;
        $file_path = $upload_dir . $filename;
        
        // 移动上传文件
        if (move_uploaded_file($file['tmp_name'], $file_path)) {
            return array(
                'success' => true,
                'file_info' => array(
                    'field_name' => $field['field_name'],
                    'original_name' => $file['name'],
                    'filename' => $filename,
                    'file_path' => $file_path,
                    'file_size' => $file['size'],
                    'file_type' => $file['type']
                )
            );
        } else {
            return array('success' => false, 'error' => '文件保存失败');
        }
    }
    
    // 发送通知
    private static function sendNotifications($form, $form_data, $settings) {
        // 发送邮件通知（如果启用）
        if (!empty($settings['enable_email_notification']) && !empty($settings['notification_email'])) {
            $subject = '新表单提交：' . $form['title'];
            $message = "表单【{$form['title']}】收到新的提交：\n\n";
            
            foreach ($form_data as $key => $value) {
                if (is_array($value)) {
                    $value = implode(', ', $value);
                }
                $message .= "$key: $value\n";
            }
            
            $message .= "\n提交时间：" . date('Y-m-d H:i:s');
            $message .= "\nIP地址：" . UformsHelper::getClientIP();
            
            UformsHelper::sendEmailNotification($settings['notification_email'], $subject, $message, $form_data);
        }
    }
}
```

### 2. 修改 Action.php 中的 showForm 方法

在你的 `Action.php` 文件中，确保在处理完POST请求后有正确的重定向：

```php
// 在 showForm 方法中，处理表单提交的部分
if ($request->isPost() && $request->get('uform_name') === $name) {
    error_log('Uforms: Form submission detected for form: ' . $name);
    
    // 处理提交
    $result = UformsFront::handleFormSubmission($form, $fields, $settings);
    
    if ($request->isAjax()) {
        // AJAX请求处理保持不变...
    } else {
        // 非AJAX请求，处理完成后重定向避免重复提交
        if (is_string($result) && strpos($result, 'uform-success') !== false) {
            // 成功提交后重定向
            if (!empty($settings['redirect_url'])) {
                $this->response->redirect($settings['redirect_url']);
            } else {
                // 重定向到同一页面，但添加成功参数
                $current_url = Helper::options()->siteUrl . 'uforms/form/' . $name . '?submitted=1';
                $this->response->redirect($current_url);
            }
            return;
        } else {
            // 有错误时显示结果
            $this->renderFormPage($form, $fields, $config, $settings, $result);
            return;
        }
    }
}

// 检查是否显示成功消息
if ($request->get('submitted') === '1') {
    $success_message = !empty($settings['success_message']) ? 
                      $settings['success_message'] : 
                      '表单提交成功！感谢您的参与。';
    
    $success_result = '<div class="uform-success">' . htmlspecialchars($success_message) . '</div>';
    $this->renderFormPage($form, $fields, $config, $settings, $success_result);
    return;
}
```

### 3. 检查数据库表结构

确认你的数据库表是否正确创建。运行以下SQL检查：

```sql
SHOW TABLES LIKE '%uforms%';
DESCRIBE typecho_uforms_forms;
DESCRIBE typecho_uforms_fields;
DESCRIBE typecho_uforms_submissions;
```

### 4. 在你的网站根目录创建一个测试文件来验证数据库连接：

创建 `test_uforms.php`：

```php
<?php
define('__TYPECHO_ROOT_DIR__', dirname(__FILE__));
require_once __TYPECHO_ROOT_DIR__ . '/config.inc.php';

try {
    $db = Typecho_Db::get();
    
    // 测试数据库连接
    $result = $db->fetchRow($db->select('COUNT(*) as count')->from('table.uforms_forms'));
    echo "Forms count: " . $result['count'] . "<br>";
    
    // 测试插入
    $test_data = array(
        'name' => 'test_form_' . time(),
        'title' => 'Test Form',
        'description' => 'Test Description',
        'config' => '{}',
        'settings' => '{}',
        'status' => 'published',
        'author_id' => 1,
        'view_count' => 0,
        'submit_count' => 0,
        'created_time' => time(),
        'modified_time' => time()
    );
    
    $form_id = $db->query($db->insert('table.uforms_forms')->rows($test_data));
    echo "Created test form with ID: " . $form_id . "<br>";
    
    // 测试提交数据插入
    $submission_data = array(
        'form_id' => $form_id,
        'data' => json_encode(array('test_field' => 'test_value')),
        'ip' => '127.0.0.1',
        'user_agent' => 'Test Agent',
        'status' => 'new',
        'source' => 'test',
        'created_time' => time(),
        'modified_time' => time()
    );
    
    $submission_id = $db->query($db->insert('table.uforms_submissions')->rows($submission_data));
    echo "Created test submission with ID: " . $submission_id . "<br>";
    
    echo "Database operations successful!";
    
} catch (Exception $e) {
    echo "Error: " . $e->getMessage();
}
?>
```

运行这个测试文件，看看是否有数据库错误。

### 5. 启用更详细的日志记录

在你的 `config.inc.php` 文件中添加：

```php
// 启用错误日志
ini_set('log_errors', 1);
ini_set('error_log', __TYPECHO_ROOT_DIR__ . '/error.log');
error_reporting(E_ALL);
```

这样应该能够解决表单提交但数据不保存到数据库的问题。关键的修改包括：

1. **改进了错误处理和日志记录**
2. **添加了数据库事务支持**
3. **修复了CSRF令牌验证**
4. **改进了POST请求后的重定向逻辑**
5. **增强了字段验证**

请按照这些修改更新你的代码，然后测试表单提交功能。
