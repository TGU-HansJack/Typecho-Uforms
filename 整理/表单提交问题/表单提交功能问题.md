# é»˜è®¤è¯é¢˜

## ğŸ§‘â€ğŸ’» User

æäº¤è¡¨å•å‡ºç°æŠ¥é”™ï¼šCall to undefined method Typecho\Widget\Request::toArray()
Error: Call to undefined method Typecho\Widget\Request::toArray() in /www/wwwroot/tiango.wiki/usr/plugins/Uforms/Action.php:52
Stack trace:
#0 /www/wwwroot/tiango.wiki/var/Typecho/Router.php(99): Uforms_Action->showForm()
#1 /www/wwwroot/tiango.wiki/index.php(23): Typecho\Router::dispatch()
#2 {main}å¹¶ä¸”æäº¤åæ²¡æœ‰æäº¤åˆ°æ•°æ®åº“ï¼Œæ§åˆ¶å°æœ‰æ²¡æœ‰æŠ¥é”™


Uforms/
â”œâ”€â”€ Plugin.php              # æ’ä»¶ä¸»æ–‡ä»¶ï¼ŒåŒ…å«æ¿€æ´»ã€ç¦ç”¨ã€é…ç½®ç­‰æ ¸å¿ƒåŠŸèƒ½
â”œâ”€â”€ index.php               # æ’ä»¶å…¥å£æ–‡ä»¶
â”œâ”€â”€ common.php              # é€šç”¨é…ç½®æ–‡ä»¶
â”œâ”€â”€ Action.php          # åŠ¨ä½œå¤„ç†ç±»ï¼Œå¤„ç†è¡¨å•å±•ç¤ºã€æäº¤ç­‰æ ¸å¿ƒæ“ä½œ
â”œâ”€â”€ admin/                  # åå°ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ admin-functions.php # åå°åŠŸèƒ½å‡½æ•°ï¼ŒåŒ…å«æƒé™éªŒè¯å’ŒUformsHelperç±»å®šä¹‰
â”‚   â”œâ”€â”€ create.php          # è¡¨å•åˆ›å»ºå’Œç¼–è¾‘ç•Œé¢
â”‚   â”œâ”€â”€ index.php           # åå°ç®¡ç†å…¥å£æ–‡ä»¶ï¼ŒåŒ…å«å¯¼èˆªå’Œé¡µé¢è·¯ç”±
â”‚   â”œâ”€â”€ manage.php          # è¡¨å•ç®¡ç†ç•Œé¢
â”‚   â”œâ”€â”€ notifications.php   # é€šçŸ¥ç®¡ç†ç•Œé¢
â”‚   â””â”€â”€ view.php            # è¡¨å•æŸ¥çœ‹ç•Œé¢
â”œâ”€â”€ assets/                 # é™æ€èµ„æºæ–‡ä»¶
â”‚   â”œâ”€â”€ css/                # æ ·å¼æ–‡ä»¶ç›®å½•
â”‚   â”‚   â”œâ”€â”€ admin.css       # åå°ç®¡ç†ç•Œé¢æ ·å¼
â”‚   â”‚   â”œâ”€â”€ create.css      # åˆ›å»ºè¡¨å•ç•Œé¢æ ·å¼
â”‚   â”‚   â”œâ”€â”€ frontend.css    # å‰ç«¯æ ·å¼
â”‚   â”‚   â”œâ”€â”€ manage.css      # ç®¡ç†ç•Œé¢æ ·å¼
â”‚   â”‚   â”œâ”€â”€ notifications.css # é€šçŸ¥ç•Œé¢æ ·å¼
â”‚   â”‚   â”œâ”€â”€ uforms.css      # è¡¨å•ç³»ç»Ÿé€šç”¨æ ·å¼
â”‚   â”‚   â””â”€â”€ view.css        # æŸ¥çœ‹é¡µé¢æ ·å¼
â”‚   â””â”€â”€ js/                 # JavaScriptæ–‡ä»¶ç›®å½•
â”‚       â”œâ”€â”€ admin.js        # åå°ç®¡ç†è„šæœ¬
â”‚       â”œâ”€â”€ frontend.js     # å‰ç«¯è„šæœ¬
â”‚       â”œâ”€â”€ sortable.min.js # æ‹–æ‹½æ’åºåŠŸèƒ½åº“
â”‚       â”œâ”€â”€ uforms.js       # è¡¨å•ç³»ç»Ÿæ ¸å¿ƒè„šæœ¬
â”‚       â””â”€â”€ uformsbuilder.js # è¡¨å•æ„å»ºå™¨æ ¸å¿ƒè„šæœ¬
â”œâ”€â”€ core/                   # æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
 
â”‚   â”œâ”€â”€ UformsHelper.php    # æ ¸å¿ƒè¾…åŠ©å‡½æ•°ç±»
â”‚   â”œâ”€â”€ config.php          # æ’ä»¶é…ç½®å®šä¹‰
â”‚   â””â”€â”€ routes.php          # è·¯ç”±é…ç½®æ–‡ä»¶
â”œâ”€â”€ frontend/               # å‰ç«¯åŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ ajax.php            # Ajaxè¯·æ±‚å¤„ç†
â”‚   â”œâ”€â”€ export.php          # æ•°æ®å¯¼å‡ºåŠŸèƒ½
â”‚   â”œâ”€â”€ front.php           # å‰ç«¯è¡¨å•å±•ç¤ºå’Œå¤„ç†åŠŸèƒ½
â”‚   â””â”€â”€ frontend-functions.php # å‰ç«¯åŠŸèƒ½å‡½æ•°
â”œâ”€â”€ install/                # å®‰è£…æ¨¡å—
â”‚   â””â”€â”€ install.php         # æ’ä»¶å®‰è£…å‘å¯¼ç•Œé¢
â”œâ”€â”€ lib/                    # ç¬¬ä¸‰æ–¹åº“
â”‚   â”œâ”€â”€ PHPMailer/          # é‚®ä»¶å‘é€åº“
â”‚   â”œâ”€â”€ echarts/            # å›¾è¡¨åº“
â”‚   â””â”€â”€ fullcalendar/       # æ—¥å†åŠŸèƒ½åº“
â”œâ”€â”€ templates/              # æ¨¡æ¿æ–‡ä»¶
â”‚   â”œâ”€â”€ calendar.php        # æ—¥å†æ¨¡æ¿
â”‚   â”œâ”€â”€ form-editor.php     # è¡¨å•ç¼–è¾‘å™¨æ¨¡æ¿
â”‚   â”œâ”€â”€ form-preview.php    # è¡¨å•é¢„è§ˆæ¨¡æ¿
â”‚   â””â”€â”€ form.php            # è¡¨å•å±•ç¤ºæ¨¡æ¿
â””â”€â”€ views/                  # è§†å›¾æ–‡ä»¶
    â”œâ”€â”€ analytics.php       # æ•°æ®åˆ†æè§†å›¾
    â”œâ”€â”€ calendar.php        # æ—¥å†è§†å›¾
    â”œâ”€â”€ overview.php        # æ¦‚è§ˆè§†å›¾
    â””â”€â”€ submissions.php     # æäº¤æ•°æ®è§†å›¾

---
## ğŸ¤– Assistant

è¿™ä¸ªé”™è¯¯æ˜¯å› ä¸ºåœ¨Typechoçš„æ–°ç‰ˆæœ¬ä¸­ï¼Œ`Typecho\Widget\Request` ç±»æ²¡æœ‰ `toArray()` æ–¹æ³•ã€‚è®©æˆ‘ä»¬ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼š

## ä¿®å¤ Action.php ç¬¬52è¡Œçš„é”™è¯¯

å°† Action.php æ–‡ä»¶ä¸­ç¬¬52è¡Œçš„ `$request->toArray()` æ›¿æ¢ä¸ºè·å–æ‰€æœ‰POSTæ•°æ®çš„æ­£ç¡®æ–¹æ³•ï¼š

```php
<?php
/**
 * Uforms Actionå¤„ç†ç±»
 */
if (!defined('__TYPECHO_ROOT_DIR__')) exit;

// ç¡®ä¿å¿…è¦çš„æ–‡ä»¶è¢«åŠ è½½
$uformsDir = __DIR__;
require_once $uformsDir . '/core/UformsHelper.php';
require_once $uformsDir . '/frontend/front.php';

class Uforms_Action extends Typecho_Widget implements Widget_Interface_Do
{
    /**
     * æ‰§è¡Œå‡½æ•°
     */
    public function execute()
    {
        // æ ¹æ®ä¸åŒçš„actionæ‰§è¡Œä¸åŒçš„æ–¹æ³•
    }

    /**
     * æ˜¾ç¤ºè¡¨å•
     */
    public function showForm()
    {
        $request = $this->request;
        $name = $request->get('name');
        
        if (empty($name)) {
            throw new Typecho_Widget_Exception('è¡¨å•åç§°ä¸èƒ½ä¸ºç©º', 404);
        }
        
        $form = UformsHelper::getFormByName($name);
        if (!$form || $form['status'] !== 'published') {
            throw new Typecho_Widget_Exception('è¡¨å•ä¸å­˜åœ¨æˆ–æœªå‘å¸ƒ', 404);
        }
        
        // å¢åŠ è®¿é—®ç»Ÿè®¡
        $this->trackFormView($form['id']);
        
        // è·å–è¡¨å•å­—æ®µ
        $fields = UformsHelper::getFormFields($form['id']);
        $config = json_decode($form['config'], true) ?: array();
        $settings = json_decode($form['settings'], true) ?: array();
        
        // å¤„ç†è¡¨å•æäº¤
        if ($request->isPost() && $request->get('uform_name') === $name) {
            error_log('Uforms: Form submission detected for form: ' . $name);
            error_log('Uforms: Is POST request: ' . ($request->isPost() ? 'true' : 'false'));
            error_log('Uforms: Is AJAX request: ' . ($request->isAjax() ? 'true' : 'false'));
            
            // ä¿®å¤ï¼šè·å–æ‰€æœ‰POSTæ•°æ®çš„æ­£ç¡®æ–¹æ³•
            $allRequestData = array();
            foreach ($_POST as $key => $value) {
                $allRequestData[$key] = $request->get($key);
            }
            error_log('Uforms: All request data: ' . print_r($allRequestData, true));
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯AJAXè¯·æ±‚
            if ($request->isAjax()) {
                error_log('Uforms: Processing AJAX request');
                // AJAXè¯·æ±‚ï¼Œè¿”å›JSONå“åº”
                try {
                    $result = UformsFront::handleFormSubmission($form, $fields, $settings);
                    error_log('Uforms: Submission result: ' . $result);
                    
                    if (is_string($result) && strpos($result, 'uform-success') !== false) {
                        // æå–æˆåŠŸæ¶ˆæ¯
                        preg_match('/<div class="uform-success">(.*?)<\/div>/s', $result, $matches);
                        $message = isset($matches[1]) ? $matches[1] : 'æäº¤æˆåŠŸ';
                        
                        error_log('Uforms: Successful submission, sending JSON response');
                        $this->response->throwJson(array(
                            'success' => true,
                            'message' => $message,
                            'redirect' => $settings['redirect_url'] ?? null
                        ));
                    } else if (is_string($result) && strpos($result, 'uform-error') !== false) {
                        // æå–é”™è¯¯ä¿¡æ¯
                        preg_match('/<div class="uform-error">(.*?)<\/div>/s', $result, $matches);
                        $message = isset($matches[1]) ? $matches[1] : 'æäº¤å¤±è´¥';
                        
                        error_log('Uforms: Submission error, sending JSON error response');
                        $this->response->throwJson(array(
                            'success' => false,
                            'message' => $message
                        ));
                    } else {
                        error_log('Uforms: Unknown result type: ' . gettype($result));
                        $this->response->throwJson(array(
                            'success' => false,
                            'message' => 'æœªçŸ¥é”™è¯¯'
                        ));
                    }
                } catch (Exception $e) {
                    error_log('Uforms: Exception in submission: ' . $e->getMessage());
                    $this->response->throwJson(array(
                        'success' => false,
                        'message' => 'æäº¤å¤±è´¥: ' . $e->getMessage()
                    ));
                }
                return; // ç¡®ä¿åœ¨AJAXå“åº”åé€€å‡º
            } else {
                error_log('Uforms: Processing non-AJAX request');
                // éAJAXè¯·æ±‚ï¼Œè¿”å›HTMLå“åº”
                $result = UformsFront::handleFormSubmission($form, $fields, $settings);
                error_log('Uforms: Non-AJAX submission result: ' . (is_string($result) ? $result : gettype($result)));
                
                if (is_string($result)) {
                    // å¦‚æœè¿”å›HTMLï¼ˆæˆåŠŸæˆ–é”™è¯¯æ¶ˆæ¯ï¼‰ï¼Œç›´æ¥æ˜¾ç¤º
                    $this->renderFormPage($form, $fields, $config, $settings, $result);
                    return;
                }
            }
        }
        
        // æ¸²æŸ“è¡¨å•é¡µé¢
        $this->renderFormPage($form, $fields, $config, $settings);
    }

    // ... å…¶ä½™æ–¹æ³•ä¿æŒä¸å˜
    
    /**
     * æ ¹æ®IDæ˜¾ç¤ºè¡¨å•
     */
    public function showFormById()
    {
        $request = $this->request;
        $id = $request->get('id');
        
        if (empty($id)) {
            throw new Typecho_Widget_Exception('è¡¨å•IDä¸èƒ½ä¸ºç©º', 404);
        }
        
        $form = UformsHelper::getForm($id);
        if (!$form || $form['status'] !== 'published') {
            throw new Typecho_Widget_Exception('è¡¨å•ä¸å­˜åœ¨æˆ–æœªå‘å¸ƒ', 404);
        }
        
        // é‡å®šå‘åˆ°åç§°URL
        $this->response->redirect(Helper::options()->siteUrl . 'uforms/form/' . $form['name']);
    }

    /**
     * å¤„ç†è¡¨å•æäº¤
     */
    public function submit()
    {
        if (!$this->request->isPost()) {
            $this->response->throwJson(array('success' => false, 'message' => 'åªæ¥å—POSTè¯·æ±‚'));
        }
        
        $form_name = $this->request->get('uform_name');
        $form_id = $this->request->get('form_id');
        
        if (empty($form_name) && empty($form_id)) {
            $this->response->throwJson(array('success' => false, 'message' => 'è¡¨å•æ ‡è¯†ä¸èƒ½ä¸ºç©º'));
        }
        
        try {
            // è·å–è¡¨å•
            if ($form_name) {
                $form = UformsHelper::getFormByName($form_name);
            } else {
                $form = UformsHelper::getForm($form_id);
            }
            
            if (!$form) {
                throw new Exception('è¡¨å•ä¸å­˜åœ¨');
            }
            
            // è·å–å­—æ®µ
            $fields = UformsHelper::getFormFields($form['id']);
            $settings = json_decode($form['settings'], true) ?: array();
            
            // å¤„ç†æäº¤
            $result = UformsFront::handleFormSubmission($form, $fields, $settings);
            
            if (strpos($result, 'uform-success') !== false) {
                $this->response->throwJson(array(
                    'success' => true, 
                    'message' => strip_tags($result),
                    'redirect' => $settings['redirect_url'] ?? null
                ));
            } else {
                // æå–é”™è¯¯ä¿¡æ¯
                preg_match_all('/<li>(.*?)<\/li>/', $result, $matches);
                $errors = $matches[1] ?: array('æäº¤å¤±è´¥');
                
                $this->response->throwJson(array(
                    'success' => false, 
                    'errors' => $errors
                ));
            }
            
        } catch (Exception $e) {
            $this->response->throwJson(array(
                'success' => false, 
                'message' => 'æäº¤å¤±è´¥: ' . $e->getMessage()
            ));
        }
    }

    /**
     * æ˜¾ç¤ºæ—¥å†
     */
    public function calendar()
    {
        $form_id = $this->request->get('id');
        if (!$form_id) {
            throw new Typecho_Widget_Exception('è¡¨å•IDä¸èƒ½ä¸ºç©º', 404);
        }
        
        $form = UformsHelper::getForm($form_id);
        if (!$form || $form['status'] !== 'published') {
            throw new Typecho_Widget_Exception('è¡¨å•ä¸å­˜åœ¨æˆ–æœªå‘å¸ƒ', 404);
        }
        
        $settings = json_decode($form['settings'], true) ?: array();
        
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨æ—¥å†åŠŸèƒ½
        if (empty($settings['enable_calendar'])) {
            throw new Typecho_Widget_Exception('æ­¤è¡¨å•æœªå¯ç”¨æ—¥å†åŠŸèƒ½', 404);
        }
        
        // æ¸²æŸ“æ—¥å†é¡µé¢
        include __DIR__ . '/templates/calendar.php';
        exit;
    }

    /**
     * APIå¤„ç†å™¨
     */
    public function apiHandler()
    {
        $action = $this->request->get('action');
        
        header('Content-Type: application/json; charset=UTF-8');
        
        try {
            switch ($action) {
                case 'validate':
                    $this->handleApiValidate();
                    break;
                    
                case 'upload':
                    $this->handleApiUpload();
                    break;
                    
                case 'calendar_events':
                    $this->handleApiCalendarEvents();
                    break;
                    
                default:
                    throw new Exception('æœªçŸ¥çš„APIåŠ¨ä½œ');
            }
        } catch (Exception $e) {
            echo json_encode(array(
                'success' => false,
                'message' => $e->getMessage()
            ));
        }
    }

    /**
     * æ¸²æŸ“è¡¨å•é¡µé¢
     */
    private function renderFormPage($form, $fields, $config, $settings, $content = null)
    {
        if (!empty($settings['embed_mode']) && $settings['embed_mode'] === 'iframe') {
            // iframeæ¨¡å¼ï¼Œä½¿ç”¨ç®€å•å¸ƒå±€
            echo '<!DOCTYPE html><html><head><meta charset="UTF-8">';
            echo '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
            echo '<link rel="stylesheet" href="' . Helper::options()->pluginUrl . '/Uforms/assets/css/uforms.css">';
            echo '</head><body style="margin: 0; padding: 20px;">';
            
            if ($content) {
                echo $content;
            } else {
                echo UformsFront::renderFormHTML($form, $fields, $config, $settings, 'iframe');
            }
            
            echo '<script src="' . Helper::options()->pluginUrl . '/Uforms/assets/js/uforms.js"></script>';
            echo '</body></html>';
        } else {
            // å®Œæ•´é¡µé¢æ¨¡å¼
            $form_id = $form['id'];
            include __DIR__ . '/templates/form.php';
        }
        
        exit;
    }

    /**
     * è®°å½•è¡¨å•è®¿é—®
     */
    private function trackFormView($form_id)
    {
        $db = Typecho_Db::get();
        $ip = UformsHelper::getClientIP();
        $user_agent = $_SERVER['HTTP_USER_AGENT'] ?? '';
        
        // è®°å½•è®¿é—®ç»Ÿè®¡
        $stat_data = array(
            'form_id' => $form_id,
            'ip' => $ip,
            'user_agent' => $user_agent,
            'action' => 'view',
            'created_time' => time()
        );
        
        $db->query($db->insert('table.uforms_stats')->rows($stat_data));
        
        // æ›´æ–°è¡¨å•è®¿é—®è®¡æ•°
        $db->query($db->update('table.uforms_forms')
                     ->expression('view_count', 'view_count + 1')
                     ->where('id = ?', $form_id));
    }

    /**
     * å¤„ç†APIéªŒè¯
     */
    private function handleApiValidate()
    {
        $field_type = $this->request->get('field_type');
        $field_value = $this->request->get('field_value');
        $field_config = json_decode($this->request->get('field_config', '{}'), true);
        
        $errors = UformsHelper::validateField($field_type, $field_value, $field_config);
        
        echo json_encode(array(
            'success' => empty($errors),
            'errors' => $errors
        ));
    }

    /**
     * å¤„ç†APIä¸Šä¼ 
     */
    private function handleApiUpload()
    {
        if (!isset($_FILES['file'])) {
            throw new Exception('æ²¡æœ‰ä¸Šä¼ æ–‡ä»¶');
        }
        
        $form_id = $this->request->get('form_id');
        $field_name = $this->request->get('field_name');
        
        $result = UformsFront::handleFileUpload($_FILES['file'], 
                                               array('field_name' => $field_name), 
                                               $form_id);
        
        echo json_encode($result);
    }

    /**
     * å¤„ç†æ—¥å†äº‹ä»¶API
     */
    private function handleApiCalendarEvents()
    {
        $form_id = $this->request->get('form_id');
        $start = $this->request->get('start');
        $end = $this->request->get('end');
        
        $db = Typecho_Db::get();
        $events = array();
        
        // è·å–æ—¥å†äº‹ä»¶
        $calendar_events = $db->fetchAll(
            $db->select('*')->from('table.uforms_calendar')
               ->where('form_id = ? AND start_time >= ? AND start_time <= ?', 
                      $form_id, strtotime($start), strtotime($end))
        );
        
        foreach ($calendar_events as $event) {
            $events[] = array(
                'id' => $event['id'],
                'title' => $event['title'],
                'start' => date('c', $event['start_time']),
                'end' => $event['end_time'] ? date('c', $event['end_time']) : null,
                'allDay' => $event['all_day'],
                'color' => $event['color'],
                'extendedProps' => array(
                    'status' => $event['status'],
                    'description' => $event['event_description']  // ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
                )
            );
        }
        
        echo json_encode(array(
            'success' => true,
            'events' => $events
        ));
    }

    /**
     * å¤„ç†åŠ¨ä½œ - ä¿®å¤æ–¹æ³•
     */
    public function action()
    {
        $request = $this->request;
        $pathInfo = $request->getPathInfo();
        
        // è§£æè·¯å¾„ä¿¡æ¯ç¡®å®šè¦æ‰§è¡Œçš„åŠ¨ä½œ
        if (preg_match('/^\/uforms\/form\/([^\/]+)/', $pathInfo, $matches)) {
            $this->request->setParam('name', $matches[1]);
            $this->showForm();
        } elseif (preg_match('/^\/uforms\/form\/(\d+)/', $pathInfo, $matches)) {
            $this->request->setParam('id', $matches[1]);
            $this->showFormById();
        } elseif (preg_match('/^\/uforms\/calendar\/(\d+)/', $pathInfo, $matches)) {
            $this->request->setParam('id', $matches[1]);
            $this->calendar();
        } elseif (preg_match('/^\/uforms\/api\/([^\/]+)/', $pathInfo, $matches)) {
            $this->apiHandler();
        } elseif (preg_match('/^\/uforms\/submit/', $pathInfo)) {
            $this->submit();
        } else {
            throw new Typecho_Widget_Exception('æœªçŸ¥æ“ä½œ', 404);
        }
    }
}
```

## ä¸»è¦ä¿®å¤å†…å®¹

1. **ä¿®å¤äº†ç¬¬52è¡Œçš„é”™è¯¯**ï¼šå°† `$request->toArray()` æ›¿æ¢ä¸ºéå† `$_POST` æ•°ç»„çš„æ–¹æ³•æ¥è·å–æ‰€æœ‰POSTæ•°æ®ã€‚

2. **å…¼å®¹æ€§æ”¹è¿›**ï¼šä½¿ç”¨æ›´å¥½çš„æ–¹å¼è·å–è¯·æ±‚æ•°æ®ï¼Œå…¼å®¹ä¸åŒç‰ˆæœ¬çš„Typechoã€‚

3. **è°ƒè¯•æ—¥å¿—ä¼˜åŒ–**ï¼šæ”¹è¿›äº†è°ƒè¯•æ—¥å¿—çš„è¾“å‡ºæ–¹å¼ï¼Œæ›´æœ‰åŠ©äºæ’æŸ¥é—®é¢˜ã€‚

ç°åœ¨ä½ å¯ä»¥ï¼š

1. å°†ä¿®å¤åçš„ä»£ç ä¿å­˜åˆ° `Action.php` æ–‡ä»¶ä¸­
2. æµ‹è¯•è¡¨å•æäº¤åŠŸèƒ½
3. æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–é”™è¯¯

å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
- ç¡®ä¿æ‰€æœ‰å¿…éœ€çš„æ–‡ä»¶éƒ½å­˜åœ¨ï¼ˆç‰¹åˆ«æ˜¯ `UformsHelper.php` å’Œ `front.php`ï¼‰
- æ£€æŸ¥æ•°æ®åº“è¿æ¥å’Œè¡¨ç»“æ„
- æŸ¥çœ‹æœåŠ¡å™¨é”™è¯¯æ—¥å¿—è·å–æ›´å¤šä¿¡æ¯

è¿™ä¸ªä¿®å¤åº”è¯¥è§£å†³ `toArray()` æ–¹æ³•æœªå®šä¹‰çš„é”™è¯¯ã€‚

---
## ğŸ§‘â€ğŸ’» User



---
## ğŸ¤– Assistant

åœ¨ä½ çš„ `UformsHelper.php` æ–‡ä»¶ä¸­ç¼ºå°‘äº†ä¸€äº›é‡è¦çš„æ–¹æ³•ï¼Œç‰¹åˆ«æ˜¯ `validateField` æ–¹æ³•å’Œæ•°æ®åº“è¿æ¥æ–¹æ³•ã€‚è®©æˆ‘ä¸ºä½ è¡¥å……å®Œæ•´çš„ä»£ç ï¼š

```php
<?php
if (!defined('__TYPECHO_ROOT_DIR__')) exit;

class UformsHelper {
    
    /**
     * è·å–æ•°æ®åº“è¿æ¥å®ä¾‹
     */
    public static function getDb()
    {
        return Typecho_Db::get();
    }
    
    /**
     * è·å–è¡¨å•URL
     */
    public static function getFormUrl($form_id) {
        return Helper::options()->siteUrl . 'uforms/form/' . $form_id;
    }
    
    /**
     * è·å–è¡¨å•åˆ—è¡¨
     */
    public static function getForms($status = null, $limit = null) {
        $db = Typecho_Db::get();
        $select = $db->select('*')->from('table.uforms_forms');
        
        if ($status) {
            $select->where('status = ?', $status);
        }
        
        if ($limit) {
            $select->limit($limit);
        }
        
        $select->order('modified_time DESC');
        
        return $db->fetchAll($select);
    }
    
    /**
     * è·å–å•ä¸ªè¡¨å•
     */
    public static function getForm($id) {
        $db = Typecho_Db::get();
        return $db->fetchRow(
            $db->select()->from('table.uforms_forms')->where('id = ?', $id)
        );
    }
    
    /**
     * æ ¹æ®åç§°è·å–è¡¨å•
     */
    public static function getFormByName($name) {
        $db = Typecho_Db::get();
        return $db->fetchRow(
            $db->select()->from('table.uforms_forms')
               ->where('name = ? AND status = ?', $name, 'published')
        );
    }
    
    /**
     * è·å–è¡¨å•å­—æ®µ
     */
    public static function getFormFields($form_id) {
        $db = Typecho_Db::get();
        return $db->fetchAll(
            $db->select()->from('table.uforms_fields')
               ->where('form_id = ?', $form_id)
               ->order('sort_order', Typecho_Db::SORT_ASC)
        );
    }
    
    /**
     * è·å–è¡¨å•æäº¤æ•°æ®
     */
    public static function getSubmissions($form_id = null, $limit = 20, $offset = 0) {
        $db = Typecho_Db::get();
        $select = $db->select('*')->from('table.uforms_submissions');
        
        if ($form_id) {
            $select->where('form_id = ?', $form_id);
        }
        
        $select->order('created_time DESC')->limit($limit)->offset($offset);
        
        return $db->fetchAll($select);
    }
    
    /**
     * éªŒè¯å­—æ®µ
     */
    public static function validateField($field_type, $value, $config = array()) {
        $errors = array();
        
        // ç©ºå€¼æ£€æŸ¥
        if (empty($value) && !empty($config['required'])) {
            $errors[] = 'æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹';
            return $errors;
        }
        
        // å¦‚æœå€¼ä¸ºç©ºä¸”ä¸æ˜¯å¿…å¡«é¡¹ï¼Œè·³è¿‡éªŒè¯
        if (empty($value)) {
            return $errors;
        }
        
        // æ ¹æ®å­—æ®µç±»å‹éªŒè¯
        switch ($field_type) {
            case 'email':
                if (!filter_var($value, FILTER_VALIDATE_EMAIL)) {
                    $errors[] = 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€';
                }
                break;
                
            case 'url':
                if (!filter_var($value, FILTER_VALIDATE_URL)) {
                    $errors[] = 'è¯·è¾“å…¥æœ‰æ•ˆçš„URLåœ°å€';
                }
                break;
                
            case 'tel':
            case 'phone':
                if (!preg_match('/^[\d\s\-\+\(\)]+$/', $value)) {
                    $errors[] = 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç”µè¯å·ç ';
                }
                break;
                
            case 'number':
            case 'range':
                if (!is_numeric($value)) {
                    $errors[] = 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—';
                } else {
                    if (isset($config['min']) && $value < $config['min']) {
                        $errors[] = 'æ•°å€¼ä¸èƒ½å°äº ' . $config['min'];
                    }
                    if (isset($config['max']) && $value > $config['max']) {
                        $errors[] = 'æ•°å€¼ä¸èƒ½å¤§äº ' . $config['max'];
                    }
                }
                break;
                
            case 'text':
            case 'textarea':
                if (isset($config['min_length']) && strlen($value) < $config['min_length']) {
                    $errors[] = 'å†…å®¹é•¿åº¦ä¸èƒ½å°‘äº ' . $config['min_length'] . ' ä¸ªå­—ç¬¦';
                }
                if (isset($config['max_length']) && strlen($value) > $config['max_length']) {
                    $errors[] = 'å†…å®¹é•¿åº¦ä¸èƒ½è¶…è¿‡ ' . $config['max_length'] . ' ä¸ªå­—ç¬¦';
                }
                if (isset($config['pattern']) && !preg_match($config['pattern'], $value)) {
                    $errors[] = 'è¾“å…¥æ ¼å¼ä¸æ­£ç¡®';
                }
                break;
                
            case 'date':
                if (!strtotime($value)) {
                    $errors[] = 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸ';
                }
                break;
                
            case 'time':
                if (!preg_match('/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/', $value)) {
                    $errors[] = 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´æ ¼å¼ (HH:MM)';
                }
                break;
                
            case 'datetime':
            case 'datetime-local':
                if (!strtotime($value)) {
                    $errors[] = 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸæ—¶é—´';
                }
                break;
                
            case 'file':
                // æ–‡ä»¶éªŒè¯é€»è¾‘åœ¨æ–‡ä»¶ä¸Šä¼ æ—¶å¤„ç†
                break;
                
            case 'select':
            case 'radio':
                if (isset($config['options']) && is_array($config['options'])) {
                    $valid_options = array();
                    foreach ($config['options'] as $option) {
                        $valid_options[] = $option['value'];
                    }
                    if (!in_array($value, $valid_options)) {
                        $errors[] = 'è¯·é€‰æ‹©æœ‰æ•ˆçš„é€‰é¡¹';
                    }
                }
                break;
                
            case 'checkbox':
                if (isset($config['options']) && is_array($config['options']) && is_array($value)) {
                    $valid_options = array();
                    foreach ($config['options'] as $option) {
                        $valid_options[] = $option['value'];
                    }
                    foreach ($value as $selected_value) {
                        if (!in_array($selected_value, $valid_options)) {
                            $errors[] = 'åŒ…å«æ— æ•ˆçš„é€‰é¡¹';
                            break;
                        }
                    }
                }
                break;
        }
        
        return $errors;
    }
    
    /**
     * åˆ›å»ºé€šçŸ¥
     */
    public static function createNotification($form_id, $type, $title, $message, $data = null) {
        $db = self::getDb();
        
        $notification_data = array(
            'form_id' => $form_id,
            'type' => $type,
            'title' => $title,
            'message' => $message,
            'data' => $data ? json_encode($data) : null,
            'is_read' => 0,
            'created_time' => time()
        );
        
        return $db->query($db->insert('table.uforms_system_notifications')->rows($notification_data));
    }
    
    /**
     * è·å–çŠ¶æ€æ ‡ç­¾
     */
    public static function getStatusLabel($status) {
        $labels = array(
            'new' => 'æœªè¯»',
            'read' => 'å·²è¯»',
            'spam' => 'åƒåœ¾å†…å®¹',
            'deleted' => 'å·²åˆ é™¤',
            'draft' => 'è‰ç¨¿',
            'published' => 'å·²å‘å¸ƒ',
            'archived' => 'å·²å½’æ¡£'
        );
        
        return isset($labels[$status]) ? $labels[$status] : $status;
    }
    
    /**
     * å¯¼å‡ºä¸ºCSV
     */
    public static function exportToCSV($submissions, $fields) {
        $csv_data = array();
        
        // è¡¨å¤´
        $header = array('ID', 'æäº¤æ—¶é—´', 'IPåœ°å€', 'çŠ¶æ€');
        foreach ($fields as $field) {
            $header[] = $field['field_label'];
        }
        $csv_data[] = $header;
        
        // æ•°æ®è¡Œ
        foreach ($submissions as $submission) {
            $row = array(
                $submission['id'],
                self::formatTime($submission['created_time']),
                $submission['ip'],
                self::getStatusLabel($submission['status'])
            );
            
            $form_data = json_decode($submission['data'], true) ?: array();
            foreach ($fields as $field) {
                $value = isset($form_data[$field['field_name']]) ? $form_data[$field['field_name']] : '';
                if (is_array($value)) {
                    $value = implode(', ', $value);
                }
                $row[] = $value;
            }
            
            $csv_data[] = $row;
        }
        
        // ç”ŸæˆCSVå†…å®¹
        $output = '';
        foreach ($csv_data as $row) {
            $output .= '"' . implode('","', array_map('str_replace', array('"', '""'), $row)) . '"' . "\n";
        }
        
        return $output;
    }
    
    /**
     * è·å–ç»Ÿè®¡æ•°æ®
     */
    public static function getStats() {
        $db = Typecho_Db::get();
        
        $total_forms = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_forms')
        )->count;
        
        $published_forms = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_forms')
               ->where('status = ?', 'published')
        )->count;
        
        $total_submissions = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_submissions')
        )->count;
        
        $new_submissions = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_submissions')
               ->where('status = ?', 'new')
        )->count;
        
        return array(
            'total_forms' => $total_forms,
            'published_forms' => $published_forms,
            'total_submissions' => $total_submissions,
            'new_submissions' => $new_submissions
        );
    }
    
    /**
     * æ ¼å¼åŒ–æ—¶é—´
     */
    public static function formatTime($timestamp) {
        return date('Y-m-d H:i:s', $timestamp);
    }
    
    /**
     * è·å–å®¢æˆ·ç«¯IP
     */
    public static function getClientIP() {
        if (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {
            $ips = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);
            return trim($ips[0]);
        } elseif (isset($_SERVER['HTTP_CLIENT_IP'])) {
            return $_SERVER['HTTP_CLIENT_IP'];
        } elseif (isset($_SERVER['REMOTE_ADDR'])) {
            return $_SERVER['REMOTE_ADDR'];
        }
        return '0.0.0.0';
    }
    
    /**
     * å‘é€é‚®ä»¶é€šçŸ¥
     */
    public static function sendEmailNotification($to, $subject, $message, $form_data = array()) {
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨é‚®ä»¶åŠŸèƒ½
        $settings_result = Typecho_Db::get()->fetchRow(
            Typecho_Db::get()->select('value')->from('table.options')
               ->where('name = ?', 'plugin:Uforms')
        );
        
        if (!$settings_result) {
            return false;
        }
        
        $settings = unserialize($settings_result['value']);
        if (empty($settings['enable_email'])) {
            return false;
        }
        
        try {
            // ä½¿ç”¨PHPMailerå‘é€é‚®ä»¶
            $phpmailer_path = dirname(__FILE__) . '/../lib/PHPMailer';
            if (!file_exists($phpmailer_path . '/PHPMailer.php')) {
                error_log('PHPMailer not found at: ' . $phpmailer_path);
                return false;
            }
            
            require_once $phpmailer_path . '/PHPMailer.php';
            require_once $phpmailer_path . '/SMTP.php';
            require_once $phpmailer_path . '/Exception.php';
            
            $mail = new PHPMailer\PHPMailer\PHPMailer();
            
            // SMTPé…ç½®
            if (!empty($settings['smtp_host'])) {
                $mail->isSMTP();
                $mail->Host = $settings['smtp_host'];
                $mail->Port = $settings['smtp_port'] ?: 587;
                $mail->SMTPAuth = true;
                $mail->Username = $settings['smtp_username'];
                $mail->Password = $settings['smtp_password'];
                $mail->SMTPSecure = PHPMailer\PHPMailer\PHPMailer::ENCRYPTION_STARTTLS;
            }
            
            // å‘ä»¶äººå’Œæ”¶ä»¶äºº
            $from_email = !empty($settings['smtp_username']) ? $settings['smtp_username'] : 'noreply@' . parse_url(Helper::options()->siteUrl, PHP_URL_HOST);
            $mail->setFrom($from_email, Helper::options()->title);
            $mail->addAddress($to);
            
            // é‚®ä»¶å†…å®¹
            $mail->isHTML(true);
            $mail->CharSet = 'UTF-8';
            $mail->Subject = $subject;
            $mail->Body = $message;
            
            return $mail->send();
        } catch (Exception $e) {
            error_log('é‚®ä»¶å‘é€å¤±è´¥: ' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * å‘é€Slacké€šçŸ¥
     */
    public static function sendSlackMessage($webhook, $message) {
        if (empty($webhook)) {
            return false;
        }
        
        $payload = json_encode($message);
        
        $ch = curl_init($webhook);
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
        curl_setopt($ch, CURLOPT_POSTFIELDS, $payload);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, array(
            'Content-Type: application/json',
            'Content-Length: ' . strlen($payload)
        ));
        curl_setopt($ch, CURLOPT_TIMEOUT, 10);
        
        $result = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
        
        return $http_code == 200;
    }
    
    /**
     * æ¸…ç†è¿‡æœŸæ•°æ®
     */
    public static function cleanupExpiredData($days = 365) {
        $db = Typecho_Db::get();
        $expire_time = time() - ($days * 24 * 60 * 60);
        
        // åˆ é™¤è¿‡æœŸçš„æäº¤æ•°æ®
        $expired_submissions = $db->fetchAll(
            $db->select('id')->from('table.uforms_submissions')
               ->where('created_time < ? AND status = ?', $expire_time, 'deleted')
        );
        
        foreach ($expired_submissions as $submission) {
            // åˆ é™¤ç›¸å…³æ–‡ä»¶
            $files = $db->fetchAll(
                $db->select('file_path')->from('table.uforms_files')
                   ->where('submission_id = ?', $submission['id'])
            );
            
            foreach ($files as $file) {
                if (file_exists($file['file_path'])) {
                    unlink($file['file_path']);
                }
            }
            
            // åˆ é™¤æ–‡ä»¶è®°å½•
            $db->query($db->delete('table.uforms_files')->where('submission_id = ?', $submission['id']));
        }
        
        // åˆ é™¤è¿‡æœŸæäº¤è®°å½•
        $db->query(
            $db->delete('table.uforms_submissions')
               ->where('created_time < ? AND status = ?', $expire_time, 'deleted')
        );
        
        // åˆ é™¤è¿‡æœŸé€šçŸ¥è®°å½•
        $db->query(
            $db->delete('table.uforms_notifications')
               ->where('created_time < ?', $expire_time)
        );
        
        // åˆ é™¤è¿‡æœŸç³»ç»Ÿé€šçŸ¥
        $db->query(
            $db->delete('table.uforms_system_notifications')
               ->where('created_time < ? AND is_read = ?', $expire_time, 1)
        );
    }
    
    /**
     * ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
     */
    public static function generateRandomString($length = 32) {
        $characters = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
        $charactersLength = strlen($characters);
        $randomString = '';
        for ($i = 0; $i < $length; $i++) {
            $randomString .= $characters[rand(0, $charactersLength - 1)];
        }
        return $randomString;
    }
    
    /**
     * å®‰å…¨çš„æ–‡ä»¶å
     */
    public static function sanitizeFilename($filename) {
        // è·å–æ–‡ä»¶æ‰©å±•å
        $extension = pathinfo($filename, PATHINFO_EXTENSION);
        $basename = pathinfo($filename, PATHINFO_FILENAME);
        
        // ç§»é™¤å±é™©å­—ç¬¦
        $basename = preg_replace('/[^a-zA-Z0-9._-]/', '', $basename);
        
        // é™åˆ¶é•¿åº¦
        if (strlen($basename) > 200) {
            $basename = substr($basename, 0, 200);
        }
        
        // å¦‚æœæ–‡ä»¶åä¸ºç©ºï¼Œç”Ÿæˆä¸€ä¸ª
        if (empty($basename)) {
            $basename = 'file_' . time();
        }
        
        return $basename . ($extension ? '.' . $extension : '');
    }
    
    /**
     * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
     */
    public static function formatFileSize($bytes) {
        if ($bytes === 0) return '0 Bytes';
        
        $k = 1024;
        $sizes = array('Bytes', 'KB', 'MB', 'GB', 'TB');
        $i = floor(log($bytes) / log($k));
        
        return round($bytes / pow($k, $i), 2) . ' ' . $sizes[$i];
    }
    
    /**
     * æ£€æŸ¥æ–‡ä»¶ç±»å‹
     */
    public static function isAllowedFileType($filename, $allowed_types = array()) {
        if (empty($allowed_types)) {
            // è·å–æ’ä»¶é…ç½®ä¸­çš„å…è®¸ç±»å‹
            try {
                $settings_result = Typecho_Db::get()->fetchRow(
                    Typecho_Db::get()->select('value')->from('table.options')
                       ->where('name = ?', 'plugin:Uforms')
                );
                
                if ($settings_result) {
                    $settings = unserialize($settings_result['value']);
                    if (!empty($settings['allowed_file_types'])) {
                        $allowed_types = explode(',', strtolower($settings['allowed_file_types']));
                        $allowed_types = array_map('trim', $allowed_types);
                    }
                }
            } catch (Exception $e) {
                // ä½¿ç”¨é»˜è®¤ç±»å‹
            }
            
            if (empty($allowed_types)) {
                $allowed_types = array('jpg', 'jpeg', 'png', 'gif', 'pdf', 'doc', 'docx', 'txt', 'zip');
            }
        }
        
        $extension = strtolower(pathinfo($filename, PATHINFO_EXTENSION));
        return in_array($extension, $allowed_types);
    }
    
    /**
     * ç”Ÿæˆç¼©ç•¥å›¾
     */
    public static function generateThumbnail($source_path, $thumb_path, $max_width = 200, $max_height = 200) {
        if (!file_exists($source_path)) {
            return false;
        }
        
        // æ£€æŸ¥GDåº“
        if (!extension_loaded('gd')) {
            return false;
        }
        
        $image_info = getimagesize($source_path);
        if (!$image_info) {
            return false;
        }
        
        $width = $image_info[0];
        $height = $image_info[1];
        $mime = $image_info['mime'];
        
        // è®¡ç®—ç¼©ç•¥å›¾å°ºå¯¸
        $ratio = min($max_width / $width, $max_height / $height);
        $new_width = intval($width * $ratio);
        $new_height = intval($height * $ratio);
        
        // åˆ›å»ºç”»å¸ƒ
        $thumb = imagecreatetruecolor($new_width, $new_height);
        
        // æ ¹æ®å›¾ç‰‡ç±»å‹å¤„ç†
        switch ($mime) {
            case 'image/jpeg':
                $source = imagecreatefromjpeg($source_path);
                break;
            case 'image/png':
                $source = imagecreatefrompng($source_path);
                imagealphablending($thumb, false);
                imagesavealpha($thumb, true);
                break;
            case 'image/gif':
                $source = imagecreatefromgif($source_path);
                break;
            default:
                return false;
        }
        
        if (!$source) {
            return false;
        }
        
        // ç”Ÿæˆç¼©ç•¥å›¾
        imagecopyresampled($thumb, $source, 0, 0, 0, 0, $new_width, $new_height, $width, $height);
        
        // ä¿å­˜ç¼©ç•¥å›¾
        $result = false;
        switch ($mime) {
            case 'image/jpeg':
                $result = imagejpeg($thumb, $thumb_path, 90);
                break;
            case 'image/png':
                $result = imagepng($thumb, $thumb_path);
                break;
            case 'image/gif':
                $result = imagegif($thumb, $thumb_path);
                break;
        }
        
        // é‡Šæ”¾èµ„æº
        imagedestroy($source);
        imagedestroy($thumb);
        
        return $result;
    }
    
    /**
     * åˆ é™¤è¡¨å•åŠç›¸å…³æ•°æ®
     */
    public static function deleteForm($formId) {
        $db = self::getDb();
        
        try {
            // å¼€å§‹äº‹åŠ¡ï¼ˆå¦‚æœæ•°æ®åº“æ”¯æŒï¼‰
            $db->query('START TRANSACTION');
            
            // åˆ é™¤è¡¨å•
            $db->query($db->delete('table.uforms_forms')->where('id = ?', $formId));
            
            // åˆ é™¤ç›¸å…³å­—æ®µ
            $db->query($db->delete('table.uforms_fields')->where('form_id = ?', $formId));
            
            // åˆ é™¤ç›¸å…³æ–‡ä»¶
            $files = $db->fetchAll(
                $db->select('file_path')->from('table.uforms_files')
                   ->where('form_id = ?', $formId)
            );
            
            foreach ($files as $file) {
                if (file_exists($file['file_path'])) {
                    unlink($file['file_path']);
                }
            }
            
            $db->query($db->delete('table.uforms_files')->where('form_id = ?', $formId));
            
            // åˆ é™¤ç›¸å…³æäº¤
            $db->query($db->delete('table.uforms_submissions')->where('form_id = ?', $formId));
            
            // åˆ é™¤å…¶ä»–ç›¸å…³æ•°æ®
            $db->query($db->delete('table.uforms_notifications')->where('form_id = ?', $formId));
            $db->query($db->delete('table.uforms_calendar')->where('form_id = ?', $formId));
            $db->query($db->delete('table.uforms_stats')->where('form_id = ?', $formId));
            $db->query($db->delete('table.uforms_system_notifications')->where('form_id = ?', $formId));
            
            // æäº¤äº‹åŠ¡
            $db->query('COMMIT');
            
            return true;
            
        } catch (Exception $e) {
            // å›æ»šäº‹åŠ¡
            $db->query('ROLLBACK');
            error_log('Uforms: Delete form failed: ' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * å¤åˆ¶è¡¨å•
     */
    public static function duplicateForm($originalId, $newName = null, $newTitle = null) {
        $originalForm = self::getForm($originalId);
        if (!$originalForm) {
            return false;
        }
        
        try {
            $user = Typecho_Widget::widget('Widget_User');
            $userId = $user->hasLogin() ? $user->uid : 1;
        } catch (Exception $e) {
            $userId = 1;
        }
        
        $db = self::getDb();
        
        // ç”Ÿæˆå”¯ä¸€åç§°
        if (!$newName) {
            $newName = $originalForm['name'] . '_copy';
            $counter = 1;
            while ($db->fetchRow($db->select('id')->from('table.uforms_forms')->where('name = ?', $newName))) {
                $newName = $originalForm['name'] . '_copy_' . $counter;
                $counter++;
            }
        }
        
        // å‡†å¤‡æ–°è¡¨å•æ•°æ®
        $newData = array(
            'name' => $newName,
            'title' => $newTitle ?: ($originalForm['title'] . ' (å‰¯æœ¬)'),
            'description' => $originalForm['description'],
            'config' => $originalForm['config'],
            'settings' => $originalForm['settings'],
            'status' => 'draft',
            'author_id' => $userId,
            'view_count' => 0,
            'submit_count' => 0,
            'created_time' => time(),
            'modified_time' => time()
        );
        
        // åˆ›å»ºæ–°è¡¨å•
        $newFormId = $db->query($db->insert('table.uforms_forms')->rows($newData));
        
        if ($newFormId) {
            // å¤åˆ¶å­—æ®µ
            $fields = self::getFormFields($originalId);
            foreach ($fields as $field) {
                $fieldData = array(
                    'form_id' => $newFormId,
                    'field_type' => $field['field_type'],
                    'field_name' => $field['field_name'],
                    'field_label' => $field['field_label'],
                    'field_config' => $field['field_config'],
                    'sort_order' => $field['sort_order'],
                    'is_required' => $field['is_required'],
                    'created_time' => time()
                );
                
                $db->query($db->insert('table.uforms_fields')->rows($fieldData));
            }
            
            return $newFormId;
        }
        
        return false;
    }
    
    /**
     * ç”Ÿæˆè¡¨å•åˆ«å
     */
    public static function generateSlug($name, $title) {
        // ä½¿ç”¨è¡¨å•åç§°ä½œä¸ºåŸºç¡€ï¼Œå¦‚æœä¸å¯ç”¨åˆ™ä½¿ç”¨æ ‡é¢˜
        $slug = $name ?: strtolower(preg_replace('/[^a-zA-Z0-9]/', '-', $title));
        $slug = trim($slug, '-');
        
        // ç¡®ä¿å”¯ä¸€æ€§
        $db = self::getDb();
        $baseSlug = $slug;
        $counter = 1;
        
        while ($db->fetchRow($db->select('id')->from('table.uforms_forms')->where('name = ?', $slug))) {
            $slug = $baseSlug . '-' . $counter;
            $counter++;
        }
        
        return $slug;
    }
    
    /**
     * æ£€æŸ¥åƒåœ¾å†…å®¹
     */
    public static function isSpam($data) {
        // ç®€å•çš„åƒåœ¾å†…å®¹æ£€æµ‹
        $spam_keywords = array('viagra', 'casino', 'lottery', 'winner', 'congratulations');
        
        foreach ($data as $value) {
            if (is_string($value)) {
                $value_lower = strtolower($value);
                foreach ($spam_keywords as $keyword) {
                    if (strpos($value_lower, $keyword) !== false) {
                        return true;
                    }
                }
            }
        }
        
        return false;
    }
    
    /**
     * è®°å½•åƒåœ¾å†…å®¹
     */
    public static function logSpam($form_id, $ip, $reason, $data) {
        $db = self::getDb();
        
        $spam_data = array(
            'form_id' => $form_id,
            'ip' => $ip,
            'reason' => $reason,
            'data' => json_encode($data),
            'created_time' => time()
        );
        
        return $db->query($db->insert('table.uforms_spam_log')->rows($spam_data));
    }
}
?>
```

## ä¸»è¦æ–°å¢å’Œä¿®å¤çš„å†…å®¹ï¼š

1. **æ·»åŠ äº† `validateField` æ–¹æ³•** - è¿™æ˜¯ä¹‹å‰ç¼ºå¤±çš„é‡è¦æ–¹æ³•ï¼Œç”¨äºéªŒè¯è¡¨å•å­—æ®µ
2. **æ·»åŠ äº† `getDb` æ–¹æ³•** - ç»Ÿä¸€çš„æ•°æ®åº“è¿æ¥æ–¹æ³• 
3. **æ·»åŠ äº† `createNotification` æ–¹æ³•** - åˆ›å»ºç³»ç»Ÿé€šçŸ¥
4. **æ·»åŠ äº† `getStatusLabel` æ–¹æ³•** - è·å–çŠ¶æ€æ ‡ç­¾
5. **æ·»åŠ äº† `exportToCSV` æ–¹æ³•** - å¯¼å‡ºCSVåŠŸèƒ½
6. **æ”¹è¿›äº†é”™è¯¯å¤„ç†** - åœ¨å„ç§æ“ä½œä¸­æ·»åŠ äº†å¼‚å¸¸å¤„ç†
7. **æ·»åŠ äº†åƒåœ¾å†…å®¹æ£€æµ‹** - `isSpam` å’Œ `logSpam` æ–¹æ³•
8. **ä¿®å¤äº†æ–‡ä»¶ç±»å‹æ£€æŸ¥** - æ”¹è¿›äº† `isAllowedFileType` æ–¹æ³•
9. **æ·»åŠ äº†äº‹åŠ¡æ”¯æŒ** - åœ¨åˆ é™¤è¡¨å•æ—¶ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

ç°åœ¨ä½ çš„ `UformsHelper.php` åº”è¯¥åŒ…å«äº†æ‰€æœ‰å¿…éœ€çš„æ–¹æ³•ã€‚è¯·å°†è¿™ä¸ªæ›´æ–°åçš„ä»£ç ä¿å­˜ï¼Œç„¶åæµ‹è¯•è¡¨å•æäº¤åŠŸèƒ½ã€‚
