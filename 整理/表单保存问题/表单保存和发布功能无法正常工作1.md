# 默认话题

## 🧑‍💻 User

我发现表单保存和发布功能无法正常工作。修改上面问题，发给我完整代码，要求要修改完成的代码完整发给我，要求代码完整，不省略，不修改无需修改部分。（过长就分开发给我，不能省略或者乱删掉功能）

---
## 🤖 Assistant

我发现了问题，主要是一些关键方法缺失和参数不匹配导致的。我将分几个部分发给你完整的修复代码：

## 第一部分：修复 UformsHelper.php

```php
<?php
if (!defined('__TYPECHO_ROOT_DIR__')) exit;

class UformsHelper {
    
    /**
     * 获取表单URL
     */
    public static function getFormUrl($form_id) {
        return Helper::options()->siteUrl . 'uforms/form/' . $form_id;
    }
    
    /**
     * 获取表单列表
     */
    public static function getForms($status = null, $limit = null) {
        $db = Typecho_Db::get();
        $select = $db->select('*')->from('table.uforms_forms');
        
        if ($status) {
            $select->where('status = ?', $status);
        }
        
        if ($limit) {
            $select->limit($limit);
        }
        
        $select->order('modified_time DESC');
        
        return $db->fetchAll($select);
    }
    
    /**
     * 获取单个表单
     */
    public static function getForm($id) {
        $db = Typecho_Db::get();
        return $db->fetchRow(
            $db->select()->from('table.uforms_forms')->where('id = ?', $id)
        );
    }
    
    /**
     * 根据名称获取表单
     */
    public static function getFormByName($name) {
        $db = Typecho_Db::get();
        return $db->fetchRow(
            $db->select()->from('table.uforms_forms')
               ->where('name = ? AND status = ?', $name, 'published')
        );
    }
    
    /**
     * 获取表单字段
     */
    public static function getFormFields($form_id) {
        $db = Typecho_Db::get();
        return $db->fetchAll(
            $db->select()->from('table.uforms_fields')
               ->where('form_id = ?', $form_id)
               ->order('sort_order ASC')
        );
    }
    
    /**
     * 获取表单提交数据
     */
    public static function getSubmissions($form_id = null, $limit = 20, $offset = 0) {
        $db = Typecho_Db::get();
        $select = $db->select('*')->from('table.uforms_submissions');
        
        if ($form_id) {
            $select->where('form_id = ?', $form_id);
        }
        
        $select->order('created_time DESC')->limit($limit)->offset($offset);
        
        return $db->fetchAll($select);
    }
    
    /**
     * 获取统计数据
     */
    public static function getStats() {
        $db = Typecho_Db::get();
        
        $total_forms = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_forms')
        )->count;
        
        $published_forms = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_forms')
               ->where('status = ?', 'published')
        )->count;
        
        $total_submissions = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_submissions')
        )->count;
        
        $new_submissions = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_submissions')
               ->where('status = ?', 'new')
        )->count;
        
        return array(
            'total_forms' => $total_forms,
            'published_forms' => $published_forms,
            'total_submissions' => $total_submissions,
            'new_submissions' => $new_submissions
        );
    }
    
    /**
     * 生成表单slug（新增）
     */
    public static function generateSlug($name, $title = '') {
        $db = Typecho_Db::get();
        
        // 优先使用name，如果name不存在则使用title转换
        if (!empty($name)) {
            $slug = strtolower(trim($name));
        } else {
            $slug = strtolower(trim($title));
        }
        
        // 清理slug：只保留字母、数字、下划线和连字符
        $slug = preg_replace('/[^a-z0-9_-]/', '_', $slug);
        $slug = preg_replace('/_+/', '_', $slug);
        $slug = trim($slug, '_');
        
        if (empty($slug)) {
            $slug = 'form_' . time();
        }
        
        // 检查唯一性
        $originalSlug = $slug;
        $counter = 1;
        
        while (self::slugExists($slug)) {
            $slug = $originalSlug . '_' . $counter;
            $counter++;
        }
        
        return $slug;
    }
    
    /**
     * 检查slug是否存在（新增）
     */
    public static function slugExists($slug) {
        $db = Typecho_Db::get();
        $exists = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_forms')
               ->where('slug = ?', $slug)
        );
        return $exists && $exists->count > 0;
    }
    
    /**
     * 创建表单版本备份（新增）
     */
    public static function createFormVersion($formId, $config, $fieldsConfig, $changelog = '') {
        $db = Typecho_Db::get();
        $user = Typecho_Widget::widget('Widget_User');
        
        try {
            // 获取当前版本号
            $currentVersion = $db->fetchObject(
                $db->select('version')->from('table.uforms_forms')->where('id = ?', $formId)
            );
            
            $newVersion = $currentVersion ? $currentVersion->version + 1 : 1;
            
            // 插入版本记录
            $versionData = array(
                'form_id' => $formId,
                'version' => $newVersion,
                'config' => is_string($config) ? $config : json_encode($config),
                'fields_config' => is_string($fieldsConfig) ? $fieldsConfig : json_encode($fieldsConfig),
                'changelog' => $changelog,
                'created_by' => $user->uid,
                'created_time' => time()
            );
            
            $db->query($db->insert('table.uforms_versions')->rows($versionData));
            
            // 更新表单版本号
            $db->query($db->update('table.uforms_forms')
                         ->rows(array('version' => $newVersion))
                         ->where('id = ?', $formId));
            
            return $newVersion;
        } catch (Exception $e) {
            error_log('Create form version error: ' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * 创建系统通知（新增）
     */
    public static function createSystemNotification($formId, $submissionId, $type, $title, $message, $data = array()) {
        $db = Typecho_Db::get();
        
        try {
            $notificationData = array(
                'form_id' => $formId,
                'submission_id' => $submissionId,
                'type' => $type,
                'title' => $title,
                'message' => $message,
                'data' => json_encode($data),
                'is_read' => 0,
                'created_time' => time()
            );
            
            return $db->query($db->insert('table.uforms_system_notifications')->rows($notificationData));
        } catch (Exception $e) {
            error_log('Create system notification error: ' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * 提交表单数据（新增）
     */
    public static function submitForm($formId, $data, $files = array()) {
        $db = Typecho_Db::get();
        $user = Typecho_Widget::widget('Widget_User');
        
        try {
            // 准备提交数据
            $submissionData = array(
                'form_id' => $formId,
                'data' => json_encode($data),
                'ip' => self::getClientIP(),
                'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',
                'user_id' => $user->hasLogin() ? $user->uid : null,
                'session_id' => session_id(),
                'referrer' => $_SERVER['HTTP_REFERER'] ?? '',
                'status' => 'new',
                'source' => 'web',
                'created_time' => time()
            );
            
            $submissionId = $db->query($db->insert('table.uforms_submissions')->rows($submissionData));
            
            // 处理文件关联
            if (!empty($files)) {
                foreach ($files as $fieldName => $fileInfo) {
                    if (is_array($fileInfo) && isset($fileInfo[0])) {
                        // 多文件
                        foreach ($fileInfo as $file) {
                            self::linkFileToSubmission($submissionId, $formId, $fieldName, $file);
                        }
                    } else {
                        // 单文件
                        self::linkFileToSubmission($submissionId, $formId, $fieldName, $fileInfo);
                    }
                }
            }
            
            // 更新表单统计
            $db->query($db->update('table.uforms_forms')
                         ->expression('submit_count', 'submit_count + 1')
                         ->rows(array('last_submit_time' => time()))
                         ->where('id = ?', $formId));
            
            return $submissionId;
        } catch (Exception $e) {
            error_log('Submit form error: ' . $e->getMessage());
            throw $e;
        }
    }
    
    /**
     * 关联文件到提交记录（新增）
     */
    public static function linkFileToSubmission($submissionId, $formId, $fieldName, $fileInfo) {
        $db = Typecho_Db::get();
        
        try {
            $fileData = array(
                'form_id' => $formId,
                'submission_id' => $submissionId,
                'field_name' => $fieldName,
                'original_name' => $fileInfo['original_name'],
                'filename' => $fileInfo['filename'],
                'file_path' => $fileInfo['path'],
                'file_size' => $fileInfo['size'],
                'file_type' => pathinfo($fileInfo['filename'], PATHINFO_EXTENSION),
                'mime_type' => $fileInfo['mime_type'] ?? '',
                'uploaded_by' => null,
                'created_time' => time()
            );
            
            return $db->query($db->insert('table.uforms_files')->rows($fileData));
        } catch (Exception $e) {
            error_log('Link file to submission error: ' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * 验证字段值（新增）
     */
    public static function validateField($fieldType, $value, $config = array()) {
        $errors = array();
        
        if (empty($value) && $value !== '0') {
            return $errors; // 空值由必填验证处理
        }
        
        switch ($fieldType) {
            case 'email':
                if (!filter_var($value, FILTER_VALIDATE_EMAIL)) {
                    $errors[] = '邮箱格式不正确';
                }
                break;
                
            case 'url':
                if (!filter_var($value, FILTER_VALIDATE_URL)) {
                    $errors[] = '网址格式不正确';
                }
                break;
                
            case 'number':
                if (!is_numeric($value)) {
                    $errors[] = '必须是数字';
                } else {
                    if (isset($config['min']) && floatval($value) < floatval($config['min'])) {
                        $errors[] = '不能小于 ' . $config['min'];
                    }
                    if (isset($config['max']) && floatval($value) > floatval($config['max'])) {
                        $errors[] = '不能大于 ' . $config['max'];
                    }
                }
                break;
                
            case 'tel':
                if (!preg_match('/^[\d\s\-\+\(\)]+$/', $value)) {
                    $errors[] = '电话号码格式不正确';
                }
                break;
        }
        
        // 长度验证
        if (isset($config['minLength']) && mb_strlen($value) < intval($config['minLength'])) {
            $errors[] = '长度不能少于 ' . $config['minLength'] . ' 个字符';
        }
        
        if (isset($config['maxLength']) && mb_strlen($value) > intval($config['maxLength'])) {
            $errors[] = '长度不能超过 ' . $config['maxLength'] . ' 个字符';
        }
        
        // 正则验证
        if (isset($config['pattern']) && !empty($config['pattern'])) {
            if (!preg_match('/' . $config['pattern'] . '/', $value)) {
                $errors[] = $config['errorMessage'] ?? '格式不正确';
            }
        }
        
        return $errors;
    }
    
    /**
     * 计算垃圾内容评分（新增）
     */
    public static function calculateSpamScore($data, $ip) {
        $score = 0;
        $content = is_array($data) ? implode(' ', $data) : $data;
        
        // 检查常见垃圾词汇
        $spamWords = array('viagra', 'casino', 'loan', 'free money', '免费', '赚钱', '贷款');
        foreach ($spamWords as $word) {
            if (stripos($content, $word) !== false) {
                $score += 0.3;
            }
        }
        
        // 检查过多的链接
        $linkCount = substr_count($content, 'http://') + substr_count($content, 'https://');
        if ($linkCount > 2) {
            $score += 0.4;
        }
        
        // 检查重复内容
        if (preg_match('/(.{10,})\1{2,}/', $content)) {
            $score += 0.2;
        }
        
        // 检查IP黑名单（简单实现）
        $blacklistIPs = array('127.0.0.1'); // 示例
        if (in_array($ip, $blacklistIPs)) {
            $score += 0.8;
        }
        
        return min($score, 1.0);
    }
    
    /**
     * 发送通知（新增）
     */
    public static function sendNotification($form, $data, $submissionId) {
        try {
            // 这里可以实现邮件通知、Webhook等
            // 暂时只创建系统通知
            self::createSystemNotification(
                $form['id'],
                $submissionId,
                'new_submission',
                '新的表单提交',
                '表单 "' . $form['title'] . '" 收到新的提交',
                array('submission_id' => $submissionId, 'form_title' => $form['title'])
            );
            
            return true;
        } catch (Exception $e) {
            error_log('Send notification error: ' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * 创建通知（兼容旧版本，新增）
     */
    public static function createNotification($formId, $type, $title, $message, $data = array(), $submissionId = null) {
        return self::createSystemNotification($formId, $submissionId, $type, $title, $message, $data);
    }
    
    /**
     * 获取插件选项（新增）
     */
    public static function getPluginOptions() {
        static $options = null;
        
        if ($options === null) {
            $options = Helper::options()->plugin('Uforms');
            if (!$options) {
                // 返回默认选项对象
                $options = (object) array(
                    'upload_enabled' => 1,
                    'upload_max_size' => 5,
                    'allowed_file_types' => 'jpg,jpeg,png,gif,pdf,doc,docx,txt,zip',
                    'enable_email' => 0,
                    'smtp_host' => '',
                    'smtp_port' => 587,
                    'smtp_username' => '',
                    'smtp_password' => '',
                    'admin_email' => '',
                    'enable_captcha' => 0,
                    'enable_spam_filter' => 1,
                    'rate_limit' => 3,
                    'admin_per_page' => 20
                );
            }
        }
        
        return $options;
    }
    
    /**
     * 格式化时间
     */
    public static function formatTime($timestamp) {
        return date('Y-m-d H:i:s', $timestamp);
    }
    
    /**
     * 获取客户端IP
     */
    public static function getClientIP() {
        if (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {
            return $_SERVER['HTTP_X_FORWARDED_FOR'];
        } elseif (isset($_SERVER['HTTP_CLIENT_IP'])) {
            return $_SERVER['HTTP_CLIENT_IP'];
        } elseif (isset($_SERVER['REMOTE_ADDR'])) {
            return $_SERVER['REMOTE_ADDR'];
        }
        return '0.0.0.0';
    }
    
    /**
     * 发送邮件通知
     */
    public static function sendEmailNotification($to, $subject, $message, $form_data = array()) {
        // 检查是否启用邮件功能
        $settings_result = Typecho_Db::get()->fetchRow(
            Typecho_Db::get()->select('value')->from('table.options')
               ->where('name = ?', 'plugin:Uforms')
        );
        
        if (!$settings_result) {
            return false;
        }
        
        $settings = unserialize($settings_result['value']);
        if (empty($settings['enable_email'])) {
            return false;
        }
        
        // 使用PHPMailer发送邮件
        require_once dirname(__FILE__) . '/../lib/PHPMailer/PHPMailer.php';
        require_once dirname(__FILE__) . '/../lib/PHPMailer/SMTP.php';
        require_once dirname(__FILE__) . '/../lib/PHPMailer/Exception.php';
        
        $mail = new PHPMailer\PHPMailer\PHPMailer();
        
        try {
            // SMTP配置
            if (!empty($settings['smtp_host'])) {
                $mail->isSMTP();
                $mail->Host = $settings['smtp_host'];
                $mail->Port = $settings['smtp_port'] ?: 587;
                $mail->SMTPAuth = true;
                $mail->Username = $settings['smtp_username'];
                $mail->Password = $settings['smtp_password'];
                $mail->SMTPSecure = PHPMailer\PHPMailer\PHPMailer::ENCRYPTION_STARTTLS;
            }
            
            // 发件人和收件人
            $mail->setFrom($settings['smtp_username'], Helper::options()->title);
            $mail->addAddress($to);
            
            // 邮件内容
            $mail->isHTML(true);
            $mail->CharSet = 'UTF-8';
            $mail->Subject = $subject;
            $mail->Body = $message;
            
            return $mail->send();
        } catch (Exception $e) {
            error_log('邮件发送失败: ' . $mail->ErrorInfo);
            return false;
        }
    }
    
    /**
     * 发送Slack通知
     */
    public static function sendSlackMessage($webhook, $message) {
        $payload = json_encode($message);
        
        $ch = curl_init($webhook);
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
        curl_setopt($ch, CURLOPT_POSTFIELDS, $payload);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, array(
            'Content-Type: application/json',
            'Content-Length: ' . strlen($payload)
        ));
        
        $result = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
        
        return $http_code == 200;
    }
    
    /**
     * 清理过期数据
     */
    public static function cleanupExpiredData($days = 365) {
        $db = Typecho_Db::get();
        $expire_time = time() - ($days * 24 * 60 * 60);
        
        // 删除过期的提交数据
        $expired_submissions = $db->fetchAll(
            $db->select('id')->from('table.uforms_submissions')
               ->where('created_time < ? AND status = ?', $expire_time, 'deleted')
        );
        
        foreach ($expired_submissions as $submission) {
            // 删除相关文件
            $files = $db->fetchAll(
                $db->select('file_path')->from('table.uforms_files')
                   ->where('submission_id = ?', $submission['id'])
            );
            
            foreach ($files as $file) {
                if (file_exists($file['file_path'])) {
                    unlink($file['file_path']);
                }
            }
            
            // 删除文件记录
            $db->query($db->delete('table.uforms_files')->where('submission_id = ?', $submission['id']));
        }
        
        // 删除过期提交记录
        $db->query(
            $db->delete('table.uforms_submissions')
               ->where('created_time < ? AND status = ?', $expire_time, 'deleted')
        );
        
        // 删除过期通知记录
        $db->query(
            $db->delete('table.uforms_notifications')
               ->where('created_time < ?', $expire_time)
        );
        
        // 删除过期系统通知
        $db->query(
            $db->delete('table.uforms_system_notifications')
               ->where('created_time < ? AND is_read = ?', $expire_time, 1)
        );
    }
    
    /**
     * 生成随机字符串
     */
    public static function generateRandomString($length = 32) {
        return bin2hex(random_bytes($length / 2));
    }
    
    /**
     * 安全的文件名
     */
    public static function sanitizeFilename($filename) {
        // 移除危险字符
        $filename = preg_replace('/[^a-zA-Z0-9._-]/', '', $filename);
        
        // 限制长度
        if (strlen($filename) > 255) {
            $filename = substr($filename, 0, 255);
        }
        
        return $filename;
    }
    
    /**
     * 格式化文件大小
     */
    public static function formatFileSize($bytes) {
        if ($bytes === 0) return '0 Bytes';
        
        $k = 1024;
        $sizes = array('Bytes', 'KB', 'MB', 'GB', 'TB');
        $i = floor(log($bytes) / log($k));
        
        return round($bytes / pow($k, $i), 2) . ' ' . $sizes[$i];
    }
    
    /**
     * 检查文件类型
     */
    public static function isAllowedFileType($filename, $allowed_types = array()) {
        if (empty($allowed_types)) {
            $allowed_types = array('jpg', 'jpeg', 'png', 'gif', 'pdf', 'doc', 'docx', 'txt');
        }
        
        $extension = strtolower(pathinfo($filename, PATHINFO_EXTENSION));
        return in_array($extension, $allowed_types);
    }
    
    /**
     * 生成缩略图
     */
    public static function generateThumbnail($source_path, $thumb_path, $max_width = 200, $max_height = 200) {
        if (!file_exists($source_path)) {
            return false;
        }
        
        $image_info = getimagesize($source_path);
        if (!$image_info) {
            return false;
        }
        
        $width = $image_info[0];
        $height = $image_info[1];
        $mime = $image_info['mime'];
        
        // 计算缩略图尺寸
        $ratio = min($max_width / $width, $max_height / $height);
        $new_width = $width * $ratio;
        $new_height = $height * $ratio;
        
        // 创建画布
        $thumb = imagecreatetruecolor($new_width, $new_height);
        
        // 根据图片类型处理
        switch ($mime) {
            case 'image/jpeg':
                $source = imagecreatefromjpeg($source_path);
                break;
            case 'image/png':
                $source = imagecreatefrompng($source_path);
                imagealphablending($thumb, false);
                imagesavealpha($thumb, true);
                break;
            case 'image/gif':
                $source = imagecreatefromgif($source_path);
                break;
            default:
                return false;
        }
        
        // 生成缩略图
        imagecopyresampled($thumb, $source, 0, 0, 0, 0, $new_width, $new_height, $width, $height);
        
        // 保存缩略图
        $result = false;
        switch ($mime) {
            case 'image/jpeg':
                $result = imagejpeg($thumb, $thumb_path, 90);
                break;
            case 'image/png':
                $result = imagepng($thumb, $thumb_path);
                break;
            case 'image/gif':
                $result = imagegif($thumb, $thumb_path);
                break;
        }
        
        // 释放资源
        imagedestroy($source);
        imagedestroy($thumb);
        
        return $result;
    }
}
?>
```

## 第二部分：修复 create.php（由于太长，我会分段发送）

```php
<?php if (!defined('__TYPECHO_ROOT_DIR__')) exit; ?>

<div class="main">
    <div class="body container">
<?php
$request = Typecho_Request::getInstance();
$user = Typecho_Widget::widget('Widget_User');
$db = Typecho_Db::get();
$options = Helper::options();

// 检查用户权限
if (!$user->hasLogin() || !$user->pass('administrator')) {
    throw new Typecho_Widget_Exception(_t('禁止访问'), 403);
}

// 加载必要的类文件
if (!class_exists('UformsHelper')) {
    require_once dirname(__FILE__) . '/../core/UformsHelper.php';
}

$form_id = $request->get('id');
$form = null;
$fields = array();

if ($form_id) {
    $form = UformsHelper::getForm($form_id);
    if (!$form || $form['author_id'] != $user->uid) {
        throw new Typecho_Widget_Exception(_t('表单不存在或无权限访问'), 404);
    }
    $fields = UformsHelper::getFormFields($form_id);
}

// 处理AJAX保存请求
if ($request->isPost() && $request->get('action') === 'save_form') {
    header('Content-Type: application/json; charset=UTF-8');
    
    try {
        $form_name = trim($request->get('form_name', ''));
        $form_title = trim($request->get('form_title', ''));
        $form_description = trim($request->get('form_description', ''));
        $form_status = $request->get('form_status', 'draft');
        $form_config = $request->get('form_config', '{}');
        $form_settings = $request->get('form_settings', '{}');
        $fields_config = $request->get('fields_config', '[]');
        $version_notes = $request->get('version_notes', '');
        $auto_save = $request->get('auto_save', false);
        
        // 验证必填字段
        if (empty($form_name)) {
            throw new Exception('表单名称不能为空');
        }
        
        if (!preg_match('/^[a-zA-Z0-9_]+$/', $form_name)) {
            throw new Exception('表单名称只能包含字母、数字和下划线');
        }
        
        if (empty($form_title)) {
            throw new Exception('表单标题不能为空');
        }
        
        // 解析字段配置
        $fields_data = json_decode($fields_config, true);
        if ($fields_data === null) {
            throw new Exception('字段配置格式错误');
        }
        
        if (empty($fields_data)) {
            throw new Exception('表单至少需要包含一个字段');
        }
        
        // 检查表单名称唯一性
        $existing = $db->fetchRow(
            $db->select()->from('table.uforms_forms')
               ->where('name = ? AND id != ?', $form_name, $form_id ?: 0)
        );
        
        if ($existing) {
            throw new Exception('表单名称已存在，请使用其他名称');
        }
        
        $current_time = time();
        
        if ($form_id) {
            // 更新表单
            $update_data = array(
                'name' => $form_name,
                'title' => $form_title,
                'description' => $form_description,
                'config' => $form_config,
                'settings' => $form_settings,
                'status' => $form_status,
                'modified_time' => $current_time
            );
            
            // 如果是发布状态，记录发布时间和生成slug
            if ($form_status === 'published') {
                if ($form['status'] !== 'published') {
                    $update_data['published_time'] = $current_time;
                }
                
                // 生成或更新slug
                if (empty($form['slug'])) {
                    $slug = UformsHelper::generateSlug($form_name, $form_title);
                    $update_data['slug'] = $slug;
                }
            }
            
            $db->query($db->update('table.uforms_forms')
                         ->rows($update_data)
                         ->where('id = ?', $form_id));
            
            // 创建版本备份（仅非自动保存时）
            if (!$auto_save) {
                UformsHelper::createFormVersion($form_id, $form_config, $fields_config, $version_notes);
            }
            
        } else {
            // 创建新表单
            $insert_data = array(
                'name' => $form_name,
                'title' => $form_title,
                'description' => $form_description,
                'config' => $form_config,
                'settings' => $form_settings,
                'status' => $form_status,
                'author_id' => $user->uid,
                'view_count' => 0,
                'submit_count' => 0,
                'created_time' => $current_time,
                'modified_time' => $current_time
            );
            
            if ($form_status === 'published') {
                $insert_data['published_time'] = $current_time;
                $slug = UformsHelper::generateSlug($form_name, $form_title);
                $insert_data['slug'] = $slug;
            }
            
            $form_id = $db->query($db->insert('table.uforms_forms')->rows($insert_data));
        }
        
        // 保存字段配置
        // 删除原有字段
        $db->query($db->delete('table.uforms_fields')->where('form_id = ?', $form_id));
        
        // 插入新字段
        foreach ($fields_data as $index => $field_config) {
            if (empty($field_config['type']) || empty($field_config['name'])) {
                continue; // 跳过无效字段
            }
            
            $field_data = array(
                'form_id' => $form_id,
                'field_type' => $field_config['type'],
                'field_name' => $field_config['name'],
                'field_label' => $field_config['label'] ?: $field_config['name'],
                'field_config' => json_encode($field_config),
                'sort_order' => $field_config['sortOrder'] ?? $index,
                'is_required' => !empty($field_config['required']) ? 1 : 0,
                'is_enabled' => 1,
                'created_time' => $current_time
            );
            
            $db->query($db->insert('table.uforms_fields')->rows($field_data));
        }
        
        // 准备响应数据
        $response_data = array(
            'form_id' => $form_id,
            'status' => $form_status
        );
        
        if ($form_status === 'published') {
            $site_url = $options->siteUrl;
            $form_url = $site_url . 'uforms/form/' . $form_id;
            $response_data['form_url'] = $form_url;
        }
        
        // 发送成功通知
        if ($form_status === 'published' && !$auto_save) {
            UformsHelper::createSystemNotification(
                $form_id,
                null,
                'form_published',
                '表单发布成功',
                "表单 \"{$form_title}\" 已成功发布并可以开始接收用户提交。",
                array('form_url' => $response_data['form_url'] ?? null)
            );
        }
        
        echo json_encode(array(
            'success' => true,
            'message' => $form_status === 'published' ? '表单发布成功' : '表单保存成功',
            'data' => $response_data
        ));
        
    } catch (Exception $e) {
        error_log('Uforms save error: ' . $e->getMessage());
        echo json_encode(array(
            'success' => false, 
            'message' => '保存失败：' . $e->getMessage()
        ));
    }
    exit;
}

// 处理保存模板请求
if ($request->isPost() && $request->get('action') === 'save_template') {
    header('Content-Type: application/json; charset=UTF-8');
    
    try {
        $template_name = trim($request->get('template_name', ''));
        $template_title = trim($request->get('template_title', ''));
        $template_description = trim($request->get('template_description', ''));
        $template_config = $request->get('template_config', '{}');
        $fields_config = $request->get('fields_config', '[]');
        $form_settings = $request->get('form_settings', '{}');
        
        if (empty($template_name)) {
            throw new Exception('模板名称不能为空');
        }
        
        // 检查模板名称唯一性
        $existing = $db->fetchRow(
            $db->select()->from('table.uforms_templates')
               ->where('name = ? AND author_id = ?', $template_name, $user->uid)
        );
        
        if ($existing) {
            throw new Exception('模板名称已存在');
        }
        
        $template_data = array(
            'name' => $template_name,
            'title' => $template_title ?: $template_name,
            'description' => $template_description,
            'config' => $template_config,
            'fields_config' => $fields_config,
            'category' => 'custom',
            'author_id' => $user->uid,
            'usage_count' => 0,
            'created_time' => time(),
            'modified_time' => time()
        );
        
        $db->query($db->insert('table.uforms_templates')->rows($template_data));
        
        echo json_encode(array('success' => true, 'message' => '模板保存成功'));
        
    } catch (Exception $e) {
        echo json_encode(array('success' => false, 'message' => '保存失败：' . $e->getMessage()));
    }
    exit;
}
?>
```

由于代码太长，我需要分几部分发送。这是第一、二部分的修复代码，主要解决了：

1. **UformsHelper.php** 中缺失的关键方法
2. **create.php** 中的保存逻辑修复

接下来我会继续发送其他部分的修复代码。请先测试这两个文件的修复是否解决了保存问题。

---
## 🧑‍💻 User

继续

---
## 🤖 Assistant

## 第三部分：create.php 的 HTML 部分

```php
<div class="uforms-creator">
    <!-- 表单构建器 -->
    <div class="form-builder">
        <!-- 左侧字段库 -->
        <div class="fields-panel">
            <h3><i class="icon-widget">🧩</i> 字段库</h3>
            
            <div class="fields-panel-content">
                <!-- 基础字段 -->
                <div class="field-category">
                    <h4><i class="icon-basic">📝</i> 基础字段</h4>
                    <div class="field-items">
                        <div class="field-item" data-type="text" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-text">📝</i>
                                <span>单行文本</span>
                            </div>
                            <div class="field-description">用于输入短文本内容</div>
                        </div>
                        <div class="field-item" data-type="textarea" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-textarea">📄</i>
                                <span>多行文本</span>
                            </div>
                            <div class="field-description">用于输入长文本内容</div>
                        </div>
                        <div class="field-item" data-type="email" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-email">📧</i>
                                <span>邮箱</span>
                            </div>
                            <div class="field-description">自动验证邮箱格式</div>
                        </div>
                        <div class="field-item" data-type="url" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-url">🔗</i>
                                <span>网址</span>
                            </div>
                            <div class="field-description">自动验证网址格式</div>
                        </div>
                        <div class="field-item" data-type="tel" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-phone">📞</i>
                                <span>电话</span>
                            </div>
                            <div class="field-description">输入电话号码</div>
                        </div>
                        <div class="field-item" data-type="number" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-number">🔢</i>
                                <span>数字</span>
                            </div>
                            <div class="field-description">只能输入数字</div>
                        </div>
                        <div class="field-item" data-type="password" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-password">🔒</i>
                                <span>密码</span>
                            </div>
                            <div class="field-description">密码输入框</div>
                        </div>
                        <div class="field-item" data-type="select" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-select">📋</i>
                                <span>下拉选择</span>
                            </div>
                            <div class="field-description">从选项中选择一项</div>
                        </div>
                        <div class="field-item" data-type="radio" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-radio">⚪</i>
                                <span>单选按钮</span>
                            </div>
                            <div class="field-description">从选项中选择一项</div>
                        </div>
                        <div class="field-item" data-type="checkbox" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-checkbox">☑️</i>
                                <span>复选框</span>
                            </div>
                            <div class="field-description">可选择多个选项</div>
                        </div>
                        <div class="field-item" data-type="file" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-file">📎</i>
                                <span>文件上传</span>
                            </div>
                            <div class="field-description">上传文件或图片</div>
                        </div>
                    </div>
                </div>
                
                <!-- 高级字段 -->
                <div class="field-category">
                    <h4><i class="icon-advanced">⚡</i> 高级字段</h4>
                    <div class="field-items">
                        <div class="field-item" data-type="date" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-date">📅</i>
                                <span>日期选择</span>
                            </div>
                            <div class="field-description">选择日期</div>
                        </div>
                        <div class="field-item" data-type="time" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-time">⏰</i>
                                <span>时间选择</span>
                            </div>
                            <div class="field-description">选择时间</div>
                        </div>
                        <div class="field-item" data-type="datetime" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-datetime">📅⏰</i>
                                <span>日期时间</span>
                            </div>
                            <div class="field-description">选择日期和时间</div>
                        </div>
                        <div class="field-item" data-type="range" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-range">🎚️</i>
                                <span>滑块</span>
                            </div>
                            <div class="field-description">拖拽选择数值</div>
                        </div>
                        <div class="field-item" data-type="rating" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-star">⭐</i>
                                <span>评分</span>
                            </div>
                            <div class="field-description">星级评分选择</div>
                        </div>
                        <div class="field-item" data-type="color" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-color">🎨</i>
                                <span>颜色选择</span>
                            </div>
                            <div class="field-description">选择颜色值</div>
                        </div>
                        <div class="field-item" data-type="signature" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-signature">✍️</i>
                                <span>签名板</span>
                            </div>
                            <div class="field-description">手写签名输入</div>
                        </div>
                        <div class="field-item" data-type="hidden" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-hidden">👁️‍🗨️</i>
                                <span>隐藏字段</span>
                            </div>
                            <div class="field-description">不显示的数据字段</div>
                        </div>
                    </div>
                </div>
                
                <!-- 布局字段 -->
                <div class="field-category">
                    <h4><i class="icon-layout">🏗️</i> 布局字段</h4>
                    <div class="field-items">
                        <div class="field-item" data-type="heading" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-heading">📰</i>
                                <span>标题</span>
                            </div>
                            <div class="field-description">添加章节标题</div>
                        </div>
                        <div class="field-item" data-type="paragraph" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-paragraph">📄</i>
                                <span>段落</span>
                            </div>
                            <div class="field-description">添加说明文字</div>
                        </div>
                        <div class="field-item" data-type="divider" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-divider">➖</i>
                                <span>分割线</span>
                            </div>
                            <div class="field-description">分隔不同区域</div>
                        </div>
                        <div class="field-item" data-type="columns" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-columns">📊</i>
                                <span>多列布局</span>
                            </div>
                            <div class="field-description">创建多列容器</div>
                        </div>
                        <div class="field-item" data-type="html" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-code">💻</i>
                                <span>HTML代码</span>
                            </div>
                            <div class="field-description">自定义HTML内容</div>
                        </div>
                    </div>
                </div>
                
                <!-- 特殊字段 -->
                <div class="field-category">
                    <h4><i class="icon-special">🌟</i> 特殊字段</h4>
                    <div class="field-items">
                        <div class="field-item" data-type="calendar" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-calendar">📅</i>
                                <span>日历预约</span>
                            </div>
                            <div class="field-description">日历预约选择</div>
                        </div>
                        <div class="field-item" data-type="cascade" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-cascade">🔗</i>
                                <span>级联选择</span>
                            </div>
                            <div class="field-description">多级关联选择</div>
                        </div>
                        <div class="field-item" data-type="tags" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-tags">🏷️</i>
                                <span>标签选择</span>
                            </div>
                            <div class="field-description">多标签输入</div>
                        </div>
                        <div class="field-item" data-type="repeater" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-repeat">🔄</i>
                                <span>重复器</span>
                            </div>
                            <div class="field-description">可重复添加的字段组</div>
                        </div>
                    </div>
                </div>

                <!-- 系统字段（Typecho集成） -->
                <div class="field-category">
                    <h4><i class="icon-system">⚙️</i> 系统字段</h4>
                    <div class="field-items">
                        <div class="field-item" data-type="user_name" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-user">👤</i>
                                <span>用户姓名</span>
                            </div>
                            <div class="field-description">获取当前用户姓名</div>
                        </div>
                        <div class="field-item" data-type="user_email" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-user-email">📧👤</i>
                                <span>用户邮箱</span>
                            </div>
                            <div class="field-description">获取当前用户邮箱</div>
                        </div>
                        <div class="field-item" data-type="page_url" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-link">🔗</i>
                                <span>页面URL</span>
                            </div>
                            <div class="field-description">当前页面地址</div>
                        </div>
                        <div class="field-item" data-type="page_title" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-page">📃</i>
                                <span>页面标题</span>
                            </div>
                            <div class="field-description">当前页面标题</div>
                        </div>
                        <div class="field-item" data-type="timestamp" draggable="true">
                            <div class="field-item-header">
                                <i class="icon-time">⏱️</i>
                                <span>时间戳</span>
                            </div>
                            <div class="field-description">当前时间戳</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 中间画布 -->
        <div class="form-canvas">
            <div class="canvas-toolbar">
                <div class="toolbar-left">
                    <button id="preview-desktop" class="preview-btn active" data-view="desktop">
                        <i class="icon-desktop">🖥️</i>桌面
                    </button>
                    <button id="preview-tablet" class="preview-btn" data-view="tablet">
                        <i class="icon-tablet">📱</i>平板
                    </button>
                    <button id="preview-mobile" class="preview-btn" data-view="mobile">
                        <i class="icon-mobile">📲</i>手机
                    </button>
                </div>
                <div class="toolbar-center">
                    <span id="canvas-scale">100%</span>
                </div>
                <div class="toolbar-right">
                    <button id="clear-form" title="清空表单">
                        <i class="icon-trash">🗑️</i>清空
                    </button>
                    <button id="preview-form" title="预览表单">
                        <i class="icon-eye">👁️</i>预览
                    </button>
                    <button id="toggle-grid" title="显示网格">
                        <i class="icon-grid">⌗</i>网格
                    </button>
                </div>
            </div>
            
            <div class="canvas-content" id="form-canvas">
                <div class="canvas-drop-zone" id="canvas-drop-zone">
                    <div class="drop-hint">
                        <div class="drop-icon">
                            <i class="icon-drag">⬇</i>
                        </div>
                        <h3>从左侧拖拽字段到这里开始创建表单</h3>
                        <p>或者点击左侧字段图标快速添加到表单</p>
                        <div class="quick-start">
                            <button class="btn btn-primary" id="add-text-field">
                                <i class="icon-plus">+</i> 添加文本字段
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右侧属性面板 -->
        <div class="properties-panel">
            <div class="panel-tabs">
                <button class="tab-button active" data-tab="field">
                    <i class="icon-field">🔧</i>字段设置
                </button>
                <button class="tab-button" data-tab="form">
                    <i class="icon-form">📋</i>表单设置
                </button>
                <button class="tab-button" data-tab="style">
                    <i class="icon-style">🎨</i>样式设置
                </button>
            </div>
            
            <!-- 字段设置面板 -->
            <div class="tab-content active" id="field-tab">
                <div class="no-selection">
                    <div class="no-selection-icon">
                        <i class="icon-select-field">👆</i>
                    </div>
                    <h4>选择一个字段</h4>
                    <p>点击表单中的字段来配置其属性和行为</p>
                </div>
                
                <div class="field-properties" style="display: none;">
                    <!-- 基本设置 -->
                    <div class="property-group">
                        <h4><i class="icon-basic">⚙️</i> 基本设置</h4>
                        <div class="property-item">
                            <label for="field-label">字段标签 <span class="required">*</span></label>
                            <input type="text" id="field-label" placeholder="输入字段标签" />
                            <div class="field-tip">显示在字段上方的标签文字</div>
                        </div>
                        <div class="property-item">
                            <label for="field-name">字段名称</label>
                            <input type="text" id="field-name" placeholder="字段的唯一标识" />
                            <div class="field-tip">用于表单提交的字段名，留空自动生成</div>
                        </div>
                        <div class="property-item">
                            <label for="field-placeholder">占位符文本</label>
                            <input type="text" id="field-placeholder" placeholder="提示用户输入的文字" />
                            <div class="field-tip">显示在输入框内的提示文字</div>
                        </div>
                        <div class="property-item">
                            <label for="field-default">默认值</label>
                            <input type="text" id="field-default" placeholder="字段的默认值" />
                            <div class="field-tip">字段的初始值</div>
                        </div>
                        <div class="property-item">
                            <label for="field-help">帮助文本</label>
                            <textarea id="field-help" placeholder="字段的详细说明" rows="3"></textarea>
                            <div class="field-tip">显示在字段下方的帮助说明</div>
                        </div>
                        <div class="property-item">
                            <label class="checkbox-label">
                                <input type="checkbox" id="field-required" />
                                <span class="checkbox-mark"></span>
                                设为必填字段
                            </label>
                        </div>
                    </div>
                    
                    <!-- 高级设置 -->
                    <div class="property-group">
                        <h4><i class="icon-advanced">⚡</i> 高级设置</h4>
                        <div class="property-item">
                            <label for="field-css-class">CSS类名</label>
                            <input type="text" id="field-css-class" placeholder="自定义CSS类" />
                            <div class="field-tip">为字段添加自定义CSS类名</div>
                        </div>
                        <div class="property-item">
                            <label for="field-css-id">CSS ID</label>
                            <input type="text" id="field-css-id" placeholder="自定义CSS ID" />
                            <div class="field-tip">为字段设置唯一的CSS ID</div>
                        </div>
                        <div class="property-item">
                            <label for="field-width">字段宽度</label>
                            <select id="field-width">
                                <option value="full">100% - 全宽</option>
                                <option value="half">50% - 半宽</option>
                                <option value="third">33.33% - 三分之一</option>
                                <option value="quarter">25% - 四分之一</option>
                                <option value="auto">自动宽度</option>
                                <option value="custom">自定义</option>
                            </select>
                        </div>
                        <div class="property-item" id="custom-width-input" style="display: none;">
                            <label for="field-custom-width">自定义宽度</label>
                            <div class="input-group">
                                <input type="number" id="field-custom-width" placeholder="数值" />
                                <select id="field-width-unit">
                                    <option value="px">px</option>
                                    <option value="%">%</option>
                                    <option value="rem">rem</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 验证规则 -->
                    <div class="property-group">
                        <h4><i class="icon-validation">✅</i> 验证规则</h4>
                        <div class="property-item">
                            <label for="field-min-length">最小长度</label>
                            <input type="number" id="field-min-length" min="0" placeholder="0" />
                        </div>
                        <div class="property-item">
                            <label for="field-max-length">最大长度</label>
                            <input type="number" id="field-max-length" min="0" placeholder="无限制" />
                        </div>
                        <div class="property-item">
                            <label for="field-pattern">正则表达式</label>
                            <input type="text" id="field-pattern" placeholder="验证模式" />
                            <div class="field-tip">用于验证输入格式的正则表达式</div>
                        </div>
                        <div class="property-item">
                            <label for="field-error-message">错误提示</label>
                            <input type="text" id="field-error-message" placeholder="验证失败时的提示" />
                        </div>
                    </div>
                    
                    <!-- 条件逻辑 -->
                    <div class="property-group">
                        <h4><i class="icon-logic">🧠</i> 条件逻辑</h4>
                        <div class="property-item">
                            <label class="checkbox-label">
                                <input type="checkbox" id="field-conditional" />
                                <span class="checkbox-mark"></span>
                                启用条件显示
                            </label>
                        </div>
                        <div class="conditional-rules" id="conditional-rules" style="display: none;">
                            <div class="rule-builder">
                                <div class="rule-header">
                                    <span>显示此字段当：</span>
                                </div>
                                <div class="rule-item">
                                    <select id="condition-field" class="rule-select">
                                        <option value="">选择字段</option>
                                    </select>
                                    <select id="condition-operator" class="rule-select">
                                        <option value="equals">等于</option>
                                        <option value="not_equals">不等于</option>
                                        <option value="contains">包含</option>
                                        <option value="not_contains">不包含</option>
                                        <option value="empty">为空</option>
                                        <option value="not_empty">不为空</option>
                                        <option value="greater">大于</option>
                                        <option value="less">小于</option>
                                    </select>
                                    <input type="text" id="condition-value" class="rule-input" placeholder="比较值" />
                                    <button type="button" class="rule-remove" title="删除规则">×</button>
                                </div>
                                <button type="button" id="add-condition-rule" class="btn btn-small">
                                    <i class="icon-plus">+</i> 添加条件
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 选项设置（用于select/radio/checkbox） -->
                    <div class="property-group options-group" style="display: none;">
                        <h4><i class="icon-list">📝</i> 选项设置</h4>
                        <div class="options-list" id="options-list">
                            <!-- 选项将通过JavaScript动态生成 -->
                        </div>
                        <div class="options-actions">
                            <button type="button" id="add-option" class="btn btn-small">
                                <i class="icon-plus">+</i> 添加选项
                            </button>
                            <button type="button" id="bulk-add-options" class="btn btn-small">
                                <i class="icon-bulk">📄</i> 批量添加
                            </button>
                        </div>
                        <div class="property-item">
                            <label class="checkbox-label">
                                <input type="checkbox" id="allow-other" />
                                <span class="checkbox-mark"></span>
                                允许用户输入其他选项
                            </label>
                        </div>
                    </div>
                    
                    <!-- 文件上传设置 -->
                    <div class="property-group file-group" style="display: none;">
                        <h4><i class="icon-file">📎</i> 文件上传设置</h4>
                        <div class="property-item">
                            <label for="file-types">允许的文件类型</label>
                            <input type="text" id="file-types" placeholder="jpg,png,pdf" value="jpg,jpeg,png,gif,pdf,doc,docx" />
                            <div class="field-tip">用逗号分隔多个类型</div>
                        </div>
                        <div class="property-item">
                            <label for="file-max-size">最大文件大小(MB)</label>
                            <input type="number" id="file-max-size" value="10" min="1" max="100" />
                        </div>
                        <div class="property-item">
                            <label class="checkbox-label">
                                <input type="checkbox" id="file-multiple" />
                                <span class="checkbox-mark"></span>
                                允许多文件上传
                            </label>
                        </div>
                        <div class="property-item">
                            <label for="file-max-count">最多上传文件数</label>
                            <input type="number" id="file-max-count" value="5" min="1" max="20" />
                        </div>
                    </div>

                    <!-- 数字字段设置 -->
                    <div class="property-group number-group" style="display: none;">
                        <h4><i class="icon-number">🔢</i> 数字设置</h4>
                        <div class="property-item">
                            <label for="number-min">最小值</label>
                            <input type="number" id="number-min" placeholder="无限制" />
                        </div>
                        <div class="property-item">
                            <label for="number-max">最大值</label>
                            <input type="number" id="number-max" placeholder="无限制" />
                        </div>
                        <div class="property-item">
                            <label for="number-step">步长</label>
                            <input type="number" id="number-step" value="1" min="0.01" step="0.01" />
                        </div>
                    </div>

                    <!-- 日期时间设置 -->
                    <div class="property-group datetime-group" style="display: none;">
                        <h4><i class="icon-calendar">📅</i> 日期时间设置</h4>
                        <div class="property-item">
                            <label for="date-min">最早日期</label>
                            <input type="date" id="date-min" />
                        </div>
                        <div class="property-item">
                            <label for="date-max">最晚日期</label>
                            <input type="date" id="date-max" />
                        </div>
                        <div class="property-item">
                            <label for="date-format">日期格式</label>
                            <select id="date-format">
                                <option value="YYYY-MM-DD">2023-12-25</option>
                                <option value="DD/MM/YYYY">25/12/2023</option>
                                <option value="MM/DD/YYYY">12/25/2023</option>
                                <option value="DD-MM-YYYY">25-12-2023</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 表单设置面板 -->
            <div class="tab-content" id="form-tab">
                <div class="property-group">
                    <h4><i class="icon-info">ℹ️</i> 基本信息</h4>
                    <div class="property-item">
                        <label for="form-name">表单名称 <span class="required">*</span></label>
                        <input type="text" id="form-name" value="<?php echo $form ? htmlspecialchars($form['name']) : ''; ?>" placeholder="表单的唯一标识" />
                        <div class="field-tip">用于生成表单URL，只能包含字母、数字和下划线</div>
                    </div>
                    <div class="property-item">
                        <label for="form-title">表单标题 <span class="required">*</span></label>
                        <input type="text" id="form-title" value="<?php echo $form ? htmlspecialchars($form['title']) : ''; ?>" placeholder="表单的显示标题" />
                    </div>
                    <div class="property-item">
                        <label for="form-description">表单描述</label>
                        <textarea id="form-description" rows="3" placeholder="表单的详细说明"><?php echo $form ? htmlspecialchars($form['description']) : ''; ?></textarea>
                    </div>
                </div>
                
                <div class="property-group">
                    <h4><i class="icon-submit">📤</i> 提交设置</h4>
                    <div class="property-item">
                        <label for="submit-text">提交按钮文本</label>
                        <input type="text" id="submit-text" value="提交" />
                    </div>
                    <div class="property-item">
                        <label for="success-message">成功消息</label>
                        <textarea id="success-message" rows="2">表单提交成功！感谢您的参与。</textarea>
                    </div>
                    <div class="property-item">
                        <label for="success-action">成功后行为</label>
                        <select id="success-action">
                            <option value="message">显示消息</option>
                            <option value="redirect">跳转页面</option>
                            <option value="refresh">刷新页面</option>
                            <option value="block">显示内容区块</option>
                        </select>
                    </div>
                    <div class="property-item" id="redirect-url-setting" style="display: none;">
                        <label for="redirect-url">跳转地址</label>
                        <input type="url" id="redirect-url" placeholder="https://example.com/thanks" />
                    </div>
                    <div class="property-item" id="success-block-setting" style="display: none;">
                        <label for="success-block">成功内容</label>
                        <textarea id="success-block" rows="4" placeholder="成功后要显示的HTML内容"></textarea>
                    </div>
                    <div class="property-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="ajax-submit" checked />
                            <span class="checkbox-mark"></span>
                            使用AJAX提交（无刷新提交）
                        </label>
                    </div>
                    <div class="property-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="prevent-duplicate" />
                            <span class="checkbox-mark"></span>
                            防止重复提交
                        </label>
                    </div>
                </div>
                
                <div class="property-group">
                    <h4><i class="icon-security">🔒</i> 安全设置</h4>
                    <div class="property-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="enable-captcha" />
                            <span class="checkbox-mark"></span>
                            启用验证码
                        </label>
                    </div>
                    <div class="property-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="enable-honeypot" checked />
                            <span class="checkbox-mark"></span>
                            启用蜜罐防spam
                        </label>
                    </div>
                    <div class="property-item">
                        <label for="submit-limit">提交限制(秒)</label>
                        <input type="number" id="submit-limit" value="60" min="0" />
                        <div class="field-tip">同一IP再次提交的最小间隔时间</div>
                    </div>
                    <div class="property-item">
                        <label for="max-submissions">最大提交次数</label>
                        <input type="number" id="max-submissions" value="0" min="0" />
                        <div class="field-tip">表单最多接受的提交次数，0表示无限制</div>
                    </div>
                </div>
                
                <div class="property-group">
                    <h4><i class="icon-email">📧</i> 邮件通知</h4>
                    <div class="property-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="admin-notification" />
                            <span class="checkbox-mark"></span>
                            发送管理员通知
                        </label>
                    </div>
                    <div class="admin-notification-settings" id="admin-notification-settings" style="display: none;">
                        <div class="property-item">
                            <label for="admin-email">收件人邮箱</label>
                            <input type="email" id="admin-email" placeholder="多个邮箱用逗号分隔" />
                        </div>
                        <div class="property-item">
                            <label for="admin-subject">邮件主题</label>
                            <input type="text" id="admin-subject" value="新的表单提交 - {form_title}" />
                        </div>
                        <div class="property-item">
                            <label for="admin-message">邮件内容</label>
                            <textarea id="admin-message" rows="6">您收到一个新的表单提交：

{all_fields}

提交时间：{submit_time}
IP地址：{ip_address}
用户代理：{user_agent}</textarea>
                            <div class="field-tip">
                                可用变量：{form_title}, {all_fields}, {submit_time}, {ip_address}, {user_agent}
                            </div>
                        </div>
                    </div>
                    
                    <div class="property-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="user-notification" />
                            <span class="checkbox-mark"></span>
                            发送用户确认邮件
                        </label>
                    </div>
                    <div class="user-notification-settings" id="user-notification-settings" style="display: none;">
                        <div class="property-item">
                            <label for="user-email-field">用户邮箱字段</label>
                            <select id="user-email-field">
                                <option value="">选择邮箱字段</option>
                            </select>
                        </div>
                        <div class="property-item">
                            <label for="user-subject">邮件主题</label>
                            <input type="text" id="user-subject" value="表单提交确认 - {form_title}" />
                        </div>
                        <div class="property-item">
                            <label for="user-message">邮件内容</label>
                            <textarea id="user-message" rows="6">感谢您的提交！

我们已收到您的表单信息，将尽快处理。

您的提交内容：
{all_fields}

如有疑问，请联系我们。</textarea>
                        </div>
                    </div>
                </div>

                <div class="property-group">
                    <h4><i class="icon-webhook">🔗</i> 第三方集成</h4>
                    <div class="property-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="enable-webhook" />
                            <span class="checkbox-mark"></span>
                            启用Webhook
                        </label>
                    </div>
                    <div class="webhook-settings" id="webhook-settings" style="display: none;">
                        <div class="property-item">
                            <label for="webhook-url">Webhook URL</label>
                            <input type="url" id="webhook-url" placeholder="https://example.com/webhook" />
                        </div>
                        <div class="property-item">
                            <label for="webhook-secret">密钥</label>
                            <input type="text" id="webhook-secret" placeholder="用于验证的密钥" />
                            <div class="field-tip">用于验证请求来源的密钥</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 样式设置面板 -->
            <div class="tab-content" id="style-tab">
                <div class="property-group">
                    <h4><i class="icon-theme">🎨</i> 表单样式</h4>
                    <div class="property-item">
                        <label for="form-theme">样式主题</label>
                        <select id="form-theme">
                            <option value="default">默认样式</option>
                            <option value="minimal">简约风格</option>
                            <option value="modern">现代风格</option>
                            <option value="classic">经典风格</option>
                            <option value="bootstrap">Bootstrap风格</option>
                            <option value="material">Material Design</option>
                        </select>
                        <div class="theme-preview" id="theme-preview">
                            <div class="preview-box">主题预览</div>
                        </div>
                    </div>
                    <div class="property-item">
                        <label for="primary-color">主色调</label>
                        <div class="color-picker-group">
                            <input type="color" id="primary-color" value="#3788d8" />
                            <input type="text" id="primary-color-text" value="#3788d8" />
                        </div>
                    </div>
                    <div class="property-item">
                        <label for="form-width">表单宽度</label>
                        <input type="text" id="form-width" value="100%" placeholder="如: 100%, 800px" />
                    </div>
                    <div class="property-item">
                        <label for="form-max-width">最大宽度</label>
                        <input type="text" id="form-max-width" placeholder="如: 800px, none" />
                    </div>
                </div>
                
                <div class="property-group">
                    <h4><i class="icon-layout">🏗️</i> 布局设置</h4>
                    <div class="property-item">
                        <label for="label-position">标签位置</label>
                        <select id="label-position">
                            <option value="top">顶部</option>
                            <option value="left">左侧</option>
                            <option value="inside">内部（浮动标签）</option>
                            <option value="hidden">隐藏</option>
                        </select>
                    </div>
                    <div class="property-item">
                        <label for="field-spacing">字段间距</label>
                        <input type="range" id="field-spacing" min="0" max="40" value="20" />
                        <span class="range-value">20px</span>
                    </div>
                    <div class="property-item">
                        <label for="form-padding">表单内边距</label>
                        <input type="range" id="form-padding" min="0" max="60" value="20" />
                        <span class="range-value">20px</span>
                    </div>
                </div>
                
                <div class="property-group">
                    <h4><i class="icon-style">✨</i> 字段样式</h4>
                    <div class="property-item">
                        <label for="input-border-radius">输入框圆角</label>
                        <input type="range" id="input-border-radius" min="0" max="20" value="4" />
                        <span class="range-value">4px</span>
                    </div>
                    <div class="property-item">
                        <label for="input-border-width">边框粗细</label>
                        <input type="range" id="input-border-width" min="0" max="5" value="1" />
                        <span class="range-value">1px</span>
                    </div>
                    <div class="property-item">
                        <label for="input-height">输入框高度</label>
                        <input type="range" id="input-height" min="30" max="60" value="40" />
                        <span class="range-value">40px</span>
                    </div>
                </div>

                <div class="property-group">
                    <h4><i class="icon-color">🌈</i> 颜色配置</h4>
                    <div class="color-grid">
                        <div class="color-item">
                            <label>背景色</label>
                            <input type="color" id="bg-color" value="#ffffff" />
                        </div>
                        <div class="color-item">
                            <label>文字色</label>
                            <input type="color" id="text-color" value="#333333" />
                        </div>
                        <div class="color-item">
                            <label>边框色</label>
                            <input type="color" id="border-color" value="#dddddd" />
                        </div>
                        <div class="color-item">
                            <label>错误色</label>
                            <input type="color" id="error-color" value="#e74c3c" />
                        </div>
                        <div class="color-item">
                            <label>成功色</label>
                            <input type="color" id="success-color" value="#27ae60" />
                        </div>
                        <div class="color-item">
                            <label>警告色</label>
                            <input type="color" id="warning-color" value="#f39c12" />
                        </div>
                    </div>
                </div>
                
                <div class="property-group">
                    <h4><i class="icon-code">💻</i> 自定义CSS</h4>
                    <div class="property-item">
                        <label for="custom-css">CSS代码</label>
                        

---
## 🧑‍💻 User

继续

---
## 🤖 Assistant

## 第四部分：create.php 剩余的 HTML 部分

```php
                        <textarea id="custom-css" rows="10" placeholder="输入自定义CSS代码" class="code-editor"></textarea>
                        <div class="css-tips">
                            <details>
                                <summary>常用CSS选择器</summary>
                                <ul>
                                    <li><code>.uform</code> - 表单容器</li>
                                    <li><code>.uform-field</code> - 字段容器</li>
                                    <li><code>.uform-label</code> - 字段标签</li>
                                    <li><code>.uform-input</code> - 输入框</li>
                                    <li><code>.uform-submit</code> - 提交按钮</li>
                                    <li><code>.uform-error</code> - 错误消息</li>
                                </ul>
                            </details>
                        </div>
                    </div>
                    <div class="property-item">
                        <button type="button" id="preview-css" class="btn btn-primary">
                            <i class="icon-eye">👁️</i> 预览样式
                        </button>
                        <button type="button" id="reset-css" class="btn btn-default">
                            <i class="icon-refresh">🔄</i> 重置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 底部操作栏 -->
    <div class="form-actions">
        <div class="actions-left">
            <button id="save-draft" class="btn btn-default">
                <i class="icon-save">💾</i>保存草稿
            </button>
            <button id="save-template" class="btn btn-default">
                <i class="icon-template">📄</i>保存为模板
            </button>
        </div>
        <div class="actions-center">
            <span class="save-status" id="save-status">
                <i class="status-icon">✅</i> 已保存
            </span>
        </div>
        <div class="actions-right">
            <button id="preview-form-btn" class="btn btn-info">
                <i class="icon-eye">👁️</i>预览表单
            </button>
            <button id="publish-form" class="btn btn-primary">
                <i class="icon-publish">🚀</i>发布表单
            </button>
            <?php if ($form && $form['status'] === 'published'): ?>
            <button id="get-code" class="btn btn-success">
                <i class="icon-code">📋</i>获取代码
            </button>
            <?php endif; ?>
        </div>
    </div>
</div>

<!-- 批量添加选项弹窗 -->
<div id="bulk-options-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>批量添加选项</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="bulk-options-tabs">
                <button class="bulk-tab active" data-tab="text">文本输入</button>
                <button class="bulk-tab" data-tab="preset">预设选项</button>
            </div>
            <div class="bulk-tab-content active" id="text-tab">
                <textarea id="bulk-options-text" rows="10" placeholder="每行一个选项，格式：&#10;选项1&#10;选项2|value2&#10;选项3"></textarea>
                <div class="bulk-tips">
                    <p>格式说明：</p>
                    <ul>
                        <li>每行一个选项</li>
                        <li>使用 | 分隔显示文本和值</li>
                        <li>例：北京|beijing</li>
                    </ul>
                </div>
            </div>
            <div class="bulk-tab-content" id="preset-tab">
                <div class="preset-categories">
                    <button class="preset-btn" data-preset="yesno">是/否</button>
                    <button class="preset-btn" data-preset="gender">性别</button>
                    <button class="preset-btn" data-preset="rating">满意度</button>
                    <button class="preset-btn" data-preset="education">学历</button>
                    <button class="preset-btn" data-preset="cities">主要城市</button>
                    <button class="preset-btn" data-preset="provinces">省份</button>
                    <button class="preset-btn" data-preset="countries">国家</button>
                    <button class="preset-btn" data-preset="numbers">数字 1-10</button>
                </div>
                <div class="preset-preview" id="preset-preview">
                    选择一个预设类别查看选项
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="apply-bulk-options" class="btn btn-primary">应用</button>
            <button class="btn btn-default modal-close">取消</button>
        </div>
    </div>
</div>

<!-- 表单预览弹窗 -->
<div id="preview-modal" class="modal large-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>表单预览</h3>
            <div class="preview-controls">
                <button id="preview-desktop-btn" class="preview-device active" data-device="desktop">
                    <i class="icon-desktop">🖥️</i>
                </button>
                <button id="preview-tablet-btn" class="preview-device" data-device="tablet">
                    <i class="icon-tablet">📱</i>
                </button>
                <button id="preview-mobile-btn" class="preview-device" data-device="mobile">
                    <i class="icon-mobile">📲</i>
                </button>
            </div>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="preview-container" id="preview-container">
                <iframe id="preview-iframe" src="about:blank" frameborder="0"></iframe>
            </div>
        </div>
    </div>
</div>

<!-- 代码获取弹窗 -->
<div id="code-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>获取表单代码</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="code-tabs">
                <button class="code-tab active" data-tab="link">直接链接</button>
                <button class="code-tab" data-tab="iframe">iframe嵌入</button>
                <button class="code-tab" data-tab="shortcode">短代码</button>
                <button class="code-tab" data-tab="api">API接口</button>
            </div>
            <div class="code-content">
                <div class="code-tab-content active" id="link-tab">
                    <label>表单访问链接：</label>
                    <div class="code-input-group">
                        <input type="text" id="form-link" readonly>
                        <button id="copy-link" class="btn">复制链接</button>
                    </div>
                    <div class="code-example">
                        <p>用户可以通过此链接直接访问表单</p>
                    </div>
                </div>
                <div class="code-tab-content" id="iframe-tab">
                    <label>iframe嵌入代码：</label>
                    <div class="code-input-group">
                        <textarea id="iframe-code" rows="4" readonly></textarea>
                        <button id="copy-iframe" class="btn">复制代码</button>
                    </div>
                    <div class="iframe-options">
                        <label>宽度: <input type="text" id="iframe-width" value="100%"></label>
                        <label>高度: <input type="text" id="iframe-height" value="600px"></label>
                        <button id="update-iframe" class="btn btn-small">更新代码</button>
                    </div>
                </div>
                <div class="code-tab-content" id="shortcode-tab">
                    <label>Typecho短代码：</label>
                    <div class="code-input-group">
                        <input type="text" id="shortcode" readonly>
                        <button id="copy-shortcode" class="btn">复制短代码</button>
                    </div>
                    <div class="code-example">
                        <p>在文章或页面中使用：</p>
                        <code>[uforms name="contact"]</code><br>
                        <code>[uforms id="123"]</code>
                    </div>
                </div>
                <div class="code-tab-content" id="api-tab">
                    <label>API提交地址：</label>
                    <div class="code-input-group">
                        <input type="text" id="api-url" readonly>
                        <button id="copy-api" class="btn">复制API</button>
                    </div>
                    <div class="api-docs">
                        <h5>API文档：</h5>
                        <p><strong>方法：</strong>POST</p>
                        <p><strong>内容类型：</strong>application/json</p>
                        <p><strong>请求示例：</strong></p>
                        <pre><code id="api-example">{
  "form_id": "123",
  "data": {
    "field_name_1": "value1",
    "field_name_2": "value2"
  }
}</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 全局变量配置
window.uformsConfig = {
    formId: <?php echo $form_id ? $form_id : 'null'; ?>,
    ajaxUrl: '<?php echo $options->adminUrl; ?>extending.php?panel=Uforms%2Fcreate.php',
    pluginUrl: '<?php echo $options->pluginUrl; ?>/Uforms',
    siteUrl: '<?php echo $options->siteUrl; ?>',
    existingFields: <?php echo json_encode($fields); ?>,
    existingConfig: <?php echo $form ? json_encode(json_decode($form['config'], true) ?: array()) : '{}'; ?>,
    existingSettings: <?php echo $form ? json_encode(json_decode($form['settings'], true) ?: array()) : '{}'; ?>,
    userId: <?php echo $user->uid; ?>,
    userName: '<?php echo addslashes($user->screenName); ?>',
    userEmail: '<?php echo addslashes($user->mail); ?>'
};

// 确保在DOM加载后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 检查依赖
    if (typeof Sortable === 'undefined') {
        console.warn('Sortable.js not loaded, drag functionality will be limited');
    }
    
    console.log('Uforms Creator initialized with config:', window.uformsConfig);
});
</script>

<!-- 加载必要的脚本文件 -->
<script src="<?php echo $options->pluginUrl; ?>/Uforms/assets/js/sortable.min.js"></script>
<script src="<?php echo $options->pluginUrl; ?>/Uforms/assets/js/uformsbuilder.js"></script>

<!-- 加载样式文件 -->
<link rel="stylesheet" href="<?php echo $options->pluginUrl; ?>/Uforms/assets/css/create.css">

    </div>
</div>
```

## 第五部分：修复的 uformsbuilder.js（第一部分）

```javascript
// 表单构建器核心类 - 修复版本
class UformsBuilder {
    constructor() {
        this.selectedField = null;
        this.formData = window.uformsConfig.existingConfig || {};
        this.formSettings = window.uformsConfig.existingSettings || {};
        this.fieldsData = new Map();
        this.fieldCounter = 0;
        this.isDirty = false;
        this.autoSaveTimer = null;
        this.isPublishing = false;
        this.previewWindow = null;
        this.currentFormId = window.uformsConfig.formId;
        
        // 预设选项数据
        this.presetOptions = {
            yesno: ['是', '否'],
            gender: ['男', '女', '其他'],
            rating: ['非常不满意', '不满意', '一般', '满意', '非常满意'],
            education: ['小学', '初中', '高中', '大专', '本科', '硕士', '博士'],
            cities: ['北京', '上海', '广州', '深圳', '杭州', '南京', '成都', '武汉', '西安', '重庆'],
            provinces: [
                '北京市', '天津市', '河北省', '山西省', '内蒙古自治区',
                '辽宁省', '吉林省', '黑龙江省', '上海市', '江苏省',
                '浙江省', '安徽省', '福建省', '江西省', '山东省',
                '河南省', '湖北省', '湖南省', '广东省', '广西壮族自治区',
                '海南省', '重庆市', '四川省', '贵州省', '云南省',
                '西藏自治区', '陕西省', '甘肃省', '青海省', '宁夏回族自治区',
                '新疆维吾尔自治区', '台湾省', '香港特别行政区', '澳门特别行政区'
            ],
            countries: ['中国', '美国', '日本', '英国', '法国', '德国', '加拿大', '澳大利亚', '韩国', '新加坡'],
            numbers: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10']
        };
        
        this.init();
    }
    
    init() {
        try {
            this.bindEvents();
            this.initSortable();
            this.loadExistingForm();
            this.setupAutoSave();
            this.initColorPickers();
            this.initRangeSliders();
            this.updateFormInfo();
            this.initDOMObserver();
            
            console.log('UformsBuilder initialized successfully');
        } catch (error) {
            console.error('UformsBuilder initialization error:', error);
            this.showNotification('error', '表单构建器初始化失败：' + error.message);
        }
    }
    
    bindEvents() {
        // 使用 jQuery 的事件委托来处理动态元素
        const $ = window.jQuery || window.$;
        
        if (!$) {
            console.error('jQuery not found');
            return;
        }
        
        // 字段库事件 - 使用事件委托
        $(document).on('click', '.field-item', (e) => {
            this.addFieldFromLibrary(e.currentTarget);
        });
        
        // 启用字段拖拽到画布
        if (typeof Sortable !== 'undefined') {
            $(document).on('dragstart', '.field-item', (e) => {
                if (e.originalEvent && e.originalEvent.dataTransfer) {
                    e.originalEvent.dataTransfer.setData('text/plain', e.currentTarget.dataset.type);
                    $(e.currentTarget).addClass('dragging');
                }
            });
            
            $(document).on('dragend', '.field-item', (e) => {
                $(e.currentTarget).removeClass('dragging');
            });
        }
        
        // 画布字段事件
        $(document).on('click', '.canvas-field', (e) => {
            e.stopPropagation();
            this.selectField(e.currentTarget);
        });
        
        $(document).on('click', '.field-action', (e) => {
            e.stopPropagation();
            this.handleFieldAction(e);
        });
        
        // 画布拖拽接收
        $('#form-canvas').on('dragover', (e) => {
            e.preventDefault();
            $('#form-canvas').addClass('drag-over');
        });
        
        $('#form-canvas').on('dragleave', (e) => {
            if (!$(e.target).closest('#form-canvas').length) {
                $('#form-canvas').removeClass('drag-over');
            }
        });
        
        $('#form-canvas').on('drop', (e) => {
            e.preventDefault();
            $('#form-canvas').removeClass('drag-over');
            
            if (e.originalEvent && e.originalEvent.dataTransfer) {
                const fieldType = e.originalEvent.dataTransfer.getData('text/plain');
                if (fieldType) {
                    const fieldConfig = this.getDefaultFieldConfig(fieldType);
                    const fieldId = this.generateFieldId();
                    
                    this.addFieldToCanvas(fieldId, fieldType, fieldConfig);
                }
            }
        });
        
        // 属性面板事件
        $('.tab-button').on('click', (e) => {
            this.switchTab(e.target.dataset.tab);
        });
        
        // 字段属性变更事件
        $('#field-label').on('input', () => this.updateFieldProperty('label'));
        $('#field-name').on('input', () => this.updateFieldProperty('name'));
        $('#field-placeholder').on('input', () => this.updateFieldProperty('placeholder'));
        $('#field-default').on('input', () => this.updateFieldProperty('default'));
        $('#field-help').on('input', () => this.updateFieldProperty('help'));
        $('#field-required').on('change', () => this.updateFieldProperty('required'));
        $('#field-css-class').on('input', () => this.updateFieldProperty('cssClass'));
        $('#field-css-id').on('input', () => this.updateFieldProperty('cssId'));
        $('#field-width').on('change', () => {
            this.updateFieldProperty('width');
            this.toggleCustomWidthInput();
        });
        $('#field-custom-width').on('input', () => this.updateFieldProperty('customWidth'));
        $('#field-width-unit').on('change', () => this.updateFieldProperty('widthUnit'));
        
        // 验证规则事件
        $('#field-min-length').on('input', () => this.updateFieldProperty('minLength'));
        $('#field-max-length').on('input', () => this.updateFieldProperty('maxLength'));
        $('#field-pattern').on('input', () => this.updateFieldProperty('pattern'));
        $('#field-error-message').on('input', () => this.updateFieldProperty('errorMessage'));
        
        // 条件逻辑事件
        $('#field-conditional').on('change', () => this.toggleConditionalLogic());
        $('#add-condition-rule').on('click', () => this.addConditionRule());
        $(document).on('click', '.rule-remove', (e) => this.removeConditionRule(e));
        
        // 选项管理事件
        $('#add-option').on('click', () => this.addOption());
        $('#bulk-add-options').on('click', () => this.showBulkOptionsModal());
        $(document).on('click', '.option-remove', (e) => this.removeOption(e));
        $(document).on('input', '.option-label, .option-value', () => this.updateOptions());
        
        // 文件上传设置事件
        $('#file-types').on('input', () => this.updateFieldProperty('fileTypes'));
        $('#file-max-size').on('input', () => this.updateFieldProperty('maxSize'));
        $('#file-multiple').on('change', () => this.updateFieldProperty('multiple'));
        $('#file-max-count').on('input', () => this.updateFieldProperty('maxCount'));
        
        // 数字字段设置事件
        $('#number-min').on('input', () => this.updateFieldProperty('min'));
        $('#number-max').on('input', () => this.updateFieldProperty('max'));
        $('#number-step').on('input', () => this.updateFieldProperty('step'));
        
        // 日期时间设置事件
        $('#date-min').on('input', () => this.updateFieldProperty('minDate'));
        $('#date-max').on('input', () => this.updateFieldProperty('maxDate'));
        $('#date-format').on('change', () => this.updateFieldProperty('dateFormat'));
        
        // 画布工具栏事件
        $('.preview-btn').on('click', (e) => {
            this.switchPreviewMode(e.target.dataset.view);
        });
        
        $('#clear-form').on('click', () => this.clearForm());
        $('#preview-form, #preview-form-btn').on('click', () => this.previewForm());
        $('#toggle-grid').on('click', () => this.toggleGrid());
        
        // 表单设置事件 - 使用命名空间避免冲突
        $('#form-name').on('input.uforms', () => {
            this.updateFormSetting('name');
            this.validateFormName();
        });
        $('#form-title').on('input.uforms', () => this.updateFormSetting('title'));
        $('#form-description').on('input.uforms', () => this.updateFormSetting('description'));
        $('#submit-text').on('input.uforms', () => this.updateFormSetting('submitText'));
        $('#success-message').on('input.uforms', () => this.updateFormSetting('successMessage'));
        $('#success-action').on('change.uforms', () => this.handleSuccessActionChange());
        $('#ajax-submit').on('change.uforms', () => this.updateFormSetting('ajaxSubmit'));
        $('#prevent-duplicate').on('change.uforms', () => this.updateFormSetting('preventDuplicate'));
        
        // 安全设置事件
        $('#enable-captcha').on('change.uforms', () => this.updateFormSetting('enableCaptcha'));
        $('#enable-honeypot').on('change.uforms', () => this.updateFormSetting('enableHoneypot'));
        $('#submit-limit').on('input.uforms', () => this.updateFormSetting('submitLimit'));
        $('#max-submissions').on('input.uforms', () => this.updateFormSetting('maxSubmissions'));
        
        // 邮件通知事件
        $('#admin-notification').on('change.uforms', () => this.toggleAdminNotification());
        $('#user-notification').on('change.uforms', () => this.toggleUserNotification());
        $('#admin-email').on('input.uforms', () => this.updateFormSetting('adminEmail'));
        $('#admin-subject').on('input.uforms', () => this.updateFormSetting('adminSubject'));
        $('#admin-message').on('input.uforms', () => this.updateFormSetting('adminMessage'));
        $('#user-email-field').on('change.uforms', () => this.updateFormSetting('userEmailField'));
        $('#user-subject').on('input.uforms', () => this.updateFormSetting('userSubject'));
        $('#user-message').on('input.uforms', () => this.updateFormSetting('userMessage'));
        
        // Webhook设置事件
        $('#enable-webhook').on('change.uforms', () => this.toggleWebhook());
        $('#webhook-url').on('input.uforms', () => this.updateFormSetting('webhookUrl'));
        $('#webhook-secret').on('input.uforms', () => this.updateFormSetting('webhookSecret'));
        
        // 样式设置事件
        $('#form-theme').on('change.uforms', () => this.updateFormStyle('theme'));
        $('#primary-color, #primary-color-text').on('input.uforms', () => this.updateFormStyle('primaryColor'));
        $('#form-width').on('input.uforms', () => this.updateFormStyle('formWidth'));
        $('#form-max-width').on('input.uforms', () => this.updateFormStyle('formMaxWidth'));
        $('#label-position').on('change.uforms', () => this.updateFormStyle('labelPosition'));
        
        // 样式滑块事件
        $('#field-spacing').on('input.uforms', () => this.updateFormStyle('fieldSpacing'));
        $('#form-padding').on('input.uforms', () => this.updateFormStyle('formPadding'));
        $('#input-border-radius').on('input.uforms', () => this.updateFormStyle('inputBorderRadius'));
        $('#input-border-width').on('input.uforms', () => this.updateFormStyle('inputBorderWidth'));
        $('#input-height').on('input.uforms', () => this.updateFormStyle('inputHeight'));
        
        // 颜色设置事件
        $('#bg-color').on('input.uforms', () => this.updateFormStyle('backgroundColor'));
        $('#text-color').on('input.uforms', () => this.updateFormStyle('textColor'));
        $('#border-color').on('input.uforms', () => this.updateFormStyle('borderColor'));
        $('#error-color').on('input.uforms', () => this.updateFormStyle('errorColor'));
        $('#success-color').on('input.uforms', () => this.updateFormStyle('successColor'));
        $('#warning-color').on('input.uforms', () => this.updateFormStyle('warningColor'));
        
        // CSS设置事件
        $('#custom-css').on('input.uforms', () => this.updateFormStyle('customCSS'));
        $('#preview-css').on('click', () => this.previewCustomCSS());
        $('#reset-css').on('click', () => this.resetCustomCSS());
        
        // 底部操作事件
        $('#save-draft').on('click', () => this.saveForm('draft'));
        $('#publish-form').on('click', () => this.saveForm('published'));
        $('#get-code').on('click', () => this.showCodeModal());
        $('#save-template').on('click', () => this.saveAsTemplate());
        
        // 模态框事件
        $('.modal-close').on('click', (e) => {
            $(e.target).closest('.modal').hide();
        });
        
        // 模态框背景点击关闭
        $('.modal').on('click', (e) => {
            if (e.target === e.currentTarget) {
                $(e.currentTarget).hide();
            }
        });
        
        // 批量选项事件
        $('.bulk-tab').on('click', (e) => this.switchBulkTab(e.target.dataset.tab));
        $('.preset-btn').on('click', (e) => this.loadPresetOptions(e.target.dataset.preset));
        $('#apply-bulk-options').on('click', () => this.applyBulkOptions());
        
        // 预览设备切换
        $('.preview-device').on('click', (e) => {
            this.switchPreviewDevice(e.target.dataset.device);
        });
        
        // 代码复制事件
        $('#copy-link, #copy-iframe, #copy-shortcode, #copy-api').on('click', (e) => {
            this.copyCode(e.target.id);
        });
        
        // iframe选项更新
        $('#update-iframe').on('click', () => this.updateIframeCode());
        
        // 代码标签页切换
        $('.code-tab').on('click', (e) => {
            this.switchCodeTab(e.target.dataset.tab);
        });
        
        // 快速添加文本字段
        $(document).on('click', '#add-text-field', () => {
            const textField = document.querySelector('.field-item[data-type="text"]');
            if (textField) {
                this.addFieldFromLibrary(textField);
            }
        });
        
        // 键盘快捷键
        $(document).on('keydown', (e) => this.handleKeyboardShortcuts(e));
        
        // 页面离开提醒
        $(window).on('beforeunload', () => {
            if (this.isDirty) {
                return '您有未保存的更改，确定要离开吗？';
            }
        });
        
        // 全局点击事件 - 取消字段选择
        $(document).on('click', (e) => {
            if (!$(e.target).closest('.canvas-field, .properties-panel, .modal').length) {
                this.deselectField();
            }
        });
    }
    
    initSortable() {
        if (typeof Sortable !== 'undefined') {
            try {
                // 画布排序
                const canvasElement = document.getElementById('form-canvas');
                if (canvasElement) {
                    this.canvasSortable = Sortable.create(canvasElement, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        handle: '.field-drag-handle',
                        filter: '.canvas-drop-zone',
                        onStart: (evt) => {
                            $('#form-canvas').addClass('sorting');
                        },
                        onEnd: (evt) => {
                            $('#form-canvas').removeClass('sorting');
                            this.updateFieldOrder();
                            this.markDirty();
                        }
                    });
                }
            } catch (error) {
                console.error('Sortable initialization error:', error);
            }
        }
    }
    
    addFieldFromLibrary(fieldItem) {
        try {
            const fieldType = fieldItem.dataset.type;
            const fieldConfig = this.getDefaultFieldConfig(fieldType);
            const fieldId = this.generateFieldId();
            
            this.addFieldToCanvas(fieldId, fieldType, fieldConfig);
        } catch (error) {
            console.error('Add field from library error:', error);
            this.showNotification('error', '添加字段失败：' + error.message);
        }
    }
    
    addFieldToCanvas(fieldId, fieldType, fieldConfig) {
        try {
            const $ = window.jQuery;
            
            // 如果画布为空，移除提示
            if ($('#form-canvas .canvas-drop-zone').length > 0) {
                $('#form-canvas').empty();
            }
            
            const fieldElement = this.createFieldElement(fieldId, fieldType, fieldConfig);
            $('#form-canvas').append(fieldElement);
            
            // 保存字段数据
            this.fieldsData.set(fieldId, {
                id: fieldId,
                type: fieldType,
                config: fieldConfig
            });
            
            // 选中新添加的字段
            this.selectField(fieldElement[0]);
            
            // 滚动到字段位置
            fieldElement[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            this.markDirty();
            
            // 添加动画效果
            fieldElement.addClass('field-added');
            setTimeout(() => {
                fieldElement.removeClass('field-added');
            }, 600);
            
            // 更新用户邮箱字段选项
            this.updateUserEmailFieldOptions();
            
        } catch (error) {
            console.error('Add field to canvas error:', error);
            this.showNotification('error', '添加字段到画布失败：' + error.message);
        }
    }
```

由于 uformsbuilder.js 文件非常长，我需要继续分段发送。请先测试这些修复是否解决了基本的保存问题，然后我会继续发送剩余的代码。

当前已修复的主要问题：
1. UformsHelper 中缺失的关键方法
2. create.php 的保存逻辑和错误处理
3. uformsbuilder.js 的初始化和事件绑定

接下来我会继续发送 uformsbuilder.js 的剩余部分。

---
## 🧑‍💻 User

继续

---
## 🤖 Assistant

## 第六部分：uformsbuilder.js（第二部分）

```javascript
    getDefaultFieldConfig(type) {
        const configs = {
            text: {
                label: '单行文本',
                name: 'text_field_' + (this.fieldCounter + 1),
                placeholder: '请输入文本',
                required: false,
                width: 'full'
            },
            textarea: {
                label: '多行文本',
                name: 'textarea_field_' + (this.fieldCounter + 1),
                placeholder: '请输入内容',
                required: false,
                width: 'full',
                rows: 4
            },
            email: {
                label: '邮箱地址',
                name: 'email_field_' + (this.fieldCounter + 1),
                placeholder: '请输入邮箱',
                required: false,
                width: 'full'
            },
            url: {
                label: '网站地址',
                name: 'url_field_' + (this.fieldCounter + 1),
                placeholder: '请输入网址',
                required: false,
                width: 'full'
            },
            tel: {
                label: '电话号码',
                name: 'tel_field_' + (this.fieldCounter + 1),
                placeholder: '请输入电话',
                required: false,
                width: 'full'
            },
            password: {
                label: '密码',
                name: 'password_field_' + (this.fieldCounter + 1),
                placeholder: '请输入密码',
                required: false,
                width: 'full'
            },
            select: {
                label: '下拉选择',
                name: 'select_field_' + (this.fieldCounter + 1),
                required: false,
                width: 'full',
                options: [
                    { label: '选项1', value: 'option1' },
                    { label: '选项2', value: 'option2' }
                ]
            },
            radio: {
                label: '单选按钮',
                name: 'radio_field_' + (this.fieldCounter + 1),
                required: false,
                width: 'full',
                options: [
                    { label: '选项1', value: 'option1' },
                    { label: '选项2', value: 'option2' }
                ]
            },
            checkbox: {
                label: '复选框',
                name: 'checkbox_field_' + (this.fieldCounter + 1),
                required: false,
                width: 'full',
                options: [
                    { label: '选项1', value: 'option1' },
                    { label: '选项2', value: 'option2' }
                ]
            },
            file: {
                label: '文件上传',
                name: 'file_field_' + (this.fieldCounter + 1),
                required: false,
                width: 'full',
                fileTypes: 'jpg,jpeg,png,gif,pdf,doc,docx',
                maxSize: 10,
                multiple: false,
                maxCount: 5
            },
            date: {
                label: '日期选择',
                name: 'date_field_' + (this.fieldCounter + 1),
                required: false,
                width: 'full',
                dateFormat: 'YYYY-MM-DD'
            },
            time: {
                label: '时间选择',
                name: 'time_field_' + (this.fieldCounter + 1),
                required: false,
                width: 'full'
            },
            datetime: {
                label: '日期时间',
                name: 'datetime_field_' + (this.fieldCounter + 1),
                required: false,
                width: 'full'
            },
            number: {
                label: '数字输入',
                name: 'number_field_' + (this.fieldCounter + 1),
                placeholder: '请输入数字',
                required: false,
                width: 'full',
                min: null,
                max: null,
                step: 1
            },
            range: {
                label: '数值滑块',
                name: 'range_field_' + (this.fieldCounter + 1),
                required: false,
                width: 'full',
                min: 0,
                max: 100,
                step: 1,
                defaultValue: 50
            },
            rating: {
                label: '评分',
                name: 'rating_field_' + (this.fieldCounter + 1),
                required: false,
                width: 'full',
                max: 5,
                icon: 'star'
            },
            color: {
                label: '颜色选择',
                name: 'color_field_' + (this.fieldCounter + 1),
                required: false,
                width: 'full',
                defaultValue: '#000000'
            },
            heading: {
                label: '标题文本',
                name: 'heading_' + (this.fieldCounter + 1),
                text: '章节标题',
                level: 'h3',
                width: 'full'
            },
            paragraph: {
                label: '段落文本',
                name: 'paragraph_' + (this.fieldCounter + 1),
                text: '这里是段落文本内容，可以用于说明或描述。',
                width: 'full'
            },
            divider: {
                label: '分割线',
                name: 'divider_' + (this.fieldCounter + 1),
                style: 'solid',
                width: 'full'
            },
            columns: {
                label: '多列布局',
                name: 'columns_' + (this.fieldCounter + 1),
                columns: 2,
                width: 'full',
                children: []
            },
            html: {
                label: 'HTML代码',
                name: 'html_' + (this.fieldCounter + 1),
                content: '<p>自定义HTML内容</p>',
                width: 'full'
            },
            hidden: {
                label: '隐藏字段',
                name: 'hidden_field_' + (this.fieldCounter + 1),
                value: '',
                width: 'full'
            },
            calendar: {
                label: '日历预约',
                name: 'calendar_field_' + (this.fieldCounter + 1),
                required: false,
                width: 'full',
                minDate: '',
                maxDate: '',
                availableTimes: []
            },
            cascade: {
                label: '级联选择',
                name: 'cascade_field_' + (this.fieldCounter + 1),
                required: false,
                width: 'full',
                options: [],
                levels: 2
            },
            tags: {
                label: '标签选择',
                name: 'tags_field_' + (this.fieldCounter + 1),
                required: false,
                width: 'full',
                maxTags: 10,
                suggestions: []
            },
            repeater: {
                label: '重复器',
                name: 'repeater_' + (this.fieldCounter + 1),
                width: 'full',
                minItems: 1,
                maxItems: 10,
                fields: []
            },
            signature: {
                label: '签名板',
                name: 'signature_field_' + (this.fieldCounter + 1),
                required: false,
                width: 'full',
                penColor: '#000000',
                backgroundColor: '#ffffff'
            },
            // 系统字段
            user_name: {
                label: '用户姓名',
                name: 'user_name_' + (this.fieldCounter + 1),
                readonly: true,
                width: 'full'
            },
            user_email: {
                label: '用户邮箱',
                name: 'user_email_' + (this.fieldCounter + 1),
                readonly: true,
                width: 'full'
            },
            page_url: {
                label: '页面URL',
                name: 'page_url_' + (this.fieldCounter + 1),
                readonly: true,
                width: 'full'
            },
            page_title: {
                label: '页面标题',
                name: 'page_title_' + (this.fieldCounter + 1),
                readonly: true,
                width: 'full'
            },
            timestamp: {
                label: '时间戳',
                name: 'timestamp_' + (this.fieldCounter + 1),
                readonly: true,
                width: 'full'
            }
        };
        
        return configs[type] || {};
    }
    
    generateFieldId() {
        return 'field_' + (++this.fieldCounter) + '_' + Date.now();
    }
    
    createFieldElement(fieldId, fieldType, config) {
        const $ = window.jQuery;
        const fieldElement = $(`
            <div class="canvas-field" id="${fieldId}" data-type="${fieldType}" data-field-id="${fieldId}">
                <div class="field-header">
                    <span class="field-drag-handle" title="拖拽排序">
                        <i class="icon-drag">≡</i>
                    </span>
                    <span class="field-label">${config.label}</span>
                    <div class="field-meta">
                        <span class="field-type">${this.getFieldTypeLabel(fieldType)}</span>
                        ${config.required ? '<span class="field-required">必填</span>' : ''}
                    </div>
                    <div class="field-actions">
                        <button class="field-action field-edit" title="编辑字段" type="button">
                            <i class="icon-edit">✏</i>
                        </button>
                        <button class="field-action field-copy" title="复制字段" type="button">
                            <i class="icon-copy">⧉</i>
                        </button>
                        <button class="field-action field-delete" title="删除字段" type="button">
                            <i class="icon-trash">🗑</i>
                        </button>
                    </div>
                </div>
                <div class="field-body">
                    ${this.renderFieldPreview(fieldType, config)}
                </div>
                <div class="field-properties-preview">
                    ${this.renderFieldPropertiesPreview(config)}
                </div>
            </div>
        `);
        
        return fieldElement;
    }

    renderFieldPreview(fieldType, config) {
        switch (fieldType) {
            case 'text':
            case 'email':
            case 'url':
            case 'tel':
            case 'password':
                return `<input type="${fieldType}" placeholder="${config.placeholder || ''}" value="${config.defaultValue || ''}" disabled class="preview-input" />`;
                
            case 'textarea':
                return `<textarea rows="${config.rows || 4}" placeholder="${config.placeholder || ''}" disabled class="preview-textarea">${config.defaultValue || ''}</textarea>`;
                
            case 'number':
                const min = config.min !== null && config.min !== undefined ? ` min="${config.min}"` : '';
                const max = config.max !== null && config.max !== undefined ? ` max="${config.max}"` : '';
                const step = config.step ? ` step="${config.step}"` : '';
                return `<input type="number" placeholder="${config.placeholder || ''}" value="${config.defaultValue || ''}"${min}${max}${step} disabled class="preview-input" />`;
                
            case 'select':
                let selectOptions = config.options ? config.options.map(opt => 
                    `<option value="${opt.value}" ${opt.value === config.defaultValue ? 'selected' : ''}>${opt.label}</option>`
                ).join('') : '';
                return `<select disabled class="preview-select">
                    <option value="">请选择</option>
                    ${selectOptions}
                </select>`;
                
            case 'radio':
                let radioOptions = config.options ? config.options.map((opt, i) => 
                    `<label class="radio-option">
                        <input type="radio" name="${config.name}" value="${opt.value}" ${opt.value === config.defaultValue ? 'checked' : ''} disabled />
                        <span>${opt.label}</span>
                    </label>`
                ).join('') : '';
                return `<div class="radio-group">${radioOptions}</div>`;
                
            case 'checkbox':
                let checkboxOptions = config.options ? config.options.map((opt, i) => 
                    `<label class="checkbox-option">
                        <input type="checkbox" name="${config.name}" value="${opt.value}" disabled />
                        <span>${opt.label}</span>
                    </label>`
                ).join('') : '';
                return `<div class="checkbox-group">${checkboxOptions}</div>`;
                
            case 'file':
                const multiple = config.multiple ? ' multiple' : '';
                const accept = config.fileTypes ? ` accept=".${config.fileTypes.split(',').join(',.')}"` : '';
                return `<input type="file" ${multiple}${accept} disabled class="preview-input" />
                        <div class="file-info">
                            类型: ${config.fileTypes || '所有'} | 
                            最大: ${config.maxSize || 10}MB
                            ${config.multiple ? ` | 最多${config.maxCount || 5}个` : ''}
                        </div>`;
                
            case 'date':
                return `<input type="date" value="${config.defaultValue || ''}" disabled class="preview-input" />`;
                
            case 'time':
                return `<input type="time" value="${config.defaultValue || ''}" disabled class="preview-input" />`;
                
            case 'datetime':
                return `<input type="datetime-local" value="${config.defaultValue || ''}" disabled class="preview-input" />`;
                
            case 'range':
                const rangeMin = config.min || 0;
                const rangeMax = config.max || 100;
                const rangeStep = config.step || 1;
                const rangeDefault = config.defaultValue || rangeMin;
                return `<input type="range" min="${rangeMin}" max="${rangeMax}" step="${rangeStep}" value="${rangeDefault}" disabled class="preview-range" />
                        <div class="range-output">${rangeDefault}</div>`;
                
            case 'color':
                return `<input type="color" value="${config.defaultValue || '#000000'}" disabled class="preview-color" />`;
                
            case 'rating':
                let stars = '';
                for (let i = 1; i <= (config.max || 5); i++) {
                    stars += `<span class="rating-star ${i <= (config.defaultValue || 0) ? 'active' : ''}" data-rating="${i}">★</span>`;
                }
                return `<div class="rating-group">${stars}</div>`;
                
            case 'heading':
                const level = config.level || 'h3';
                return `<${level} class="form-heading">${config.text || '标题文本'}</${level}>`;
                
            case 'paragraph':
                return `<div class="form-paragraph">${config.text || '段落文本'}</div>`;
                
            case 'divider':
                return `<hr class="form-divider" style="border-style: ${config.style || 'solid'}" />`;
                
            case 'columns':
                return `<div class="form-columns columns-${config.columns || 2}">
                    ${Array.from({length: config.columns || 2}, (_, i) => 
                        `<div class="column">列 ${i + 1}</div>`
                    ).join('')}
                </div>`;
                
            case 'html':
                return `<div class="form-html">${config.content || '<p>HTML内容</p>'}</div>`;
                
            case 'hidden':
                return `<div class="hidden-field-info">隐藏字段: ${config.name} = "${config.value || ''}"</div>`;
                
            case 'calendar':
                return `<div class="calendar-preview">
                    <div class="calendar-widget">📅 日历选择器</div>
                    <div class="calendar-info">日期范围: ${config.minDate || '无限制'} - ${config.maxDate || '无限制'}</div>
                </div>`;
                
            case 'cascade':
                return `<div class="cascade-preview">
                    <select disabled class="preview-select"><option>请选择...</option></select>
                    <select disabled class="preview-select"><option>请先选择上级</option></select>
                </div>`;
                
            case 'tags':
                return `<div class="tags-preview">
                    <input type="text" placeholder="输入标签..." disabled class="preview-input" />
                    <div class="tags-display">
                        <span class="tag">示例标签</span>
                    </div>
                </div>`;
                
            case 'repeater':
                return `<div class="repeater-preview">
                    <div class="repeater-item">重复项 1</div>
                    <button type="button" class="add-item" disabled>+ 添加项目</button>
                </div>`;
                
            case 'signature':
                return `<div class="signature-preview">
                    <div class="signature-pad" style="background: ${config.backgroundColor || '#ffffff'}; border: 1px dashed #ccc; height: 120px; display: flex; align-items: center; justify-content: center;">
                        签名区域
                    </div>
                </div>`;
                
            // 系统字段
            case 'user_name':
                return `<input type="text" value="当前用户姓名" readonly disabled class="preview-input system-field" />`;
                
            case 'user_email':
                return `<input type="email" value="user@example.com" readonly disabled class="preview-input system-field" />`;
                
            case 'page_url':
                return `<input type="url" value="${window.location.href}" readonly disabled class="preview-input system-field" />`;
                
            case 'page_title':
                return `<input type="text" value="${document.title}" readonly disabled class="preview-input system-field" />`;
                
            case 'timestamp':
                return `<input type="text" value="${new Date().toLocaleString()}" readonly disabled class="preview-input system-field" />`;
                
            default:
                return `<div class="field-placeholder">未知字段类型: ${fieldType}</div>`;
        }
    }
    
    renderFieldPropertiesPreview(config) {
        const properties = [];
        
        if (config.placeholder) {
            properties.push(`<span class="prop-item">占位符: ${config.placeholder}</span>`);
        }
        
        if (config.help) {
            properties.push(`<span class="prop-item">帮助: ${config.help}</span>`);
        }
        
        if (config.cssClass) {
            properties.push(`<span class="prop-item">CSS类: ${config.cssClass}</span>`);
        }
        
        if (config.cssId) {
            properties.push(`<span class="prop-item">CSS ID: ${config.cssId}</span>`);
        }
        
        if (config.minLength || config.maxLength) {
            properties.push(`<span class="prop-item">长度: ${config.minLength || 0} - ${config.maxLength || '∞'}</span>`);
        }
        
        if (config.width && config.width !== 'full') {
            properties.push(`<span class="prop-item">宽度: ${this.getWidthLabel(config.width)}</span>`);
        }
        
        if (config.conditional && config.conditional.enabled) {
            properties.push(`<span class="prop-item">条件显示</span>`);
        }
        
        return properties.length > 0 ? properties.join('') : '';
    }
    
    getWidthLabel(width) {
        const labels = {
            'full': '100%',
            'half': '50%',
            'third': '33.33%',
            'quarter': '25%',
            'auto': '自动',
            'custom': '自定义'
        };
        return labels[width] || width;
    }
    
    getFieldTypeLabel(type) {
        const labels = {
            text: '文本',
            textarea: '多行文本',
            email: '邮箱',
            url: '网址',
            tel: '电话',
            number: '数字',
            password: '密码',
            select: '下拉选择',
            radio: '单选',
            checkbox: '多选',
            file: '文件',
            date: '日期',
            time: '时间',
            datetime: '日期时间',
            range: '滑块',
            color: '颜色',
            rating: '评分',
            heading: '标题',
            paragraph: '段落',
            divider: '分割线',
            columns: '多列',
            html: 'HTML',
            hidden: '隐藏',
            calendar: '日历',
            cascade: '级联',
            tags: '标签',
            repeater: '重复器',
            signature: '签名',
            user_name: '用户姓名',
            user_email: '用户邮箱',
            page_url: '页面URL',
            page_title: '页面标题',
            timestamp: '时间戳'
        };
        
        return labels[type] || type;
    }
    
    selectField(fieldElement) {
        const $ = window.jQuery;
        
        try {
            // 移除其他字段的选中状态
            $('.canvas-field').removeClass('selected');
            
            // 选中当前字段
            $(fieldElement).addClass('selected');
            
            this.selectedField = fieldElement;
            const fieldId = fieldElement.id;
            const fieldData = this.fieldsData.get(fieldId);
            
            if (fieldData) {
                this.showFieldProperties(fieldData);
            }
        } catch (error) {
            console.error('Select field error:', error);
        }
    }
    
    deselectField() {
        const $ = window.jQuery;
        $('.canvas-field').removeClass('selected');
        this.selectedField = null;
        this.hideFieldProperties();
    }
    
    showFieldProperties(fieldData) {
        try {
            // 切换到字段设置标签
            this.switchTab('field');
            
            // 隐藏无选择提示，显示属性设置
            $('.no-selection').hide();
            $('.field-properties').show();
            
            // 填充基本属性
            $('#field-label').val(fieldData.config.label || '');
            $('#field-name').val(fieldData.config.name || '');
            $('#field-placeholder').val(fieldData.config.placeholder || '');
            $('#field-default').val(fieldData.config.defaultValue || fieldData.config.value || '');
            $('#field-help').val(fieldData.config.help || '');
            $('#field-required').prop('checked', fieldData.config.required || false);
            $('#field-css-class').val(fieldData.config.cssClass || '');
            $('#field-css-id').val(fieldData.config.cssId || '');
            $('#field-width').val(fieldData.config.width || 'full');
            
            // 自定义宽度设置
            if (fieldData.config.width === 'custom') {
                $('#field-custom-width').val(fieldData.config.customWidth || '');
                $('#field-width-unit').val(fieldData.config.widthUnit || 'px');
                $('#custom-width-input').show();
            } else {
                $('#custom-width-input').hide();
            }
            
            // 显示/隐藏特定设置组
            this.toggleFieldSpecificSettings(fieldData.type);
            
            // 填充特定字段设置
            this.loadFieldSpecificSettings(fieldData);
            
        } catch (error) {
            console.error('Show field properties error:', error);
        }
    }
    
    hideFieldProperties() {
        $('.field-properties').hide();
        $('.no-selection').show();
    }
    
    toggleFieldSpecificSettings(fieldType) {
        // 隐藏所有特殊设置组
        $('.options-group, .file-group, .number-group, .datetime-group').hide();
        
        // 根据字段类型显示相应设置
        if (['select', 'radio', 'checkbox'].includes(fieldType)) {
            $('.options-group').show();
        }
        
        if (fieldType === 'file') {
            $('.file-group').show();
        }
        
        if (['number', 'range'].includes(fieldType)) {
            $('.number-group').show();
        }
        
        if (['date', 'time', 'datetime'].includes(fieldType)) {
            $('.datetime-group').show();
        }
    }
    
    loadFieldSpecificSettings(fieldData) {
        const { type, config } = fieldData;
        
        try {
            // 选项类字段设置
            if (['select', 'radio', 'checkbox'].includes(type) && config.options) {
                this.loadOptions(config.options);
            }
            
            // 文件上传设置
            if (type === 'file') {
                $('#file-types').val(config.fileTypes || 'jpg,jpeg,png,gif,pdf,doc,docx');
                $('#file-max-size').val(config.maxSize || 10);
                $('#file-multiple').prop('checked', config.multiple || false);
                $('#file-max-count').val(config.maxCount || 5);
            }
            
            // 数字字段设置
            if (['number', 'range'].includes(type)) {
                $('#number-min').val(config.min || '');
                $('#number-max').val(config.max || '');
                $('#number-step').val(config.step || 1);
            }
            
            // 日期时间设置
            if (['date', 'time', 'datetime'].includes(type)) {
                $('#date-min').val(config.minDate || '');
                $('#date-max').val(config.maxDate || '');
                $('#date-format').val(config.dateFormat || 'YYYY-MM-DD');
            }
            
            // 验证规则
            $('#field-min-length').val(config.minLength || '');
            $('#field-max-length').val(config.maxLength || '');
            $('#field-pattern').val(config.pattern || '');
            $('#field-error-message').val(config.errorMessage || '');
            
            // 条件逻辑
            if (config.conditional) {
                $('#field-conditional').prop('checked', true);
                this.showConditionalRules();
                this.loadConditionalRules(config.conditional);
            } else {
                $('#field-conditional').prop('checked', false);
                this.hideConditionalRules();
            }
        } catch (error) {
            console.error('Load field specific settings error:', error);
        }
    }
    
    loadOptions(options) {
        const $ = window.jQuery;
        const optionsList = $('#options-list');
        optionsList.empty();
        
        options.forEach((option, index) => {
            const optionItem = $(`
                <div class="option-item">
                    <span class="option-drag" title="拖拽排序">⋮⋮</span>
                    <input type="text" class="option-label" placeholder="选项标签" value="${option.label}" />
                    <input type="text" class="option-value" placeholder="选项值" value="${option.value}" />
                    <button type="button" class="option-remove" title="删除选项">×</button>
                </div>
            `);
            optionsList.append(optionItem);
        });
        
        // 初始化选项拖拽排序
        this.initOptionsSortable();
        
        // 确保至少有一个空选项用于添加
        if (options.length === 0) {
            this.addOption();
        }
    }
    
    initOptionsSortable() {
        const optionsList = document.querySelector('#options-list');
        if (optionsList && typeof Sortable !== 'undefined') {
            if (this.optionsSortable) {
                this.optionsSortable.destroy();
            }
            
            try {
                this.optionsSortable = Sortable.create(optionsList, {
                    animation: 150,
                    handle: '.option-drag',
                    onEnd: () => this.updateOptions()
                });
            } catch (error) {
                console.error('Options sortable error:', error);
            }
        }
    }
    
    updateFieldProperty(property) {
        if (!this.selectedField) return;
        
        const fieldId = this.selectedField.id;
        const fieldData = this.fieldsData.get(fieldId);
        if (!fieldData) return;
        
        try {
            // 获取新值
            let value;
            const elementId = `field-${property.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
            const element = document.getElementById(elementId);
            
            if (element) {
                if (element.type === 'checkbox') {
                    value = element.checked;
                } else {
                    value = element.value;
                }
            }
            
            // 更新字段数据
            fieldData.config[property] = value;
            
            // 特殊处理
            if (property === 'label') {
                // 更新画布中的标签显示
                $(this.selectedField).find('.field-label').text(value);
                
                // 如果name为空，自动生成
                if (!fieldData.config.name) {
                    const autoName = this.generateFieldName(value);
                    fieldData.config.name = autoName;
                    $('#field-name').val(autoName);
                }
            }
            
            if (property === 'name') {
                // 验证字段名唯一性
                this.validateFieldName(value, fieldId);
            }
            
            if (property === 'required') {
                // 更新必填显示
                const requiredSpan = $(this.selectedField).find('.field-required');
                if (value) {
                    if (requiredSpan.length === 0) {
                        $(this.selectedField).find('.field-meta').append('<span class="field-required">必填</span>');
                    }
                } else {
                    requiredSpan.remove();
                }
            }
            
            if (property === 'width') {
                this.toggleCustomWidthInput();
            }
            
            // 更新预览
            this.updateFieldPreview(fieldId);
            
            // 更新属性预览
            this.updateFieldPropertiesPreview(fieldId);
            
            this.markDirty();
            
        } catch (error) {
            console.error('Update field property error:', error);
        }
    }
    
    toggleCustomWidthInput() {
        const width = $('#field-width').val();
        if (width === 'custom') {
            $('#custom-width-input').show();
        } else {
            $('#custom-width-input').hide();
        }
    }
    
    generateFieldName(label) {
        // 移除特殊字符，转换为下划线格式
        let name = label.replace(/[^\w\u4e00-\u9fa5]/g, '_')
                        .replace(/_{2,}/g, '_')
                        .replace(/^_|_$/g, '')
                        .toLowerCase();
        
        // 处理中文转拼音（简单处理）
        if (/[\u4e00-\u9fa5]/.test(name)) {
            name = 'field_' + Date.now();
        }
        
        // 确保唯一性
        let finalName = name;
        let counter = 1;
        const existingNames = Array.from(this.fieldsData.values()).map(f => f.config.name);
        
        while (existingNames.includes(finalName)) {
            finalName = `${name}_${counter}`;
            counter++;
        }
        
        return finalName;
    }
    
    validateFieldName(name, excludeFieldId) {
        const existingNames = Array.from(this.fieldsData.entries())
            .filter(([id, data]) => id !== excludeFieldId)
            .map(([id, data]) => data.config.name);
        
        if (existingNames.includes(name)) {
            alert('字段名称已存在，请使用其他名称');
            // 重新生成唯一名称
            const uniqueName = this.generateFieldName(name);
            $('#field-name').val(uniqueName);
            if (this.selectedField) {
                const fieldData = this.fieldsData.get(this.selectedField.id);
                if (fieldData) {
                    fieldData.config.name = uniqueName;
                }
            }
        }
    }
```

继续发送剩余部分...

---
## 🧑‍💻 User

继续

---
## 🤖 Assistant

## 第七部分：uformsbuilder.js（第三部分）

```javascript
    updateFieldPreview(fieldId) {
        try {
            const fieldData = this.fieldsData.get(fieldId);
            if (!fieldData) return;
            
            const fieldElement = document.getElementById(fieldId);
            const fieldBody = fieldElement.querySelector('.field-body');
            
            fieldBody.innerHTML = this.renderFieldPreview(fieldData.type, fieldData.config);
        } catch (error) {
            console.error('Update field preview error:', error);
        }
    }
    
    updateFieldPropertiesPreview(fieldId) {
        try {
            const fieldData = this.fieldsData.get(fieldId);
            if (!fieldData) return;
            
            const fieldElement = document.getElementById(fieldId);
            const propertiesPreview = fieldElement.querySelector('.field-properties-preview');
            
            propertiesPreview.innerHTML = this.renderFieldPropertiesPreview(fieldData.config);
        } catch (error) {
            console.error('Update field properties preview error:', error);
        }
    }
    
    handleFieldAction(e) {
        try {
            const action = e.target.closest('.field-action');
            const fieldElement = e.target.closest('.canvas-field');
            
            if (action.classList.contains('field-edit')) {
                this.selectField(fieldElement);
            } else if (action.classList.contains('field-copy')) {
                this.duplicateField(fieldElement);
            } else if (action.classList.contains('field-delete')) {
                this.deleteField(fieldElement);
            }
        } catch (error) {
            console.error('Handle field action error:', error);
        }
    }
    
    duplicateField(fieldElement) {
        try {
            const $ = window.jQuery;
            const fieldId = fieldElement.id;
            const originalData = this.fieldsData.get(fieldId);
            
            if (!originalData) return;
            
            // 创建新字段数据
            const newFieldId = this.generateFieldId();
            const newConfig = JSON.parse(JSON.stringify(originalData.config));
            
            // 修改名称以避免重复
            newConfig.name = this.generateFieldName(newConfig.name + '_copy');
            newConfig.label = newConfig.label + ' (副本)';
            
            // 创建新字段元素
            const newFieldElement = this.createFieldElement(newFieldId, originalData.type, newConfig);
            
            // 插入到原字段后面
            $(fieldElement).after(newFieldElement);
            
            // 保存新字段数据
            this.fieldsData.set(newFieldId, {
                id: newFieldId,
                type: originalData.type,
                config: newConfig
            });
            
            // 选中新字段
            this.selectField(newFieldElement[0]);
            
            this.markDirty();
            
            // 添加动画
            newFieldElement.addClass('field-added');
            setTimeout(() => {
                newFieldElement.removeClass('field-added');
            }, 600);
        } catch (error) {
            console.error('Duplicate field error:', error);
            this.showNotification('error', '复制字段失败：' + error.message);
        }
    }
    
    deleteField(fieldElement) {
        try {
            const $ = window.jQuery;
            const fieldId = fieldElement.id;
            const fieldData = this.fieldsData.get(fieldId);
            
            if (!fieldData) return;
            
            if (confirm(`确定要删除字段 "${fieldData.config.label}" 吗？`)) {
                // 移除字段数据
                this.fieldsData.delete(fieldId);
                
                // 如果是当前选中的字段，清空属性面板
                if (this.selectedField === fieldElement) {
                    this.selectedField = null;
                    this.hideFieldProperties();
                }
                
                // 移除元素
                $(fieldElement).addClass('field-removing');
                setTimeout(() => {
                    $(fieldElement).remove();
                    
                    // 如果没有字段了，显示提示
                    if ($('#form-canvas .canvas-field').length === 0) {
                        this.showEmptyCanvas();
                    }
                    
                    // 更新用户邮箱字段选项
                    this.updateUserEmailFieldOptions();
                }, 300);
                
                this.markDirty();
            }
        } catch (error) {
            console.error('Delete field error:', error);
            this.showNotification('error', '删除字段失败：' + error.message);
        }
    }
    
    showEmptyCanvas() {
        $('#form-canvas').html(`
            <div class="canvas-drop-zone" id="canvas-drop-zone">
                <div class="drop-hint">
                    <div class="drop-icon">
                        <i class="icon-drag">⬇</i>
                    </div>
                    <h3>从左侧拖拽字段到这里开始创建表单</h3>
                    <p>或者点击左侧字段图标快速添加到表单</p>
                    <div class="quick-start">
                        <button class="btn btn-primary" id="add-text-field">
                            <i class="icon-plus">+</i> 添加文本字段
                        </button>
                    </div>
                </div>
            </div>
        `);
    }
    
    switchTab(tab) {
        try {
            const $ = window.jQuery;
            // 切换标签按钮状态
            $('.tab-button').removeClass('active');
            $(`.tab-button[data-tab="${tab}"]`).addClass('active');
            
            // 切换内容面板
            $('.tab-content').removeClass('active');
            $(`#${tab}-tab`).addClass('active');
        } catch (error) {
            console.error('Switch tab error:', error);
        }
    }
    
    // 选项管理方法
    addOption() {
        try {
            const $ = window.jQuery;
            const optionsList = $('#options-list');
            const optionItem = $(`
                <div class="option-item">
                    <span class="option-drag" title="拖拽排序">⋮⋮</span>
                    <input type="text" class="option-label" placeholder="选项标签" />
                    <input type="text" class="option-value" placeholder="选项值" />
                    <button type="button" class="option-remove" title="删除选项">×</button>
                </div>
            `);
            
            optionsList.append(optionItem);
            
            // 聚焦到新添加的标签输入框
            optionItem.find('.option-label').focus();
            
            // 重新初始化排序
            this.initOptionsSortable();
        } catch (error) {
            console.error('Add option error:', error);
        }
    }
    
    removeOption(e) {
        try {
            const $ = window.jQuery;
            const optionItem = $(e.target).closest('.option-item');
            const optionsList = $('#options-list');
            
            // 确保至少保留一个选项
            if (optionsList.children('.option-item').length > 1) {
                optionItem.remove();
                this.updateOptions();
            } else {
                alert('至少需要保留一个选项');
            }
        } catch (error) {
            console.error('Remove option error:', error);
        }
    }
    
    updateOptions() {
        if (!this.selectedField) return;
        
        try {
            const $ = window.jQuery;
            const fieldId = this.selectedField.id;
            const fieldData = this.fieldsData.get(fieldId);
            if (!fieldData) return;
            
            const options = [];
            $('#options-list .option-item').each(function() {
                const label = $(this).find('.option-label').val().trim();
                const value = $(this).find('.option-value').val().trim();
                
                if (label) {
                    options.push({
                        label: label,
                        value: value || label.toLowerCase().replace(/\s+/g, '_')
                    });
                }
            });
            
            fieldData.config.options = options;
            this.updateFieldPreview(fieldId);
            this.markDirty();
        } catch (error) {
            console.error('Update options error:', error);
        }
    }
    
    showBulkOptionsModal() {
        $('#bulk-options-modal').show();
        $('#bulk-options-text').focus();
    }
    
    switchBulkTab(tab) {
        const $ = window.jQuery;
        $('.bulk-tab').removeClass('active');
        $(`.bulk-tab[data-tab="${tab}"]`).addClass('active');
        
        $('.bulk-tab-content').removeClass('active');
        $(`#${tab}-tab`).addClass('active');
    }
    
    loadPresetOptions(preset) {
        const options = this.presetOptions[preset];
        if (options) {
            const previewHtml = options.map(opt => `<div class="preset-option">${opt}</div>`).join('');
            $('#preset-preview').html(previewHtml);
            
            // 将预设选项填入文本框
            const textContent = options.join('\n');
            $('#bulk-options-text').val(textContent);
        }
    }
    
    applyBulkOptions() {
        try {
            const $ = window.jQuery;
            const activeTab = $('.bulk-tab.active').data('tab');
            let optionsText = $('#bulk-options-text').val();
            
            if (!optionsText.trim()) {
                alert('请输入选项内容');
                return;
            }
            
            // 解析选项
            const lines = optionsText.split('\n');
            const options = [];
            
            lines.forEach(line => {
                line = line.trim();
                if (line) {
                    const parts = line.split('|');
                    const label = parts[0].trim();
                    const value = parts.length > 1 ? parts[1].trim() : label.toLowerCase().replace(/\s+/g, '_');
                    
                    if (label) {
                        options.push({ label, value });
                    }
                }
            });
            
            if (options.length === 0) {
                alert('没有有效的选项');
                return;
            }
            
            // 清空现有选项并添加新选项
            $('#options-list').empty();
            
            options.forEach(option => {
                const optionItem = $(`
                    <div class="option-item">
                        <span class="option-drag" title="拖拽排序">⋮⋮</span>
                        <input type="text" class="option-label" placeholder="选项标签" value="${option.label}" />
                        <input type="text" class="option-value" placeholder="选项值" value="${option.value}" />
                        <button type="button" class="option-remove" title="删除选项">×</button>
                    </div>
                `);
                $('#options-list').append(optionItem);
            });
            
            this.updateOptions();
            this.initOptionsSortable();
            
            $('#bulk-options-modal').hide();
        } catch (error) {
            console.error('Apply bulk options error:', error);
            this.showNotification('error', '批量添加选项失败：' + error.message);
        }
    }
    
    // 条件逻辑方法
    toggleConditionalLogic() {
        const enabled = $('#field-conditional').is(':checked');
        
        if (enabled) {
            this.showConditionalRules();
        } else {
            this.hideConditionalRules();
        }
        
        if (this.selectedField) {
            const fieldId = this.selectedField.id;
            const fieldData = this.fieldsData.get(fieldId);
            if (fieldData) {
                if (enabled) {
                    fieldData.config.conditional = { enabled: true, rules: [] };
                } else {
                    delete fieldData.config.conditional;
                }
                this.markDirty();
            }
        }
    }
    
    showConditionalRules() {
        $('#conditional-rules').show();
        this.updateConditionFieldOptions();
    }
    
    hideConditionalRules() {
        $('#conditional-rules').hide();
    }
    
    updateConditionFieldOptions() {
        const $ = window.jQuery;
        const conditionField = $('#condition-field');
        conditionField.html('<option value="">选择字段</option>');
        
        // 获取当前字段之前的字段作为条件字段选项
        const currentFieldIndex = Array.from($('#form-canvas .canvas-field')).indexOf(this.selectedField);
        
        $('#form-canvas .canvas-field').each((index, element) => {
            if (index < currentFieldIndex) {
                const fieldId = element.id;
                const fieldData = this.fieldsData.get(fieldId);
                if (fieldData) {
                    const option = $(`<option value="${fieldId}">${fieldData.config.label}</option>`);
                    conditionField.append(option);
                }
            }
        });
    }
    
    addConditionRule() {
        try {
            const $ = window.jQuery;
            const rulesContainer = $('.rule-builder');
            const ruleItem = $(`
                <div class="rule-item">
                    <select class="rule-select condition-field">
                        <option value="">选择字段</option>
                    </select>
                    <select class="rule-select condition-operator">
                        <option value="equals">等于</option>
                        <option value="not_equals">不等于</option>
                        <option value="contains">包含</option>
                        <option value="not_contains">不包含</option>
                        <option value="empty">为空</option>
                        <option value="not_empty">不为空</option>
                        <option value="greater">大于</option>
                        <option value="less">小于</option>
                    </select>
                    <input type="text" class="rule-input condition-value" placeholder="比较值" />
                    <button type="button" class="rule-remove" title="删除规则">×</button>
                </div>
            `);
            
            rulesContainer.append(ruleItem);
            
            // 填充字段选项
            const conditionField = ruleItem.find('.condition-field');
            $('#condition-field option').each(function() {
                conditionField.append($(this).clone());
            });
        } catch (error) {
            console.error('Add condition rule error:', error);
        }
    }
    
    removeConditionRule(e) {
        $(e.target).closest('.rule-item').remove();
    }
    
    loadConditionalRules(conditional) {
        if (conditional.rules && conditional.rules.length > 0) {
            $('.rule-builder .rule-item').remove();
            
            conditional.rules.forEach(rule => {
                this.addConditionRule();
                const ruleItem = $('.rule-builder .rule-item').last();
                ruleItem.find('.condition-field').val(rule.field);
                ruleItem.find('.condition-operator').val(rule.operator);
                ruleItem.find('.condition-value').val(rule.value);
            });
        }
    }
    
    // 表单设置方法
    updateFormSetting(setting) {
        try {
            let value;
            const elementId = setting.replace(/([A-Z])/g, '-$1').toLowerCase();
            const element = document.getElementById(elementId);
            
            if (element) {
                if (element.type === 'checkbox') {
                    value = element.checked;
                } else {
                    value = element.value;
                }
            }
            
            this.formSettings[setting] = value;
            this.markDirty();
            
            // 特殊处理
            if (setting === 'name') {
                this.validateFormName();
            }
        } catch (error) {
            console.error('Update form setting error:', error);
        }
    }
    
    validateFormName() {
        const name = $('#form-name').val();
        const nameRegex = /^[a-zA-Z0-9_]+$/;
        
        if (name && !nameRegex.test(name)) {
            $('#form-name').addClass('error');
            this.showFormError('表单名称只能包含字母、数字和下划线');
        } else {
            $('#form-name').removeClass('error');
            this.hideFormError();
        }
    }
    
    showFormError(message) {
        const $ = window.jQuery;
        let errorDiv = $('.form-name-error');
        if (errorDiv.length === 0) {
            errorDiv = $('<div class="form-name-error field-tip error"></div>');
            $('#form-name').after(errorDiv);
        }
        errorDiv.text(message);
    }
    
    hideFormError() {
        $('.form-name-error').remove();
    }
    
    handleSuccessActionChange() {
        const action = $('#success-action').val();
        
        // 隐藏所有特定设置
        $('#redirect-url-setting, #success-block-setting').hide();
        
        // 显示对应设置
        if (action === 'redirect') {
            $('#redirect-url-setting').show();
        } else if (action === 'block') {
            $('#success-block-setting').show();
        }
        
        this.updateFormSetting('successAction');
    }
    
    toggleAdminNotification() {
        const enabled = $('#admin-notification').is(':checked');
        
        if (enabled) {
            $('#admin-notification-settings').show();
        } else {
            $('#admin-notification-settings').hide();
        }
        
        this.updateFormSetting('adminNotification');
    }
    
    toggleUserNotification() {
        const enabled = $('#user-notification').is(':checked');
        
        if (enabled) {
            $('#user-notification-settings').show();
            this.updateUserEmailFieldOptions();
        } else {
            $('#user-notification-settings').hide();
        }
        
        this.updateFormSetting('userNotification');
    }
    
    toggleWebhook() {
        const enabled = $('#enable-webhook').is(':checked');
        
        if (enabled) {
            $('#webhook-settings').show();
        } else {
            $('#webhook-settings').hide();
        }
        
        this.updateFormSetting('enableWebhook');
    }
    
    updateUserEmailFieldOptions() {
        try {
            const $ = window.jQuery;
            const select = $('#user-email-field');
            select.html('<option value="">选择邮箱字段</option>');
            
            // 找到所有邮箱类型的字段
            this.fieldsData.forEach((fieldData, fieldId) => {
                if (fieldData.type === 'email') {
                    const option = $(`<option value="${fieldId}">${fieldData.config.label}</option>`);
                    select.append(option);
                }
            });
        } catch (error) {
            console.error('Update user email field options error:', error);
        }
    }
    
    // 样式设置方法
    updateFormStyle(property) {
        try {
            let value;
            const elementId = property.replace(/([A-Z])/g, '-$1').toLowerCase();
            const element = document.getElementById(elementId);
            
            if (element) {
                value = element.value;
            }
            
            // 特殊处理颜色选择器
            if (property === 'primaryColor') {
                const colorInput = $('#primary-color');
                const textInput = $('#primary-color-text');
                
                if (element.id === 'primary-color') {
                    textInput.val(value);
                } else {
                    colorInput.val(value);
                }
                
                // 应用颜色到预览
                this.applyColorPreview(value);
            }
            
            if (!this.formData.style) {
                this.formData.style = {};
            }
            
            this.formData.style[property] = value;
            this.markDirty();
            
            // 实时预览样式变更
            this.applyStylePreview(property, value);
        } catch (error) {
            console.error('Update form style error:', error);
        }
    }
    
    applyColorPreview(color) {
        // 在画布中应用颜色预览
        const style = `
            .canvas-field.selected { border-color: ${color} !important; }
            .btn-primary { background-color: ${color} !important; }
            .field-required { color: ${color} !important; }
            .tab-button.active { color: ${color} !important; border-bottom-color: ${color} !important; }
        `;
        
        this.updatePreviewStyle('color-preview', style);
    }
    
    applyStylePreview(property, value) {
        const styleMap = {
            'fieldSpacing': '--uform-field-spacing',
            'formPadding': '--uform-form-padding',
            'inputBorderRadius': '--uform-input-border-radius',
            'inputBorderWidth': '--uform-input-border-width',
            'inputHeight': '--uform-input-height',
            'backgroundColor': '--uform-bg-color',
            'textColor': '--uform-text-color',
            'borderColor': '--uform-border-color',
            'errorColor': '--uform-error-color',
            'successColor': '--uform-success-color',
            'warningColor': '--uform-warning-color'
        };
        
        const cssVar = styleMap[property];
        if (cssVar) {
            let unit = '';
            if (['fieldSpacing', 'formPadding', 'inputBorderRadius', 'inputBorderWidth', 'inputHeight'].includes(property)) {
                unit = 'px';
            }
            document.documentElement.style.setProperty(cssVar, value + unit);
        }
    }
    
    updatePreviewStyle(id, css) {
        let styleElement = document.getElementById(id);
        if (!styleElement) {
            styleElement = document.createElement('style');
            styleElement.id = id;
            document.head.appendChild(styleElement);
        }
        
        styleElement.textContent = css;
    }
    
    initColorPickers() {
        // 同步颜色输入框
        $('#primary-color').on('input', function() {
            $('#primary-color-text').val(this.value);
        });
        
        $('#primary-color-text').on('input', function() {
            if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
                $('#primary-color').val(this.value);
            }
        });
    }
    
    initRangeSliders() {
        const self = this;
        const $ = window.jQuery;
        
        // 初始化所有范围滑块
        $('input[type="range"]').each(function() {
            const slider = $(this);
            const valueDisplay = slider.siblings('.range-value');
            
            slider.on('input', function() {
                const value = this.value;
                let unit = 'px';
                
                // 根据slider的ID确定单位
                if (this.id.includes('spacing') || this.id.includes('padding') || this.id.includes('radius')) {
                    unit = 'px';
                }
                
                valueDisplay.text(value + unit);
                
                // 如果需要实时预览样式变更
                self.updateRangePreview(this);
            });
            
            // 初始化显示
            slider.trigger('input');
        });
    }
    
    updateRangePreview(rangeElement) {
        const id = rangeElement.id;
        const value = rangeElement.value;
        
        // 根据不同的滑块类型应用预览
        if (id.includes('field-spacing')) {
            document.documentElement.style.setProperty('--uform-field-spacing', value + 'px');
        } else if (id.includes('form-padding')) {
            document.documentElement.style.setProperty('--uform-form-padding', value + 'px');
        } else if (id.includes('input-border-radius')) {
            document.documentElement.style.setProperty('--uform-input-border-radius', value + 'px');
        } else if (id.includes('input-border-width')) {
            document.documentElement.style.setProperty('--uform-input-border-width', value + 'px');
        } else if (id.includes('input-height')) {
            document.documentElement.style.setProperty('--uform-input-height', value + 'px');
        }
    }
    
    initDOMObserver() {
        // 创建 MutationObserver 实例
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    // 检查是否有新的表单字段被添加
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            // 如果是表单字段
                            if (node.classList && node.classList.contains('canvas-field')) {
                                this.onFieldAdded(node);
                            }
                            // 如果是范围滑块
                            const rangeInputs = node.querySelectorAll('input[type="range"]');
                            if (rangeInputs.length > 0) {
                                this.initNewRangeSliders(rangeInputs);
                            }
                        }
                    });
                    
                    // 处理移除的节点
                    mutation.removedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE && 
                            node.classList && node.classList.contains('canvas-field')) {
                            this.onFieldRemoved(node);
                        }
                    });
                }
            });
        });
        
        // 开始观察
        const targetNode = document.getElementById('form-canvas');
        if (targetNode) {
            observer.observe(targetNode, {
                childList: true,
                subtree: true
            });
        }
        
        // 也观察属性面板的变化
        const propertiesPanel = document.querySelector('.properties-panel');
        if (propertiesPanel) {
            observer.observe(propertiesPanel, {
                childList: true,
                subtree: true
            });
        }
    }
    
    onFieldAdded(fieldNode) {
        // 重新绑定事件
        $(fieldNode).find('.field-action').on('click', (e) => {
            this.handleFieldAction(e);
        });
        
        // 更新用户邮箱字段选项
        this.updateUserEmailFieldOptions();
        
        // 标记为脏数据
        this.markDirty();
    }
    
    onFieldRemoved(fieldNode) {
        const fieldId = fieldNode.id;
        
        // 从数据中移除
        if (this.fieldsData.has(fieldId)) {
            this.fieldsData.delete(fieldId);
        }
        
        // 如果是当前选中的字段，清空选择
        if (this.selectedField === fieldNode) {
            this.selectedField = null;
            this.hideFieldProperties();
        }
        
        // 更新用户邮箱字段选项
        this.updateUserEmailFieldOptions();
        
        // 标记为脏数据
        this.markDirty();
    }
    
    initNewRangeSliders(rangeInputs) {
        const self = this;
        const $ = window.jQuery;
        
        rangeInputs.forEach((rangeInput) => {
            const slider = $(rangeInput);
            const valueDisplay = slider.siblings('.range-value');
            
            // 移除已存在的事件监听器，避免重复绑定
            slider.off('input.uforms');
            
            // 绑定新的事件监听器
            slider.on('input.uforms', function() {
                const value = this.value;
                let unit = 'px';
                
                if (this.id.includes('spacing') || this.id.includes('padding') || this.id.includes('radius')) {
                    unit = 'px';
                }
                
                valueDisplay.text(value + unit);
                self.updateRangePreview(this);
            });
            
            // 初始化显示
            slider.trigger('input');
        });
    }
```

继续发送最后的部分...

---
## 🧑‍💻 User

继续

---
## 🤖 Assistant

## 第八部分：uformsbuilder.js（第四部分 - 最后部分）

```javascript
    previewCustomCSS() {
        const css = $('#custom-css').val();
        this.updatePreviewStyle('custom-css-preview', css);
        
        // 显示预览反馈
        $('#preview-css').text('已预览').addClass('btn-success');
        setTimeout(() => {
            $('#preview-css').text('预览样式').removeClass('btn-success');
        }, 2000);
    }
    
    resetCustomCSS() {
        if (confirm('确定要重置自定义CSS吗？')) {
            $('#custom-css').val('');
            this.updatePreviewStyle('custom-css-preview', '');
            this.updateFormStyle('customCSS');
        }
    }
    
    // 预览功能
    switchPreviewMode(mode) {
        const $ = window.jQuery;
        $('.preview-btn').removeClass('active');
        $(`.preview-btn[data-view="${mode}"]`).addClass('active');
        
        const canvas = $('#form-canvas');
        
        // 移除所有预览模式class
        canvas.removeClass('preview-desktop preview-tablet preview-mobile');
        
        // 添加对应的预览模式class
        canvas.addClass(`preview-${mode}`);
        
        // 更新缩放比例显示
        const scales = {
            desktop: '100%',
            tablet: '768px',
            mobile: '375px'
        };
        
        $('#canvas-scale').text(scales[mode]);
    }
    
    toggleGrid() {
        $('#form-canvas').toggleClass('show-grid');
        $('#toggle-grid').toggleClass('active');
    }
    
    clearForm() {
        if (confirm('确定要清空整个表单吗？此操作不可撤销。')) {
            // 清空所有字段数据
            this.fieldsData.clear();
            this.selectedField = null;
            this.fieldCounter = 0;
            
            // 清空画布
            this.showEmptyCanvas();
            
            // 隐藏属性面板
            this.hideFieldProperties();
            
            this.markDirty();
        }
    }
    
    previewForm() {
        try {
            // 保存当前表单数据
            const formData = this.collectFormData();
            
            if (formData.fields.length === 0) {
                alert('表单至少需要包含一个字段才能预览');
                return;
            }
            
            // 显示预览模态框
            $('#preview-modal').show();
            
            // 生成预览HTML
            this.generatePreviewHTML(formData).then(html => {
                const iframe = document.getElementById('preview-iframe');
                iframe.srcdoc = html;
            });
        } catch (error) {
            console.error('Preview form error:', error);
            this.showNotification('error', '预览表单失败：' + error.message);
        }
    }
    
    generatePreviewHTML(formData) {
        return new Promise((resolve) => {
            try {
                // 构建预览HTML
                const html = `
                    <!DOCTYPE html>
                    <html lang="zh-CN">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>${formData.title || '表单预览'}</title>
                        <link rel="stylesheet" href="${window.uformsConfig.pluginUrl}/assets/css/uforms.css">
                        <style>
                            body { margin: 0; padding: 20px; background: #f5f5f5; }
                            .preview-notice { 
                                background: #e3f2fd; 
                                border: 1px solid #2196f3; 
                                color: #1976d2; 
                                padding: 10px; 
                                margin-bottom: 20px; 
                                border-radius: 4px; 
                                text-align: center; 
                            }
                            ${this.generateFormCSS(formData)}
                            ${formData.customCSS || ''}
                        </style>
                    </head>
                    <body>
                        <div class="preview-notice">
                            <strong>这是表单预览</strong> - 所有字段均已禁用，无法提交
                        </div>
                        ${this.generateFormHTML(formData, true)}
                    </body>
                    </html>
                `;
                
                resolve(html);
            } catch (error) {
                console.error('Generate preview HTML error:', error);
                resolve('<html><body><div class="error">预览生成失败</div></body></html>');
            }
        });
    }
    
    generateFormCSS(formData) {
        const style = formData.style || {};
        
        return `
            .uform {
                max-width: ${style.formMaxWidth || 'none'};
                width: ${style.formWidth || '100%'};
                padding: ${style.formPadding || 20}px;
                background: ${style.backgroundColor || '#ffffff'};
                color: ${style.textColor || '#333333'};
                border-radius: ${style.inputBorderRadius || 4}px;
            }
            .uform-field {
                margin-bottom: ${style.fieldSpacing || 20}px;
            }
            .uform-input, .uform-textarea, .uform-select {
                border-radius: ${style.inputBorderRadius || 4}px;
                border-width: ${style.inputBorderWidth || 1}px;
                border-color: ${style.borderColor || '#dddddd'};
                height: ${style.inputHeight || 40}px;
            }
            .uform-label {
                color: ${style.textColor || '#333333'};
            }
            .uform-submit {
                background-color: ${style.primaryColor || '#3788d8'};
                border-radius: ${style.inputBorderRadius || 4}px;
            }
            .uform-error {
                color: ${style.errorColor || '#e74c3c'};
            }
            .uform-success {
                color: ${style.successColor || '#27ae60'};
            }
        `;
    }
    
    generateFormHTML(formData, isPreview = false) {
        let html = `<div class="uform uform-${formData.theme || 'default'}" data-form-name="${formData.name}">`;
        
        // 表单标题和描述
        if (formData.title) {
            html += `<div class="uform-header">`;
            html += `<h2 class="uform-title">${formData.title}</h2>`;
            if (formData.description) {
                html += `<div class="uform-description">${formData.description}</div>`;
            }
            html += `</div>`;
        }
        
        // 表单内容
        html += `<form class="uform-form" ${isPreview ? '' : 'method="post"'}>`;
        
        // 渲染字段
        formData.fields.forEach(fieldData => {
            html += this.renderFormField(fieldData, isPreview);
        });
        
        // 提交按钮
        html += `<div class="uform-actions">`;
        html += `<button type="${isPreview ? 'button' : 'submit'}" class="uform-submit btn btn-primary" ${isPreview ? 'disabled' : ''}>${formData.submitText || '提交'}</button>`;
        html += `</div>`;
        
        html += `</form></div>`;
        
        return html;
    }
    
    renderFormField(fieldData, isPreview = false) {
        const disabled = isPreview ? 'disabled' : '';
        const required = fieldData.required ? 'required' : '';
        const cssClass = fieldData.cssClass ? ` ${fieldData.cssClass}` : '';
        const cssId = fieldData.cssId ? ` id="${fieldData.cssId}"` : '';
        
        let html = `<div class="uform-field uform-field-${fieldData.type} width-${fieldData.width || 'full'}${cssClass}"${cssId}>`;
        
        // 字段标签
        if (fieldData.label && !['heading', 'paragraph', 'divider', 'hidden'].includes(fieldData.type)) {
            html += `<label class="uform-label">`;
            html += fieldData.label;
            if (fieldData.required) {
                html += ` <span class="required-mark">*</span>`;
            }
            html += `</label>`;
        }
        
        // 字段输入控件
        html += this.renderFieldInput(fieldData, disabled, required);
        
        // 帮助文本
        if (fieldData.help) {
            html += `<div class="uform-help">${fieldData.help}</div>`;
        }
        
        html += `</div>`;
        
        return html;
    }
    
    renderFieldInput(fieldData, disabled, required) {
        const placeholder = fieldData.placeholder ? ` placeholder="${fieldData.placeholder}"` : '';
        const defaultValue = fieldData.defaultValue || fieldData.value || '';
        
        switch (fieldData.type) {
            case 'text':
            case 'email':
            case 'url':
            case 'tel':
            case 'password':
                return `<input type="${fieldData.type}" name="${fieldData.name}" value="${defaultValue}"${placeholder} ${required} ${disabled} class="uform-input">`;
                
            case 'textarea':
                return `<textarea name="${fieldData.name}" rows="${fieldData.rows || 4}"${placeholder} ${required} ${disabled} class="uform-textarea">${defaultValue}</textarea>`;
                
            case 'number':
                const min = fieldData.min !== null && fieldData.min !== undefined ? ` min="${fieldData.min}"` : '';
                const max = fieldData.max !== null && fieldData.max !== undefined ? ` max="${fieldData.max}"` : '';
                const step = fieldData.step ? ` step="${fieldData.step}"` : '';
                return `<input type="number" name="${fieldData.name}" value="${defaultValue}"${placeholder}${min}${max}${step} ${required} ${disabled} class="uform-input">`;
                
            case 'select':
                let selectHtml = `<select name="${fieldData.name}" ${required} ${disabled} class="uform-select">`;
                if (!fieldData.required) {
                    selectHtml += `<option value="">${fieldData.placeholder || '请选择'}</option>`;
                }
                if (fieldData.options) {
                    fieldData.options.forEach(option => {
                        const selected = option.value === defaultValue ? ' selected' : '';
                        selectHtml += `<option value="${option.value}"${selected}>${option.label}</option>`;
                    });
                }
                selectHtml += `</select>`;
                return selectHtml;
                
            case 'radio':
                let radioHtml = `<div class="uform-radio-group">`;
                if (fieldData.options) {
                    fieldData.options.forEach((option, index) => {
                        const checked = option.value === defaultValue ? ' checked' : '';
                        radioHtml += `<label class="uform-radio-label">`;
                        radioHtml += `<input type="radio" name="${fieldData.name}" value="${option.value}"${checked} ${required} ${disabled}>`;
                        radioHtml += `<span class="radio-text">${option.label}</span>`;
                        radioHtml += `</label>`;
                    });
                }
                radioHtml += `</div>`;
                return radioHtml;
                
            case 'checkbox':
                let checkboxHtml = `<div class="uform-checkbox-group">`;
                if (fieldData.options) {
                    fieldData.options.forEach((option, index) => {
                        checkboxHtml += `<label class="uform-checkbox-label">`;
                        checkboxHtml += `<input type="checkbox" name="${fieldData.name}[]" value="${option.value}" ${disabled}>`;
                        checkboxHtml += `<span class="checkbox-text">${option.label}</span>`;
                        checkboxHtml += `</label>`;
                    });
                }
                checkboxHtml += `</div>`;
                return checkboxHtml;
                
            case 'file':
                const multiple = fieldData.multiple ? ' multiple' : '';
                const accept = fieldData.fileTypes ? ` accept=".${fieldData.fileTypes.split(',').join(',.')}"` : '';
                return `<input type="file" name="${fieldData.name}" ${required} ${disabled}${multiple}${accept} class="uform-file">`;
                
            case 'date':
                return `<input type="date" name="${fieldData.name}" value="${defaultValue}" ${required} ${disabled} class="uform-input">`;
                
            case 'time':
                return `<input type="time" name="${fieldData.name}" value="${defaultValue}" ${required} ${disabled} class="uform-input">`;
                
            case 'datetime':
                return `<input type="datetime-local" name="${fieldData.name}" value="${defaultValue}" ${required} ${disabled} class="uform-input">`;
                
            case 'range':
                const rangeMin = fieldData.min || 0;
                const rangeMax = fieldData.max || 100;
                const rangeStep = fieldData.step || 1;
                const rangeDefault = fieldData.defaultValue || rangeMin;
                return `<input type="range" name="${fieldData.name}" min="${rangeMin}" max="${rangeMax}" step="${rangeStep}" value="${rangeDefault}" ${disabled} class="uform-range">`;
                
            case 'color':
                return `<input type="color" name="${fieldData.name}" value="${fieldData.defaultValue || '#000000'}" ${disabled} class="uform-color">`;
                
            case 'heading':
                const level = fieldData.level || 'h3';
                return `<${level} class="uform-heading">${fieldData.text || '标题'}</${level}>`;
                
            case 'paragraph':
                return `<div class="uform-paragraph">${fieldData.text || '段落文本'}</div>`;
                
            case 'divider':
                return `<hr class="uform-divider">`;
                
            case 'hidden':
                return `<input type="hidden" name="${fieldData.name}" value="${fieldData.value || ''}">`;
                
            default:
                return `<div class="uform-unknown">未知字段类型: ${fieldData.type}</div>`;
        }
    }
    
    // 保存功能 - 核心方法
    saveForm(status = 'draft') {
        if (this.isPublishing) {
            return; // 防止重复提交
        }
        
        try {
            const formData = this.collectFormData();
            formData.status = status;
            
            // 验证必填字段
            const validationResult = this.validateFormData(formData);
            if (!validationResult.valid) {
                alert(validationResult.message);
                if (validationResult.tab) {
                    this.switchTab(validationResult.tab);
                }
                return;
            }
            
            this.isPublishing = true;
            
            // 显示保存状态
            this.setSaveStatus('saving', status === 'published' ? '正在发布...' : '正在保存...');
            
            // 禁用保存按钮
            $('#save-draft, #publish-form').prop('disabled', true);
            
            // 发送保存请求
            $.ajax({
                url: window.uformsConfig.ajaxUrl,
                method: 'POST',
                data: {
                    action: 'save_form',
                    form_id: this.currentFormId,
                    form_name: formData.name,
                    form_title: formData.title,
                    form_description: formData.description,
                    form_status: formData.status,
                    form_config: JSON.stringify(formData.config || {}),
                    form_settings: JSON.stringify(formData.settings || {}),
                    fields_config: JSON.stringify(formData.fields || []),
                    version_notes: status === 'published' ? '表单发布' : '保存草稿'
                },
                success: (response) => {
                    this.handleSaveResponse(response, status);
                },
                error: (xhr, status, error) => {
                    this.handleSaveError(xhr, status, error);
                },
                complete: () => {
                    this.isPublishing = false;
                    $('#save-draft, #publish-form').prop('disabled', false);
                }
            });
        } catch (error) {
            this.isPublishing = false;
            $('#save-draft, #publish-form').prop('disabled', false);
            console.error('Save form error:', error);
            this.showNotification('error', '保存失败：' + error.message);
        }
    }
    
    handleSaveResponse(response, status) {
        try {
            if (response.success) {
                this.setSaveStatus('success', status === 'published' ? '发布成功！' : '保存成功！');
                this.isDirty = false;
                
                // 更新表单ID
                if (response.data && response.data.form_id && !this.currentFormId) {
                    this.currentFormId = response.data.form_id;
                    window.uformsConfig.formId = response.data.form_id;
                }
                
                // 如果是发布，显示相关功能
                if (status === 'published') {
                    this.handlePublishSuccess(response.data);
                }
                
                // 显示成功消息
                this.showNotification('success', status === 'published' ? '表单发布成功！' : '表单保存成功！');
                
                // 3秒后恢复正常状态
                setTimeout(() => {
                    this.setSaveStatus('saved', '已保存');
                }, 3000);
            } else {
                this.setSaveStatus('error', response.message || '保存失败');
                this.showNotification('error', '保存失败：' + (response.message || '未知错误'));
            }
        } catch (error) {
            console.error('Handle save response error:', error);
            this.setSaveStatus('error', '处理响应失败');
        }
    }
    
    handleSaveError(xhr, status, error) {
        this.setSaveStatus('error', '保存失败');
        this.showNotification('error', '保存失败，请检查网络连接');
        console.error('Save error:', xhr, status, error);
    }
    
    handlePublishSuccess(data) {
        // 显示获取代码按钮
        $('#get-code').show();
        
        // 更新表单信息
        if (data.form_url) {
            this.formData.url = data.form_url;
        }
        
        // 创建成功通知
        this.showPublishSuccessNotification(data);
    }
    
    showPublishSuccessNotification(data) {
        const $ = window.jQuery;
        const notification = $(`
            <div class="publish-success-notification">
                <h4>🎉 表单发布成功！</h4>
                <p>您的表单已成功发布，现在可以开始接收用户提交的数据。</p>
                <div class="quick-actions">
                    <button class="btn btn-primary" onclick="window.uformsBuilder.showCodeModal()">
                        <i class="icon-code">📋</i> 获取表单代码
                    </button>
                    <button class="btn btn-info" onclick="window.uformsBuilder.previewForm()">
                        <i class="icon-eye">👁</i> 预览表单
                    </button>
                    ${data.form_url ? `<a href="${data.form_url}" target="_blank" class="btn btn-success">
                        <i class="icon-link">🔗</i> 访问表单
                    </a>` : ''}
                </div>
            </div>
        `);
        
        // 临时显示在页面顶部
        $('body').prepend(notification);
        
        // 5秒后自动消失
        setTimeout(() => {
            notification.fadeOut(500, () => notification.remove());
        }, 5000);
    }
    
    validateFormData(formData) {
        // 验证表单名称
        if (!formData.name || !formData.name.trim()) {
            return { valid: false, message: '表单名称不能为空', tab: 'form' };
        }
        
        // 验证表单名称格式
        const nameRegex = /^[a-zA-Z0-9_]+$/;
        if (!nameRegex.test(formData.name)) {
            return { valid: false, message: '表单名称只能包含字母、数字和下划线', tab: 'form' };
        }
        
        // 验证表单标题
        if (!formData.title || !formData.title.trim()) {
            return { valid: false, message: '表单标题不能为空', tab: 'form' };
        }
        
        // 验证字段
        if (formData.fields.length === 0) {
            return { valid: false, message: '表单至少需要包含一个字段', tab: 'field' };
        }
        
        // 验证字段名称唯一性
        const fieldNames = formData.fields.map(field => field.name);
        const duplicateNames = fieldNames.filter((name, index) => fieldNames.indexOf(name) !== index);
        if (duplicateNames.length > 0) {
            return { 
                valid: false, 
                message: `存在重复的字段名称: ${duplicateNames.join(', ')}`, 
                tab: 'field' 
            };
        }
        
        // 验证必填字段是否有标签
        const fieldsWithoutLabel = formData.fields.filter(field => 
            field.required && (!field.label || !field.label.trim()) && 
            !['heading', 'paragraph', 'divider', 'hidden'].includes(field.type)
        );
        if (fieldsWithoutLabel.length > 0) {
            return { 
                valid: false, 
                message: '必填字段必须设置标签', 
                tab: 'field' 
            };
        }
        
        return { valid: true };
    }
    
    collectFormData() {
        try {
            // 收集表单基本信息
            const formInfo = {
                name: $('#form-name').val() || '',
                title: $('#form-title').val() || '',
                description: $('#form-description').val() || ''
            };
            
            // 收集表单设置
            const formSettings = {
                submitText: $('#submit-text').val() || '提交',
                successMessage: $('#success-message').val() || '表单提交成功！',
                successAction: $('#success-action').val() || 'message',
                redirectUrl: $('#redirect-url').val() || '',
                successBlock: $('#success-block').val() || '',
                ajaxSubmit: $('#ajax-submit').is(':checked'),
                preventDuplicate: $('#prevent-duplicate').is(':checked'),
                
                // 安全设置
                enableCaptcha: $('#enable-captcha').is(':checked'),
                enableHoneypot: $('#enable-honeypot').is(':checked'),
                submitLimit: parseInt($('#submit-limit').val()) || 0,
                maxSubmissions: parseInt($('#max-submissions').val()) || 0,
                
                // 邮件通知
                adminNotification: $('#admin-notification').is(':checked'),
                adminEmail: $('#admin-email').val() || '',
                adminSubject: $('#admin-subject').val() || '新的表单提交 - {form_title}',
                adminMessage: $('#admin-message').val() || '',
                
                userNotification: $('#user-notification').is(':checked'),
                userEmailField: $('#user-email-field').val() || '',
                userSubject: $('#user-subject').val() || '表单提交确认 - {form_title}',
                userMessage: $('#user-message').val() || '',
                
                // Webhook设置
                enableWebhook: $('#enable-webhook').is(':checked'),
                webhookUrl: $('#webhook-url').val() || '',
                webhookSecret: $('#webhook-secret').val() || ''
            };
            
            // 收集样式配置
            const styleConfig = {
                theme: $('#form-theme').val() || 'default',
                primaryColor: $('#primary-color').val() || '#3788d8',
                formWidth: $('#form-width').val() || '100%',
                formMaxWidth: $('#form-max-width').val() || 'none',
                labelPosition: $('#label-position').val() || 'top',
                
                // 间距设置
                fieldSpacing: parseInt($('#field-spacing').val()) || 20,
                formPadding: parseInt($('#form-padding').val()) || 20,
                
                // 输入框样式
                inputBorderRadius: parseInt($('#input-border-radius').val()) || 4,
                inputBorderWidth: parseInt($('#input-border-width').val()) || 1,
                inputHeight: parseInt($('#input-height').val()) || 40,
                
                // 颜色配置
                backgroundColor: $('#bg-color').val() || '#ffffff',
                textColor: $('#text-color').val() || '#333333',
                borderColor: $('#border-color').val() || '#dddddd',
                errorColor: $('#error-color').val() || '#e74c3c',
                successColor: $('#success-color').val() || '#27ae60',
                warningColor: $('#warning-color').val() || '#f39c12',
                
                // 自定义CSS
                customCSS: $('#custom-css').val() || ''
            };
            
            // 收集字段数据
            const fields = [];
            $('#form-canvas .canvas-field').each((index, element) => {
                const fieldId = element.id;
                const fieldData = this.fieldsData.get(fieldId);
                if (fieldData) {
                    fields.push({
                        ...fieldData.config,
                        type: fieldData.type,
                        sortOrder: index
                    });
                }
            });
            
            return {
                ...formInfo,
                config: styleConfig,
                settings: formSettings,
                fields: fields
            };
        } catch (error) {
            console.error('Collect form data error:', error);
            throw error;
        }
    }
    
    setSaveStatus(status, message) {
        const statusElement = $('#save-status');
        const iconMap = {
            saving: '⏳',
            success: '✅',
            error: '❌',
            saved: '✅',
            unsaved: '⚠️'
        };
        
        statusElement.removeClass('saving success error saved unsaved')
                   .addClass(status)
                   .html(`<i class="status-icon">${iconMap[status]}</i> ${message}`);
    }
    
    setupAutoSave() {
        // 监听表单变化，3秒后自动保存草稿
        let autoSaveTimeout;
        
        const triggerAutoSave = () => {
            if (!this.isDirty || !this.currentFormId) return;
            
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                if (this.isDirty && !this.isPublishing) {
                    this.autoSaveDraft();
                }
            }, 3000);
        };
        
        // 监听各种输入事件
        $(document).on('input change', '.property-item input, .property-item textarea, .property-item select', triggerAutoSave);
    }
    
    autoSaveDraft() {
        if (!this.currentFormId || this.isPublishing) return;
        
        try {
            this.setSaveStatus('saving', '自动保存中...');
            
            const formData = this.collectFormData();
            formData.status = 'draft';
            
            $.ajax({
                url: window.uformsConfig.ajaxUrl,
                method: 'POST',
                data: {
                    action: 'save_form',
                    form_id: this.currentFormId,
                    form_name: formData.name,
                    form_title: formData.title,
                    form_description: formData.description,
                    form_status: 'draft',
                    form_config: JSON.stringify(formData.config),
                    form_settings: JSON.stringify(formData.settings),
                    fields_config: JSON.stringify(formData.fields),
                    auto_save: true
                },
                success: (response) => {
                    if (response.success) {
                        this.setSaveStatus('saved', '已自动保存');
                        this.isDirty = false;
                    }
                },
                error: () => {
                    // 自动保存失败时不显示错误，避免打扰用户
                    this.setSaveStatus('saved', '已保存');
                }
            });
        } catch (error) {
            console.error('Auto save error:', error);
        }
    }
    
    markDirty() {
        this.isDirty = true;
        this.setSaveStatus('unsaved', '有未保存的更改');
    }
    
    updateFieldOrder() {
        // 更新字段排序后的处理逻辑
        this.markDirty();
    }
    
    updateFormInfo() {
        // 更新表单信息显示
        if (this.currentFormId) {
            $('.form-info').show();
            $('#form-id-display').text(this.currentFormId);
        }
    }
    
    // 代码获取功能
    showCodeModal() {
        if (!this.currentFormId) {
            alert('请先保存并发布表单');
            return;
        }
        
        try {
            const siteUrl = window.uformsConfig.siteUrl;
            const formData = this.collectFormData();
            
            // 生成各种代码
            const formUrl = `${siteUrl}uforms/form/${this.currentFormId}`;
            const iframeCode = `<iframe src="${formUrl}" width="100%" height="600px" frameborder="0"></iframe>`;
            const shortcode = `[uforms id="${this.currentFormId}"]`;
            const shortcodeByName = formData.name ? `[uforms name="${formData.name}"]` : '';
            const apiUrl = `${siteUrl}uforms/api/submit`;
            
            // 填充代码内容
            $('#form-link').val(formUrl);
            $('#iframe-code').val(iframeCode);
            $('#shortcode').val(shortcode);
            $('#api-url').val(apiUrl);
            
            // 更新API文档
            this.updateAPIDocumentation();
            
            $('#code-modal').show();
        } catch (error) {
            console.error('Show code modal error:', error);
            this.showNotification('error', '获取代码失败：' + error.message);
        }
    }
    
    updateAPIDocumentation() {
        const fields = Array.from(this.fieldsData.values()).map(field => ({
            name: field.config.name,
            type: field.type,
            required: field.config.required || false
        }));
        
        const apiExample = {
            form_id: this.currentFormId,
            data: {}
        };
        
        fields.forEach(field => {
            switch (field.type) {
                case 'text':
                case 'email':
                case 'url':
                case 'tel':
                    apiExample.data[field.name] = "示例文本";
                    break;
                case 'number':
                    apiExample.data[field.name] = 123;
                    break;
                case 'select':
                case 'radio':
                    apiExample.data[field.name] = "option1";
                    break;
                case 'checkbox':
                    apiExample.data[field.name] = ["option1", "option2"];
                    break;
                case 'file':
                    apiExample.data[field.name] = "base64编码的文件内容";
                    break;
                default:
                    apiExample.data[field.name] = "值";
            }
        });
        
        $('#api-example').text(JSON.stringify(apiExample, null, 2));
    }
    
    updateIframeCode() {
        const width = $('#iframe-width').val() || '100%';
        const height = $('#iframe-height').val() || '600px';
        const formUrl = $('#form-link').val();
        
        const iframeCode = `<iframe src="${formUrl}" width="${width}" height="${height}" frameborder="0"></iframe>`;
        $('#iframe-code').val(iframeCode);
    }
    
    switchCodeTab(tab) {
        $('.code-tab').removeClass('active');
        $(`.code-tab[data-tab="${tab}"]`).addClass('active');
        
        $('.code-tab-content').removeClass('active');
        $(`#${tab}-tab`).addClass('active');
    }
    
    copyCode(buttonId) {
        let targetId;
        
        switch (buttonId) {
            case 'copy-link':
                targetId = 'form-link';
                break;
            case 'copy-iframe':
                targetId = 'iframe-code';
                break;
            case 'copy-shortcode':
                targetId = 'shortcode';
                break;
            case 'copy-api':
                targetId = 'api-url';
                break;
        }
        
        if (targetId) {
            const element = document.getElementById(targetId);
            element.select();
            element.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                
                // 更新按钮文本和样式
                const button = document.getElementById(buttonId);
                const originalText = button.textContent;
                button.textContent = '已复制';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('复制失败:', err);
                alert('复制失败，请手动选择并复制');
            }
        }
    }
    
    // 模板功能
    saveAsTemplate() {
        try {
            const formData = this.collectFormData();
            const templateName = prompt('请输入模板名称：', formData.title + ' - 模板');
            
            if (!templateName) return;
            
            // 验证模板数据
            if (formData.fields.length === 0) {
                alert('模板至少需要包含一个字段');
                return;
            }
            
            $.ajax({
                url: window.uformsConfig.ajaxUrl,
                method: 'POST',
                data: {
                    action: 'save_template',
                    template_name: templateName,
                    template_title: formData.title,
                    template_description: formData.description,
                    template_config: JSON.stringify(formData.config),
                    fields_config: JSON.stringify(formData.fields),
                    form_settings: JSON.stringify(formData.settings)
                },
                success: (response) => {
                    if (response.success) {
                        this.showNotification('success', '模板保存成功！');
                    } else {
                        this.showNotification('error', '模板保存失败：' + response.message);
                    }
                },
                error: () => {
                    this.showNotification('error', '模板保存失败，请重试');
                }
            });
        } catch (error) {
            console.error('Save template error:', error);
            this.showNotification('error', '保存模板失败：' + error.message);
        }
    }
    
    // 预览设备切换
    switchPreviewDevice(device) {
        $('.preview-device').removeClass('active');
        $(`.preview-device[data-device="${device}"]`).addClass('active');
        
        const iframe = $('#preview-iframe');
        const container = $('#preview-container');
        
        // 移除现有设备类
        container.removeClass('device-desktop device-tablet device-mobile');
        
        // 添加新设备类
        container.addClass(`device-${device}`);
        
        // 设置iframe尺寸
        const sizes = {
            desktop: { width: '100%', height: '600px' },
            tablet: { width: '768px', height: '600px' },
            mobile: { width: '375px', height: '600px' }
        };
        
        const size = sizes[device];
        iframe.css(size);
    }
    
    // 通知系统
    showNotification(type, message, duration = 5000) {
        const $ = window.jQuery;
        const notification = $(`
            <div class="notification notification-${type}">
                <div class="notification-content">
                    <span class="notification-icon">${type === 'success' ? '✅' : '❌'}</span>
                    <span class="notification-message">${message}</span>
                    <button class="notification-close">×</button>
                </div>
            </div>
        `);
        
        // 添加到页面
        if ($('.notifications-container').length === 0) {
            $('body').append('<div class="notifications-container"></div>');
        }
        
        $('.notifications-container').append(notification);
        
        // 显示动画
        setTimeout(() => notification.addClass('show'), 100);
        
        // 自动消失
        setTimeout(() => {
            notification.removeClass('show');
            setTimeout(() => notification.remove(), 300);
        }, duration);
        
        // 手动关闭
        notification.find('.notification-close').on('click', () => {
            notification.removeClass('show');
            setTimeout(() => notification.remove(), 300);
        });
    }
    
    // 加载现有表单
    loadExistingForm() {
        try {
            // 加载现有表单数据
            if (window.uformsConfig.existingFields && window.uformsConfig.existingFields.length > 0) {
                // 清空画布
                $('#form-canvas').empty();
                
                window.uformsConfig.existingFields.forEach((field, index) => {
                    const fieldConfig = field.field_config ? JSON.parse(field.field_config) : {};
                    const fieldId = this.generateFieldId();
                    
                    // 合并字段配置
                    const mergedConfig = {
                        ...fieldConfig,
                        label: field.field_label,
                        name: field.field_name,
                        required: field.is_required == 1
                    };
                    
                    // 创建字段元素
                    const fieldElement = this.createFieldElement(fieldId, field.field_type, mergedConfig);
                    $('#form-canvas').append(fieldElement);
                    
                    // 保存字段数据
                    this.fieldsData.set(fieldId, {
                        id: fieldId,
                        type: field.field_type,
                        config: mergedConfig
                    });
                });
                
                // 更新用户邮箱字段选项
                this.updateUserEmailFieldOptions();
            }
            
            // 加载表单设置
            if (window.uformsConfig.existingSettings) {
                const settings = window.uformsConfig.existingSettings;
                
                // 填充表单设置
                Object.keys(settings).forEach(key => {
                    const elementId = key.replace(/([A-Z])/g, '-$1').toLowerCase();
                    const element = document.getElementById(elementId);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = settings[key];
                        } else {
                            element.value = settings[key];
                        }
                    }
                });
                
                // 触发相关事件
                if (settings.adminNotification) {
                    this.toggleAdminNotification();
                }
                if (settings.userNotification) {
                    this.toggleUserNotification();
                }
                if (settings.enableWebhook) {
                    this.toggleWebhook();
                }
            }
            
            // 加载表单配置
            if (window.uformsConfig.existingConfig) {
                const config = window.uformsConfig.existingConfig;
                
                Object.keys(config).forEach(key => {
                    const elementId = key.replace(/([A-Z])/g, '-$1').toLowerCase();
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.value = config[key];
                        if (element.type === 'range') {
                            $(element).trigger('input'); // 更新range显示
                        }
                    }
                });
            }
            
            // 如果没有字段，显示空状态
            if (this.fieldsData.size === 0) {
                this.showEmptyCanvas();
            }
        } catch (error) {
            console.error('Load existing form error:', error);
        }
    }
    
    // 销毁方法 - 清理资源
    destroy() {
        try {
            // 清理事件监听器
            $(document).off('.uforms');
            $('.modal-close').off('click');
            $('.modal').off('click');
            
            // 清理MutationObserver
            if (this.observer) {
                this.observer.disconnect();
            }
            
            // 清理定时器
            if (this.autoSaveTimer) {
                clearTimeout(this.autoSaveTimer);
            }
            
            // 清理Sortable
            if (this.canvasSortable) {
                this.canvasSortable.destroy();
            }
            
            if (this.optionsSortable) {
                this.optionsSortable.destroy();
            }
        } catch (error) {
            console.error('Destroy error:', error);
        }
    }
    
    // 键盘快捷键
    handleKeyboardShortcuts(e) {
        // Ctrl+S 保存
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            this.saveForm('draft');
        }
        
        // Ctrl+Shift+S 发布
        if (e.ctrlKey && e.shiftKey && e.key === 'S') {
            e.preventDefault();
            this.saveForm('published');
        }
        
        // Delete 删除选中字段
        if (e.key === 'Delete' && this.selectedField) {
            e.preventDefault();
            this.deleteField(this.selectedField);
        }
        
        // Ctrl+D 复制字段
        if (e.ctrlKey && e.key === 'd' && this.selectedField) {
            e.preventDefault();
            this.duplicateField(this.selectedField);
        }
        
        // Esc 取消选择
        if (e.key === 'Escape') {
            this.deselectField();
            $('.modal').hide(); // 关闭模态框
        }
        
        // Ctrl+P 预览表单
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            this.previewForm();
        }
        
        // Ctrl+G 切换网格
        if (e.ctrlKey && e.key === 'g') {
            e.preventDefault();
            this.toggleGrid();
        }
    }
}

// 初始化构建器
$(document).ready(function() {
    // 检查必要的依赖
    if (typeof Sortable === 'undefined') {
        console.warn('Sortable.js 未加载，拖拽功能将不可用');
    }
    
    // 初始化表单构建器
    try {
        window.uformsBuilder = new UformsBuilder();
        console.log('Uforms Builder 初始化成功');
    } catch (error) {
        console.error('Uforms Builder 初始化失败:', error);
        alert('表单构建器初始化失败，请刷新页面重试');
    }
});

// 页面卸载时清理资源
$(window).on('beforeunload', function() {
    if (window.uformsBuilder && typeof window.uformsBuilder.destroy === 'function') {
        window.uformsBuilder.destroy();
    }
});
```

## 总结

现在我已经发送了完整的修复代码，主要修复了以下问题：

### 修复内容：
1. **UformsHelper.php** - 添加了缺失的关键方法
2. **create.php** - 完整的保存逻辑和错误处理
3. **uformsbuilder.js** - 完整的表单构建器代码

### 主要功能：
1. ✅ 表单保存和发布功能
2. ✅ 字段拖拽和配置
3. ✅ 实时预览
4. ✅ 错误处理和用户提示
5. ✅ 自动保存功能
6. ✅ 模板保存功能
7. ✅ 代码生成功能

### 测试建议：
1. 先测试基本的表单创建和保存
2. 测试字段的添加、删除、编辑
3. 测试表单发布功能
4. 检查错误提示是否正常显示

如果还有任何问题，请告诉我具体的错误信息，我会进一步修复。

---
## 🧑‍💻 User

不行，UformsBuilder initialized successfully uformsbuilder.js:49:21
Uforms Builder 初始化成功 uformsbuilder.js:3204:17
Uforms Creator initialized with config: 
Object { formId: null, ajaxUrl: "https://tiango.wiki/admin/extending.php?panel=Uforms%2Fcreate.php", pluginUrl: "https://tiango.wiki/usr/plugins/Uforms", siteUrl: "https://tiango.wiki/", existingFields: [], existingConfig: {…}, existingSettings: {…}, userId: 1, userName: "HansJack", userEmail: "2959602696@qq.com" }
extending.php:1125:13
Uncaught TypeError: can't access property "replace", e is undefined
    jQuery 5
    switchPreviewDevice https://tiango.wiki/usr/plugins/Uforms/assets/js/uformsbuilder.js:2988
    bindEvents https://tiango.wiki/usr/plugins/Uforms/assets/js/uformsbuilder.js:271
    jQuery 7
    bindEvents https://tiango.wiki/usr/plugins/Uforms/assets/js/uformsbuilder.js:270
    init https://tiango.wiki/usr/plugins/Uforms/assets/js/uformsbuilder.js:40
    UformsBuilder https://tiango.wiki/usr/plugins/Uforms/assets/js/uformsbuilder.js:35
    <anonymous> https://tiango.wiki/usr/plugins/Uforms/assets/js/uformsbuilder.js:3203
    jQuery 8
11 jquery.js:1:2715
Save error: 
Object { readyState: 4, getResponseHeader: getResponseHeader(e), getAllResponseHeaders: getAllResponseHeaders(), setRequestHeader: setRequestHeader(e, t), overrideMimeType: overrideMimeType(e), statusCode: statusCode(e), abort: abort(e), state: state(), always: always(), then: then(), … }
 error <empty string> uformsbuilder.js:2505:17
Save error: 
Object { readyState: 4, getResponseHeader: getResponseHeader(e), getAllResponseHeaders: getAllResponseHeaders(), setRequestHeader: setRequestHeader(e, t), overrideMimeType: overrideMimeType(e), statusCode: statusCode(e), abort: abort(e), state: state(), always: always(), then: then(), … }
 error <empty string> uformsbuilder.js:2505:17
Save error: 
Object { readyState: 4, getResponseHeader: getResponseHeader(e), getAllResponseHeaders: getAllResponseHeaders(), setRequestHeader: setRequestHeader(e, t), overrideMimeType: overrideMimeType(e), statusCode: statusCode(e), abort: abort(e), state: state(), always: always(), then: then(), … }
 error <empty string> uformsbuilder.js:2505:17


---
## 🤖 Assistant


