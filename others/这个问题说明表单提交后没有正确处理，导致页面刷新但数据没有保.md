## ğŸ¤– Assistant

è¿™ä¸ªé—®é¢˜è¯´æ˜è¡¨å•æäº¤åæ²¡æœ‰æ­£ç¡®å¤„ç†ï¼Œå¯¼è‡´é¡µé¢åˆ·æ–°ä½†æ•°æ®æ²¡æœ‰ä¿å­˜åˆ°æ•°æ®åº“ã€‚è®©æˆ‘ä»¬æ¥æ’æŸ¥å’Œä¿®å¤è¿™ä¸ªé—®é¢˜ã€‚

## é—®é¢˜åˆ†æ

1. "Firefox å¿…é¡»å‘é€å°†é‡å¤æ­¤å‰æ“ä½œ" æç¤ºè¯´æ˜è¡¨å•æ˜¯é€šè¿‡ POST æäº¤çš„ï¼Œä½†æ²¡æœ‰æ­£ç¡®çš„é‡å®šå‘
2. æ•°æ®æ²¡æœ‰ä¿å­˜åˆ°æ•°æ®åº“ï¼Œè¯´æ˜ `handleFormSubmission` æ–¹æ³•å¯èƒ½æœ‰é—®é¢˜
3. æ§åˆ¶å°æ²¡æœ‰æŠ¥é”™ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨ç«¯çš„é—®é¢˜

## è§£å†³æ–¹æ¡ˆ

### 1. é¦–å…ˆæ£€æŸ¥ `front.php` æ–‡ä»¶ä¸­çš„ `handleFormSubmission` æ–¹æ³•

ä¿®æ”¹ä½ çš„ `front.php` æ–‡ä»¶ï¼š

```php
<?php
if (!defined('__TYPECHO_ROOT_DIR__')) exit;

require_once dirname(__FILE__) . '/frontend-functions.php';

class UformsFront {
    
    public static function renderForm($form_name, $template = 'default') {
        $db = Typecho_Db::get();
        $request = Typecho_Request::getInstance();
        
        try {
            // è·å–è¡¨å•
            $form = $db->fetchRow(
                $db->select('*')->from('table.uforms_forms')
                   ->where('name = ? AND status = ?', $form_name, 'published')
            );
            
            if (!$form) {
                return '<div class="uform-error">è¡¨å•ä¸å­˜åœ¨æˆ–æœªå‘å¸ƒ</div>';
            }
            
            // è·å–è¡¨å•å­—æ®µ
            $fields = $db->fetchAll(
                $db->select('*')->from('table.uforms_fields')
                   ->where('form_id = ?', $form['id'])
                   ->order('sort_order ASC')
            );
            
            $form_config = json_decode($form['config'], true) ?: array();
            $form_settings = json_decode($form['settings'], true) ?: array();
            
            // å¤„ç†è¡¨å•æäº¤
            if ($request->isPost() && $request->get('uform_name') === $form_name) {
                return self::handleFormSubmission($form, $fields, $form_settings);
            }
            
            // æ¸²æŸ“è¡¨å•
            return self::renderFormHTML($form, $fields, $form_config, $form_settings, $template);
            
        } catch (Exception $e) {
            return '<div class="uform-error">è¡¨å•åŠ è½½å¤±è´¥: ' . htmlspecialchars($e->getMessage()) . '</div>';
        }
    }
    
    public static function handleFormSubmission($form, $fields, $settings) {
        $db = Typecho_Db::get();
        $request = Typecho_Request::getInstance();
        
        error_log('Uforms: handleFormSubmission called for form ID: ' . $form['id']);
        
        $errors = array();
        $form_data = array();
        $uploaded_files = array();
        
        // éªŒè¯å®‰å…¨ä»¤ç‰Œ
        $security = Helper::security();
        if (!$security->checkToken($request->get('_token'))) {
            error_log('Uforms: Security token validation failed');
            return '<div class="uform-error">å®‰å…¨éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
        }
        
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨è¡¨å•
        if (isset($settings['enable_forms']) && !$settings['enable_forms']) {
            error_log('Uforms: Form submissions disabled');
            return '<div class="uform-error">è¡¨å•å·²ç¦ç”¨</div>';
        }
        
        // æ£€æŸ¥é¢‘ç‡é™åˆ¶
        if (!self::checkRateLimit($form['id'])) {
            error_log('Uforms: Rate limit exceeded');
            return '<div class="uform-error">æäº¤è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•</div>';
        }
        
        // éªŒè¯å­—æ®µ
        foreach ($fields as $field) {
            $field_name = $field['field_name'];
            $field_value = $request->get($field_name);
            $field_config = json_decode($field['field_config'], true) ?: array();
            
            error_log('Uforms: Processing field: ' . $field_name . ' = ' . print_r($field_value, true));
            
            // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
            if ($field['field_type'] === 'file' && isset($_FILES[$field_name])) {
                $file_result = self::handleFileUpload($_FILES[$field_name], $field, $form['id']);
                if ($file_result['success']) {
                    $form_data[$field_name] = $file_result['file_info'];
                    $uploaded_files[] = $file_result['file_info'];
                } else {
                    $errors[$field_name] = $file_result['error'];
                }
                continue;
            }
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if ($field['is_required'] && (empty($field_value) || (is_array($field_value) && count($field_value) === 0))) {
                $errors[$field_name] = 'æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹';
                continue;
            }
            
            // æ ¹æ®å­—æ®µç±»å‹éªŒè¯
            if (!empty($field_value)) {
                $validation_errors = UformsHelper::validateField($field['field_type'], $field_value, $field_config);
                if (!empty($validation_errors)) {
                    $errors[$field_name] = implode(', ', $validation_errors);
                }
            }
            
            $form_data[$field_name] = $field_value;
        }
        
        error_log('Uforms: Validation errors: ' . print_r($errors, true));
        error_log('Uforms: Form data: ' . print_r($form_data, true));
        
        // å¦‚æœæœ‰é”™è¯¯ï¼Œè¿”å›è¡¨å•
        if (!empty($errors)) {
            $error_html = '<div class="uform-errors"><ul>';
            foreach ($errors as $field => $error) {
                $error_html .= '<li>' . htmlspecialchars($error) . '</li>';
            }
            $error_html .= '</ul></div>';
            return $error_html . self::renderFormHTML($form, $fields, array(), $settings, 'default', $errors, $form_data);
        }
        
        try {
            // æ£€æŸ¥åƒåœ¾å†…å®¹
            if (UformsHelper::isSpam($form_data)) {
                UformsHelper::logSpam($form['id'], UformsHelper::getClientIP(), 'spam_keywords', $form_data);
                error_log('Uforms: Spam detected and logged');
                return '<div class="uform-error">æäº¤å¤±è´¥ï¼Œå†…å®¹è¢«è¯†åˆ«ä¸ºåƒåœ¾ä¿¡æ¯</div>';
            }
            
            // å¼€å§‹æ•°æ®åº“äº‹åŠ¡
            $db->query('START TRANSACTION');
            error_log('Uforms: Starting database transaction');
            
            // ä¿å­˜æäº¤æ•°æ®
            $submission_data = array(
                'form_id' => $form['id'],
                'data' => json_encode($form_data, JSON_UNESCAPED_UNICODE),
                'ip' => UformsHelper::getClientIP(),
                'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',
                'status' => 'new',
                'source' => 'web',
                'created_time' => time(),
                'modified_time' => time()
            );
            
            error_log('Uforms: Inserting submission data: ' . print_r($submission_data, true));
            
            $submission_id = $db->query($db->insert('table.uforms_submissions')->rows($submission_data));
            
            if (!$submission_id) {
                throw new Exception('Failed to insert submission data');
            }
            
            error_log('Uforms: Submission ID: ' . $submission_id);
            
            // ä¿å­˜æ–‡ä»¶è®°å½•
            foreach ($uploaded_files as $file_info) {
                $file_data = array(
                    'submission_id' => $submission_id,
                    'form_id' => $form['id'],
                    'field_name' => $file_info['field_name'],
                    'original_name' => $file_info['original_name'],
                    'filename' => $file_info['filename'],
                    'file_path' => $file_info['file_path'],
                    'file_size' => $file_info['file_size'],
                    'file_type' => $file_info['file_type'],
                    'created_time' => time()
                );
                $db->query($db->insert('table.uforms_files')->rows($file_data));
            }
            
            // æ›´æ–°è¡¨å•æäº¤è®¡æ•°
            $db->query($db->update('table.uforms_forms')
                          ->expression('submit_count', 'submit_count + 1')
                          ->where('id = ?', $form['id']));
            
            // æäº¤äº‹åŠ¡
            $db->query('COMMIT');
            error_log('Uforms: Transaction committed successfully');
            
            // å‘é€é€šçŸ¥
            self::sendNotifications($form, $form_data, $settings);
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            $success_message = !empty($settings['success_message']) ? 
                              $settings['success_message'] : 
                              'è¡¨å•æäº¤æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„å‚ä¸ã€‚';
            
            error_log('Uforms: Submission successful');
            
            return '<div class="uform-success">' . htmlspecialchars($success_message) . '</div>';
            
        } catch (Exception $e) {
            // å›æ»šäº‹åŠ¡
            $db->query('ROLLBACK');
            
            // è®°å½•é”™è¯¯æ—¥å¿—
            error_log('Uforms submission error: ' . $e->getMessage());
            error_log('Uforms submission error trace: ' . $e->getTraceAsString());
            
            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            return '<div class="uform-error">è¡¨å•æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚é”™è¯¯ä¿¡æ¯ï¼š' . htmlspecialchars($e->getMessage()) . '</div>';
        }
    }
    
    public static function renderFormHTML($form, $fields, $config, $settings, $template = 'default', $errors = array(), $form_data = array()) {
        $html = '';
        
        // æ·»åŠ æ ·å¼å¼•ç”¨
        $pluginUrl = Helper::options()->pluginUrl . '/Uforms';
        $html .= '<link rel="stylesheet" href="' . $pluginUrl . '/assets/css/uforms.css">';
        
        // è¡¨å•å®¹å™¨å¼€å§‹
        $html .= '<div class="uform uform-' . htmlspecialchars($form['name']) . '" data-form-name="' . htmlspecialchars($form['name']) . '">';
        
        // è¡¨å•å¤´éƒ¨
        if (!empty($form['title']) || !empty($form['description'])) {
            $html .= '<div class="uform-header">';
            if (!empty($form['title'])) {
                $html .= '<h2 class="uform-title">' . htmlspecialchars($form['title']) . '</h2>';
            }
            if (!empty($form['description'])) {
                $html .= '<div class="uform-description">' . nl2br(htmlspecialchars($form['description'])) . '</div>';
            }
            $html .= '</div>';
        }
        
        // è¡¨å•ä¸»ä½“
        $html .= '<form class="uform-form" method="post" enctype="multipart/form-data" action="">';
        $html .= '<input type="hidden" name="uform_name" value="' . htmlspecialchars($form['name']) . '">';
        
        // CSRFä¿æŠ¤
        $security = Helper::security();
        $html .= $security->getTokenInput();
        
        // æ¸²æŸ“å­—æ®µ
        foreach ($fields as $field) {
            $field_config = json_decode($field['field_config'], true) ?: array();
            $field_errors = isset($errors[$field['field_name']]) ? array($errors[$field['field_name']]) : array();
            $field_value = isset($form_data[$field['field_name']]) ? $form_data[$field['field_name']] : '';
            
            $html .= self::renderField($field, $field_config, $field_errors, $field_value);
        }
        
        // æäº¤æŒ‰é’®
        $submit_text = !empty($settings['submit_text']) ? $settings['submit_text'] : 'æäº¤';
        $html .= '<div class="uform-actions">';
        $html .= '<button type="submit" class="uform-submit btn btn-primary">' . htmlspecialchars($submit_text) . '</button>';
        $html .= '</div>';
        
        $html .= '</form>';
        $html .= '</div>';
        
        // æ·»åŠ JavaScriptå¼•ç”¨
        $html .= '<script src="' . $pluginUrl . '/assets/js/uforms.js"></script>';
        
        return $html;
    }
    
    private static function renderField($field, $config, $errors = array(), $value = '') {
        $type = $field['field_type'];
        $name = $field['field_name'];
        $label = $field['field_label'];
        $required = $field['is_required'];
        
        $html = '<div class="uform-field uform-field-' . $type . '">';
        
        // å­—æ®µæ ‡ç­¾
        if (!in_array($type, array('heading', 'paragraph', 'divider', 'hidden'))) {
            $html .= '<label class="uform-label" for="' . htmlspecialchars($name) . '">';
            $html .= htmlspecialchars($label);
            if ($required) {
                $html .= ' <span class="required-mark">*</span>';
            }
            $html .= '</label>';
        }
        
        // å­—æ®µè¾“å…¥æ§ä»¶
        switch ($type) {
            case 'text':
            case 'email':
            case 'url':
            case 'tel':
                $html .= '<input type="' . $type . '" id="' . htmlspecialchars($name) . '" name="' . htmlspecialchars($name) . '" ';
                $html .= 'value="' . htmlspecialchars($value) . '" ';
                $html .= 'class="uform-input' . (!empty($errors) ? ' error' : '') . '" ';
                if ($required) $html .= 'required ';
                if (isset($config['placeholder'])) {
                    $html .= 'placeholder="' . htmlspecialchars($config['placeholder']) . '" ';
                }
                $html .= '>';
                break;
                
            case 'textarea':
                $html .= '<textarea id="' . htmlspecialchars($name) . '" name="' . htmlspecialchars($name) . '" ';
                $html .= 'class="uform-textarea' . (!empty($errors) ? ' error' : '') . '" ';
                if ($required) $html .= 'required ';
                $html .= 'rows="' . (isset($config['rows']) ? intval($config['rows']) : 4) . '" ';
                if (isset($config['placeholder'])) {
                    $html .= 'placeholder="' . htmlspecialchars($config['placeholder']) . '" ';
                }
                $html .= '>' . htmlspecialchars($value) . '</textarea>';
                break;
                
            case 'select':
                $html .= '<select id="' . htmlspecialchars($name) . '" name="' . htmlspecialchars($name) . '" ';
                $html .= 'class="uform-select' . (!empty($errors) ? ' error' : '') . '" ';
                if ($required) $html .= 'required ';
                $html .= '>';
                
                if (!$required) {
                    $html .= '<option value="">' . (isset($config['placeholder']) ? htmlspecialchars($config['placeholder']) : 'è¯·é€‰æ‹©') . '</option>';
                }
                
                if (isset($config['options']) && is_array($config['options'])) {
                    foreach ($config['options'] as $option) {
                        $selected = $value == $option['value'] ? ' selected' : '';
                        $html .= '<option value="' . htmlspecialchars($option['value']) . '"' . $selected . '>' . htmlspecialchars($option['label']) . '</option>';
                    }
                }
                $html .= '</select>';
                break;
                
            case 'radio':
                $html .= '<div class="uform-radio-group">';
                if (isset($config['options']) && is_array($config['options'])) {
                    foreach ($config['options'] as $option) {
                        $checked = $value == $option['value'] ? ' checked' : '';
                        $html .= '<label class="uform-radio-label">';
                        $html .= '<input type="radio" name="' . htmlspecialchars($name) . '" value="' . htmlspecialchars($option['value']) . '"' . $checked;
                        if ($required) $html .= ' required';
                        $html .= '>';
                        $html .= '<span class="radio-text">' . htmlspecialchars($option['label']) . '</span>';
                        $html .= '</label>';
                    }
                }
                $html .= '</div>';
                break;
                
            case 'checkbox':
                $html .= '<div class="uform-checkbox-group">';
                if (isset($config['options']) && is_array($config['options'])) {
                    $values = is_array($value) ? $value : array($value);
                    foreach ($config['options'] as $option) {
                        $checked = in_array($option['value'], $values) ? ' checked' : '';
                        $html .= '<label class="uform-checkbox-label">';
                        $html .= '<input type="checkbox" name="' . htmlspecialchars($name) . '[]" value="' . htmlspecialchars($option['value']) . '"' . $checked . '>';
                        $html .= '<span class="checkbox-text">' . htmlspecialchars($option['label']) . '</span>';
                        $html .= '</label>';
                    }
                }
                $html .= '</div>';
                break;
                
            case 'hidden':
                $html .= '<input type="hidden" name="' . htmlspecialchars($name) . '" value="' . htmlspecialchars($value) . '">';
                break;
                
            default:
                $html .= '<input type="text" name="' . htmlspecialchars($name) . '" value="' . htmlspecialchars($value) . '" class="uform-input">';
        }
        
        // é”™è¯¯ä¿¡æ¯
        if (!empty($errors)) {
            foreach ($errors as $error) {
                $html .= '<div class="uform-error">' . htmlspecialchars($error) . '</div>';
            }
        }
        
        $html .= '</div>';
        
        return $html;
    }
    
    // æ£€æŸ¥é¢‘ç‡é™åˆ¶
    private static function checkRateLimit($form_id) {
        $db = Typecho_Db::get();
        $ip = UformsHelper::getClientIP();
        $time_limit = time() - 60; // 1åˆ†é’Ÿå†…é™åˆ¶
        
        $count = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_submissions')
               ->where('form_id = ? AND ip = ? AND created_time > ?', $form_id, $ip, $time_limit)
        )->count;
        
        return $count < 3; // æ¯åˆ†é’Ÿæœ€å¤š3æ¬¡æäº¤
    }
    
    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    public static function handleFileUpload($file, $field, $form_id) {
        if ($file['error'] !== UPLOAD_ERR_OK) {
            return array('success' => false, 'error' => 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
        }
        
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!UformsHelper::isAllowedFileType($file['name'])) {
            return array('success' => false, 'error' => 'ä¸å…è®¸çš„æ–‡ä»¶ç±»å‹');
        }
        
        // åˆ›å»ºä¸Šä¼ ç›®å½•
        $upload_dir = __TYPECHO_ROOT_DIR__ . '/usr/uploads/uforms/' . $form_id . '/';
        if (!is_dir($upload_dir)) {
            if (!mkdir($upload_dir, 0755, true)) {
                return array('success' => false, 'error' => 'æ— æ³•åˆ›å»ºä¸Šä¼ ç›®å½•');
            }
        }
        
        // ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å
        $filename = UformsHelper::sanitizeFilename($file['name']);
        $filename = time() . '_' . $filename;
        $file_path = $upload_dir . $filename;
        
        // ç§»åŠ¨ä¸Šä¼ æ–‡ä»¶
        if (move_uploaded_file($file['tmp_name'], $file_path)) {
            return array(
                'success' => true,
                'file_info' => array(
                    'field_name' => $field['field_name'],
                    'original_name' => $file['name'],
                    'filename' => $filename,
                    'file_path' => $file_path,
                    'file_size' => $file['size'],
                    'file_type' => $file['type']
                )
            );
        } else {
            return array('success' => false, 'error' => 'æ–‡ä»¶ä¿å­˜å¤±è´¥');
        }
    }
    
    // å‘é€é€šçŸ¥
    private static function sendNotifications($form, $form_data, $settings) {
        // å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if (!empty($settings['enable_email_notification']) && !empty($settings['notification_email'])) {
            $subject = 'æ–°è¡¨å•æäº¤ï¼š' . $form['title'];
            $message = "è¡¨å•ã€{$form['title']}ã€‘æ”¶åˆ°æ–°çš„æäº¤ï¼š\n\n";
            
            foreach ($form_data as $key => $value) {
                if (is_array($value)) {
                    $value = implode(', ', $value);
                }
                $message .= "$key: $value\n";
            }
            
            $message .= "\næäº¤æ—¶é—´ï¼š" . date('Y-m-d H:i:s');
            $message .= "\nIPåœ°å€ï¼š" . UformsHelper::getClientIP();
            
            UformsHelper::sendEmailNotification($settings['notification_email'], $subject, $message, $form_data);
        }
    }
}
```

### 2. ä¿®æ”¹ Action.php ä¸­çš„ showForm æ–¹æ³•

åœ¨ä½ çš„ `Action.php` æ–‡ä»¶ä¸­ï¼Œç¡®ä¿åœ¨å¤„ç†å®ŒPOSTè¯·æ±‚åæœ‰æ­£ç¡®çš„é‡å®šå‘ï¼š

```php
// åœ¨ showForm æ–¹æ³•ä¸­ï¼Œå¤„ç†è¡¨å•æäº¤çš„éƒ¨åˆ†
if ($request->isPost() && $request->get('uform_name') === $name) {
    error_log('Uforms: Form submission detected for form: ' . $name);
    
    // å¤„ç†æäº¤
    $result = UformsFront::handleFormSubmission($form, $fields, $settings);
    
    if ($request->isAjax()) {
        // AJAXè¯·æ±‚å¤„ç†ä¿æŒä¸å˜...
    } else {
        // éAJAXè¯·æ±‚ï¼Œå¤„ç†å®Œæˆåé‡å®šå‘é¿å…é‡å¤æäº¤
        if (is_string($result) && strpos($result, 'uform-success') !== false) {
            // æˆåŠŸæäº¤åé‡å®šå‘
            if (!empty($settings['redirect_url'])) {
                $this->response->redirect($settings['redirect_url']);
            } else {
                // é‡å®šå‘åˆ°åŒä¸€é¡µé¢ï¼Œä½†æ·»åŠ æˆåŠŸå‚æ•°
                $current_url = Helper::options()->siteUrl . 'uforms/form/' . $name . '?submitted=1';
                $this->response->redirect($current_url);
            }
            return;
        } else {
            // æœ‰é”™è¯¯æ—¶æ˜¾ç¤ºç»“æœ
            $this->renderFormPage($form, $fields, $config, $settings, $result);
            return;
        }
    }
}

// æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
if ($request->get('submitted') === '1') {
    $success_message = !empty($settings['success_message']) ? 
                      $settings['success_message'] : 
                      'è¡¨å•æäº¤æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„å‚ä¸ã€‚';
    
    $success_result = '<div class="uform-success">' . htmlspecialchars($success_message) . '</div>';
    $this->renderFormPage($form, $fields, $config, $settings, $success_result);
    return;
}
```

### 3. æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„

ç¡®è®¤ä½ çš„æ•°æ®åº“è¡¨æ˜¯å¦æ­£ç¡®åˆ›å»ºã€‚è¿è¡Œä»¥ä¸‹SQLæ£€æŸ¥ï¼š

```sql
SHOW TABLES LIKE '%uforms%';
DESCRIBE typecho_uforms_forms;
DESCRIBE typecho_uforms_fields;
DESCRIBE typecho_uforms_submissions;
```

### 4. åœ¨ä½ çš„ç½‘ç«™æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶æ¥éªŒè¯æ•°æ®åº“è¿æ¥ï¼š

åˆ›å»º `test_uforms.php`ï¼š

```php
<?php
define('__TYPECHO_ROOT_DIR__', dirname(__FILE__));
require_once __TYPECHO_ROOT_DIR__ . '/config.inc.php';

try {
    $db = Typecho_Db::get();
    
    // æµ‹è¯•æ•°æ®åº“è¿æ¥
    $result = $db->fetchRow($db->select('COUNT(*) as count')->from('table.uforms_forms'));
    echo "Forms count: " . $result['count'] . "<br>";
    
    // æµ‹è¯•æ’å…¥
    $test_data = array(
        'name' => 'test_form_' . time(),
        'title' => 'Test Form',
        'description' => 'Test Description',
        'config' => '{}',
        'settings' => '{}',
        'status' => 'published',
        'author_id' => 1,
        'view_count' => 0,
        'submit_count' => 0,
        'created_time' => time(),
        'modified_time' => time()
    );
    
    $form_id = $db->query($db->insert('table.uforms_forms')->rows($test_data));
    echo "Created test form with ID: " . $form_id . "<br>";
    
    // æµ‹è¯•æäº¤æ•°æ®æ’å…¥
    $submission_data = array(
        'form_id' => $form_id,
        'data' => json_encode(array('test_field' => 'test_value')),
        'ip' => '127.0.0.1',
        'user_agent' => 'Test Agent',
        'status' => 'new',
        'source' => 'test',
        'created_time' => time(),
        'modified_time' => time()
    );
    
    $submission_id = $db->query($db->insert('table.uforms_submissions')->rows($submission_data));
    echo "Created test submission with ID: " . $submission_id . "<br>";
    
    echo "Database operations successful!";
    
} catch (Exception $e) {
    echo "Error: " . $e->getMessage();
}
?>
```

è¿è¡Œè¿™ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰æ•°æ®åº“é”™è¯¯ã€‚

### 5. å¯ç”¨æ›´è¯¦ç»†çš„æ—¥å¿—è®°å½•

åœ¨ä½ çš„ `config.inc.php` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```php
// å¯ç”¨é”™è¯¯æ—¥å¿—
ini_set('log_errors', 1);
ini_set('error_log', __TYPECHO_ROOT_DIR__ . '/error.log');
error_reporting(E_ALL);
```

è¿™æ ·åº”è¯¥èƒ½å¤Ÿè§£å†³è¡¨å•æäº¤ä½†æ•°æ®ä¸ä¿å­˜åˆ°æ•°æ®åº“çš„é—®é¢˜ã€‚å…³é”®çš„ä¿®æ”¹åŒ…æ‹¬ï¼š

1. **æ”¹è¿›äº†é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•**
2. **æ·»åŠ äº†æ•°æ®åº“äº‹åŠ¡æ”¯æŒ**
3. **ä¿®å¤äº†CSRFä»¤ç‰ŒéªŒè¯**
4. **æ”¹è¿›äº†POSTè¯·æ±‚åçš„é‡å®šå‘é€»è¾‘**
5. **å¢å¼ºäº†å­—æ®µéªŒè¯**

è¯·æŒ‰ç…§è¿™äº›ä¿®æ”¹æ›´æ–°ä½ çš„ä»£ç ï¼Œç„¶åæµ‹è¯•è¡¨å•æäº¤åŠŸèƒ½ã€‚
