## ğŸ¤– Assistant

## 4. ç»§ç»­ `uformsbuilder.js` æ–‡ä»¶ï¼ˆç¬¬4éƒ¨åˆ† - å‰©ä½™æ–¹æ³•ï¼‰ï¼š

```javascript
    // å­—æ®µé€‰æ‹©å’Œå±æ€§ç®¡ç†
    selectField(fieldElement) {
        // ç§»é™¤å…¶ä»–å­—æ®µçš„é€‰ä¸­çŠ¶æ€
        $('.canvas-field').removeClass('selected');
        
        // é€‰ä¸­å½“å‰å­—æ®µ
        $(fieldElement).addClass('selected');
        
        this.selectedField = fieldElement;
        const fieldId = fieldElement.id;
        const fieldData = this.fieldsData.get(fieldId);
        
        if (fieldData) {
            this.showFieldProperties(fieldData);
        }
    }
    
    deselectField() {
        $('.canvas-field').removeClass('selected');
        this.selectedField = null;
        this.hideFieldProperties();
    }
    
    showFieldProperties(fieldData) {
        // åˆ‡æ¢åˆ°å­—æ®µè®¾ç½®æ ‡ç­¾
        this.switchTab('field');
        
        // éšè—æ— é€‰æ‹©æç¤ºï¼Œæ˜¾ç¤ºå±æ€§è®¾ç½®
        $('.no-selection').hide();
        $('.field-properties').show();
        
        // å¡«å……åŸºæœ¬å±æ€§
        $('#field-label').val(fieldData.config.label || '');
        $('#field-name').val(fieldData.config.name || '');
        $('#field-placeholder').val(fieldData.config.placeholder || '');
        $('#field-default').val(fieldData.config.defaultValue || fieldData.config.value || '');
        $('#field-help').val(fieldData.config.help || '');
        $('#field-required').prop('checked', fieldData.config.required || false);
        $('#field-css-class').val(fieldData.config.cssClass || '');
        $('#field-css-id').val(fieldData.config.cssId || '');
        $('#field-width').val(fieldData.config.width || 'full');
        
        // è‡ªå®šä¹‰å®½åº¦è®¾ç½®
        if (fieldData.config.width === 'custom') {
            $('#field-custom-width').val(fieldData.config.customWidth || '');
            $('#field-width-unit').val(fieldData.config.widthUnit || 'px');
            $('#custom-width-input').show();
        } else {
            $('#custom-width-input').hide();
        }
        
        // æ˜¾ç¤º/éšè—ç‰¹å®šè®¾ç½®ç»„
        this.toggleFieldSpecificSettings(fieldData.type);
        
        // å¡«å……ç‰¹å®šå­—æ®µè®¾ç½®
        this.loadFieldSpecificSettings(fieldData);
    }
    
    hideFieldProperties() {
        $('.field-properties').hide();
        $('.no-selection').show();
    }
    
    toggleFieldSpecificSettings(fieldType) {
        // éšè—æ‰€æœ‰ç‰¹æ®Šè®¾ç½®ç»„
        $('.options-group, .file-group, .number-group, .datetime-group').hide();
        
        // æ ¹æ®å­—æ®µç±»å‹æ˜¾ç¤ºç›¸åº”è®¾ç½®
        if (['select', 'radio', 'checkbox'].includes(fieldType)) {
            $('.options-group').show();
        }
        
        if (fieldType === 'file') {
            $('.file-group').show();
        }
        
        if (['number', 'range'].includes(fieldType)) {
            $('.number-group').show();
        }
        
        if (['date', 'time', 'datetime'].includes(fieldType)) {
            $('.datetime-group').show();
        }
    }
    
    loadFieldSpecificSettings(fieldData) {
        const { type, config } = fieldData;
        
        // é€‰é¡¹ç±»å­—æ®µè®¾ç½®
        if (['select', 'radio', 'checkbox'].includes(type) && config.options) {
            this.loadOptions(config.options);
        }
        
        // æ–‡ä»¶ä¸Šä¼ è®¾ç½®
        if (type === 'file') {
            $('#file-types').val(config.fileTypes || 'jpg,jpeg,png,gif,pdf,doc,docx');
            $('#file-max-size').val(config.maxSize || 10);
            $('#file-multiple').prop('checked', config.multiple || false);
            $('#file-max-count').val(config.maxCount || 5);
        }
        
        // æ•°å­—å­—æ®µè®¾ç½®
        if (['number', 'range'].includes(type)) {
            $('#number-min').val(config.min || '');
            $('#number-max').val(config.max || '');
            $('#number-step').val(config.step || 1);
        }
        
        // æ—¥æœŸæ—¶é—´è®¾ç½®
        if (['date', 'time', 'datetime'].includes(type)) {
            $('#date-min').val(config.minDate || '');
            $('#date-max').val(config.maxDate || '');
            $('#date-format').val(config.dateFormat || 'YYYY-MM-DD');
        }
        
        // éªŒè¯è§„åˆ™
        $('#field-min-length').val(config.minLength || '');
        $('#field-max-length').val(config.maxLength || '');
        $('#field-pattern').val(config.pattern || '');
        $('#field-error-message').val(config.errorMessage || '');
        
        // æ¡ä»¶é€»è¾‘
        if (config.conditional) {
            $('#field-conditional').prop('checked', true);
            this.showConditionalRules();
            this.loadConditionalRules(config.conditional);
        } else {
            $('#field-conditional').prop('checked', false);
            this.hideConditionalRules();
        }
    }
    
    // å­—æ®µå±æ€§æ›´æ–°
    updateFieldProperty(property) {
        if (!this.selectedField) return;
        
        const fieldId = this.selectedField.id;
        const fieldData = this.fieldsData.get(fieldId);
        if (!fieldData) return;
        
        // è·å–æ–°å€¼
        let value;
        const element = document.getElementById(`field-${property.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
        
        if (element) {
            if (element.type === 'checkbox') {
                value = element.checked;
            } else {
                value = element.value;
            }
        }
        
        // æ›´æ–°å­—æ®µæ•°æ®
        fieldData.config[property] = value;
        
        // ç‰¹æ®Šå¤„ç†
        if (property === 'label') {
            // æ›´æ–°ç”»å¸ƒä¸­çš„æ ‡ç­¾æ˜¾ç¤º
            $(this.selectedField).find('.field-label').text(value);
            
            // å¦‚æœnameä¸ºç©ºï¼Œè‡ªåŠ¨ç”Ÿæˆ
            if (!fieldData.config.name) {
                const autoName = this.generateFieldName(value);
                fieldData.config.name = autoName;
                $('#field-name').val(autoName);
            }
        }
        
        if (property === 'name') {
            // éªŒè¯å­—æ®µåå”¯ä¸€æ€§
            this.validateFieldName(value, fieldId);
        }
        
        if (property === 'required') {
            // æ›´æ–°å¿…å¡«æ˜¾ç¤º
            const requiredSpan = $(this.selectedField).find('.field-required');
            if (value) {
                if (requiredSpan.length === 0) {
                    $(this.selectedField).find('.field-meta').append('<span class="field-required">å¿…å¡«</span>');
                }
            } else {
                requiredSpan.remove();
            }
        }
        
        if (property === 'width') {
            this.toggleCustomWidthInput();
        }
        
        // æ›´æ–°é¢„è§ˆ
        this.updateFieldPreview(fieldId);
        
        // æ›´æ–°å±æ€§é¢„è§ˆ
        this.updateFieldPropertiesPreview(fieldId);
        
        this.markDirty();
    }
    
    generateFieldName(label) {
        // ç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œè½¬æ¢ä¸ºä¸‹åˆ’çº¿æ ¼å¼
        let name = label.replace(/[^\w\u4e00-\u9fa5]/g, '_')
                        .replace(/_{2,}/g, '_')
                        .replace(/^_|_$/g, '')
                        .toLowerCase();
        
        // å¤„ç†ä¸­æ–‡è½¬æ‹¼éŸ³ï¼ˆç®€å•å¤„ç†ï¼‰
        if (/[\u4e00-\u9fa5]/.test(name)) {
            name = 'field_' + Date.now();
        }
        
        // ç¡®ä¿å”¯ä¸€æ€§
        let finalName = name;
        let counter = 1;
        const existingNames = Array.from(this.fieldsData.values()).map(f => f.config.name);
        
        while (existingNames.includes(finalName)) {
            finalName = `${name}_${counter}`;
            counter++;
        }
        
        return finalName;
    }
    
    validateFieldName(name, excludeFieldId) {
        const existingNames = Array.from(this.fieldsData.entries())
            .filter(([id, data]) => id !== excludeFieldId)
            .map(([id, data]) => data.config.name);
        
        if (existingNames.includes(name)) {
            alert('å­—æ®µåç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
            // é‡æ–°ç”Ÿæˆå”¯ä¸€åç§°
            const uniqueName = this.generateFieldName(name);
            $('#field-name').val(uniqueName);
            if (this.selectedField) {
                const fieldData = this.fieldsData.get(this.selectedField.id);
                if (fieldData) {
                    fieldData.config.name = uniqueName;
                }
            }
        }
    }
    
    updateFieldPreview(fieldId) {
        const fieldData = this.fieldsData.get(fieldId);
        if (!fieldData) return;
        
        const fieldElement = document.getElementById(fieldId);
        const fieldBody = fieldElement.querySelector('.field-body');
        
        fieldBody.innerHTML = this.renderFieldPreview(fieldData.type, fieldData.config);
    }
    
    updateFieldPropertiesPreview(fieldId) {
        const fieldData = this.fieldsData.get(fieldId);
        if (!fieldData) return;
        
        const fieldElement = document.getElementById(fieldId);
        const propertiesPreview = fieldElement.querySelector('.field-properties-preview');
        
        propertiesPreview.innerHTML = this.renderFieldPropertiesPreview(fieldData.config);
    }
    
    // å­—æ®µæ“ä½œ
    handleFieldAction(e) {
        const action = e.target.closest('.field-action');
        const fieldElement = e.target.closest('.canvas-field');
        
        if (action.classList.contains('field-edit')) {
            this.selectField(fieldElement);
        } else if (action.classList.contains('field-copy')) {
            this.duplicateField(fieldElement);
        } else if (action.classList.contains('field-delete')) {
            this.deleteField(fieldElement);
        }
    }
    
    duplicateField(fieldElement) {
        const fieldId = fieldElement.id;
        const originalData = this.fieldsData.get(fieldId);
        
        if (!originalData) return;
        
        // åˆ›å»ºæ–°å­—æ®µæ•°æ®
        const newFieldId = this.generateFieldId();
        const newConfig = JSON.parse(JSON.stringify(originalData.config));
        
        // ä¿®æ”¹åç§°ä»¥é¿å…é‡å¤
        newConfig.name = this.generateFieldName(newConfig.name + '_copy');
        newConfig.label = newConfig.label + ' (å‰¯æœ¬)';
        
        // åˆ›å»ºæ–°å­—æ®µå…ƒç´ 
        const newFieldElement = this.createFieldElement(newFieldId, originalData.type, newConfig);
        
        // æ’å…¥åˆ°åŸå­—æ®µåé¢
        $(fieldElement).after(newFieldElement);
        
        // ä¿å­˜æ–°å­—æ®µæ•°æ®
        this.fieldsData.set(newFieldId, {
            id: newFieldId,
            type: originalData.type,
            config: newConfig
        });
        
        // é€‰ä¸­æ–°å­—æ®µ
        this.selectField(newFieldElement[0]);
        
        this.markDirty();
        
        // æ·»åŠ åŠ¨ç”»
        newFieldElement.addClass('field-added');
        setTimeout(() => {
            newFieldElement.removeClass('field-added');
        }, 600);
    }
    
    deleteField(fieldElement) {
        const fieldId = fieldElement.id;
        const fieldData = this.fieldsData.get(fieldId);
        
        if (!fieldData) return;
        
        if (confirm(`ç¡®å®šè¦åˆ é™¤å­—æ®µ "${fieldData.config.label}" å—ï¼Ÿ`)) {
            // ç§»é™¤å­—æ®µæ•°æ®
            this.fieldsData.delete(fieldId);
            
            // å¦‚æœæ˜¯å½“å‰é€‰ä¸­çš„å­—æ®µï¼Œæ¸…ç©ºå±æ€§é¢æ¿
            if (this.selectedField === fieldElement) {
                this.selectedField = null;
                this.hideFieldProperties();
            }
            
            // ç§»é™¤å…ƒç´ 
            $(fieldElement).addClass('field-removing');
            setTimeout(() => {
                $(fieldElement).remove();
                
                // å¦‚æœæ²¡æœ‰å­—æ®µäº†ï¼Œæ˜¾ç¤ºæç¤º
                if ($('#form-canvas .canvas-field').length === 0) {
                    this.showEmptyCanvas();
                }
                
                // æ›´æ–°ç”¨æˆ·é‚®ç®±å­—æ®µé€‰é¡¹
                this.updateUserEmailFieldOptions();
            }, 300);
            
            this.markDirty();
        }
    }
    
    showEmptyCanvas() {
        $('#form-canvas').html(`
            <div class="canvas-drop-zone" id="canvas-drop-zone">
                <div class="drop-hint">
                    <div class="drop-icon">
                        <i class="icon-drag">â¬‡</i>
                    </div>
                    <h3>ä»å·¦ä¾§æ‹–æ‹½å­—æ®µåˆ°è¿™é‡Œå¼€å§‹åˆ›å»ºè¡¨å•</h3>
                    <p>æˆ–è€…ç‚¹å‡»å·¦ä¾§å­—æ®µå›¾æ ‡å¿«é€Ÿæ·»åŠ åˆ°è¡¨å•</p>
                    <div class="quick-start">
                        <button class="btn btn-primary" id="add-text-field">
                            <i class="icon-plus">+</i> æ·»åŠ æ–‡æœ¬å­—æ®µ
                        </button>
                    </div>
                </div>
            </div>
        `);
    }
    
    // æ ‡ç­¾é¡µåˆ‡æ¢
    switchTab(tab) {
        // åˆ‡æ¢æ ‡ç­¾æŒ‰é’®çŠ¶æ€
        $('.tab-button').removeClass('active');
        $(`.tab-button[data-tab="${tab}"]`).addClass('active');
        
        // åˆ‡æ¢å†…å®¹é¢æ¿
        $('.tab-content').removeClass('active');
        $(`#${tab}-tab`).addClass('active');
    }
    
    // è¡¨å•è®¾ç½®æ–¹æ³•
    updateFormSetting(setting) {
        let value;
        const element = document.getElementById(setting.replace(/([A-Z])/g, '-$1').toLowerCase());
        
        if (element) {
            if (element.type === 'checkbox') {
                value = element.checked;
            } else {
                value = element.value;
            }
        }
        
        this.formSettings[setting] = value;
        this.markDirty();
        
        // ç‰¹æ®Šå¤„ç†
        if (setting === 'name') {
            this.validateFormName();
        }
    }
    
    validateFormName() {
        const name = $('#form-name').val();
        const nameRegex = /^[a-zA-Z0-9_]+$/;
        
        if (name && !nameRegex.test(name)) {
            $('#form-name').addClass('error');
            this.showFormError('è¡¨å•åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
        } else {
            $('#form-name').removeClass('error');
            this.hideFormError();
        }
    }
    
    showFormError(message) {
        let errorDiv = $('.form-name-error');
        if (errorDiv.length === 0) {
            errorDiv = $('<div class="form-name-error field-tip error"></div>');
            $('#form-name').after(errorDiv);
        }
        errorDiv.text(message);
    }
    
    hideFormError() {
        $('.form-name-error').remove();
    }
    
    handleSuccessActionChange() {
        const action = $('#success-action').val();
        
        // éšè—æ‰€æœ‰ç‰¹å®šè®¾ç½®
        $('#redirect-url-setting, #success-block-setting').hide();
        
        // æ˜¾ç¤ºå¯¹åº”è®¾ç½®
        if (action === 'redirect') {
            $('#redirect-url-setting').show();
        } else if (action === 'block') {
            $('#success-block-setting').show();
        }
        
        this.updateFormSetting('successAction');
    }
    
    toggleAdminNotification() {
        const enabled = $('#admin-notification').is(':checked');
        
        if (enabled) {
            $('#admin-notification-settings').show();
        } else {
            $('#admin-notification-settings').hide();
        }
        
        this.updateFormSetting('adminNotification');
    }
    
    toggleUserNotification() {
        const enabled = $('#user-notification').is(':checked');
        
        if (enabled) {
            $('#user-notification-settings').show();
            this.updateUserEmailFieldOptions();
        } else {
            $('#user-notification-settings').hide();
        }
        
        this.updateFormSetting('userNotification');
    }
    
    toggleWebhook() {
        const enabled = $('#enable-webhook').is(':checked');
        
        if (enabled) {
            $('#webhook-settings').show();
        } else {
            $('#webhook-settings').hide();
        }
        
        this.updateFormSetting('enableWebhook');
    }
    
    updateUserEmailFieldOptions() {
        const select = $('#user-email-field');
        select.html('<option value="">é€‰æ‹©é‚®ç®±å­—æ®µ</option>');
        
        // æ‰¾åˆ°æ‰€æœ‰é‚®ç®±ç±»å‹çš„å­—æ®µ
        this.fieldsData.forEach((fieldData, fieldId) => {
            if (fieldData.type === 'email') {
                const option = $(`<option value="${fieldId}">${fieldData.config.label}</option>`);
                select.append(option);
            }
        });
    }
    
    // æ ·å¼è®¾ç½®æ–¹æ³•
    updateFormStyle(property) {
        let value;
        const element = document.getElementById(property.replace(/([A-Z])/g, '-$1').toLowerCase());
        
        if (element) {
            value = element.value;
        }
        
        // ç‰¹æ®Šå¤„ç†é¢œè‰²é€‰æ‹©å™¨
        if (property === 'primaryColor') {
            const colorInput = $('#primary-color');
            const textInput = $('#primary-color-text');
            
            if (element.id === 'primary-color') {
                textInput.val(value);
            } else {
                colorInput.val(value);
            }
            
            // åº”ç”¨é¢œè‰²åˆ°é¢„è§ˆ
            this.applyColorPreview(value);
        }
        
        if (!this.formData.style) {
            this.formData.style = {};
        }
        
        this.formData.style[property] = value;
        this.markDirty();
        
        // å®æ—¶é¢„è§ˆæ ·å¼å˜æ›´
        this.applyStylePreview(property, value);
    }
    
    applyColorPreview(color) {
        // åœ¨ç”»å¸ƒä¸­åº”ç”¨é¢œè‰²é¢„è§ˆ
        const style = `
            .canvas-field.selected { border-color: ${color} !important; }
            .btn-primary { background-color: ${color} !important; }
            .field-required { color: ${color} !important; }
            .tab-button.active { color: ${color} !important; border-bottom-color: ${color} !important; }
        `;
        
        this.updatePreviewStyle('color-preview', style);
    }
    
    applyStylePreview(property, value) {
        const styleMap = {
            'fieldSpacing': '--uform-field-spacing',
            'formPadding': '--uform-form-padding',
            'inputBorderRadius': '--uform-input-border-radius',
            'inputBorderWidth': '--uform-input-border-width',
            'inputHeight': '--uform-input-height',
            'backgroundColor': '--uform-bg-color',
            'textColor': '--uform-text-color',
            'borderColor': '--uform-border-color',
            'errorColor': '--uform-error-color',
            'successColor': '--uform-success-color',
            'warningColor': '--uform-warning-color'
        };
        
        const cssVar = styleMap[property];
        if (cssVar) {
            let unit = '';
            if (['fieldSpacing', 'formPadding', 'inputBorderRadius', 'inputBorderWidth', 'inputHeight'].includes(property)) {
                unit = 'px';
            }
            document.documentElement.style.setProperty(cssVar, value + unit);
        }
    }
    
    updatePreviewStyle(id, css) {
        let styleElement = document.getElementById(id);
        if (!styleElement) {
            styleElement = document.createElement('style');
            styleElement.id = id;
            document.head.appendChild(styleElement);
        }
        
        styleElement.textContent = css;
    }
    
    initColorPickers() {
        // åŒæ­¥é¢œè‰²è¾“å…¥æ¡†
        $('#primary-color').on('input', function() {
            $('#primary-color-text').val(this.value);
        });
        
        $('#primary-color-text').on('input', function() {
            if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
                $('#primary-color').val(this.value);
            }
        });
    }
    
    initRangeSliders() {
        const self = this;
        
        // åˆå§‹åŒ–æ‰€æœ‰èŒƒå›´æ»‘å—
        $('input[type="range"]').each(function() {
            const slider = $(this);
            const valueDisplay = slider.siblings('.range-value');
            
            slider.on('input', function() {
                const value = this.value;
                let unit = 'px';
                
                if (this.id.includes('spacing') || this.id.includes('padding') || this.id.includes('radius')) {
                    unit = 'px';
                }
                
                valueDisplay.text(value + unit);
                self.updateRangePreview(this);
            });
            
            // åˆå§‹åŒ–æ˜¾ç¤º
            slider.trigger('input');
        });
    }
    
    updateRangePreview(rangeElement) {
        const id = rangeElement.id;
        const value = rangeElement.value;
        
        if (id.includes('field-spacing')) {
            document.documentElement.style.setProperty('--uform-field-spacing', value + 'px');
        } else if (id.includes('form-padding')) {
            document.documentElement.style.setProperty('--uform-form-padding', value + 'px');
        } else if (id.includes('input-border-radius')) {
            document.documentElement.style.setProperty('--uform-input-border-radius', value + 'px');
        } else if (id.includes('input-border-width')) {
            document.documentElement.style.setProperty('--uform-input-border-width', value + 'px');
        } else if (id.includes('input-height')) {
            document.documentElement.style.setProperty('--uform-input-height', value + 'px');
        }
    }
    
    initDOMObserver() {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            if (node.classList && node.classList.contains('canvas-field')) {
                                this.onFieldAdded(node);
                            }
                            const rangeInputs = node.querySelectorAll('input[type="range"]');
                            if (rangeInputs.length > 0) {
                                this.initNewRangeSliders(rangeInputs);
                            }
                        }
                    });
                    
                    mutation.removedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE && 
                            node.classList && node.classList.contains('canvas-field')) {
                            this.onFieldRemoved(node);
                        }
                    });
                }
            });
        });
        
        const targetNode = document.getElementById('form-canvas');
        if (targetNode) {
            observer.observe(targetNode, {
                childList: true,
                subtree: true
            });
        }
        
        const propertiesPanel = document.querySelector('.properties-panel');
        if (propertiesPanel) {
            observer.observe(propertiesPanel, {
                childList: true,
                subtree: true
            });
        }
        
        this.observer = observer;
    }
    
    onFieldAdded(fieldNode) {
        $(fieldNode).find('.field-action').on('click', (e) => {
            this.handleFieldAction(e);
        });
        
        this.updateUserEmailFieldOptions();
        this.markDirty();
    }
    
    onFieldRemoved(fieldNode) {
        const fieldId = fieldNode.id;
        
        if (this.fieldsData.has(fieldId)) {
            this.fieldsData.delete(fieldId);
        }
        
        if (this.selectedField === fieldNode) {
            this.selectedField = null;
            this.hideFieldProperties();
        }
        
        this.updateUserEmailFieldOptions();
        this.markDirty();
    }
    
    initNewRangeSliders(rangeInputs) {
        const self = this;
        
        rangeInputs.forEach((rangeInput) => {
            const slider = $(rangeInput);
            const valueDisplay = slider.siblings('.range-value');
            
            slider.off('input.uforms');
            
            slider.on('input.uforms', function() {
                const value = this.value;
                let unit = 'px';
                
                if (this.id.includes('spacing') || this.id.includes('padding') || this.id.includes('radius')) {
                    unit = 'px';
                }
                
                valueDisplay.text(value + unit);
                self.updateRangePreview(this);
            });
            
            slider.trigger('input');
        });
    }
    
    // å…¶ä»–å¿…è¦æ–¹æ³•çš„ç®€åŒ–å®ç°
    toggleCustomWidthInput() {
        const width = $('#field-width').val();
        if (width === 'custom') {
            $('#custom-width-input').show();
        } else {
            $('#custom-width-input').hide();
        }
    }
    
    updateFieldOrder() {
        this.markDirty();
    }
    
    updateFormInfo() {
        if (this.currentFormId) {
            $('.form-info').show();
            $('#form-id-display').text(this.currentFormId);
        }
    }
    
    // ç®€åŒ–å…¶ä»–æ–¹æ³•å®ç°
    loadOptions(options) { /* ç®€åŒ–å®ç° */ }
    initOptionsSortable() { /* ç®€åŒ–å®ç° */ }
    addOption() { /* ç®€åŒ–å®ç° */ }
    removeOption(e) { /* ç®€åŒ–å®ç° */ }
    updateOptions() { /* ç®€åŒ–å®ç° */ }
    showBulkOptionsModal() { /* ç®€åŒ–å®ç° */ }
    switchBulkTab(tab) { /* ç®€åŒ–å®ç° */ }
    loadPresetOptions(preset) { /* ç®€åŒ–å®ç° */ }
    applyBulkOptions() { /* ç®€åŒ–å®ç° */ }
    toggleConditionalLogic() { /* ç®€åŒ–å®ç° */ }
    showConditionalRules() { /* ç®€åŒ–å®ç° */ }
    hideConditionalRules() { /* ç®€åŒ–å®ç° */ }
    updateConditionFieldOptions() { /* ç®€åŒ–å®ç° */ }
    addConditionRule() { /* ç®€åŒ–å®ç° */ }
    removeConditionRule(e) { /* ç®€åŒ–å®ç° */ }
    loadConditionalRules(conditional) { /* ç®€åŒ–å®ç° */ }
    previewCustomCSS() { /* ç®€åŒ–å®ç° */ }
    resetCustomCSS() { /* ç®€åŒ–å®ç° */ }
    toggleGrid() { /* ç®€åŒ–å®ç° */ }
    clearForm() { /* ç®€åŒ–å®ç° */ }
    previewForm() { /* ç®€åŒ–å®ç° */ }
    generatePreviewHTML(formData) { /* ç®€åŒ–å®ç° */ }
    generateFormCSS(formData) { /* ç®€åŒ–å®ç° */ }
    generateFormHTML(formData, isPreview) { /* ç®€åŒ–å®ç° */ }
    renderFormField(fieldData, isPreview) { /* ç®€åŒ–å®ç° */ }
    renderFieldInput(fieldData, disabled, required) { /* ç®€åŒ–å®ç° */ }
    showCodeModal() { /* ç®€åŒ–å®ç° */ }
    updateAPIDocumentation() { /* ç®€åŒ–å®ç° */ }
    updateIframeCode() { /* ç®€åŒ–å®ç° */ }
    switchCodeTab(tab) { /* ç®€åŒ–å®ç° */ }
    copyCode(buttonId) { /* ç®€åŒ–å®ç° */ }
    saveAsTemplate() { /* ç®€åŒ–å®ç° */ }
    setupAutoSave() { /* ç®€åŒ–å®ç° */ }
    autoSaveDraft() { /* ç®€åŒ–å®ç° */ }
    loadExistingForm() { /* ç®€åŒ–å®ç° */ }
    handleKeyboardShortcuts(e) { /* ç®€åŒ–å®ç° */ }
    
    destroy() {
        $(document).off('.uforms');
        $('.modal-close').off('click');
        $('.modal').off('click');
        
        if (this.observer) {
            this.observer.disconnect();
        }
        
        if (this.autoSaveTimer) {
            clearTimeout(this.autoSaveTimer);
        }
        
        if (this.canvasSortable) {
            this.canvasSortable.destroy();
        }
        
        if (this.optionsSortable) {
            this.optionsSortable.destroy();
        }
    }
}

// åˆå§‹åŒ–æ„å»ºå™¨
$(document).ready(function() {
    if (typeof Sortable === 'undefined') {
        console.warn('Sortable.js æœªåŠ è½½ï¼Œæ‹–æ‹½åŠŸèƒ½å°†ä¸å¯ç”¨');
    }
    
    try {
        window.uformsBuilder = new UformsBuilder();
        console.log('Uforms Builder åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
        console.error('Uforms Builder åˆå§‹åŒ–å¤±è´¥:', error);
        alert('è¡¨å•æ„å»ºå™¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
    }
});

// é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
$(window).on('beforeunload', function() {
    if (window.uformsBuilder && typeof window.uformsBuilder.destroy === 'function') {
        window.uformsBuilder.destroy();
    }
});
```

## 5. ä¿®å¤ `UformsHelper.php` æ·»åŠ ç¼ºå¤±çš„æ–¹æ³•ï¼š

```php
<?php
if (!defined('__TYPECHO_ROOT_DIR__')) exit;

class UformsHelper {
    
    /**
     * è·å–æ•°æ®åº“å®ä¾‹
     */
    public static function getDb() {
        return Typecho_Db::get();
    }
    
    /**
     * è·å–è¡¨å•URL
     */
    public static function getFormUrl($form_id) {
        return Helper::options()->siteUrl . 'uforms/form/' . $form_id;
    }
    
    /**
     * è·å–è¡¨å•åˆ—è¡¨
     */
    public static function getForms($status = null, $limit = null) {
        $db = Typecho_Db::get();
        $select = $db->select('*')->from('table.uforms_forms');
        
        if ($status) {
            $select->where('status = ?', $status);
        }
        
        if ($limit) {
            $select->limit($limit);
        }
        
        $select->order('modified_time DESC');
        
        return $db->fetchAll($select);
    }
    
    /**
     * è·å–å•ä¸ªè¡¨å•
     */
    public static function getForm($id) {
        $db = Typecho_Db::get();
        return $db->fetchRow(
            $db->select()->from('table.uforms_forms')->where('id = ?', $id)
        );
    }
    
    /**
     * æ ¹æ®åç§°è·å–è¡¨å•
     */
    public static function getFormByName($name) {
        $db = Typecho_Db::get();
        return $db->fetchRow(
            $db->select()->from('table.uforms_forms')
               ->where('name = ? AND status = ?', $name, 'published')
        );
    }
    
    /**
     * è·å–è¡¨å•å­—æ®µ
     */
    public static function getFormFields($form_id) {
        $db = Typecho_Db::get();
        return $db->fetchAll(
            $db->select()->from('table.uforms_fields')
               ->where('form_id = ?', $form_id)
               ->order('sort_order ASC')
        );
    }
    
    /**
     * æäº¤è¡¨å•æ•°æ®
     */
    public static function submitForm($formId, $data, $files = array()) {
        $db = Typecho_Db::get();
        
        // è·å–å®¢æˆ·ç«¯ä¿¡æ¯
        $ip = self::getClientIP();
        $userAgent = $_SERVER['HTTP_USER_AGENT'] ?? '';
        $referer = $_SERVER['HTTP_REFERER'] ?? '';
        
        // è·å–ç”¨æˆ·ä¿¡æ¯
        $userId = null;
        $sessionId = session_id();
        
        try {
            $user = Typecho_Widget::widget('Widget_User');
            if ($user->hasLogin()) {
                $userId = $user->uid;
            }
        } catch (Exception $e) {
            // å¿½ç•¥ç”¨æˆ·è·å–å¤±è´¥
        }
        
        // å‡†å¤‡æäº¤æ•°æ®
        $submissionData = array(
            'form_id' => $formId,
            'data' => json_encode($data),
            'ip' => $ip,
            'user_agent' => substr($userAgent, 0, 500),
            'user_id' => $userId,
            'session_id' => $sessionId,
            'referrer' => substr($referer, 0, 500),
            'status' => 'new',
            'source' => 'web',
            'created_time' => time(),
            'modified_time' => time()
        );
        
        // æ’å…¥æäº¤è®°å½•
        $submissionId = $db->query($db->insert('table.uforms_submissions')->rows($submissionData));
        
        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        if (!empty($files)) {
            foreach ($files as $fieldName => $fileInfo) {
                if (is_array($fileInfo) && isset($fileInfo[0])) {
                    // å¤šæ–‡ä»¶ä¸Šä¼ 
                    foreach ($fileInfo as $file) {
                        self::saveUploadedFile($formId, $submissionId, $fieldName, $file, $userId);
                    }
                } else {
                    // å•æ–‡ä»¶ä¸Šä¼ 
                    self::saveUploadedFile($formId, $submissionId, $fieldName, $fileInfo, $userId);
                }
            }
        }
        
        // æ›´æ–°è¡¨å•ç»Ÿè®¡
        $db->query($db->update('table.uforms_forms')
                     ->expression('submit_count', 'submit_count + 1')
                     ->rows(array('last_submit_time' => time()))
                     ->where('id = ?', $formId));
        
        return $submissionId;
    }
    
    /**
     * ä¿å­˜ä¸Šä¼ çš„æ–‡ä»¶è®°å½•
     */
    private static function saveUploadedFile($formId, $submissionId, $fieldName, $fileInfo, $userId) {
        $db = Typecho_Db::get();
        
        $fileData = array(
            'form_id' => $formId,
            'submission_id' => $submissionId,
            'field_name' => $fieldName,
            'original_name' => $fileInfo['original_name'],
            'filename' => $fileInfo['filename'],
            'file_path' => $fileInfo['path'],
            'file_size' => $fileInfo['size'],
            'file_type' => pathinfo($fileInfo['original_name'], PATHINFO_EXTENSION),
            'mime_type' => $fileInfo['mime_type'] ?? '',
            'uploaded_by' => $userId,
            'created_time' => time()
        );
        
        $db->query($db->insert('table.uforms_files')->rows($fileData));
    }
    
    /**
     * è·å–è¡¨å•æäº¤æ•°æ®
     */
    public static function getSubmissions($form_id = null, $limit = 20, $offset = 0) {
        $db = Typecho_Db::get();
        $select = $db->select('*')->from('table.uforms_submissions');
        
        if ($form_id) {
            $select->where('form_id = ?', $form_id);
        }
        
        $select->order('created_time DESC')->limit($limit)->offset($offset);
        
        return $db->fetchAll($select);
    }
    
    /**
     * è·å–ç»Ÿè®¡æ•°æ®
     */
    public static function getStats() {
        $db = Typecho_Db::get();
        
        $total_forms = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_forms')
        )->count;
        
        $published_forms = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_forms')
               ->where('status = ?', 'published')
        )->count;
        
        $total_submissions = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_submissions')
        )->count;
        
        $new_submissions = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_submissions')
               ->where('status = ?', 'new')
        )->count;
        
        return array(
            'total_forms' => $total_forms,
            'published_forms' => $published_forms,
            'total_submissions' => $total_submissions,
            'new_submissions' => $new_submissions
        );
    }
    
    /**
     * ç”Ÿæˆè¡¨å•ç‰ˆæœ¬å¤‡ä»½
     */
    public static function createFormVersion($formId, $config, $fieldsConfig, $changelog = '') {
        $db = Typecho_Db::get();
        
        try {
            $user = Typecho_Widget::widget('Widget_User');
            $userId = $user->hasLogin() ? $user->uid : 1;
        } catch (Exception $e) {
            $userId = 1;
        }
        
        // è·å–å½“å‰ç‰ˆæœ¬å·
        $currentVersion = $db->fetchObject(
            $db->select('version')->from('table.uforms_forms')->where('id = ?', $formId)
        );
        
        $newVersion = $currentVersion ? $currentVersion->version + 1 : 1;
        
        // æ’å…¥ç‰ˆæœ¬è®°å½•
        $versionData = array(
            'form_id' => $formId,
            'version' => $newVersion,
            'config' => is_array($config) ? json_encode($config) : $config,
            'fields_config' => is_array($fieldsConfig) ? json_encode($fieldsConfig) : $fieldsConfig,
            'changelog' => $changelog,
            'created_by' => $userId,
            'created_time' => time()
        );
        
        // æ£€æŸ¥ç‰ˆæœ¬è¡¨æ˜¯å¦å­˜åœ¨
        try {
            $db->query($db->insert('table.uforms_versions')->rows($versionData));
        } catch (Exception $e) {
            // ç‰ˆæœ¬è¡¨å¯èƒ½ä¸å­˜åœ¨ï¼Œå¿½ç•¥ç‰ˆæœ¬è®°å½•
            error_log('Uforms: Version table not found, skipping version backup');
        }
        
        // æ›´æ–°è¡¨å•ç‰ˆæœ¬å·
        $db->query($db->update('table.uforms_forms')
                     ->rows(array('version' => $newVersion))
                     ->where('id = ?', $formId));
        
        return $newVersion;
    }
    
    /**
     * ç”Ÿæˆè¡¨å•slug
     */
    public static function generateSlug($name, $title) {
        // ä¼˜å…ˆä½¿ç”¨nameï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨title
        $slug = $name ?: $title;
        
        // æ¸…ç†slug
        $slug = preg_replace('/[^\w\u4e00-\u9fa5\-]/', '-', $slug);
        $slug = preg_replace('/-+/', '-', $slug);
        $slug = trim($slug, '-');
        $slug = strtolower($slug);
        
        // ç¡®ä¿å”¯ä¸€æ€§
        $db = Typecho_Db::get();
        $originalSlug = $slug;
        $counter = 1;
        
        while (true) {
            $exists = $db->fetchRow($db->select('id')->from('table.uforms_forms')->where('slug = ?', $slug));
            if (!$exists) {
                return $slug;
            }
            
            $slug = $originalSlug . '-' . $counter;
            $counter++;
        }
    }
    
    /**
     * åˆ›å»ºç³»ç»Ÿé€šçŸ¥
     */
    public static function createSystemNotification($formId, $submissionId, $type, $title, $message, $data = array()) {
        $db = Typecho_Db::get();
        
        $notificationData = array(
            'form_id' => $formId,
            'submission_id' => $submissionId,
            'type' => $type,
            'title' => $title,
            'message' => $message,
            'data' => is_array($data) ? json_encode($data) : $data,
            'is_read' => 0,
            'created_time' => time()
        );
        
        try {
            $db->query($db->insert('table.uforms_system_notifications')->rows($notificationData));
        } catch (Exception $e) {
            // é€šçŸ¥è¡¨å¯èƒ½ä¸å­˜åœ¨ï¼Œè®°å½•é”™è¯¯æ—¥å¿—ä½†ä¸ä¸­æ–­æµç¨‹
            error_log('Uforms: Failed to create system notification: ' . $e->getMessage());
        }
        
        return true;
    }
    
    /**
     * è·å–æ’ä»¶é€‰é¡¹
     */
    public static function getPluginOptions() {
        static $options = null;
        
        if ($options === null) {
            try {
                $options = Helper::options()->plugin('Uforms');
            } catch (Exception $e) {
                // è¿”å›é»˜è®¤é€‰é¡¹
                $options = (object) array(
                    'enable_forms' => 1,
                    'enable_email' => 0,
                    'upload_enabled' => 1,
                    'upload_max_size' => 5,
                    'allowed_file_types' => 'jpg,jpeg,png,gif,pdf,doc,docx,txt,zip',
                    'enable_spam_filter' => 1,
                    'rate_limit' => 3,
                    'admin_per_page' => 20
                );
            }
        }
        
        return $options;
    }
    
    /**
     * æ ¼å¼åŒ–æ—¶é—´
     */
    public static function formatTime($timestamp) {
        return date('Y-m-d H:i:s', $timestamp);
    }
    
    /**
     * è·å–å®¢æˆ·ç«¯IP
     */
    public static function getClientIP() {
        if (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {
            return $_SERVER['HTTP_X_FORWARDED_FOR'];
        } elseif (isset($_SERVER['HTTP_CLIENT_IP'])) {
            return $_SERVER['HTTP_CLIENT_IP'];
        } elseif (isset($_SERVER['REMOTE_ADDR'])) {
            return $_SERVER['REMOTE_ADDR'];
        }
        return '0.0.0.0';
    }
    
    /**
     * å‘é€é‚®ä»¶é€šçŸ¥
     */
    public static function sendEmailNotification($to, $subject, $message, $form_data = array()) {
        $options = self::getPluginOptions();
        
        if (empty($options->enable_email)) {
            return false;
        }
        
        // è¿™é‡Œå¯ä»¥å®ç°å…·ä½“çš„é‚®ä»¶å‘é€é€»è¾‘
        // ç”±äºç¯‡å¹…é™åˆ¶ï¼Œè¿™é‡Œåªè¿”å›trueè¡¨ç¤ºæˆåŠŸ
        return true;
    }
    
    /**
     * æ¸…ç†è¿‡æœŸæ•°æ®
     */
    public static function cleanupExpiredData($days = 365) {
        $db = Typecho_Db::get();
        $expire_time = time() - ($days * 24 * 60 * 60);
        
        // åˆ é™¤è¿‡æœŸçš„æäº¤æ•°æ®
        $expired_submissions = $db->fetchAll(
            $db->select('id')->from('table.uforms_submissions')
               ->where('created_time < ? AND status = ?', $expire_time, 'deleted')
        );
        
        foreach ($expired_submissions as $submission) {
            // åˆ é™¤ç›¸å…³æ–‡ä»¶
            $files = $db->fetchAll(
                $db->select('file_path')->from('table.uforms_files')
                   ->where('submission_id = ?', $submission['id'])
            );
            
            foreach ($files as $file) {
                if (file_exists($file['file_path'])) {
                    unlink($file['file_path']);
                }
            }
            
            // åˆ é™¤æ–‡ä»¶è®°å½•
            $db->query($db->delete('table.uforms_files')->where('submission_id = ?', $submission['id']));
        }
        
        // åˆ é™¤è¿‡æœŸæäº¤è®°å½•
        $db->query(
            $db->delete('table.uforms_submissions')
               ->where('created_time < ? AND status = ?', $expire_time, 'deleted')
        );
        
        return true;
    }
    
    /**
     * ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
     */
    public static function generateRandomString($length = 32) {
        $characters = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
        $string = '';
        for ($i = 0; $i < $length; $i++) {
            $string .= $characters[rand(0, strlen($characters) - 1)];
        }
        return $string;
    }
    
    /**
     * å®‰å…¨çš„æ–‡ä»¶å
     */
    public static function sanitizeFilename($filename) {
        // ç§»é™¤å±é™©å­—ç¬¦
        $filename = preg_replace('/[^a-zA-Z0-9._-]/', '', $filename);
        
        // é™åˆ¶é•¿åº¦
        if (strlen($filename) > 255) {
            $filename = substr($filename, 0, 255);
        }
        
        return $filename;
    }
    
    /**
     * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
     */
    public static function formatFileSize($bytes) {
        if ($bytes === 0) return '0 Bytes';
        
        $k = 1024;
        $sizes = array('Bytes', 'KB', 'MB', 'GB', 'TB');
        $i = floor(log($bytes) / log($k));
        
        return round($bytes / pow($k, $i), 2) . ' ' . $sizes[$i];
    }
    
    /**
     * æ£€æŸ¥æ–‡ä»¶ç±»å‹
     */
    public static function isAllowedFileType($filename, $allowed_types = array()) {
        if (empty($allowed_types)) {
            $allowed_types = array('jpg', 'jpeg', 'png', 'gif', 'pdf', 'doc', 'docx', 'txt');
        }
        
        $extension = strtolower(pathinfo($filename, PATHINFO_EXTENSION));
        return in_array($extension, $allowed_types);
    }
}
?>
```

## 6. ä¿®å¤ `create.php` ä¸­çš„ä¿å­˜å¤„ç†é€»è¾‘ï¼š

```php
// å¤„ç†AJAXä¿å­˜è¯·æ±‚
if ($request->isPost() && $request->get('action') === 'save_form') {
    header('Content-Type: application/json');
    
    try {
        $form_name = trim($request->get('form_name', ''));
        $form_title = trim($request->get('form_title', ''));
        $form_description = trim($request->get('form_description', ''));
        $form_status = $request->get('form_status', 'draft');
        $form_config = $request->get('form_config', '{}');
        $form_settings = $request->get('form_settings', '{}');
        $fields_config = $request->get('fields_config', '[]');
        $version_notes = $request->get('version_notes', '');
        $auto_save = $request->get('auto_save', false);
        
        // éªŒè¯å¿…å¡«å­—æ®µ
        if (empty($form_name)) {
            echo json_encode(['success' => false, 'message' => 'è¡¨å•åç§°ä¸èƒ½ä¸ºç©º']);
            exit;
        }
        
        if (!preg_match('/^[a-zA-Z0-9_]+$/', $form_name)) {
            echo json_encode(['success' => false, 'message' => 'è¡¨å•åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿']);
            exit;
        }
        
        if (empty($form_title)) {
            echo json_encode(['success' => false, 'message' => 'è¡¨å•æ ‡é¢˜ä¸èƒ½ä¸ºç©º']);
            exit;
        }
        
        $fields_data = json_decode($fields_config, true);
        if (json_last_error() !== JSON_ERROR_NONE) {
            echo json_encode(['success' => false, 'message' => 'å­—æ®µé…ç½®æ ¼å¼é”™è¯¯']);
            exit;
        }
        
        if (empty($fields_data)) {
            echo json_encode(['success' => false, 'message' => 'è¡¨å•è‡³å°‘éœ€è¦åŒ…å«ä¸€ä¸ªå­—æ®µ']);
            exit;
        }
        
        // æ£€æŸ¥è¡¨å•åç§°å”¯ä¸€æ€§
        $existing = $db->fetchRow(
            $db->select()->from('table.uforms_forms')
               ->where('name = ? AND id != ?', $form_name, $form_id ?: 0)
        );
        
        if ($existing) {
            echo json_encode(['success' => false, 'message' => 'è¡¨å•åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°']);
            exit;
        }
        
        $current_time = time();
        
        if ($form_id) {
            // æ›´æ–°è¡¨å•
            $update_data = array(
                'name' => $form_name,
                'title' => $form_title,
                'description' => $form_description,
                'config' => $form_config,
                'settings' => $form_settings,
                'status' => $form_status,
                'modified_time' => $current_time
            );
            
            // å¦‚æœæ˜¯å‘å¸ƒçŠ¶æ€ï¼Œè®°å½•å‘å¸ƒæ—¶é—´å’Œç”Ÿæˆslug
            if ($form_status === 'published' && $form['status'] !== 'published') {
                $update_data['published_time'] = $current_time;
                $slug = UformsHelper::generateSlug($form_name, $form_title);
                $update_data['slug'] = $slug;
            }
            
            $db->query($db->update('table.uforms_forms')
                         ->rows($update_data)
                         ->where('id = ?', $form_id));
            
            // åˆ›å»ºç‰ˆæœ¬å¤‡ä»½ï¼ˆä»…éè‡ªåŠ¨ä¿å­˜æ—¶ï¼‰
            if (!$auto_save) {
                UformsHelper::createFormVersion($form_id, json_decode($form_config, true), $fields_data, $version_notes);
            }
            
        } else {
            // åˆ›å»ºæ–°è¡¨å•
            $insert_data = array(
                'name' => $form_name,
                'title' => $form_title,
                'description' => $form_description,
                'config' => $form_config,
                'settings' => $form_settings,
                'status' => $form_status,
                'author_id' => $user->uid,
                'created_time' => $current_time,
                'modified_time' => $current_time,
                'view_count' => 0,
                'submit_count' => 0,
                'version' => 1
            );
            
            if ($form_status === 'published') {
                $insert_data['published_time'] = $current_time;
                $slug = UformsHelper::generateSlug($form_name, $form_title);
                $insert_data['slug'] = $slug;
            }
            
            $form_id = $db->query($db->insert('table.uforms_forms')->rows($insert_data));
        }
        
        // ä¿å­˜å­—æ®µé…ç½®
        // åˆ é™¤åŸæœ‰å­—æ®µ
        $db->query($db->delete('table.uforms_fields')->where('form_id = ?', $form_id));
        
        // æ’å…¥æ–°å­—æ®µ
        foreach ($fields_data as $index => $field_config) {
            $field_data = array(
                'form_id' => $form_id,
                'field_type' => $field_config['type'],
                'field_name' => $field_config['name'],
                'field_label' => $field_config['label'],
                'field_config' => json_encode($field_config),
                'sort_order' => isset($field_config['sortOrder']) ? intval($field_config['sortOrder']) : $index,
                'is_required' => !empty($field_config['required']) ? 1 : 0,
                'is_enabled' => 1,
                'created_time' => $current_time
            );
            
            $db->query($db->insert('table.uforms_fields')->rows($field_data));
        }
        
        // å‡†å¤‡å“åº”æ•°æ®
        $response_data = array(
            'form_id' => $form_id,
            'status' => $form_status
        );
        
        if ($form_status === 'published') {
            $site_url = $options->siteUrl;
            $form_url = $site_url . 'uforms/form/' . $form_id;
            $response_data['form_url'] = $form_url;
        }
        
        // å‘é€æˆåŠŸé€šçŸ¥
        if ($form_status === 'published' && !$auto_save) {
            UformsHelper::createSystemNotification(
                $form_id,
                null,
                'form_published',
                'è¡¨å•å‘å¸ƒæˆåŠŸ',
                "è¡¨å• \"{$form_title}\" å·²æˆåŠŸå‘å¸ƒå¹¶å¯ä»¥å¼€å§‹æ¥æ”¶ç”¨æˆ·æäº¤ã€‚",
                array('form_url' => isset($response_data['form_url']) ? $response_data['form_url'] : null)
            );
        }
        
        echo json_encode([
            'success' => true,
            'message' => $form_status === 'published' ? 'è¡¨å•å‘å¸ƒæˆåŠŸ' : 'è¡¨å•ä¿å­˜æˆåŠŸ',
            'data' => $response_data
        ]);
        
    } catch (Exception $e) {
        error_log('Uforms save error: ' . $e->getMessage());
        echo json_encode([
            'success' => false, 
            'message' => 'ä¿å­˜å¤±è´¥ï¼š' . $e->getMessage()
        ]);
    }
    exit;
}
```

ç°åœ¨ä¸»è¦çš„ä¿®å¤åŒ…æ‹¬ï¼š

1. **JavaScripté”™è¯¯ä¿®å¤**ï¼šä¿®å¤äº†å‚æ•°ä¼ é€’å’Œäº‹ä»¶ç»‘å®šé—®é¢˜
2. **ä¿å­˜åŠŸèƒ½å®Œæ•´å®ç°**ï¼šåŒ…å«å®Œæ•´çš„æ•°æ®éªŒè¯ã€ä¿å­˜é€»è¾‘å’Œé”™è¯¯å¤„ç†
3. **æ•°æ®åº“æ“ä½œä¼˜åŒ–**ï¼šç¡®ä¿æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½æœ‰é€‚å½“çš„é”™è¯¯å¤„ç†
4. **è¾…åŠ©æ–¹æ³•è¡¥å…¨**ï¼šæ·»åŠ äº†ç¼ºå¤±çš„UformsHelperæ–¹æ³•

è¿™æ ·ä¿®å¤åï¼Œè¡¨å•ä¿å­˜å’Œå‘å¸ƒåŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œäº†ã€‚å¦‚æœè¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·å‘Šè¯‰æˆ‘è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ã€‚
