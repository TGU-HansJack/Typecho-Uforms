# 默认话题

## 🧑‍💻 User

提交表单出现报错：Call to undefined method Typecho\Widget\Request::toArray()
Error: Call to undefined method Typecho\Widget\Request::toArray() in /www/wwwroot/tiango.wiki/usr/plugins/Uforms/Action.php:52
Stack trace:
#0 /www/wwwroot/tiango.wiki/var/Typecho/Router.php(99): Uforms_Action->showForm()
#1 /www/wwwroot/tiango.wiki/index.php(23): Typecho\Router::dispatch()
#2 {main}并且提交后没有提交到数据库，控制台有没有报错


Uforms/
├── Plugin.php              # 插件主文件，包含激活、禁用、配置等核心功能
├── index.php               # 插件入口文件
├── common.php              # 通用配置文件
├── Action.php          # 动作处理类，处理表单展示、提交等核心操作
├── admin/                  # 后台管理模块
│   ├── admin-functions.php # 后台功能函数，包含权限验证和UformsHelper类定义
│   ├── create.php          # 表单创建和编辑界面
│   ├── index.php           # 后台管理入口文件，包含导航和页面路由
│   ├── manage.php          # 表单管理界面
│   ├── notifications.php   # 通知管理界面
│   └── view.php            # 表单查看界面
├── assets/                 # 静态资源文件
│   ├── css/                # 样式文件目录
│   │   ├── admin.css       # 后台管理界面样式
│   │   ├── create.css      # 创建表单界面样式
│   │   ├── frontend.css    # 前端样式
│   │   ├── manage.css      # 管理界面样式
│   │   ├── notifications.css # 通知界面样式
│   │   ├── uforms.css      # 表单系统通用样式
│   │   └── view.css        # 查看页面样式
│   └── js/                 # JavaScript文件目录
│       ├── admin.js        # 后台管理脚本
│       ├── frontend.js     # 前端脚本
│       ├── sortable.min.js # 拖拽排序功能库
│       ├── uforms.js       # 表单系统核心脚本
│       └── uformsbuilder.js # 表单构建器核心脚本
├── core/                   # 核心功能模块
 
│   ├── UformsHelper.php    # 核心辅助函数类
│   ├── config.php          # 插件配置定义
│   └── routes.php          # 路由配置文件
├── frontend/               # 前端功能模块
│   ├── ajax.php            # Ajax请求处理
│   ├── export.php          # 数据导出功能
│   ├── front.php           # 前端表单展示和处理功能
│   └── frontend-functions.php # 前端功能函数
├── install/                # 安装模块
│   └── install.php         # 插件安装向导界面
├── lib/                    # 第三方库
│   ├── PHPMailer/          # 邮件发送库
│   ├── echarts/            # 图表库
│   └── fullcalendar/       # 日历功能库
├── templates/              # 模板文件
│   ├── calendar.php        # 日历模板
│   ├── form-editor.php     # 表单编辑器模板
│   ├── form-preview.php    # 表单预览模板
│   └── form.php            # 表单展示模板
└── views/                  # 视图文件
    ├── analytics.php       # 数据分析视图
    ├── calendar.php        # 日历视图
    ├── overview.php        # 概览视图
    └── submissions.php     # 提交数据视图

---
## 🤖 Assistant

这个错误是因为在Typecho的新版本中，`Typecho\Widget\Request` 类没有 `toArray()` 方法。让我们修复这个问题：

## 修复 Action.php 第52行的错误

将 Action.php 文件中第52行的 `$request->toArray()` 替换为获取所有POST数据的正确方法：

```php
<?php
/**
 * Uforms Action处理类
 */
if (!defined('__TYPECHO_ROOT_DIR__')) exit;

// 确保必要的文件被加载
$uformsDir = __DIR__;
require_once $uformsDir . '/core/UformsHelper.php';
require_once $uformsDir . '/frontend/front.php';

class Uforms_Action extends Typecho_Widget implements Widget_Interface_Do
{
    /**
     * 执行函数
     */
    public function execute()
    {
        // 根据不同的action执行不同的方法
    }

    /**
     * 显示表单
     */
    public function showForm()
    {
        $request = $this->request;
        $name = $request->get('name');
        
        if (empty($name)) {
            throw new Typecho_Widget_Exception('表单名称不能为空', 404);
        }
        
        $form = UformsHelper::getFormByName($name);
        if (!$form || $form['status'] !== 'published') {
            throw new Typecho_Widget_Exception('表单不存在或未发布', 404);
        }
        
        // 增加访问统计
        $this->trackFormView($form['id']);
        
        // 获取表单字段
        $fields = UformsHelper::getFormFields($form['id']);
        $config = json_decode($form['config'], true) ?: array();
        $settings = json_decode($form['settings'], true) ?: array();
        
        // 处理表单提交
        if ($request->isPost() && $request->get('uform_name') === $name) {
            error_log('Uforms: Form submission detected for form: ' . $name);
            error_log('Uforms: Is POST request: ' . ($request->isPost() ? 'true' : 'false'));
            error_log('Uforms: Is AJAX request: ' . ($request->isAjax() ? 'true' : 'false'));
            
            // 修复：获取所有POST数据的正确方法
            $allRequestData = array();
            foreach ($_POST as $key => $value) {
                $allRequestData[$key] = $request->get($key);
            }
            error_log('Uforms: All request data: ' . print_r($allRequestData, true));
            
            // 检查是否是AJAX请求
            if ($request->isAjax()) {
                error_log('Uforms: Processing AJAX request');
                // AJAX请求，返回JSON响应
                try {
                    $result = UformsFront::handleFormSubmission($form, $fields, $settings);
                    error_log('Uforms: Submission result: ' . $result);
                    
                    if (is_string($result) && strpos($result, 'uform-success') !== false) {
                        // 提取成功消息
                        preg_match('/<div class="uform-success">(.*?)<\/div>/s', $result, $matches);
                        $message = isset($matches[1]) ? $matches[1] : '提交成功';
                        
                        error_log('Uforms: Successful submission, sending JSON response');
                        $this->response->throwJson(array(
                            'success' => true,
                            'message' => $message,
                            'redirect' => $settings['redirect_url'] ?? null
                        ));
                    } else if (is_string($result) && strpos($result, 'uform-error') !== false) {
                        // 提取错误信息
                        preg_match('/<div class="uform-error">(.*?)<\/div>/s', $result, $matches);
                        $message = isset($matches[1]) ? $matches[1] : '提交失败';
                        
                        error_log('Uforms: Submission error, sending JSON error response');
                        $this->response->throwJson(array(
                            'success' => false,
                            'message' => $message
                        ));
                    } else {
                        error_log('Uforms: Unknown result type: ' . gettype($result));
                        $this->response->throwJson(array(
                            'success' => false,
                            'message' => '未知错误'
                        ));
                    }
                } catch (Exception $e) {
                    error_log('Uforms: Exception in submission: ' . $e->getMessage());
                    $this->response->throwJson(array(
                        'success' => false,
                        'message' => '提交失败: ' . $e->getMessage()
                    ));
                }
                return; // 确保在AJAX响应后退出
            } else {
                error_log('Uforms: Processing non-AJAX request');
                // 非AJAX请求，返回HTML响应
                $result = UformsFront::handleFormSubmission($form, $fields, $settings);
                error_log('Uforms: Non-AJAX submission result: ' . (is_string($result) ? $result : gettype($result)));
                
                if (is_string($result)) {
                    // 如果返回HTML（成功或错误消息），直接显示
                    $this->renderFormPage($form, $fields, $config, $settings, $result);
                    return;
                }
            }
        }
        
        // 渲染表单页面
        $this->renderFormPage($form, $fields, $config, $settings);
    }

    // ... 其余方法保持不变
    
    /**
     * 根据ID显示表单
     */
    public function showFormById()
    {
        $request = $this->request;
        $id = $request->get('id');
        
        if (empty($id)) {
            throw new Typecho_Widget_Exception('表单ID不能为空', 404);
        }
        
        $form = UformsHelper::getForm($id);
        if (!$form || $form['status'] !== 'published') {
            throw new Typecho_Widget_Exception('表单不存在或未发布', 404);
        }
        
        // 重定向到名称URL
        $this->response->redirect(Helper::options()->siteUrl . 'uforms/form/' . $form['name']);
    }

    /**
     * 处理表单提交
     */
    public function submit()
    {
        if (!$this->request->isPost()) {
            $this->response->throwJson(array('success' => false, 'message' => '只接受POST请求'));
        }
        
        $form_name = $this->request->get('uform_name');
        $form_id = $this->request->get('form_id');
        
        if (empty($form_name) && empty($form_id)) {
            $this->response->throwJson(array('success' => false, 'message' => '表单标识不能为空'));
        }
        
        try {
            // 获取表单
            if ($form_name) {
                $form = UformsHelper::getFormByName($form_name);
            } else {
                $form = UformsHelper::getForm($form_id);
            }
            
            if (!$form) {
                throw new Exception('表单不存在');
            }
            
            // 获取字段
            $fields = UformsHelper::getFormFields($form['id']);
            $settings = json_decode($form['settings'], true) ?: array();
            
            // 处理提交
            $result = UformsFront::handleFormSubmission($form, $fields, $settings);
            
            if (strpos($result, 'uform-success') !== false) {
                $this->response->throwJson(array(
                    'success' => true, 
                    'message' => strip_tags($result),
                    'redirect' => $settings['redirect_url'] ?? null
                ));
            } else {
                // 提取错误信息
                preg_match_all('/<li>(.*?)<\/li>/', $result, $matches);
                $errors = $matches[1] ?: array('提交失败');
                
                $this->response->throwJson(array(
                    'success' => false, 
                    'errors' => $errors
                ));
            }
            
        } catch (Exception $e) {
            $this->response->throwJson(array(
                'success' => false, 
                'message' => '提交失败: ' . $e->getMessage()
            ));
        }
    }

    /**
     * 显示日历
     */
    public function calendar()
    {
        $form_id = $this->request->get('id');
        if (!$form_id) {
            throw new Typecho_Widget_Exception('表单ID不能为空', 404);
        }
        
        $form = UformsHelper::getForm($form_id);
        if (!$form || $form['status'] !== 'published') {
            throw new Typecho_Widget_Exception('表单不存在或未发布', 404);
        }
        
        $settings = json_decode($form['settings'], true) ?: array();
        
        // 检查是否启用日历功能
        if (empty($settings['enable_calendar'])) {
            throw new Typecho_Widget_Exception('此表单未启用日历功能', 404);
        }
        
        // 渲染日历页面
        include __DIR__ . '/templates/calendar.php';
        exit;
    }

    /**
     * API处理器
     */
    public function apiHandler()
    {
        $action = $this->request->get('action');
        
        header('Content-Type: application/json; charset=UTF-8');
        
        try {
            switch ($action) {
                case 'validate':
                    $this->handleApiValidate();
                    break;
                    
                case 'upload':
                    $this->handleApiUpload();
                    break;
                    
                case 'calendar_events':
                    $this->handleApiCalendarEvents();
                    break;
                    
                default:
                    throw new Exception('未知的API动作');
            }
        } catch (Exception $e) {
            echo json_encode(array(
                'success' => false,
                'message' => $e->getMessage()
            ));
        }
    }

    /**
     * 渲染表单页面
     */
    private function renderFormPage($form, $fields, $config, $settings, $content = null)
    {
        if (!empty($settings['embed_mode']) && $settings['embed_mode'] === 'iframe') {
            // iframe模式，使用简单布局
            echo '<!DOCTYPE html><html><head><meta charset="UTF-8">';
            echo '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
            echo '<link rel="stylesheet" href="' . Helper::options()->pluginUrl . '/Uforms/assets/css/uforms.css">';
            echo '</head><body style="margin: 0; padding: 20px;">';
            
            if ($content) {
                echo $content;
            } else {
                echo UformsFront::renderFormHTML($form, $fields, $config, $settings, 'iframe');
            }
            
            echo '<script src="' . Helper::options()->pluginUrl . '/Uforms/assets/js/uforms.js"></script>';
            echo '</body></html>';
        } else {
            // 完整页面模式
            $form_id = $form['id'];
            include __DIR__ . '/templates/form.php';
        }
        
        exit;
    }

    /**
     * 记录表单访问
     */
    private function trackFormView($form_id)
    {
        $db = Typecho_Db::get();
        $ip = UformsHelper::getClientIP();
        $user_agent = $_SERVER['HTTP_USER_AGENT'] ?? '';
        
        // 记录访问统计
        $stat_data = array(
            'form_id' => $form_id,
            'ip' => $ip,
            'user_agent' => $user_agent,
            'action' => 'view',
            'created_time' => time()
        );
        
        $db->query($db->insert('table.uforms_stats')->rows($stat_data));
        
        // 更新表单访问计数
        $db->query($db->update('table.uforms_forms')
                     ->expression('view_count', 'view_count + 1')
                     ->where('id = ?', $form_id));
    }

    /**
     * 处理API验证
     */
    private function handleApiValidate()
    {
        $field_type = $this->request->get('field_type');
        $field_value = $this->request->get('field_value');
        $field_config = json_decode($this->request->get('field_config', '{}'), true);
        
        $errors = UformsHelper::validateField($field_type, $field_value, $field_config);
        
        echo json_encode(array(
            'success' => empty($errors),
            'errors' => $errors
        ));
    }

    /**
     * 处理API上传
     */
    private function handleApiUpload()
    {
        if (!isset($_FILES['file'])) {
            throw new Exception('没有上传文件');
        }
        
        $form_id = $this->request->get('form_id');
        $field_name = $this->request->get('field_name');
        
        $result = UformsFront::handleFileUpload($_FILES['file'], 
                                               array('field_name' => $field_name), 
                                               $form_id);
        
        echo json_encode($result);
    }

    /**
     * 处理日历事件API
     */
    private function handleApiCalendarEvents()
    {
        $form_id = $this->request->get('form_id');
        $start = $this->request->get('start');
        $end = $this->request->get('end');
        
        $db = Typecho_Db::get();
        $events = array();
        
        // 获取日历事件
        $calendar_events = $db->fetchAll(
            $db->select('*')->from('table.uforms_calendar')
               ->where('form_id = ? AND start_time >= ? AND start_time <= ?', 
                      $form_id, strtotime($start), strtotime($end))
        );
        
        foreach ($calendar_events as $event) {
            $events[] = array(
                'id' => $event['id'],
                'title' => $event['title'],
                'start' => date('c', $event['start_time']),
                'end' => $event['end_time'] ? date('c', $event['end_time']) : null,
                'allDay' => $event['all_day'],
                'color' => $event['color'],
                'extendedProps' => array(
                    'status' => $event['status'],
                    'description' => $event['event_description']  // 修复：使用正确的字段名
                )
            );
        }
        
        echo json_encode(array(
            'success' => true,
            'events' => $events
        ));
    }

    /**
     * 处理动作 - 修复方法
     */
    public function action()
    {
        $request = $this->request;
        $pathInfo = $request->getPathInfo();
        
        // 解析路径信息确定要执行的动作
        if (preg_match('/^\/uforms\/form\/([^\/]+)/', $pathInfo, $matches)) {
            $this->request->setParam('name', $matches[1]);
            $this->showForm();
        } elseif (preg_match('/^\/uforms\/form\/(\d+)/', $pathInfo, $matches)) {
            $this->request->setParam('id', $matches[1]);
            $this->showFormById();
        } elseif (preg_match('/^\/uforms\/calendar\/(\d+)/', $pathInfo, $matches)) {
            $this->request->setParam('id', $matches[1]);
            $this->calendar();
        } elseif (preg_match('/^\/uforms\/api\/([^\/]+)/', $pathInfo, $matches)) {
            $this->apiHandler();
        } elseif (preg_match('/^\/uforms\/submit/', $pathInfo)) {
            $this->submit();
        } else {
            throw new Typecho_Widget_Exception('未知操作', 404);
        }
    }
}
```

## 主要修复内容

1. **修复了第52行的错误**：将 `$request->toArray()` 替换为遍历 `$_POST` 数组的方法来获取所有POST数据。

2. **兼容性改进**：使用更好的方式获取请求数据，兼容不同版本的Typecho。

3. **调试日志优化**：改进了调试日志的输出方式，更有助于排查问题。

现在你可以：

1. 将修复后的代码保存到 `Action.php` 文件中
2. 测试表单提交功能
3. 检查是否还有其他错误

如果还有问题，请检查：
- 确保所有必需的文件都存在（特别是 `UformsHelper.php` 和 `front.php`）
- 检查数据库连接和表结构
- 查看服务器错误日志获取更多信息

这个修复应该解决 `toArray()` 方法未定义的错误。

---
## 🧑‍💻 User



---
## 🤖 Assistant

在你的 `UformsHelper.php` 文件中缺少了一些重要的方法，特别是 `validateField` 方法和数据库连接方法。让我为你补充完整的代码：

```php
<?php
if (!defined('__TYPECHO_ROOT_DIR__')) exit;

class UformsHelper {
    
    /**
     * 获取数据库连接实例
     */
    public static function getDb()
    {
        return Typecho_Db::get();
    }
    
    /**
     * 获取表单URL
     */
    public static function getFormUrl($form_id) {
        return Helper::options()->siteUrl . 'uforms/form/' . $form_id;
    }
    
    /**
     * 获取表单列表
     */
    public static function getForms($status = null, $limit = null) {
        $db = Typecho_Db::get();
        $select = $db->select('*')->from('table.uforms_forms');
        
        if ($status) {
            $select->where('status = ?', $status);
        }
        
        if ($limit) {
            $select->limit($limit);
        }
        
        $select->order('modified_time DESC');
        
        return $db->fetchAll($select);
    }
    
    /**
     * 获取单个表单
     */
    public static function getForm($id) {
        $db = Typecho_Db::get();
        return $db->fetchRow(
            $db->select()->from('table.uforms_forms')->where('id = ?', $id)
        );
    }
    
    /**
     * 根据名称获取表单
     */
    public static function getFormByName($name) {
        $db = Typecho_Db::get();
        return $db->fetchRow(
            $db->select()->from('table.uforms_forms')
               ->where('name = ? AND status = ?', $name, 'published')
        );
    }
    
    /**
     * 获取表单字段
     */
    public static function getFormFields($form_id) {
        $db = Typecho_Db::get();
        return $db->fetchAll(
            $db->select()->from('table.uforms_fields')
               ->where('form_id = ?', $form_id)
               ->order('sort_order', Typecho_Db::SORT_ASC)
        );
    }
    
    /**
     * 获取表单提交数据
     */
    public static function getSubmissions($form_id = null, $limit = 20, $offset = 0) {
        $db = Typecho_Db::get();
        $select = $db->select('*')->from('table.uforms_submissions');
        
        if ($form_id) {
            $select->where('form_id = ?', $form_id);
        }
        
        $select->order('created_time DESC')->limit($limit)->offset($offset);
        
        return $db->fetchAll($select);
    }
    
    /**
     * 验证字段
     */
    public static function validateField($field_type, $value, $config = array()) {
        $errors = array();
        
        // 空值检查
        if (empty($value) && !empty($config['required'])) {
            $errors[] = '此字段为必填项';
            return $errors;
        }
        
        // 如果值为空且不是必填项，跳过验证
        if (empty($value)) {
            return $errors;
        }
        
        // 根据字段类型验证
        switch ($field_type) {
            case 'email':
                if (!filter_var($value, FILTER_VALIDATE_EMAIL)) {
                    $errors[] = '请输入有效的邮箱地址';
                }
                break;
                
            case 'url':
                if (!filter_var($value, FILTER_VALIDATE_URL)) {
                    $errors[] = '请输入有效的URL地址';
                }
                break;
                
            case 'tel':
            case 'phone':
                if (!preg_match('/^[\d\s\-\+\(\)]+$/', $value)) {
                    $errors[] = '请输入有效的电话号码';
                }
                break;
                
            case 'number':
            case 'range':
                if (!is_numeric($value)) {
                    $errors[] = '请输入有效的数字';
                } else {
                    if (isset($config['min']) && $value < $config['min']) {
                        $errors[] = '数值不能小于 ' . $config['min'];
                    }
                    if (isset($config['max']) && $value > $config['max']) {
                        $errors[] = '数值不能大于 ' . $config['max'];
                    }
                }
                break;
                
            case 'text':
            case 'textarea':
                if (isset($config['min_length']) && strlen($value) < $config['min_length']) {
                    $errors[] = '内容长度不能少于 ' . $config['min_length'] . ' 个字符';
                }
                if (isset($config['max_length']) && strlen($value) > $config['max_length']) {
                    $errors[] = '内容长度不能超过 ' . $config['max_length'] . ' 个字符';
                }
                if (isset($config['pattern']) && !preg_match($config['pattern'], $value)) {
                    $errors[] = '输入格式不正确';
                }
                break;
                
            case 'date':
                if (!strtotime($value)) {
                    $errors[] = '请输入有效的日期';
                }
                break;
                
            case 'time':
                if (!preg_match('/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/', $value)) {
                    $errors[] = '请输入有效的时间格式 (HH:MM)';
                }
                break;
                
            case 'datetime':
            case 'datetime-local':
                if (!strtotime($value)) {
                    $errors[] = '请输入有效的日期时间';
                }
                break;
                
            case 'file':
                // 文件验证逻辑在文件上传时处理
                break;
                
            case 'select':
            case 'radio':
                if (isset($config['options']) && is_array($config['options'])) {
                    $valid_options = array();
                    foreach ($config['options'] as $option) {
                        $valid_options[] = $option['value'];
                    }
                    if (!in_array($value, $valid_options)) {
                        $errors[] = '请选择有效的选项';
                    }
                }
                break;
                
            case 'checkbox':
                if (isset($config['options']) && is_array($config['options']) && is_array($value)) {
                    $valid_options = array();
                    foreach ($config['options'] as $option) {
                        $valid_options[] = $option['value'];
                    }
                    foreach ($value as $selected_value) {
                        if (!in_array($selected_value, $valid_options)) {
                            $errors[] = '包含无效的选项';
                            break;
                        }
                    }
                }
                break;
        }
        
        return $errors;
    }
    
    /**
     * 创建通知
     */
    public static function createNotification($form_id, $type, $title, $message, $data = null) {
        $db = self::getDb();
        
        $notification_data = array(
            'form_id' => $form_id,
            'type' => $type,
            'title' => $title,
            'message' => $message,
            'data' => $data ? json_encode($data) : null,
            'is_read' => 0,
            'created_time' => time()
        );
        
        return $db->query($db->insert('table.uforms_system_notifications')->rows($notification_data));
    }
    
    /**
     * 获取状态标签
     */
    public static function getStatusLabel($status) {
        $labels = array(
            'new' => '未读',
            'read' => '已读',
            'spam' => '垃圾内容',
            'deleted' => '已删除',
            'draft' => '草稿',
            'published' => '已发布',
            'archived' => '已归档'
        );
        
        return isset($labels[$status]) ? $labels[$status] : $status;
    }
    
    /**
     * 导出为CSV
     */
    public static function exportToCSV($submissions, $fields) {
        $csv_data = array();
        
        // 表头
        $header = array('ID', '提交时间', 'IP地址', '状态');
        foreach ($fields as $field) {
            $header[] = $field['field_label'];
        }
        $csv_data[] = $header;
        
        // 数据行
        foreach ($submissions as $submission) {
            $row = array(
                $submission['id'],
                self::formatTime($submission['created_time']),
                $submission['ip'],
                self::getStatusLabel($submission['status'])
            );
            
            $form_data = json_decode($submission['data'], true) ?: array();
            foreach ($fields as $field) {
                $value = isset($form_data[$field['field_name']]) ? $form_data[$field['field_name']] : '';
                if (is_array($value)) {
                    $value = implode(', ', $value);
                }
                $row[] = $value;
            }
            
            $csv_data[] = $row;
        }
        
        // 生成CSV内容
        $output = '';
        foreach ($csv_data as $row) {
            $output .= '"' . implode('","', array_map('str_replace', array('"', '""'), $row)) . '"' . "\n";
        }
        
        return $output;
    }
    
    /**
     * 获取统计数据
     */
    public static function getStats() {
        $db = Typecho_Db::get();
        
        $total_forms = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_forms')
        )->count;
        
        $published_forms = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_forms')
               ->where('status = ?', 'published')
        )->count;
        
        $total_submissions = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_submissions')
        )->count;
        
        $new_submissions = $db->fetchObject(
            $db->select('COUNT(*) as count')->from('table.uforms_submissions')
               ->where('status = ?', 'new')
        )->count;
        
        return array(
            'total_forms' => $total_forms,
            'published_forms' => $published_forms,
            'total_submissions' => $total_submissions,
            'new_submissions' => $new_submissions
        );
    }
    
    /**
     * 格式化时间
     */
    public static function formatTime($timestamp) {
        return date('Y-m-d H:i:s', $timestamp);
    }
    
    /**
     * 获取客户端IP
     */
    public static function getClientIP() {
        if (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {
            $ips = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);
            return trim($ips[0]);
        } elseif (isset($_SERVER['HTTP_CLIENT_IP'])) {
            return $_SERVER['HTTP_CLIENT_IP'];
        } elseif (isset($_SERVER['REMOTE_ADDR'])) {
            return $_SERVER['REMOTE_ADDR'];
        }
        return '0.0.0.0';
    }
    
    /**
     * 发送邮件通知
     */
    public static function sendEmailNotification($to, $subject, $message, $form_data = array()) {
        // 检查是否启用邮件功能
        $settings_result = Typecho_Db::get()->fetchRow(
            Typecho_Db::get()->select('value')->from('table.options')
               ->where('name = ?', 'plugin:Uforms')
        );
        
        if (!$settings_result) {
            return false;
        }
        
        $settings = unserialize($settings_result['value']);
        if (empty($settings['enable_email'])) {
            return false;
        }
        
        try {
            // 使用PHPMailer发送邮件
            $phpmailer_path = dirname(__FILE__) . '/../lib/PHPMailer';
            if (!file_exists($phpmailer_path . '/PHPMailer.php')) {
                error_log('PHPMailer not found at: ' . $phpmailer_path);
                return false;
            }
            
            require_once $phpmailer_path . '/PHPMailer.php';
            require_once $phpmailer_path . '/SMTP.php';
            require_once $phpmailer_path . '/Exception.php';
            
            $mail = new PHPMailer\PHPMailer\PHPMailer();
            
            // SMTP配置
            if (!empty($settings['smtp_host'])) {
                $mail->isSMTP();
                $mail->Host = $settings['smtp_host'];
                $mail->Port = $settings['smtp_port'] ?: 587;
                $mail->SMTPAuth = true;
                $mail->Username = $settings['smtp_username'];
                $mail->Password = $settings['smtp_password'];
                $mail->SMTPSecure = PHPMailer\PHPMailer\PHPMailer::ENCRYPTION_STARTTLS;
            }
            
            // 发件人和收件人
            $from_email = !empty($settings['smtp_username']) ? $settings['smtp_username'] : 'noreply@' . parse_url(Helper::options()->siteUrl, PHP_URL_HOST);
            $mail->setFrom($from_email, Helper::options()->title);
            $mail->addAddress($to);
            
            // 邮件内容
            $mail->isHTML(true);
            $mail->CharSet = 'UTF-8';
            $mail->Subject = $subject;
            $mail->Body = $message;
            
            return $mail->send();
        } catch (Exception $e) {
            error_log('邮件发送失败: ' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * 发送Slack通知
     */
    public static function sendSlackMessage($webhook, $message) {
        if (empty($webhook)) {
            return false;
        }
        
        $payload = json_encode($message);
        
        $ch = curl_init($webhook);
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
        curl_setopt($ch, CURLOPT_POSTFIELDS, $payload);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, array(
            'Content-Type: application/json',
            'Content-Length: ' . strlen($payload)
        ));
        curl_setopt($ch, CURLOPT_TIMEOUT, 10);
        
        $result = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
        
        return $http_code == 200;
    }
    
    /**
     * 清理过期数据
     */
    public static function cleanupExpiredData($days = 365) {
        $db = Typecho_Db::get();
        $expire_time = time() - ($days * 24 * 60 * 60);
        
        // 删除过期的提交数据
        $expired_submissions = $db->fetchAll(
            $db->select('id')->from('table.uforms_submissions')
               ->where('created_time < ? AND status = ?', $expire_time, 'deleted')
        );
        
        foreach ($expired_submissions as $submission) {
            // 删除相关文件
            $files = $db->fetchAll(
                $db->select('file_path')->from('table.uforms_files')
                   ->where('submission_id = ?', $submission['id'])
            );
            
            foreach ($files as $file) {
                if (file_exists($file['file_path'])) {
                    unlink($file['file_path']);
                }
            }
            
            // 删除文件记录
            $db->query($db->delete('table.uforms_files')->where('submission_id = ?', $submission['id']));
        }
        
        // 删除过期提交记录
        $db->query(
            $db->delete('table.uforms_submissions')
               ->where('created_time < ? AND status = ?', $expire_time, 'deleted')
        );
        
        // 删除过期通知记录
        $db->query(
            $db->delete('table.uforms_notifications')
               ->where('created_time < ?', $expire_time)
        );
        
        // 删除过期系统通知
        $db->query(
            $db->delete('table.uforms_system_notifications')
               ->where('created_time < ? AND is_read = ?', $expire_time, 1)
        );
    }
    
    /**
     * 生成随机字符串
     */
    public static function generateRandomString($length = 32) {
        $characters = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
        $charactersLength = strlen($characters);
        $randomString = '';
        for ($i = 0; $i < $length; $i++) {
            $randomString .= $characters[rand(0, $charactersLength - 1)];
        }
        return $randomString;
    }
    
    /**
     * 安全的文件名
     */
    public static function sanitizeFilename($filename) {
        // 获取文件扩展名
        $extension = pathinfo($filename, PATHINFO_EXTENSION);
        $basename = pathinfo($filename, PATHINFO_FILENAME);
        
        // 移除危险字符
        $basename = preg_replace('/[^a-zA-Z0-9._-]/', '', $basename);
        
        // 限制长度
        if (strlen($basename) > 200) {
            $basename = substr($basename, 0, 200);
        }
        
        // 如果文件名为空，生成一个
        if (empty($basename)) {
            $basename = 'file_' . time();
        }
        
        return $basename . ($extension ? '.' . $extension : '');
    }
    
    /**
     * 格式化文件大小
     */
    public static function formatFileSize($bytes) {
        if ($bytes === 0) return '0 Bytes';
        
        $k = 1024;
        $sizes = array('Bytes', 'KB', 'MB', 'GB', 'TB');
        $i = floor(log($bytes) / log($k));
        
        return round($bytes / pow($k, $i), 2) . ' ' . $sizes[$i];
    }
    
    /**
     * 检查文件类型
     */
    public static function isAllowedFileType($filename, $allowed_types = array()) {
        if (empty($allowed_types)) {
            // 获取插件配置中的允许类型
            try {
                $settings_result = Typecho_Db::get()->fetchRow(
                    Typecho_Db::get()->select('value')->from('table.options')
                       ->where('name = ?', 'plugin:Uforms')
                );
                
                if ($settings_result) {
                    $settings = unserialize($settings_result['value']);
                    if (!empty($settings['allowed_file_types'])) {
                        $allowed_types = explode(',', strtolower($settings['allowed_file_types']));
                        $allowed_types = array_map('trim', $allowed_types);
                    }
                }
            } catch (Exception $e) {
                // 使用默认类型
            }
            
            if (empty($allowed_types)) {
                $allowed_types = array('jpg', 'jpeg', 'png', 'gif', 'pdf', 'doc', 'docx', 'txt', 'zip');
            }
        }
        
        $extension = strtolower(pathinfo($filename, PATHINFO_EXTENSION));
        return in_array($extension, $allowed_types);
    }
    
    /**
     * 生成缩略图
     */
    public static function generateThumbnail($source_path, $thumb_path, $max_width = 200, $max_height = 200) {
        if (!file_exists($source_path)) {
            return false;
        }
        
        // 检查GD库
        if (!extension_loaded('gd')) {
            return false;
        }
        
        $image_info = getimagesize($source_path);
        if (!$image_info) {
            return false;
        }
        
        $width = $image_info[0];
        $height = $image_info[1];
        $mime = $image_info['mime'];
        
        // 计算缩略图尺寸
        $ratio = min($max_width / $width, $max_height / $height);
        $new_width = intval($width * $ratio);
        $new_height = intval($height * $ratio);
        
        // 创建画布
        $thumb = imagecreatetruecolor($new_width, $new_height);
        
        // 根据图片类型处理
        switch ($mime) {
            case 'image/jpeg':
                $source = imagecreatefromjpeg($source_path);
                break;
            case 'image/png':
                $source = imagecreatefrompng($source_path);
                imagealphablending($thumb, false);
                imagesavealpha($thumb, true);
                break;
            case 'image/gif':
                $source = imagecreatefromgif($source_path);
                break;
            default:
                return false;
        }
        
        if (!$source) {
            return false;
        }
        
        // 生成缩略图
        imagecopyresampled($thumb, $source, 0, 0, 0, 0, $new_width, $new_height, $width, $height);
        
        // 保存缩略图
        $result = false;
        switch ($mime) {
            case 'image/jpeg':
                $result = imagejpeg($thumb, $thumb_path, 90);
                break;
            case 'image/png':
                $result = imagepng($thumb, $thumb_path);
                break;
            case 'image/gif':
                $result = imagegif($thumb, $thumb_path);
                break;
        }
        
        // 释放资源
        imagedestroy($source);
        imagedestroy($thumb);
        
        return $result;
    }
    
    /**
     * 删除表单及相关数据
     */
    public static function deleteForm($formId) {
        $db = self::getDb();
        
        try {
            // 开始事务（如果数据库支持）
            $db->query('START TRANSACTION');
            
            // 删除表单
            $db->query($db->delete('table.uforms_forms')->where('id = ?', $formId));
            
            // 删除相关字段
            $db->query($db->delete('table.uforms_fields')->where('form_id = ?', $formId));
            
            // 删除相关文件
            $files = $db->fetchAll(
                $db->select('file_path')->from('table.uforms_files')
                   ->where('form_id = ?', $formId)
            );
            
            foreach ($files as $file) {
                if (file_exists($file['file_path'])) {
                    unlink($file['file_path']);
                }
            }
            
            $db->query($db->delete('table.uforms_files')->where('form_id = ?', $formId));
            
            // 删除相关提交
            $db->query($db->delete('table.uforms_submissions')->where('form_id = ?', $formId));
            
            // 删除其他相关数据
            $db->query($db->delete('table.uforms_notifications')->where('form_id = ?', $formId));
            $db->query($db->delete('table.uforms_calendar')->where('form_id = ?', $formId));
            $db->query($db->delete('table.uforms_stats')->where('form_id = ?', $formId));
            $db->query($db->delete('table.uforms_system_notifications')->where('form_id = ?', $formId));
            
            // 提交事务
            $db->query('COMMIT');
            
            return true;
            
        } catch (Exception $e) {
            // 回滚事务
            $db->query('ROLLBACK');
            error_log('Uforms: Delete form failed: ' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * 复制表单
     */
    public static function duplicateForm($originalId, $newName = null, $newTitle = null) {
        $originalForm = self::getForm($originalId);
        if (!$originalForm) {
            return false;
        }
        
        try {
            $user = Typecho_Widget::widget('Widget_User');
            $userId = $user->hasLogin() ? $user->uid : 1;
        } catch (Exception $e) {
            $userId = 1;
        }
        
        $db = self::getDb();
        
        // 生成唯一名称
        if (!$newName) {
            $newName = $originalForm['name'] . '_copy';
            $counter = 1;
            while ($db->fetchRow($db->select('id')->from('table.uforms_forms')->where('name = ?', $newName))) {
                $newName = $originalForm['name'] . '_copy_' . $counter;
                $counter++;
            }
        }
        
        // 准备新表单数据
        $newData = array(
            'name' => $newName,
            'title' => $newTitle ?: ($originalForm['title'] . ' (副本)'),
            'description' => $originalForm['description'],
            'config' => $originalForm['config'],
            'settings' => $originalForm['settings'],
            'status' => 'draft',
            'author_id' => $userId,
            'view_count' => 0,
            'submit_count' => 0,
            'created_time' => time(),
            'modified_time' => time()
        );
        
        // 创建新表单
        $newFormId = $db->query($db->insert('table.uforms_forms')->rows($newData));
        
        if ($newFormId) {
            // 复制字段
            $fields = self::getFormFields($originalId);
            foreach ($fields as $field) {
                $fieldData = array(
                    'form_id' => $newFormId,
                    'field_type' => $field['field_type'],
                    'field_name' => $field['field_name'],
                    'field_label' => $field['field_label'],
                    'field_config' => $field['field_config'],
                    'sort_order' => $field['sort_order'],
                    'is_required' => $field['is_required'],
                    'created_time' => time()
                );
                
                $db->query($db->insert('table.uforms_fields')->rows($fieldData));
            }
            
            return $newFormId;
        }
        
        return false;
    }
    
    /**
     * 生成表单别名
     */
    public static function generateSlug($name, $title) {
        // 使用表单名称作为基础，如果不可用则使用标题
        $slug = $name ?: strtolower(preg_replace('/[^a-zA-Z0-9]/', '-', $title));
        $slug = trim($slug, '-');
        
        // 确保唯一性
        $db = self::getDb();
        $baseSlug = $slug;
        $counter = 1;
        
        while ($db->fetchRow($db->select('id')->from('table.uforms_forms')->where('name = ?', $slug))) {
            $slug = $baseSlug . '-' . $counter;
            $counter++;
        }
        
        return $slug;
    }
    
    /**
     * 检查垃圾内容
     */
    public static function isSpam($data) {
        // 简单的垃圾内容检测
        $spam_keywords = array('viagra', 'casino', 'lottery', 'winner', 'congratulations');
        
        foreach ($data as $value) {
            if (is_string($value)) {
                $value_lower = strtolower($value);
                foreach ($spam_keywords as $keyword) {
                    if (strpos($value_lower, $keyword) !== false) {
                        return true;
                    }
                }
            }
        }
        
        return false;
    }
    
    /**
     * 记录垃圾内容
     */
    public static function logSpam($form_id, $ip, $reason, $data) {
        $db = self::getDb();
        
        $spam_data = array(
            'form_id' => $form_id,
            'ip' => $ip,
            'reason' => $reason,
            'data' => json_encode($data),
            'created_time' => time()
        );
        
        return $db->query($db->insert('table.uforms_spam_log')->rows($spam_data));
    }
}
?>
```

## 主要新增和修复的内容：

1. **添加了 `validateField` 方法** - 这是之前缺失的重要方法，用于验证表单字段
2. **添加了 `getDb` 方法** - 统一的数据库连接方法 
3. **添加了 `createNotification` 方法** - 创建系统通知
4. **添加了 `getStatusLabel` 方法** - 获取状态标签
5. **添加了 `exportToCSV` 方法** - 导出CSV功能
6. **改进了错误处理** - 在各种操作中添加了异常处理
7. **添加了垃圾内容检测** - `isSpam` 和 `logSpam` 方法
8. **修复了文件类型检查** - 改进了 `isAllowedFileType` 方法
9. **添加了事务支持** - 在删除表单时使用事务确保数据一致性

现在你的 `UformsHelper.php` 应该包含了所有必需的方法。请将这个更新后的代码保存，然后测试表单提交功能。
