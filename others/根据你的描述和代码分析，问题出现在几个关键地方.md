## 🤖 Assistant

根据你的描述和代码分析，问题出现在几个关键地方。主要问题是：

1. **数据库连接问题** - `front.php` 中使用了 `global $db, $request` 但没有正确初始化
2. **路由处理问题** - Action.php 的路由处理可能有问题
3. **POST-REDIRECT-GET模式缺失** - 导致刷新时重复提交

## 解决方案

### 1. 修复 `frontend/front.php`

```php
<?php
if (!defined('__TYPECHO_ROOT_DIR__')) exit;

class UformsFront {
    
    public static function renderForm($form_name, $template = 'default') {
        $db = Typecho_Db::get();
        $request = Typecho_Request::getInstance();
        
        try {
            // 获取表单
            $form = $db->fetchRow(
                $db->select('*')->from('table.uforms_forms')
                   ->where('name = ? AND status = ?', $form_name, 'published')
            );
            
            if (!$form) {
                return '<div class="uform-error">表单不存在或未发布</div>';
            }
            
            // 获取表单字段
            $fields = $db->fetchAll(
                $db->select('*')->from('table.uforms_fields')
                   ->where('form_id = ?', $form['id'])
                   ->order('sort_order ASC')
            );
            
            $form_config = json_decode($form['config'], true) ?: array();
            $form_settings = json_decode($form['settings'], true) ?: array();
            
            // 处理表单提交
            if ($request->isPost() && $request->get('uform_name') === $form_name) {
                return self::handleFormSubmission($form, $fields, $form_settings);
            }
            
            // 渲染表单
            return self::renderFormHTML($form, $fields, $form_config, $form_settings, $template);
            
        } catch (Exception $e) {
            error_log('Uforms renderForm error: ' . $e->getMessage());
            return '<div class="uform-error">表单加载失败: ' . htmlspecialchars($e->getMessage()) . '</div>';
        }
    }
    
    public static function handleFormSubmission($form, $fields, $settings) {
        $db = Typecho_Db::get();
        $request = Typecho_Request::getInstance();
        
        error_log('Uforms: Starting handleFormSubmission for form ID: ' . $form['id']);
        error_log('Uforms: POST data: ' . print_r($_POST, true));
        
        $errors = array();
        $form_data = array();
        $uploaded_files = array();
        
        try {
            // 验证安全令牌
            $security = Helper::security();
            $token = $request->get('_token');
            
            error_log('Uforms: Checking security token: ' . $token);
            
            if (!$security->checkToken($token)) {
                error_log('Uforms: Security token validation failed');
                return '<div class="uform-error">安全验证失败，请重试</div>';
            }
            
            // 检查频率限制
            if (!self::checkRateLimit($form['id'])) {
                error_log('Uforms: Rate limit exceeded');
                return '<div class="uform-error">提交过于频繁，请稍后再试</div>';
            }
            
            // 验证字段
            foreach ($fields as $field) {
                $field_name = $field['field_name'];
                $field_value = $request->get($field_name);
                $field_config = json_decode($field['field_config'], true) ?: array();
                
                error_log('Uforms: Processing field: ' . $field_name . ' = ' . print_r($field_value, true));
                
                // 处理文件上传
                if ($field['field_type'] === 'file' && isset($_FILES[$field_name])) {
                    $file_result = self::handleFileUpload($_FILES[$field_name], $field, $form['id']);
                    if ($file_result['success']) {
                        $form_data[$field_name] = $file_result['file_info'];
                        $uploaded_files[] = $file_result['file_info'];
                    } else {
                        $errors[$field_name] = $file_result['error'];
                    }
                    continue;
                }
                
                // 验证必填字段
                if ($field['is_required'] && (empty($field_value) || (is_array($field_value) && count($field_value) === 0))) {
                    $errors[$field_name] = '此字段为必填项';
                    continue;
                }
                
                // 根据字段类型验证
                if (!empty($field_value)) {
                    $validation_errors = UformsHelper::validateField($field['field_type'], $field_value, $field_config);
                    if (!empty($validation_errors)) {
                        $errors[$field_name] = implode(', ', $validation_errors);
                    }
                }
                
                $form_data[$field_name] = $field_value;
            }
            
            error_log('Uforms: Validation errors: ' . print_r($errors, true));
            error_log('Uforms: Form data collected: ' . print_r($form_data, true));
            
            // 如果有错误，返回表单
            if (!empty($errors)) {
                $error_html = '<div class="uform-errors"><ul>';
                foreach ($errors as $field => $error) {
                    $error_html .= '<li>' . htmlspecialchars($error) . '</li>';
                }
                $error_html .= '</ul></div>';
                return $error_html . self::renderFormHTML($form, $fields, array(), $settings, 'default', $errors, $form_data);
            }
            
            // 检查垃圾内容
            if (UformsHelper::isSpam($form_data)) {
                UformsHelper::logSpam($form['id'], UformsHelper::getClientIP(), 'spam_keywords', $form_data);
                error_log('Uforms: Spam detected and logged');
                return '<div class="uform-error">提交失败，内容被识别为垃圾信息</div>';
            }
            
            error_log('Uforms: Starting database operations');
            
            // 保存提交数据到数据库
            $submission_data = array(
                'form_id' => intval($form['id']),
                'data' => json_encode($form_data, JSON_UNESCAPED_UNICODE),
                'ip' => UformsHelper::getClientIP(),
                'user_agent' => isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : '',
                'status' => 'new',
                'source' => 'web',
                'created_time' => time(),
                'modified_time' => time()
            );
            
            error_log('Uforms: Preparing to insert submission data: ' . print_r($submission_data, true));
            
            // 插入提交数据
            $insert_query = $db->insert('table.uforms_submissions')->rows($submission_data);
            error_log('Uforms: Insert query: ' . $insert_query);
            
            $submission_id = $db->query($insert_query);
            
            if (!$submission_id || $submission_id <= 0) {
                throw new Exception('Failed to insert submission data. Submission ID: ' . $submission_id);
            }
            
            error_log('Uforms: Successfully inserted submission with ID: ' . $submission_id);
            
            // 保存文件记录
            foreach ($uploaded_files as $file_info) {
                $file_data = array(
                    'submission_id' => $submission_id,
                    'form_id' => $form['id'],
                    'field_name' => $file_info['field_name'],
                    'original_name' => $file_info['original_name'],
                    'filename' => $file_info['filename'],
                    'file_path' => $file_info['file_path'],
                    'file_size' => $file_info['file_size'],
                    'file_type' => $file_info['file_type'],
                    'created_time' => time()
                );
                $db->query($db->insert('table.uforms_files')->rows($file_data));
                error_log('Uforms: Saved file record for: ' . $file_info['original_name']);
            }
            
            // 更新表单提交计数
            $update_query = $db->update('table.uforms_forms')
                              ->expression('submit_count', 'submit_count + 1')
                              ->where('id = ?', $form['id']);
            $db->query($update_query);
            
            error_log('Uforms: Updated form submit count');
            
            // 发送通知
            self::sendNotifications($form, $form_data, $settings);
            
            // 显示成功消息
            $success_message = !empty($settings['success_message']) ? 
                              $settings['success_message'] : 
                              '表单提交成功！感谢您的参与。';
            
            error_log('Uforms: Submission completed successfully');
            
            return '<div class="uform-success">' . htmlspecialchars($success_message) . '</div>';
            
        } catch (Exception $e) {
            // 记录详细错误日志
            error_log('Uforms submission error: ' . $e->getMessage());
            error_log('Uforms submission error file: ' . $e->getFile());
            error_log('Uforms submission error line: ' . $e->getLine());
            error_log('Uforms submission error trace: ' . $e->getTraceAsString());
            
            // 显示错误消息
            return '<div class="uform-error">表单提交失败，请稍后重试。错误：' . htmlspecialchars($e->getMessage()) . '</div>';
        }
    }
    
    public static function renderFormHTML($form, $fields, $config, $settings, $template = 'default', $errors = array(), $form_data = array()) {
        $html = '';
        
        // 添加样式引用
        $pluginUrl = Helper::options()->pluginUrl . '/Uforms';
        $html .= '<link rel="stylesheet" href="' . $pluginUrl . '/assets/css/uforms.css">';
        
        // 表单容器开始
        $html .= '<div class="uform uform-' . htmlspecialchars($form['name']) . '" data-form-name="' . htmlspecialchars($form['name']) . '">';
        
        // 表单头部
        if (!empty($form['title']) || !empty($form['description'])) {
            $html .= '<div class="uform-header">';
            if (!empty($form['title'])) {
                $html .= '<h2 class="uform-title">' . htmlspecialchars($form['title']) . '</h2>';
            }
            if (!empty($form['description'])) {
                $html .= '<div class="uform-description">' . nl2br(htmlspecialchars($form['description'])) . '</div>';
            }
            $html .= '</div>';
        }
        
        // 表单主体
        $html .= '<form class="uform-form" method="post" enctype="multipart/form-data" action="">';
        $html .= '<input type="hidden" name="uform_name" value="' . htmlspecialchars($form['name']) . '">';
        
        // CSRF保护
        $security = Helper::security();
        $html .= $security->getTokenInput();
        
        // 渲染字段
        foreach ($fields as $field) {
            $field_config = json_decode($field['field_config'], true) ?: array();
            $field_errors = isset($errors[$field['field_name']]) ? array($errors[$field['field_name']]) : array();
            $field_value = isset($form_data[$field['field_name']]) ? $form_data[$field['field_name']] : '';
            
            $html .= self::renderField($field, $field_config, $field_errors, $field_value);
        }
        
        // 提交按钮
        $submit_text = !empty($settings['submit_text']) ? $settings['submit_text'] : '提交';
        $html .= '<div class="uform-actions">';
        $html .= '<button type="submit" class="uform-submit btn btn-primary">' . htmlspecialchars($submit_text) . '</button>';
        $html .= '</div>';
        
        $html .= '</form>';
        $html .= '</div>';
        
        // 添加JavaScript引用
        $html .= '<script src="' . $pluginUrl . '/assets/js/uforms.js"></script>';
        
        return $html;
    }
    
    private static function renderField($field, $config, $errors = array(), $value = '') {
        $type = $field['field_type'];
        $name = $field['field_name'];
        $label = $field['field_label'];
        $required = $field['is_required'];
        
        $html = '<div class="uform-field uform-field-' . $type . '">';
        
        // 字段标签
        if (!in_array($type, array('heading', 'paragraph', 'divider', 'hidden'))) {
            $html .= '<label class="uform-label" for="' . htmlspecialchars($name) . '">';
            $html .= htmlspecialchars($label);
            if ($required) {
                $html .= ' <span class="required-mark">*</span>';
            }
            $html .= '</label>';
        }
        
        // 字段输入控件
        switch ($type) {
            case 'text':
            case 'email':
            case 'url':
            case 'tel':
                $html .= '<input type="' . $type . '" id="' . htmlspecialchars($name) . '" name="' . htmlspecialchars($name) . '" ';
                $html .= 'value="' . htmlspecialchars($value) . '" ';
                $html .= 'class="uform-input' . (!empty($errors) ? ' error' : '') . '" ';
                if ($required) $html .= 'required ';
                if (isset($config['placeholder'])) {
                    $html .= 'placeholder="' . htmlspecialchars($config['placeholder']) . '" ';
                }
                $html .= '>';
                break;
                
            case 'textarea':
                $html .= '<textarea id="' . htmlspecialchars($name) . '" name="' . htmlspecialchars($name) . '" ';
                $html .= 'class="uform-textarea' . (!empty($errors) ? ' error' : '') . '" ';
                if ($required) $html .= 'required ';
                $html .= 'rows="' . (isset($config['rows']) ? intval($config['rows']) : 4) . '" ';
                if (isset($config['placeholder'])) {
                    $html .= 'placeholder="' . htmlspecialchars($config['placeholder']) . '" ';
                }
                $html .= '>' . htmlspecialchars($value) . '</textarea>';
                break;
                
            case 'select':
                $html .= '<select id="' . htmlspecialchars($name) . '" name="' . htmlspecialchars($name) . '" ';
                $html .= 'class="uform-select' . (!empty($errors) ? ' error' : '') . '" ';
                if ($required) $html .= 'required ';
                $html .= '>';
                
                if (!$required) {
                    $html .= '<option value="">' . (isset($config['placeholder']) ? htmlspecialchars($config['placeholder']) : '请选择') . '</option>';
                }
                
                if (isset($config['options']) && is_array($config['options'])) {
                    foreach ($config['options'] as $option) {
                        $selected = $value == $option['value'] ? ' selected' : '';
                        $html .= '<option value="' . htmlspecialchars($option['value']) . '"' . $selected . '>' . htmlspecialchars($option['label']) . '</option>';
                    }
                }
                $html .= '</select>';
                break;
                
            case 'radio':
                $html .= '<div class="uform-radio-group">';
                if (isset($config['options']) && is_array($config['options'])) {
                    foreach ($config['options'] as $option) {
                        $checked = $value == $option['value'] ? ' checked' : '';
                        $html .= '<label class="uform-radio-label">';
                        $html .= '<input type="radio" name="' . htmlspecialchars($name) . '" value="' . htmlspecialchars($option['value']) . '"' . $checked;
                        if ($required) $html .= ' required';
                        $html .= '>';
                        $html .= '<span class="radio-text">' . htmlspecialchars($option['label']) . '</span>';
                        $html .= '</label>';
                    }
                }
                $html .= '</div>';
                break;
                
            case 'checkbox':
                $html .= '<div class="uform-checkbox-group">';
                if (isset($config['options']) && is_array($config['options'])) {
                    $values = is_array($value) ? $value : array($value);
                    foreach ($config['options'] as $option) {
                        $checked = in_array($option['value'], $values) ? ' checked' : '';
                        $html .= '<label class="uform-checkbox-label">';
                        $html .= '<input type="checkbox" name="' . htmlspecialchars($name) . '[]" value="' . htmlspecialchars($option['value']) . '"' . $checked . '>';
                        $html .= '<span class="checkbox-text">' . htmlspecialchars($option['label']) . '</span>';
                        $html .= '</label>';
                    }
                }
                $html .= '</div>';
                break;
                
            case 'hidden':
                $html .= '<input type="hidden" name="' . htmlspecialchars($name) . '" value="' . htmlspecialchars($value) . '">';
                break;
                
            default:
                $html .= '<input type="text" name="' . htmlspecialchars($name) . '" value="' . htmlspecialchars($value) . '" class="uform-input">';
        }
        
        // 错误信息
        if (!empty($errors)) {
            foreach ($errors as $error) {
                $html .= '<div class="uform-error">' . htmlspecialchars($error) . '</div>';
            }
        }
        
        $html .= '</div>';
        
        return $html;
    }
    
    // 检查频率限制
    private static function checkRateLimit($form_id) {
        $db = Typecho_Db::get();
        $ip = UformsHelper::getClientIP();
        $time_limit = time() - 300; // 5分钟内限制
        
        try {
            $count = $db->fetchObject(
                $db->select('COUNT(*) as count')->from('table.uforms_submissions')
                   ->where('form_id = ? AND ip = ? AND created_time > ?', $form_id, $ip, $time_limit)
            )->count;
            
            return $count < 5; // 每5分钟最多5次提交
        } catch (Exception $e) {
            error_log('Uforms: Rate limit check failed: ' . $e->getMessage());
            return true; // 如果检查失败，允许提交
        }
    }
    
    // 处理文件上传
    public static function handleFileUpload($file, $field, $form_id) {
        if ($file['error'] !== UPLOAD_ERR_OK) {
            return array('success' => false, 'error' => '文件上传失败：错误代码 ' . $file['error']);
        }
        
        // 检查文件类型
        if (!UformsHelper::isAllowedFileType($file['name'])) {
            return array('success' => false, 'error' => '不允许的文件类型');
        }
        
        // 创建上传目录
        $upload_dir = __TYPECHO_ROOT_DIR__ . '/usr/uploads/uforms/' . $form_id . '/';
        if (!is_dir($upload_dir)) {
            if (!mkdir($upload_dir, 0755, true)) {
                return array('success' => false, 'error' => '无法创建上传目录');
            }
        }
        
        // 生成安全的文件名
        $filename = UformsHelper::sanitizeFilename($file['name']);
        $filename = time() . '_' . $filename;
        $file_path = $upload_dir . $filename;
        
        // 移动上传文件
        if (move_uploaded_file($file['tmp_name'], $file_path)) {
            return array(
                'success' => true,
                'file_info' => array(
                    'field_name' => $field['field_name'],
                    'original_name' => $file['name'],
                    'filename' => $filename,
                    'file_path' => $file_path,
                    'file_size' => $file['size'],
                    'file_type' => $file['type']
                )
            );
        } else {
            return array('success' => false, 'error' => '文件保存失败');
        }
    }
    
    // 发送通知
    private static function sendNotifications($form, $form_data, $settings) {
        // 发送邮件通知（如果启用）
        if (!empty($settings['enable_email_notification']) && !empty($settings['notification_email'])) {
            $subject = '新表单提交：' . $form['title'];
            $message = "表单【{$form['title']}】收到新的提交：\n\n";
            
            foreach ($form_data as $key => $value) {
                if (is_array($value)) {
                    $value = implode(', ', $value);
                }
                $message .= "$key: $value\n";
            }
            
            $message .= "\n提交时间：" . date('Y-m-d H:i:s');
            $message .= "\nIP地址：" . UformsHelper::getClientIP();
            
            UformsHelper::sendEmailNotification($settings['notification_email'], $subject, $message, $form_data);
        }
    }
}
```

### 2. 修复 `Action.php` 中的处理逻辑

```php
/**
 * 显示表单
 */
public function showForm()
{
    $request = $this->request;
    $name = $request->get('name');
    
    if (empty($name)) {
        throw new Typecho_Widget_Exception('表单名称不能为空', 404);
    }
    
    $form = UformsHelper::getFormByName($name);
    if (!$form || $form['status'] !== 'published') {
        throw new Typecho_Widget_Exception('表单不存在或未发布', 404);
    }
    
    // 增加访问统计
    $this->trackFormView($form['id']);
    
    // 获取表单字段
    $fields = UformsHelper::getFormFields($form['id']);
    $config = json_decode($form['config'], true) ?: array();
    $settings = json_decode($form['settings'], true) ?: array();
    
    // 处理表单提交
    if ($request->isPost() && $request->get('uform_name') === $name) {
        error_log('Uforms: Form submission detected for form: ' . $name);
        
        // 处理提交
        $result = UformsFront::handleFormSubmission($form, $fields, $settings);
        
        // 检查结果类型
        if (is_string($result)) {
            if (strpos($result, 'uform-success') !== false) {
                // 提交成功，进行重定向避免重复提交
                if (!empty($settings['redirect_url'])) {
                    $this->response->redirect($settings['redirect_url']);
                } else {
                    // 重定向到当前页面并添加成功标记
                    $redirect_url = Helper::options()->siteUrl . 'uforms/form/' . $name . '?success=1';
                    $this->response->redirect($redirect_url);
                }
                return;
            } else {
                // 有错误，显示表单和错误信息
                $this->renderFormPage($form, $fields, $config, $settings, $result);
                return;
            }
        }
    }
    
    // 检查是否需要显示成功消息
    if ($request->get('success') === '1') {
        $success_message = !empty($settings['success_message']) ? 
                          $settings['success_message'] : 
                          '表单提交成功！感谢您的参与。';
        $success_content = '<div class="uform-success">' . htmlspecialchars($success_message) . '</div>';
        $this->renderFormPage($form, $fields, $config, $settings, $success_content);
        return;
    }
    
    // 渲染表单页面
    $this->renderFormPage($form, $fields, $config, $settings);
}
```

### 3. 创建一个测试页面验证数据库

在网站根目录创建 `debug_uforms.php`：

```php
<?php
define('__TYPECHO_ROOT_DIR__', dirname(__FILE__));
require_once __TYPECHO_ROOT_DIR__ . '/config.inc.php';

echo "<h2>Uforms 调试信息</h2>";

try {
    $db = Typecho_Db::get();
    echo "<p>✓ 数据库连接成功</p>";
    
    // 检查表是否存在
    $tables = array('uforms_forms', 'uforms_fields', 'uforms_submissions');
    foreach ($tables as $table) {
        try {
            $count = $db->fetchObject($db->select('COUNT(*) as count')->from('table.' . $table))->count;
            echo "<p>✓ 表 {$table} 存在，记录数：{$count}</p>";
        } catch (Exception $e) {
            echo "<p>✗ 表 {$table} 不存在或有错误：{$e->getMessage()}</p>";
        }
    }
    
    // 测试插入数据
    echo "<h3>测试数据插入</h3>";
    
    $test_data = array(
        'form_id' => 999,
        'data' => json_encode(array('test' => 'value')),
        'ip' => '127.0.0.1',
        'user_agent' => 'Test',
        'status' => 'new',
        'source' => 'test',
        'created_time' => time(),
        'modified_time' => time()
    );
    
    $insert_id = $db->query($db->insert('table.uforms_submissions')->rows($test_data));
    if ($insert_id) {
        echo "<p>✓ 测试数据插入成功，ID：{$insert_id}</p>";
        
        // 删除测试数据
        $db->query($db->delete('table.uforms_submissions')->where('id = ?', $insert_id));
        echo "<p>✓ 测试数据已清理</p>";
    } else {
        echo "<p>✗ 测试数据插入失败</p>";
    }
    
} catch (Exception $e) {
    echo "<p>✗ 数据库错误：{$e->getMessage()}</p>";
    echo "<p>错误跟踪：{$e->getTraceAsString()}</p>";
}

echo "<h3>系统信息</h3>";
echo "<p>PHP版本：" . PHP_VERSION . "</p>";
echo "<p>Typecho版本：" . Typecho_Common::VERSION . "</p>";
echo "<p>错误日志位置：" . ini_get('error_log') . "</p>";

// 检查错误日志
$log_file = __TYPECHO_ROOT_DIR__ . '/error.log';
if (file_exists($log_file)) {
    echo "<h3>最近的错误日志</h3>";
    $logs = file_get_contents($log_file);
    $recent_logs = substr($logs, -2000); // 最后2000个字符
    echo "<pre style='background:#f5f5f5;padding:10px;overflow:auto;max-height:300px;'>" . htmlspecialchars($recent_logs) . "</pre>";
}
?>
```

访问这个文件来检查数据库状态和插件配置。

### 4. 更新路由注册

在 `Plugin.php` 中，确保路由正确注册：

```php
// 注册路由 - 使用正确的参数名
Helper::addRoute('uforms_form', '/uforms/form/[name]', 'Uforms_Action', 'showForm');
Helper::addRoute('uforms_form_id', '/uforms/form/id/[id:digital]', 'Uforms_Action', 'showFormById'); 
Helper::addRoute('uforms_submit', '/uforms/submit', 'Uforms_Action', 'submit');
```

现在请按以下步骤操作：

1. **更新代码**：用上面修复的代码替换对应文件
2. **访问调试页面**：运行 `debug_uforms.php` 检查数据库状态
3. **查看错误日志**：检查 `/error.log` 文件中的详细错误信息
4. **测试表单提交**：重新测试表单提交功能

这些修改应该能解决表单提交但数据不保存的问题。关键修复包括：

- 正确的数据库连接和错误处理
- 详细的日志记录
- POST-REDIRECT-GET模式避免重复提交
- 数据库插入的错误检查
