# 默认话题

## 🧑‍💻 User

管理页面的创建、搜索、状态选择按钮都报错：Deprecated: urlencode(): Passing null to parameter #1 ($string) of type string is deprecated in /www/wwwroot/tiango.wiki/admin/extending.php on line 8

页面不存在
Typecho\Plugin\Exception: 页面不存在 in /www/wwwroot/tiango.wiki/admin/extending.php:9
Stack trace:
#0 {main}

---
## 🤖 Assistant

从错误信息来看，主要有两个问题：

1. **urlencode() 传入 null 值的警告** - PHP 8.1+ 版本对 null 值更加严格
2. **页面不存在的错误** - 路由或文件路径问题

## 修复方案

### 1. 修复 urlencode() null 值问题

创建一个安全的 urlencode 函数，在所有需要的地方替换：

**在 `admin-functions.php` 中添加：**

```php
<?php
// 在文件开头添加这个函数
if (!function_exists('safe_urlencode')) {
    function safe_urlencode($string) {
        return urlencode((string)($string ?? ''));
    }
}
```

### 2. 修复 `manage.php` 中的问题

**替换 `manage.php` 中所有的 urlencode 调用：**

```php
<?php
// 将所有类似这样的代码：
// ?view=<?php echo urlencode('create'); ?>
// 替换为：
// ?view=<?php echo safe_urlencode('create'); ?>

// 修复后的关键部分：
?>

<!-- 修复创建按钮链接 -->
<a href="<?php echo $options->adminUrl; ?>extending.php?panel=<?php echo safe_urlencode('Uforms/index.php'); ?>&view=<?php echo safe_urlencode('create'); ?>" class="ui primary button">
    <i class="plus icon"></i> 新建表单
</a>

<!-- 修复编辑链接 -->
<a href="<?php echo $options->adminUrl; ?>extending.php?panel=<?php echo safe_urlencode('Uforms/index.php'); ?>&view=<?php echo safe_urlencode('create'); ?>&id=<?php echo safe_urlencode((string)($form['id'] ?? '')); ?>" class="ui icon button action-edit" title="编辑">
    <i class="pencil alternate icon"></i>
</a>

<!-- 修复其他操作链接 -->
<a class="item" href="<?php echo $options->adminUrl; ?>extending.php?panel=<?php echo safe_urlencode('Uforms/index.php'); ?>&view=<?php echo safe_urlencode('create'); ?>&action=<?php echo safe_urlencode('duplicate'); ?>&id=<?php echo safe_urlencode((string)($form['id'] ?? '')); ?>">
    <i class="copy icon"></i> 复制表单
</a>

<a class="item" href="?action=<?php echo safe_urlencode('change_status'); ?>&id=<?php echo safe_urlencode((string)($form['id'] ?? '')); ?>&status=<?php echo safe_urlencode('published'); ?>">
    <i class="paper plane icon"></i> 发布表单
</a>
```

### 3. 修复 `index.php` 导航问题

**更新 `index.php` 中的导航链接：**

```php
<?php
// 修复导航 URL 构建
$base_url = $options->adminUrl . 'extending.php?panel=' . safe_urlencode('Uforms/index.php');
?>

<nav class="uforms-nav">
    <a href="<?php echo $base_url; ?>&view=manage" class="<?php echo $view === 'manage' ? 'active' : ''; ?>">
        <i class="list icon"></i>管理
    </a>
    <a href="<?php echo $base_url; ?>&view=create" class="<?php echo $view === 'create' ? 'active' : ''; ?>">
        <i class="plus icon"></i>创建
    </a>
    <a href="<?php echo $base_url; ?>&view=view" class="<?php echo $view === 'view' ? 'active' : ''; ?>">
        <i class="chart line icon"></i>视图
    </a>
    <a href="<?php echo $base_url; ?>&view=notifications" class="<?php echo $view === 'notifications' ? 'active' : ''; ?>">
        <i class="bell outline icon"></i>通知
    </a>
</nav>
```

### 4. 修复 `view.php` 中的 URL 问题

**更新 `view.php` 中的链接：**

```php
<div class="view-nav">
    <a href="?view=view&type=overview" class="ui button <?php echo (!isset($type) || $type === 'overview') ? 'primary' : ''; ?>">
        <i class="dashboard icon"></i>概览
    </a>
    <a href="?view=view&type=submissions" class="ui button <?php echo (isset($type) && $type === 'submissions') ? 'primary' : ''; ?>">
        <i class="inbox icon"></i>提交数据
    </a>
    <a href="?view=view&type=calendar" class="ui button <?php echo (isset($type) && $type === 'calendar') ? 'primary' : ''; ?>">
        <i class="calendar alternate icon"></i>日历视图
    </a>
    <a href="?view=view&type=analytics" class="ui button <?php echo (isset($type) && $type === 'analytics') ? 'primary' : ''; ?>">
        <i class="chart bar icon"></i>数据分析
    </a>
</div>
```

### 5. 创建视图文件

**确保 `views` 目录和相关文件存在，在插件根目录创建：**

`views/overview.php`:
```php
<?php if (!defined('__TYPECHO_ROOT_DIR__')) exit; ?>

<div class="ui segment">
    <h3><i class="dashboard icon"></i> 概览</h3>
    <p>这里是概览内容，显示表单统计信息。</p>
    
    <div class="ui statistics">
        <div class="statistic">
            <div class="value">
                <?php echo count($forms ?? []); ?>
            </div>
            <div class="label">
                总表单数
            </div>
        </div>
    </div>
</div>
```

`views/submissions.php`:
```php
<?php if (!defined('__TYPECHO_ROOT_DIR__')) exit; ?>

<div class="ui segment">
    <h3><i class="inbox icon"></i> 提交数据</h3>
    <p>这里显示表单提交的数据。</p>
</div>
```

`views/calendar.php`:
```php
<?php if (!defined('__TYPECHO_ROOT_DIR__')) exit; ?>

<div class="ui segment">
    <h3><i class="calendar alternate icon"></i> 日历视图</h3>
    <p>这里显示日历视图。</p>
</div>
```

`views/analytics.php`:
```php
<?php if (!defined('__TYPECHO_ROOT_DIR__')) exit; ?>

<div class="ui segment">
    <h3><i class="chart bar icon"></i> 数据分析</h3>
    <p>这里显示数据分析图表。</p>
</div>
```

### 6. 修复 AJAX 处理

**更新 `ajax.php` 中的 AJAX URL：**

```php
// 修复 JavaScript 中的 AJAX URL
$ajax_url = $options->adminUrl . 'extending.php?panel=' . safe_urlencode('Uforms/admin/ajax.php');
```

### 7. 添加错误处理

**在 `admin-functions.php` 中添加错误处理：**

```php
// 添加调试函数
if (!function_exists('uforms_debug')) {
    function uforms_debug($message, $data = null) {
        if (defined('__TYPECHO_DEBUG__') && __TYPECHO_DEBUG__) {
            error_log('[Uforms Debug] ' . $message . ($data ? ' Data: ' . print_r($data, true) : ''));
        }
    }
}

// 修复变量检查
function safe_get_var($var, $default = '') {
    return isset($var) && $var !== null ? $var : $default;
}
```

**完成这些修复后，重新测试管理页面的功能。如果仍有问题，请查看具体的错误信息，我可以提供更针对性的解决方案。**

主要修复点：
1. 所有 `urlencode()` 调用都使用 `safe_urlencode()`
2. 确保所有变量在使用前都进行了 null 检查
3. 创建缺失的视图文件
4. 修复 URL 构建逻辑
5. 添加调试和错误处理功能
